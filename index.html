<!DOCTYPE html>
<html lang="en">
<head>
<!--
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  K-MUDANG Pro v4.15.4 [PUBLIC] - ì¼ì£¼ ê³„ì‚° ì˜¤ë¥˜ ìˆ˜ì •                         â•‘
â•‘  Ancient Korean Four Pillars Destiny Analysis & Lottery Number Generator      â•‘
â•‘                                                                                â•‘
â•‘  v4.15.4 Changes:                                                             â•‘
â•‘    - [CRITICAL FIX] ì¼ì£¼ ê³„ì‚° ì˜¤ë¥˜ ìˆ˜ì • (baseJdn ì‚¬ì£¼ë¡œë˜ì™€ ë™ì¼í•˜ê²Œ ë³€ê²½)    â•‘
â•‘    - [FIX] 60ê°‘ì ì¸ë±ìŠ¤ ë°©ì‹ìœ¼ë¡œ ì¼ì£¼ ê³„ì‚° ì•Œê³ ë¦¬ì¦˜ í†µì¼                      â•‘
â•‘                                                                                â•‘
â•‘  v4.15.3 Changes:                                                             â•‘
â•‘    - [FIX] Firebase ë¡œê·¸ì¸ ì•ˆì •í™” (signInWithRedirect fallback)               â•‘
â•‘    - [KASI] í•œêµ­ì²œë¬¸ì—°êµ¬ì› ì ˆê¸° ë°ì´í„° 100% ì ìš© (1940-2050)                  â•‘
â•‘    - [FIX] AI ë³µì‚¬ í”„ë¡¬í”„íŠ¸ì— ìƒë…„ì›”ì¼ì‹œ/ì–‘ë ¥ìŒë ¥/ì¶œìƒì§€ì—­ ì¶”ê°€               â•‘
â•‘                                                                                â•‘
â•‘  v4.15.1 Changes (å¤§é‹ Precision Engine):                                     â•‘
â•‘    - [MAJOR] ëŒ€ìš´ ì‹œì‘ ë‚˜ì´ ì •ë°€ ê³„ì‚° (ë¶„ ë‹¨ìœ„ â†’ 3ì¼=1ë…„ í™˜ì‚°)                â•‘
â•‘    - [NEW] ìˆœí–‰/ì—­í–‰ ë¡œì§ ì–‘ë‚¨ìŒë…€/ìŒë‚¨ì–‘ë…€ ì •í™• ì ìš©                          â•‘
â•‘    - [NEW] êµìš´ê¸°(äº¤é‹æœŸ) ê²½ê³  ì‹œìŠ¤í…œ ê°•í™”                                     â•‘
â•‘    - Total: 75 AI Rules                                                       â•‘
â•‘                                                                                â•‘
â•‘  Business: K-MUDANG (ì¼€ì´ë¬´ë‹¹) | Registration: 487-20-02668                   â•‘
â•‘  Contact: kmudang.official@gmail.com                                          â•‘
â•‘  Last Updated: 2025-01-18                                                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>K-MUDANG Pro | Four Pillars Destiny & Lottery</title>
<meta name="description" content="Ancient Korean Four Pillars Destiny Analysis for Powerball & Mega Millions. Professional Saju fortune reading.">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:title" content="K-MUDANG Pro | Four Pillars Destiny & Lottery">
<meta property="og:description" content="ğŸ”® Professional Four Pillars Analysis Â· ğŸ° Powerball & Mega Millions Numbers">
<meta property="og:image" content="https://raw.githubusercontent.com/shrmsdl-netizen/k-mudang/main/og-image.png">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Noto+Serif+KR:wght@400;700;900&family=Cinzel+Decorative:wght@400;700;900&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<!-- Firebase SDK for Authentication -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<script>
/* ========================================
   ğŸ”’ PUBLIC EDITION - Firebase Auth
   Login Required | Premium Features Locked
   ======================================== */
console.log('ğŸ”’ K-MUDANG Pro [PUBLIC EDITION] v4.15.3 - KASI Verified');

// Firebase Configuration (Production)
const firebaseConfig = {
    apiKey: "AIzaSyBG8P5KYAo3vTcJBm0rNsAmTgRm8Nt3Rgw",
    authDomain: "k-mudang-pro.firebaseapp.com",
    projectId: "k-mudang-pro",
    storageBucket: "k-mudang-pro.firebasestorage.app",
    messagingSenderId: "287683280564",
    appId: "1:287683280564:web:6168a13d4f1302f0fe21e1",
    measurementId: "G-044J002H6P"
};

// Initialize Firebase
let auth = null;
let firebaseReady = false;

function initFirebase() {
    if (typeof firebase !== 'undefined' && firebase.apps) {
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        auth = firebase.auth();
        firebaseReady = true;
        console.log('âœ… Firebase initialized successfully');
        
        // Check for redirect result (for browsers that don't support popup)
        auth.getRedirectResult().then((result) => {
            if (result.user) {
                console.log('Redirect login successful:', result.user.email);
            }
        }).catch((error) => {
            console.log('Redirect result check:', error.code);
        });
        
        // Auth state observer
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            if (user) {
                console.log('User signed in:', user.email);
                isPremium = await checkPremiumStatus(user.email);
                updateAuthUI();
                if (isPremium) {
                    unlockAllPremium();
                    toast('ğŸ‘‘ Premium features unlocked!');
                }
            } else {
                console.log('User signed out');
                isPremium = false;
                currentUser = null;
                updateAuthUI();
                lockPremiumFeatures();
            }
        });
        
        return true;
    }
    return false;
}

// Try to init immediately, then retry on DOMContentLoaded
if (!initFirebase()) {
    document.addEventListener('DOMContentLoaded', function() {
        if (!firebaseReady) {
            setTimeout(initFirebase, 100);
        }
    });
}

console.log('Public Edition initialized');

/* ========================================
   Toast Function (Early Definition)
   ======================================== */
function toast(msg) {
    const t = document.getElementById('toast');
    if (t) {
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    } else {
        console.log('Toast:', msg);
    }
}

/* ========================================
   Premium State Management
   ======================================== */
let isPremium = false;
let currentUser = null;

// Check premium status via server
async function checkPremiumStatus(email) {
    try {
        const response = await fetch('https://us-central1-k-mudang-pro.cloudfunctions.net/checkPurchaseByEmail', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });
        const data = await response.json();
        // Firebase Functions returns {status: "active"} for valid premium
        return data.success && data.status === 'active';
    } catch (e) {
        console.warn('Premium check failed:', e);
        return false;
    }
}

// Google Sign In
function googleSignIn() {
    // Try to init Firebase if not ready
    if (!firebaseReady) {
        initFirebase();
    }
    
    if (!auth) {
        toast('âŒ Firebase SDK failed to load. Please refresh the page.');
        console.error('Firebase auth is null. Check if SDK loaded correctly.');
        return;
    }
    
    const provider = new firebase.auth.GoogleAuthProvider();
    
    // Try popup first, fallback to redirect
    auth.signInWithPopup(provider)
        .then((result) => {
            toast('âœ… Logged in as ' + result.user.displayName);
        })
        .catch((error) => {
            console.error('Login error:', error);
            if (error.code === 'auth/operation-not-supported-in-this-environment' ||
                error.code === 'auth/popup-blocked') {
                // Fallback to redirect
                auth.signInWithRedirect(provider);
            } else {
                toast('âŒ Login failed: ' + error.message);
            }
        });
}

// Sign Out
function signOut() {
    if (!auth) {
        toast('âŒ Firebase not loaded. Please refresh.');
        return;
    }
    auth.signOut()
        .then(() => {
            toast('ğŸ‘‹ Signed out successfully');
        })
        .catch((error) => {
            toast('âŒ Sign out failed');
        });
}

// Update UI based on auth state
function updateAuthUI() {
    const loginBtn = document.getElementById('login-btn');
    const userInfo = document.getElementById('user-info');
    const userName = document.getElementById('user-name');
    const premiumBadge = document.getElementById('premium-badge');
    const premiumSection = document.getElementById('premium-section');
    
    if (currentUser) {
        // ë¡œê·¸ì¸ ìƒíƒœ
        if (loginBtn) loginBtn.style.display = 'none';
        if (userInfo) userInfo.style.display = 'flex';
        if (userName) userName.textContent = currentUser.displayName || currentUser.email;
        if (premiumBadge) {
            premiumBadge.style.display = isPremium ? 'inline' : 'none';
        }
        // í”„ë¦¬ë¯¸ì—„ì´ë©´ êµ¬ë§¤ ìœ ë„ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        if (premiumSection) {
            premiumSection.style.display = isPremium ? 'none' : 'block';
        }
    } else {
        // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
        if (loginBtn) loginBtn.style.display = 'inline-flex';
        if (userInfo) userInfo.style.display = 'none';
        if (premiumBadge) premiumBadge.style.display = 'none';
        // ë¹„ë¡œê·¸ì¸ì‹œ êµ¬ë§¤ ìœ ë„ ì„¹ì…˜ í‘œì‹œ
        if (premiumSection) premiumSection.style.display = 'block';
    }
}

// Lock premium features
function lockPremiumFeatures() {
    // .premium-section í´ë˜ìŠ¤ë¥¼ ê°€ì§„ í”„ë¦¬ë¯¸ì—„ ì½˜í…ì¸  ì ê¸ˆ
    document.querySelectorAll('.premium-section').forEach(el => {
        el.classList.remove('unlocked');
    });
    document.querySelectorAll('.premium-lock').forEach(el => {
        el.style.display = 'flex';
    });
    document.querySelectorAll('.premium-overlay').forEach(el => {
        el.style.display = 'flex';
    });
    // êµ¬ë§¤ ìœ ë„ ì„¹ì…˜ì€ í‘œì‹œ
    const premiumSection = document.getElementById('premium-section');
    if (premiumSection) premiumSection.style.display = 'block';
}

// Unlock all premium content
function unlockAllPremium() {
    // .premium-section í´ë˜ìŠ¤ë¥¼ ê°€ì§„ í”„ë¦¬ë¯¸ì—„ ì½˜í…ì¸  í•´ê¸ˆ
    document.querySelectorAll('.premium-section').forEach(el => {
        el.classList.add('unlocked');
    });
    document.querySelectorAll('.premium-lock').forEach(el => {
        el.style.display = 'none';
    });
    document.querySelectorAll('.premium-overlay').forEach(el => {
        el.style.display = 'none';
    });
    // í”„ë¦¬ë¯¸ì—„ í•´ê¸ˆ ì‹œ êµ¬ë§¤ ìœ ë„ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
    const premiumSection = document.getElementById('premium-section');
    if (premiumSection) premiumSection.style.display = 'none';
    console.log('All premium features unlocked');
}

// Open premium checkout (Gumroad)
function openPremiumCheckout() {
    if (!currentUser) {
        toast('âš ï¸ Please sign in first');
        googleSignIn();
        return;
    }
    
    // Gumroad checkout URL with email prefill
    const checkoutUrl = `https://kmudang.gumroad.com/l/premium?email=${encodeURIComponent(currentUser.email)}`;
    window.open(checkoutUrl, '_blank');
    toast('ğŸ›’ Opening checkout...');
}

/* ========================================
   Premium Feature Gating
   ======================================== */
function requirePremium(feature) {
    if (isPremium) return true;
    
    toast(`ğŸ‘‘ ${feature} requires Premium`);
    
    // Show premium modal
    const premiumSection = document.getElementById('premium-section');
    if (premiumSection) {
        premiumSection.scrollIntoView({ behavior: 'smooth' });
    }
    
    return false;
}

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('Public Edition initialized');
    updateAuthUI();
    
    // Show premium overlay on locked sections
    if (!isPremium) {
        lockPremiumFeatures();
    }
});

</script>

<!-- Console Protection -->
<script>
(function() {
    const block = function() { return false; };
    document.addEventListener('contextmenu', block);
    document.addEventListener('keydown', function(e) {
        if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || 
            (e.ctrlKey && e.shiftKey && e.key === 'J') || (e.ctrlKey && e.key === 'U')) {
            e.preventDefault();
            return false;
        }
    });
})();
</script>


<style>
/* ========================================
   Animations
   ======================================== */
@keyframes shimmer { 0% { background-position: -200% center; } 100% { background-position: 200% center; } }
@keyframes breathe { 0%, 100% { opacity: 0.04; transform: scale(1); } 50% { opacity: 0.07; transform: scale(1.02); } }
@keyframes dragonPulse { 0%, 100% { filter: drop-shadow(0 0 15px var(--theme-accent-glow)); } 50% { filter: drop-shadow(0 0 30px var(--theme-accent-glow)); } }
@keyframes ballDrop { 0% { transform: translateY(-30px) scale(0.5); opacity: 0; } 60% { transform: translateY(5px) scale(1.1); } 100% { transform: translateY(0) scale(1); opacity: 1; } }
@keyframes glowPulse { 0%, 100% { box-shadow: inset -3px -3px 10px rgba(0,0,0,0.4), inset 3px 3px 8px rgba(255,255,255,0.3), 0 0 25px var(--theme-glow), 0 8px 20px rgba(0,0,0,0.3); } 50% { box-shadow: inset -3px -3px 10px rgba(0,0,0,0.4), inset 3px 3px 8px rgba(255,255,255,0.3), 0 0 40px var(--theme-glow), 0 8px 20px rgba(0,0,0,0.3); } }
@keyframes buttonPulse { 0% { box-shadow: 0 4px 25px var(--theme-glow), 0 0 0 0 rgba(212, 175, 55, 0.7); } 70% { box-shadow: 0 4px 25px var(--theme-glow), 0 0 0 15px rgba(212, 175, 55, 0); } 100% { box-shadow: 0 4px 25px var(--theme-glow), 0 0 0 0 rgba(212, 175, 55, 0); } }
@keyframes kofiPulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(255,215,0,0.5); } 50% { transform: scale(1.02); box-shadow: 0 0 35px rgba(255,215,0,0.8); } }

/* ========================================
   CSS Variables
   ======================================== */
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
    --navy: #1a2332;
    --navy-light: #243447;
    --gold: #D4AF37;
    --gold-light: #F4D58D;
    --pearl: #F5F5F5;
    --gray: #9CA3AF;
    --theme-primary: #DC3545;
    --theme-secondary: #8B0000;
    --theme-accent: #FFD700;
    --theme-accent-glow: rgba(255, 215, 0, 0.4);
    --theme-glow: rgba(220, 53, 69, 0.4);
    --theme-bg-1: #1a1a2e;
    --theme-bg-2: #2d1f3d;
    --wood: #4CAF50;
    --fire: #F44336;
    --earth: #FF9800;
    --metal: #9E9E9E;
    --water: #2196F3;
}

body.powerball-mode {
    --theme-primary: #DC3545;
    --theme-secondary: #8B0000;
    --theme-accent: #FFD700;
    --theme-accent-glow: rgba(255, 215, 0, 0.4);
    --theme-glow: rgba(220, 53, 69, 0.4);
    --theme-bg-1: #1a1a2e;
    --theme-bg-2: #2d1f3d;
}

body.mega-mode {
    --theme-primary: #2E86DE;
    --theme-secondary: #003478;
    --theme-accent: #FFD700;
    --theme-accent-glow: rgba(255, 215, 0, 0.4);
    --theme-glow: rgba(46, 134, 222, 0.4);
    --theme-bg-1: #141E30;
    --theme-bg-2: #243B55;
}

body.saju-mode {
    --theme-primary: #D4AF37;
    --theme-secondary: #8B7020;
    --theme-accent: #FFD700;
    --theme-accent-glow: rgba(255, 215, 0, 0.4);
    --theme-glow: rgba(212, 175, 55, 0.4);
    --theme-bg-1: #1a1a2e;
    --theme-bg-2: #16213e;
}

body {
    font-family: 'Cormorant Garamond', 'Noto Serif KR', Georgia, serif;
    background: var(--navy);
    color: var(--pearl);
    min-height: 100vh;
    padding-bottom: 20px;
    line-height: 1.7;
    transition: all 0.5s ease;
}

/* ========================================
   Watermark & Bagua
   ======================================== */
.oracle-watermark {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    max-width: 500px;
    height: auto;
    max-height: 90vh;
    object-fit: contain;
    opacity: 0.15;
    filter: grayscale(30%) brightness(1.2);
    z-index: -1;
    pointer-events: none;
    transition: opacity 0.5s ease;
}

body.mega-mode .oracle-watermark {
    filter: grayscale(50%) brightness(1.3) hue-rotate(200deg);
    opacity: 0.12;
}

body.saju-mode .oracle-watermark {
    filter: grayscale(20%) brightness(1.1) sepia(20%);
    opacity: 0.18;
}

.bagua {
    position: fixed;
    font-size: 2.5rem;
    opacity: 0.4;
    pointer-events: none;
    z-index: 2;
    font-family: serif;
    line-height: 1;
    text-shadow: 0 0 20px currentColor, 0 0 40px currentColor;
    text-align: center;
    transition: all 0.5s ease;
}
.bagua-sub { font-size: 0.4em; display: block; margin-top: 5px; opacity: 0.8; font-family: 'Noto Serif KR', serif; }
.bagua.tl { top: 180px; left: 15px; color: #FFD700; }
.bagua.tr { top: 180px; right: 15px; color: #FF6B6B; }
.bagua.bl { bottom: 100px; left: 15px; color: #4ECDC4; }
.bagua.br { bottom: 100px; right: 15px; color: #A29BFE; }

body.mega-mode .bagua.tl { color: #87CEEB; }
body.mega-mode .bagua.tr { color: #E8E8E8; }
body.mega-mode .bagua.bl { color: #98D8C8; }
body.mega-mode .bagua.br { color: #B8B8FF; }

body.saju-mode .bagua.tl { color: #FFD700; }
body.saju-mode .bagua.tr { color: #FF7675; }
body.saju-mode .bagua.bl { color: #55EFC4; }
body.saju-mode .bagua.br { color: #A29BFE; }

/* ========================================
   Tab Navigation
   ======================================== */
.game-switcher {
    display: flex;
    justify-content: center;
    gap: 8px;
    padding: 12px 10px;
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(10px);
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.game-btn {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.15);
    color: rgba(255,255,255,0.5);
    padding: 10px 20px;
    font-family: 'Noto Serif KR', 'Cinzel Decorative', serif;
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 1px;
    cursor: pointer;
    border-radius: 25px;
    transition: all 0.4s ease;
    min-width: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.tab-main { font-size: 14px; font-weight: 700; }
.tab-sub { font-size: 10px; opacity: 0.7; }

.game-btn:hover {
    border-color: var(--theme-accent);
    color: var(--pearl);
    transform: translateY(-2px);
}

.game-btn:active {
    transform: scale(0.95);
    transition: transform 0.1s ease;
}

.game-btn.active {
    background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
    border-color: var(--theme-accent);
    color: white;
    box-shadow: 0 4px 20px var(--theme-glow);
}

/* ========================================
   Layout
   ======================================== */
.container {
    max-width: 520px;
    margin: 0 auto;
    padding: 15px;
    position: relative;
    z-index: 10;
}

.tab-content { display: none; }
.tab-content.active { display: block; }

/* ========================================
   Header
   ======================================== */
header {
    text-align: center;
    padding: 25px 15px;
    position: relative;
}

.dragon-seal {
    width: 70px;
    height: 70px;
    margin: 0 auto 15px;
    animation: dragonPulse 3s ease-in-out infinite;
}

.dragon-seal svg { width: 100%; height: 100%; }

header h1 {
    font-family: 'Cinzel Decorative', serif;
    font-size: 2rem;
    font-weight: 900;
    background: linear-gradient(135deg, var(--gold), var(--gold-light), var(--gold));
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmer 3s linear infinite;
    letter-spacing: 3px;
}

.game-title {
    display: inline-block;
    font-size: 1rem;
    font-weight: 700;
    color: var(--theme-accent);
    margin-top: 8px;
    padding: 5px 15px;
    border: 1px solid var(--theme-accent);
    border-radius: 20px;
    letter-spacing: 2px;
}

.subtitle {
    font-size: 0.85rem;
    color: var(--gray);
    margin-top: 10px;
    letter-spacing: 1px;
}

/* ========================================
   Cards
   ======================================== */
.card {
    background: linear-gradient(145deg, rgba(36,52,71,0.9), rgba(26,35,50,0.95));
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 15px;
    border: 1px solid rgba(255,255,255,0.08);
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.card.gold {
    border-color: rgba(212,175,55,0.3);
    background: linear-gradient(145deg, rgba(212,175,55,0.15), rgba(26,35,50,0.95));
}

.card h3 {
    font-size: 1rem;
    font-weight: 700;
    color: var(--theme-accent);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* ========================================
   Form Elements
   ======================================== */
.form-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 15px;
}

.form-group { display: flex; flex-direction: column; gap: 5px; }

.form-group label {
    font-size: 11px;
    color: var(--gray);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.form-group select, .form-group input {
    background: #1a2332;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 8px;
    padding: 12px 10px;
    color: #FFFFFF;
    font-size: 18px;
    font-weight: 600;
    font-family: 'Cinzel Decorative', 'Cormorant Garamond', serif;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
}

.form-group select {
    background: #1a2332 url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23D4AF37' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E") no-repeat right 10px center;
    padding-right: 30px;
    cursor: pointer;
}

.form-group select option {
    background: #1a2332;
    color: #FFFFFF;
    font-size: 18px;
    font-family: 'Cinzel Decorative', 'Cormorant Garamond', serif;
    padding: 14px;
}

.form-group select:focus, .form-group input:focus {
    outline: none;
    border-color: var(--theme-accent);
    box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
}

.toggle-btns { display: flex; gap: 5px; }

.toggle-btn {
    flex: 1;
    padding: 8px;
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 8px;
    background: transparent;
    color: var(--gray);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s;
}

.toggle-btn.on {
    background: var(--theme-primary);
    border-color: var(--theme-accent);
    color: white;
}

/* ========================================
   Buttons
   ======================================== */
.btn {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
    border: none;
    border-radius: 12px;
    color: white;
    font-family: inherit;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 20px var(--theme-glow);
    letter-spacing: 1px;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 30px var(--theme-glow);
}

.btn:active { 
    transform: scale(0.95); 
    transition: transform 0.1s ease;
}

.btn-secondary {
    background: transparent;
    border: 1px solid var(--theme-accent);
    color: var(--theme-accent);
    box-shadow: none;
}

/* ========================================
   Ko-fi Button (Premium Gold)
   ======================================== */
.kofi-container {
    margin-top: 25px;
    padding: 20px;
    background: transparent;
    border: none;
    text-align: center;
}

.kofi-container p {
    color: var(--gold-light);
    font-size: 13px;
    margin-bottom: 15px;
    opacity: 0.85;
}

.kofi-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 16px 32px;
    background: #000000;
    border: 2px solid #D4AF37;
    border-radius: 12px;
    color: #D4AF37;
    font-family: 'Cinzel Decorative', serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 0 20px rgba(212,175,55,0.2), inset 0 0 0 0 rgba(212,175,55,0);
    letter-spacing: 1px;
}

.kofi-btn:hover {
    background: linear-gradient(135deg, rgba(212,175,55,0.25) 0%, rgba(212,175,55,0.15) 100%);
    border-color: #FFD700;
    color: #FFD700;
    transform: translateY(-2px);
    box-shadow: 0 0 35px rgba(212,175,55,0.4), 0 8px 25px rgba(0,0,0,0.3);
    text-shadow: 0 0 10px rgba(255,215,0,0.5);
}

.kofi-btn:active {
    transform: translateY(0);
}

.kofi-btn img {
    width: 24px;
    height: 24px;
}

/* ========================================
   Auth Bar & Premium UI
   ======================================== */
.auth-bar {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    padding: 10px 15px;
    background: linear-gradient(135deg, rgba(0,0,0,0.5) 0%, rgba(26,35,50,0.8) 100%);
    border-bottom: 1px solid rgba(212,175,55,0.2);
}

.login-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: #fff;
    border: none;
    border-radius: 20px;
    color: #333;
    font-family: 'Noto Serif KR', serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.login-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.login-btn img {
    width: 18px;
    height: 18px;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.user-name {
    color: var(--pearl);
    font-size: 13px;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.premium-badge {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #000;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
    animation: kofiPulse 2s infinite;
}

.logout-btn {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: var(--gray);
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.3s;
}

.logout-btn:hover {
    background: rgba(255,255,255,0.2);
    color: var(--pearl);
}

.premium-unlock-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 14px 28px;
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FFD700 100%);
    background-size: 200% 200%;
    animation: shimmer 3s ease infinite;
    border: none;
    border-radius: 25px;
    color: #000;
    font-family: 'Cinzel Decorative', serif;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 20px rgba(255,215,0,0.4);
}

.premium-unlock-btn:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 6px 30px rgba(255,215,0,0.6);
}

.premium-lock {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 30px;
    background: linear-gradient(135deg, rgba(0,0,0,0.4) 0%, rgba(26,35,50,0.6) 100%);
    border: 1px dashed rgba(212,175,55,0.3);
    border-radius: 12px;
    text-align: center;
    min-height: 150px;
}

.premium-lock p {
    color: var(--gold);
    margin-bottom: 15px;
    font-size: 1.1rem;
}

.premium-lock .price {
    color: var(--gold-light);
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 10px;
}

.premium-lock .duration {
    color: var(--gray);
    font-size: 0.85rem;
    margin-bottom: 20px;
}

/* Premium Section Overlay */
.premium-section {
    position: relative;
}

.premium-tag {
    font-size: 0.7rem;
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #000;
    padding: 2px 8px;
    border-radius: 10px;
    margin-left: 8px;
    font-weight: 700;
}

.premium-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(26, 35, 50, 0.95);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    border-radius: 15px;
}

.premium-overlay-content {
    text-align: center;
    padding: 20px;
}

.premium-overlay-content p {
    color: var(--gold);
    margin-bottom: 10px;
    font-size: 1.1rem;
}

.premium-overlay-content .premium-price {
    color: var(--gold-light);
    font-size: 0.9rem;
    margin-bottom: 15px;
}

.premium-section.unlocked .premium-overlay {
    display: none;
}

.premium-section.unlocked .premium-tag {
    display: none;
}

/* ========================================
   Lottery Balls
   ======================================== */
.balls-container {
    display: flex;
    justify-content: center;
    gap: 8px;
    flex-wrap: wrap;
    padding: 20px 0;
    min-height: 80px;
}

.ball {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Cinzel Decorative', serif;
    font-weight: 900;
    font-size: 18px;
    color: white;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    background: linear-gradient(135deg, #DC3545, #8B0000);
    box-shadow: inset -3px -3px 10px rgba(0,0,0,0.4), inset 3px 3px 8px rgba(255,255,255,0.3), 0 0 25px var(--theme-glow), 0 8px 20px rgba(0,0,0,0.3);
    opacity: 0;
    animation: ballDrop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
}

.ball.powerball {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #1a1a2e;
    box-shadow: inset -3px -3px 10px rgba(0,0,0,0.3), inset 3px 3px 8px rgba(255,255,255,0.5), 0 0 30px rgba(255,215,0,0.5), 0 8px 20px rgba(0,0,0,0.3);
}

.ball.mega {
    background: linear-gradient(135deg, #2E86DE, #003478);
}

.ball.megaball {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #1a1a2e;
}

/* ========================================
   Saju Pillars
   ======================================== */
.pillars {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 15px;
}

.pillar {
    background: rgba(0,0,0,0.3);
    border-radius: 12px;
    padding: 12px 8px;
    text-align: center;
    border: 1px solid rgba(255,255,255,0.1);
}

.pillar.dm {
    border-color: var(--gold);
    background: rgba(212,175,55,0.15);
}

.pillar-label {
    font-size: 10px;
    color: var(--gray);
    margin-bottom: 8px;
    text-transform: uppercase;
}

.pillar-stem {
    font-size: 28px;
    font-weight: 900;
    margin-bottom: 4px;
}

.pillar-branch {
    font-size: 24px;
    font-weight: 700;
}

.pillar-sub {
    font-size: 11px;
    color: var(--gray);
    margin-top: 5px;
}

.pillar-god {
    font-size: 10px;
    color: var(--theme-accent);
    margin-top: 5px;
    padding: 3px 6px;
    background: rgba(212,175,55,0.2);
    border-radius: 4px;
}

/* Element Colors */
.el-wood { color: var(--wood); }
.el-fire { color: var(--fire); }
.el-earth { color: var(--earth); }
.el-metal { color: var(--metal); }
.el-water { color: var(--water); }

/* ========================================
   Strength Bar
   ======================================== */
.strength-box {
    background: rgba(0,0,0,0.2);
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
}

.strength-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.strength-title { font-size: 13px; color: var(--gray); }

.strength-badge {
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: 700;
}

.strength-badge.strong { background: var(--fire); color: white; }
.strength-badge.weak { background: var(--water); color: white; }
.strength-badge.balanced { background: var(--wood); color: white; }

.strength-bar {
    height: 8px;
    background: rgba(255,255,255,0.1);
    border-radius: 4px;
    overflow: hidden;
}

.strength-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.8s ease;
}

.strength-fill.strong { background: linear-gradient(90deg, var(--fire), #ff6b6b); }
.strength-fill.weak { background: linear-gradient(90deg, var(--water), #74b9ff); }
.strength-fill.balanced { background: linear-gradient(90deg, var(--wood), #81c784); }

.factors {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-top: 12px;
}

.factor {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    padding: 6px 10px;
    background: rgba(255,255,255,0.05);
    border-radius: 6px;
}

.factor-label { color: var(--gray); }
.factor-value.pos { color: var(--fire); }
.factor-value.neg { color: var(--water); }

/* ========================================
   Element Bar
   ======================================== */
.element-bar {
    display: flex;
    height: 30px;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 10px;
}

.element-bar > div { transition: width 0.5s ease; }

.element-legend {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
    font-size: 11px;
}

.element-legend span {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* ========================================
   Info Box
   ======================================== */
.info-box {
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
}

.info-box p { font-size: 13px; line-height: 1.7; }

/* ========================================
   Luck Timeline
   ======================================== */
.luck-timeline {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding: 10px 0;
    scrollbar-width: thin;
}

.luck-item {
    flex: 0 0 70px;
    text-align: center;
    padding: 12px 8px;
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
    border: 1px solid transparent;
}

.luck-item.current {
    border-color: var(--gold);
    background: rgba(212,175,55,0.2);
}

.luck-age { font-size: 11px; color: var(--gray); margin-bottom: 5px; }
.luck-pillar { font-size: 18px; font-weight: 700; }
.luck-element { font-size: 10px; color: var(--theme-accent); margin-top: 5px; }

/* ========================================
   Sinsal Grid
   ======================================== */
.sinsal-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.sinsal-item {
    padding: 12px;
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
    border-left: 3px solid var(--gray);
}

.sinsal-item.good { border-color: var(--wood); }
.sinsal-item.bad { border-color: var(--fire); }

.sinsal-name { font-size: 13px; font-weight: 700; margin-bottom: 5px; }
.sinsal-desc { font-size: 11px; color: var(--gray); }

/* ========================================
   History
   ======================================== */
.history-section { margin-top: 15px; }

.history-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    background: rgba(0,0,0,0.2);
    border-radius: 10px;
    margin-bottom: 8px;
}

.history-type {
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 10px;
    background: var(--theme-primary);
    color: white;
}

.history-balls { display: flex; gap: 4px; flex-wrap: wrap; }

.history-balls .ball {
    width: 28px;
    height: 28px;
    font-size: 11px;
    animation: none;
    opacity: 1;
}

/* ========================================
   Toast
   ======================================== */
.toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 12px 24px;
    border-radius: 25px;
    font-size: 14px;
    z-index: 9999;
    opacity: 0;
    transition: all 0.3s;
    border: 1px solid var(--theme-accent);
}

.toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

/* ========================================
   Footer
   ======================================== */
footer {
    text-align: center;
    padding: 30px 15px;
    color: var(--gray);
    font-size: 12px;
}

footer a {
    color: var(--theme-accent);
    text-decoration: none;
}

/* ========================================
   Responsive
   ======================================== */
@media (max-width: 400px) {
    .game-switcher { gap: 4px; padding: 10px 5px; }
    .game-btn { padding: 8px 12px; font-size: 12px; min-width: auto; }
    .tab-main { font-size: 12px; }
    .tab-sub { font-size: 9px; }
    header h1 { font-size: 1.6rem; }
    .ball { width: 40px; height: 40px; font-size: 15px; }
    .pillar-stem { font-size: 22px; }
    .pillar-branch { font-size: 18px; }
    .bagua { font-size: 1.8rem; }
}

/* Talisman Card Styles */
#talisman-canvas {
    max-width: 100%;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}
#talisman-preview {
    text-align: center;
    padding: 20px;
}
/* [v4.14.1] Talisman Generation Animation */
#talisman-ritual-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.95);
    display: none;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 9999;
}
#talisman-ritual-overlay.active {
    display: flex;
}
.ritual-text {
    color: #D4AF37;
    font-size: 1.5rem;
    margin-bottom: 30px;
    font-family: "Noto Serif KR", serif;
    animation: ritualPulse 1.5s ease-in-out infinite;
}
@keyframes ritualPulse {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
}
</style>
</head>
<body class="saju-mode">

<!-- Bagua decoration -->
<div class="bagua tl">â˜°<span class="bagua-sub">ä¹¾</span></div>
<div class="bagua tr">â˜·<span class="bagua-sub">å¤</span></div>
<div class="bagua bl">â˜µ<span class="bagua-sub">å</span></div>
<div class="bagua br">â˜²<span class="bagua-sub">é›¢</span></div>

<img class="oracle-watermark" src="https://raw.githubusercontent.com/shrmsdl-netizen/k-mudang/main/og-image.png" alt="" />

<!-- 3-Tab Navigation -->
<div class="game-switcher">
    <button class="game-btn active" onclick="switchGame('saju')"><span class="tab-main">ğŸ”® Four Pillars</span><span class="tab-sub">å››æŸ±</span></button>
    <button class="game-btn" onclick="switchGame('powerball')"><span class="tab-main">ğŸ”´ Powerball</span></button>
    <button class="game-btn" onclick="switchGame('mega')"><span class="tab-main">ğŸ”µ Mega Millions</span></button>
</div>

<!-- Auth Bar -->
<!-- Auth bar hidden for Personal Edition -->
<div class="auth-bar" id="auth-bar">
    <button class="login-btn" id="login-btn" onclick="googleSignIn()">
        <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Sign in with Google
    </button>
    <div class="user-info" id="user-info" style="display:none;">
        <span class="user-name" id="user-name"></span>
        <span class="premium-badge" id="premium-badge" style="display:none;">ğŸ‘‘ Premium</span>
        <button class="logout-btn" onclick="signOut()">Logout</button>
    </div>
</div>

<div class="container">

    <!-- ========================================
         Tab 1: SAJU (å››æŸ±) Fortune
         ======================================== -->
    <div id="tab-saju" class="tab-content active">
        <header>
            <div class="dragon-seal">
                <svg viewBox="0 0 100 100">
                    <defs>
                        <linearGradient id="dragonGold1" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFD700"/>
                            <stop offset="50%" style="stop-color:#FFA500"/>
                            <stop offset="100%" style="stop-color:#FFD700"/>
                        </linearGradient>
                    </defs>
                    <circle cx="50" cy="50" r="45" fill="none" stroke="url(#dragonGold1)" stroke-width="2"/>
                    <text x="50" y="58" text-anchor="middle" fill="url(#dragonGold1)" font-size="32" font-family="serif">é¾</text>
                </svg>
            </div>
            <h1>K-MUDANG</h1>
            <span class="game-title">FORTUNE</span>
            <p class="subtitle">The State of the Art Â· Algorithm + AI</p>
        </header>

        <div class="card">
            <h3>ğŸ“… Birth Date & Time</h3>
            <div class="form-row">
                <div class="form-group"><label>Month</label><select id="saju-month"></select></div>
                <div class="form-group"><label>Day</label><select id="saju-day"></select></div>
                <div class="form-group"><label>Year</label><select id="saju-year"></select></div>
                <div class="form-group"><label>Hour</label><select id="saju-hour"></select></div>
            </div>
            <div class="form-row" style="grid-template-columns: 1fr;">
                <div class="form-group">
                    <label>ğŸŒ Birth Location</label>
                    <select id="birth-location" onchange="updateTimezoneInfo()">
                        <optgroup label="ğŸ‡ºğŸ‡¸ United States">
                            <option value="us-pacific" selected>Pacific (CA, WA, OR)</option>
                            <option value="us-mountain">Mountain (CO, AZ, UT, NV)</option>
                            <option value="us-central">Central (TX, IL, MN)</option>
                            <option value="us-eastern">Eastern (NY, FL, GA)</option>
                            <option value="us-alaska">Alaska</option>
                            <option value="us-hawaii">Hawaii</option>
                        </optgroup>
                        <optgroup label="ğŸŒ East Asia">
                            <option value="korea">ğŸ‡°ğŸ‡· Korea</option>
                            <option value="japan">ğŸ‡¯ğŸ‡µ Japan</option>
                            <option value="china">ğŸ‡¨ğŸ‡³ China</option>
                            <option value="taiwan">ğŸ‡¹ğŸ‡¼ Taiwan</option>
                            <option value="hongkong">ğŸ‡­ğŸ‡° Hong Kong</option>
                        </optgroup>
                        <optgroup label="ğŸŒ Southeast Asia">
                            <option value="vietnam">ğŸ‡»ğŸ‡³ Vietnam</option>
                            <option value="thailand">ğŸ‡¹ğŸ‡­ Thailand</option>
                            <option value="singapore">ğŸ‡¸ğŸ‡¬ Singapore</option>
                            <option value="philippines">ğŸ‡µğŸ‡­ Philippines</option>
                            <option value="indonesia">ğŸ‡®ğŸ‡© Indonesia</option>
                        </optgroup>
                        <optgroup label="ğŸŒ South Asia / Middle East">
                            <option value="india">ğŸ‡®ğŸ‡³ India</option>
                            <option value="uae">ğŸ‡¦ğŸ‡ª UAE / Dubai</option>
                            <option value="israel">ğŸ‡®ğŸ‡± Israel</option>
                            <option value="saudi">ğŸ‡¸ğŸ‡¦ Saudi Arabia</option>
                        </optgroup>
                        <optgroup label="ğŸ‡ªğŸ‡º Europe">
                            <option value="uk">ğŸ‡¬ğŸ‡§ UK</option>
                            <option value="germany">ğŸ‡©ğŸ‡ª Germany</option>
                            <option value="france">ğŸ‡«ğŸ‡· France</option>
                            <option value="spain">ğŸ‡ªğŸ‡¸ Spain</option>
                            <option value="italy">ğŸ‡®ğŸ‡¹ Italy</option>
                            <option value="russia">ğŸ‡·ğŸ‡º Russia (Moscow)</option>
                        </optgroup>
                        <optgroup label="ğŸŒ Americas">
                            <option value="canada-west">ğŸ‡¨ğŸ‡¦ Canada West</option>
                            <option value="canada-east">ğŸ‡¨ğŸ‡¦ Canada East</option>
                            <option value="mexico">ğŸ‡²ğŸ‡½ Mexico</option>
                            <option value="brazil">ğŸ‡§ğŸ‡· Brazil</option>
                        </optgroup>
                        <optgroup label="ğŸŒ Oceania">
                            <option value="australia-east">ğŸ‡¦ğŸ‡º Australia East</option>
                            <option value="australia-west">ğŸ‡¦ğŸ‡º Australia West</option>
                            <option value="newzealand">ğŸ‡³ğŸ‡¿ New Zealand</option>
                        </optgroup>
                    </select>
                    <p id="timezone-info" style="font-size:0.7rem;color:var(--gold);margin-top:5px;display:none;"></p>
                </div>
            </div>
            <div class="form-row" style="grid-template-columns: repeat(2, 1fr);">
                <div class="form-group">
                    <label>Gender</label>
                    <div class="toggle-btns">
                        <button class="toggle-btn on" data-gender="m" onclick="setGender('m')">ğŸ‘¨ M</button>
                        <button class="toggle-btn" data-gender="f" onclick="setGender('f')">ğŸ‘© F</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Calendar</label>
                    <div class="toggle-btns">
                        <button class="toggle-btn on" data-cal="solar" onclick="setCalendar('solar')">â˜€ï¸ Solar</button>
                        <button class="toggle-btn" data-cal="lunar" onclick="setCalendar('lunar')">ğŸŒ™ Lunar</button>
                    </div>
                    <p id="lunar-notice" style="display:none;font-size:0.7rem;color:var(--gold);margin-top:5px;">ğŸ’¡ Solar calendar recommended for accuracy</p>
                </div>
            </div>
            <button class="btn" onclick="analyzeSaju()">ğŸ”® Analyze Fortune</button>
        </div>

        <div id="saju-result" style="display:none;">
            <!-- Four Pillars Chart - FREE -->
            <div class="card">
                <h3>ğŸ“œ Four Pillars (Four Pillars Chart)</h3>
                <div class="pillars" id="pillars"></div>
                <!-- 12ìš´ì„±/ê°•ì•½ì€ Premiumìœ¼ë¡œ ì´ë™ -->
            </div>

            <!-- Premium Upsell for Full Analysis -->
            <div class="card" style="text-align:center;background:linear-gradient(135deg,rgba(255,215,0,0.08),rgba(255,193,7,0.03));border:1px solid rgba(212,175,55,0.2);">
                <p style="font-size:1.2rem;margin-bottom:10px;">ğŸ”® Unlock Full Destiny Analysis</p>
                <p style="font-size:0.85rem;color:var(--gray);margin-bottom:15px;">
                    70+ Advanced interpretations Â· Life Cycles Â· Divine Stars Â· Monthly Fortune
                </p>
                <button class="premium-unlock-btn" onclick="openPremiumCheckout()">ğŸ™ Offer ç¦å‚µ Â· Unlock Premium</button>
            </div>

            <!-- Strength & 12 States - PREMIUM -->
            <div class="card" id="card-strength">
                <h3>ğŸ’ª Day Master Strength</h3>
                
                <div id="twelve-states"></div>
                <div class="strength-box" id="strength-box"></div>
            </div>

            <!-- ç´éŸ³(Sound Element)/å‘½å®®(Life Palace)/Conception - PREMIUM -->
            <div class="card" id="card-napeum">
                <h3>ğŸµ ç´éŸ³ & å‘½å®®</h3>
                
                <div id="napeum-myunggung"></div>
            </div>

            <!-- Hidden Stems Analysis - PREMIUM -->
            <div class="card" id="card-jijanggan">
                <h3>ğŸŒ¿ æ”¯è—å¹² Hidden Stems</h3>
                
                <div id="jijanggan-analysis"></div>
            </div>

            <!-- Root & Stem Analysis - PREMIUM -->
            <div class="card" id="card-tonggeun">
                <h3>ğŸŒ³ é€šæ ¹é€å¹² Root & Stem</h3>
                
                <div id="tonggeun-analysis"></div>
            </div>

            <!-- Five Elements (äº”è¡Œ) - PREMIUM -->
            <div class="card" id="card-elements">
                <h3>ğŸŒŸ Five Elements (äº”è¡Œ)</h3>
                
                <div class="element-bar" id="element-bar"></div>
                <div class="element-legend" id="element-legend"></div>
                <div id="element-analysis"></div>
            </div>

            <!-- Beneficial Elements (ç”¨ç¥) - PREMIUM -->
            <div class="card gold" id="card-gods">
                <h3>âš–ï¸ Beneficial Elements (ç”¨ç¥)</h3>
                
                <div id="gods" class="gods-grid"></div>
                <div id="gods-detail"></div>
                <div id="gods-analysis"></div>
            </div>

            <!-- Six Relations (å…­è¦ª) Analysis - PREMIUM -->
            <div class="card" id="card-yukcheon">
                <h3>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Six Relations (å…­è¦ª)</h3>
                
                <div id="yukcheon-analysis"></div>
            </div>

            <!-- Structure - PREMIUM -->
            <div class="card" id="card-format">
                <h3>ğŸ›ï¸ æ ¼å±€ Structure</h3>
                
                <div id="format"></div>
                <div id="format-analysis"></div>
            </div>

            <!-- Day Pillar Analysis - PREMIUM -->
            <div class="card" id="card-ilju">
                <h3>ğŸ“… æ—¥æŸ± Day Pillar Analysis</h3>
                
                <div id="ilju"></div>
            </div>

            <!-- Position & Life Stages - PREMIUM -->
            <div class="card" id="card-gungwi">
                <h3>ğŸ  Palace & Twelve States</h3>
                
                <div id="gungwi-analysis"></div>
                <div id="twelve-states-full"></div>
            </div>

            <!-- å¤§é‹(Life Cycle) - PREMIUM -->
            <div class="card premium-section" id="card-luck">
                <h3>ğŸ”„ Life Cycles (å¤§é‹) <span class="premium-tag">ğŸ‘‘ Premium</span></h3>
                <div class="premium-overlay" id="overlay-luck">
                    <div class="premium-overlay-content">
                        <p>ğŸ™ ç¦å‚µ (Karma Offering)</p>
                        <p class="premium-price">$20 Â· 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer ç¦å‚µ</button>
                    </div>
                </div>
                <div class="luck-timeline" id="luck-timeline"></div>
                <div id="luck-detail"></div>
                <div id="gyoungi-analysis"></div>
            </div>

            <!-- í–¥í›„ 10ë…„ ìš´ - PREMIUM -->
            <div class="card premium-section" id="card-tenyears">
                <h3>ğŸ“ˆ Next 10 Years Fortune <span class="premium-tag">ğŸ‘‘ Premium</span></h3>
                <div class="premium-overlay" id="overlay-tenyears">
                    <div class="premium-overlay-content">
                        <p>ğŸ™ ç¦å‚µ (Karma Offering)</p>
                        <p class="premium-price">$20 Â· 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer ç¦å‚µ</button>
                    </div>
                </div>
                <div id="ten-years-luck"></div>
            </div>

            <!-- Monthly Fortune - PREMIUM -->
            <div class="card premium-section" id="card-monthly">
                <h3>ğŸ“† Monthly Fortune <span class="premium-tag">ğŸ‘‘ Premium</span></h3>
                <div class="premium-overlay" id="overlay-monthly">
                    <div class="premium-overlay-content">
                        <p>ğŸ™ ç¦å‚µ (Karma Offering)</p>
                        <p class="premium-price">$20 Â· 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer ç¦å‚µ</button>
                    </div>
                </div>
                <div id="monthly-luck"></div>
            </div>

            <!-- Harmony/Clash Analysis - PREMIUM -->
            <div class="card" id="card-interactions">
                <h3>ğŸ”— Harmony & Clash</h3>
                
                <div id="interactions"></div>
                <div id="banghap-amhap"></div>
                <div id="advanced-interactions"></div>
            </div>

            <!-- ê³µë§ - PREMIUM -->
            <div class="card" id="card-gongmang">
                <h3>â­• Empty Void (ç©ºäº¡)</h3>
                
                <div id="gongmang"></div>
                <div id="gongmang-haeso"></div>
            </div>

            <!-- ì‹ ì‚´ - PREMIUM -->
            <div class="card" id="card-sinsal">
                <h3>âœ¨ Divine Stars (ç¥æ®º)</h3>
                
                <div id="sinsal"></div>
                <div id="sinsal-position"></div>
                <div class="sinsal-grid" id="sinsal-grid"></div>
            </div>

            <!-- Today's Fortune - PREMIUM -->
            <div class="card gold premium-section" id="card-today">
                <h3>ğŸŒ… Today's Fortune <span class="premium-tag">ğŸ‘‘ Premium</span></h3>
                <div class="premium-overlay">
                    <div class="premium-overlay-content">
                        <p>ğŸ™ ç¦å‚µ (Karma Offering)</p>
                        <p class="premium-price">$20 Â· 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer ç¦å‚µ</button>
                    </div>
                </div>
                <div id="today-fortune"></div>
            </div>

            <!-- AI Comprehensive Interpretation - PREMIUM -->
            <div class="card gold" id="card-ai">
                <h3>ğŸ¤– AI Interpretation</h3>
                
                <div id="ai-interpretation"></div>
                <div style="margin-top:25px; text-align:center; padding:30px 20px; background:linear-gradient(135deg, rgba(20,20,35,0.9), rgba(30,30,50,0.95)); border:1px solid rgba(212,175,55,0.3); border-radius:12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    
                    <p style="font-size:1.2rem; background:linear-gradient(to right, #D4AF37, #FFE5B4, #D4AF37); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; margin-bottom:15px; font-weight:700; letter-spacing:1.5px;">
                        THE STATE OF THE ART
                    </p>

                    <p style="font-size:0.95rem; color:#e0e0e0; line-height:1.6; margin-bottom:25px;">
                        Classical precision meets modern AI.<br>
                        This hybrid approachâ€”our exact calculations paired with AI's insightâ€”is <span style="color:var(--gold); font-weight:600;">the most advanced reading available today.</span>
                    </p>

                    <button class="btn" onclick="copySajuForAI()" style="background:linear-gradient(135deg,#6D28D9,#3B82F6); margin:0 auto; padding:16px 32px; font-size:16px; letter-spacing:0.5px; border-radius:50px; box-shadow:0 0 20px rgba(109, 40, 217, 0.4); font-weight:600;">
                        âœ¨ Copy Full Analysis
                    </button>

                    <p style="font-size:0.8rem; color:#9CA3AF; margin-top:18px;">
                        Paste into <strong>Gemini</strong> or <strong>ChatGPT</strong> for a deep dive into your destiny.
                    </p>
                </div>
            </div>

            <!-- ì¢…í•© í•´ì„ - PREMIUM -->
            <div class="card gold premium-section" id="card-summary">
                <h3>ğŸ“– Summary Analysis <span class="premium-tag">ğŸ‘‘ Premium</span></h3>
                <div class="premium-overlay">
                    <div class="premium-overlay-content">
                        <p>ğŸ™ ç¦å‚µ (Karma Offering)</p>
                        <p class="premium-price">$20 Â· 24-hour access</p>
                        <button class="premium-unlock-btn" onclick="openPremiumCheckout()">Offer ç¦å‚µ</button>
                    </div>
                </div>
                <div id="summary-analysis"></div>
            </div>

            <!-- ===== Share Section ===== -->
            <div class="card" style="text-align:center;background:linear-gradient(135deg,rgba(212,175,55,0.1),rgba(139,90,43,0.05));border:1px solid rgba(212,175,55,0.3);">
                <p style="font-size:1.1rem;margin-bottom:8px;">âœ¨ Enjoying K-MUDANG?</p>
                <p style="font-size:0.9rem;color:var(--gray);margin-bottom:20px;">
                    Share the gift of cosmic insight with those who seek their fortune
                </p>
                <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
                    <button class="btn" onclick="shareApp()" style="background:linear-gradient(135deg,#25D366,#128C7E);padding:12px 24px;">
                        ğŸ“¤ Share
                    </button>
                    <button class="btn" onclick="copyShareLink()" style="background:linear-gradient(135deg,#6c757d,#495057);padding:12px 24px;">
                        ğŸ”— Copy Link
                    </button>
                </div>
            </div>

            <!-- ===== Fortune Talisman Card ===== -->
            <div class="card" id="talisman-card" style="text-align:center;background:linear-gradient(135deg,#8B0000,#DC143C);border:3px solid #FFD700;">
                <p style="font-size:1.5rem;margin-bottom:8px;color:#FFD700;">ğŸ® 2026 Fortune Talisman ğŸ®</p>
                <p style="font-size:0.9rem;color:#FFF;margin-bottom:15px;">
                    Generate your personal fortune talisman based on your Yongshin (ç”¨ç¥)
                </p>
                <div id="talisman-preview" style="display:none;margin-bottom:20px;">
                    <canvas id="talisman-canvas" width="540" height="960"></canvas>
                    <p style="font-size:0.75rem;color:var(--gray);margin-top:10px;">ğŸ“± Optimized for phone wallpaper (9:16)</p>
                    <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:15px;">
                        <button onclick="downloadTalisman()" style="padding:10px 20px;background:linear-gradient(135deg,#D4AF37,#B8860B);color:#1a1a1a;border:none;border-radius:20px;font-weight:600;cursor:pointer;">
                            ğŸ“¥ Save as Wallpaper
                        </button>
                        <button onclick="shareTalisman()" style="padding:10px 20px;background:linear-gradient(135deg,#25D366,#128C7E);color:white;border:none;border-radius:20px;font-weight:600;cursor:pointer;">
                            ğŸ“¤ Share
                        </button>
                    </div>
                </div>
                
                <!-- [v4.14.1] Ritual Animation Overlay -->
                <div id="talisman-ritual-overlay">
                    <p class="ritual-text">ğŸ–Œï¸ Inscribing your talisman...</p>
                    <p class="ritual-text" style="font-size:1rem;">Drawing your talisman...</p>
                    <canvas id="ritual-canvas" width="300" height="400" style="border:2px solid #8B7355;border-radius:8px;margin-top:20px;"></canvas>
                </div>
                
                <div id="talisman-btn-wrapper">
                    <button class="btn" onclick="generateTalisman()" style="background:#FFD700;color:#000;width:100%;padding:20px;font-size:1.2rem;font-weight:bold;">
                        ğŸ® Generate My Talisman ğŸ®
                    </button>
                </div>
            </div>

            <!-- ===== Premium Unlock (ç¦å‚µ) ===== -->
            <div class="card" id="premium-section" style="text-align:center;background:linear-gradient(135deg,rgba(255,215,0,0.08),rgba(255,193,7,0.03));border:1px solid rgba(212,175,55,0.2);">
                <p style="font-size:1.4rem;margin-bottom:8px;">ğŸ™ ç¦å‚µ (Karma Offering)</p>
                <p style="font-size:0.95rem;color:var(--gold-light);line-height:1.7;margin-bottom:15px;font-style:italic;">
                    "ë³µì„ ë°›ì•˜ìœ¼ë©´ ë³µì±„ë¥¼ ë‚´ì–´ì•¼ í•œë‹¤"<br>
                    <span style="font-size:0.8rem;color:var(--gray);">"Having received wisdom, an offering honors tradition."</span>
                </p>
                <p style="font-size:0.85rem;color:var(--gray);line-height:1.6;margin-bottom:15px;">
                    In Korean fortune-telling tradition, <strong style="color:var(--gold);">ç¦å‚µ (Bokchae)</strong> is the sacred exchange â€”<br>
                    a grateful offering for cosmic insight received.
                </p>
                <p style="font-size:0.8rem;color:var(--gray);margin-bottom:20px;">
                    Unlock: Life Cycles (å¤§é‹) Â· 10-Year Fortune Â· Monthly Fortune Â· AI Copy
                </p>
                
                <!-- Single Offering Button -->
                <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-bottom:15px;">
                    <button class="premium-unlock-btn" onclick="openPremiumCheckout()" style="padding:18px 40px;background:linear-gradient(135deg,#FFD700,#FFA500);box-shadow:0 0 20px rgba(255,215,0,0.3);">
                        <span style="display:block;font-size:1.4rem;font-weight:700;">Unlock Premium Â· $20</span>
                    </button>
                </div>
                
                <p class="duration" style="font-size:0.85rem;color:var(--gray);margin-bottom:15px;">24-hour full access</p>
                <p style="font-size:0.7rem;color:var(--gray);margin-top:10px;opacity:0.6;">
                    ğŸ”’ Secure payment via Gumroad
                </p>
            </div>

            <!-- ===== Classical Studies ===== -->
            <div class="card" style="text-align:center;background:linear-gradient(135deg,rgba(103,58,183,0.08),rgba(156,39,176,0.03));border:1px solid rgba(156,39,176,0.2);">
                <p style="font-size:1.1rem;margin-bottom:12px;">â˜¯ Essence of Classical Destiny Studies (ç²¾é«“)</p>
                <p style="font-size:0.85rem;color:var(--gold);margin-bottom:15px;">
                    ã€æ»´å¤©é«“ã€ Â· ã€å­å¹³çœè©®ã€ Â· ã€çª®é€šå¯¶é‘‘ã€
                </p>
                <p style="font-size:0.8rem;color:var(--gray);line-height:1.7;margin-bottom:15px;">
                    The authentic theories from three classical texts of Korean-Chinese astrology, modernized for the digital age.
                </p>
                <div style="font-size:0.75rem;color:var(--gray);opacity:0.8;line-height:1.8;">
                    <p>è¬æ­²æ›† Perpetual Calendar Â· ç¯€æ°£ Solar Terms</p>
                    <p>ç”¨ç¥ Beneficial Elements Â· ç´éŸ³ Sound Elements</p>
                    <p>å‘½å®® Life Palace Â· èƒå…ƒ Conception Origin Â· æ”¯è—å¹² Hidden Stems</p>
                    <p>é€šæ ¹é€å¹² Root & Stem Â· æ–¹åˆ Directional Harmony Â· æš—åˆ Hidden Harmony</p>
                    <p>å…­åç”²å­ æ—¥æŸ±è«– 60 Pillars Day Master Theory</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         Tab 2: POWERBALL
         ======================================== -->
    <div id="tab-powerball" class="tab-content">
        <header>
            <div class="dragon-seal">
                <svg viewBox="0 0 100 100">
                    <defs>
                        <linearGradient id="dragonGold2" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFD700"/>
                            <stop offset="50%" style="stop-color:#FFA500"/>
                            <stop offset="100%" style="stop-color:#FFD700"/>
                        </linearGradient>
                    </defs>
                    <circle cx="50" cy="50" r="45" fill="none" stroke="url(#dragonGold2)" stroke-width="2"/>
                    <text x="50" y="58" text-anchor="middle" fill="url(#dragonGold2)" font-size="32" font-family="serif">é¾</text>
                </svg>
            </div>
            <h1>K-MUDANG</h1>
            <span class="game-title">POWERBALL</span>
            <p class="subtitle">The State of the Art Â· Algorithm + AI</p>
        </header>

        <div class="card">
            <h3>ğŸ“… Your Birth Date</h3>
            <div class="form-row" style="grid-template-columns: repeat(3, 1fr);">
                <div class="form-group"><label>Month</label><select id="pb-month"></select></div>
                <div class="form-group"><label>Day</label><select id="pb-day"></select></div>
                <div class="form-group"><label>Year</label><select id="pb-year"></select></div>
            </div>
            <button class="btn btn-secondary" onclick="generatePowerball('quick')">ğŸ² Quick Pick (Random)</button>
            <div style="margin-top:15px;padding:12px;background:rgba(255,215,0,0.05);border-radius:8px;border:1px solid rgba(212,175,55,0.2);">
                <p style="font-size:0.8rem;color:var(--gold);margin-bottom:8px;">ğŸ”® Want destiny-based numbers?</p>
                <button class="premium-unlock-btn" onclick="openPremiumCheckout()" style="padding:8px 16px;font-size:12px;">
                    ğŸ‘‘ Unlock Destiny Numbers
                </button>
            </div>
        </div>

        <div class="card" id="pb-result" style="display:none;">
            <h3>ğŸ° Your Numbers</h3>
            <div class="balls-container" id="pb-balls"></div>
            
            <!-- Premium Upsell -->
            <div style="text-align:center;margin-top:20px;padding:15px;background:rgba(255,215,0,0.05);border-radius:10px;">
                <p style="color:var(--gold);margin-bottom:10px;">ğŸ‘‘ Want AI-powered destiny analysis?</p>
                <button class="premium-unlock-btn" onclick="openPremiumCheckout()" style="padding:10px 20px;font-size:12px;">
                    Unlock Premium $20
                </button>
            </div>
        </div>

        <div class="card history-section" id="pb-history" style="display:none;">
            <h3>ğŸ“‹ History</h3>
            <div id="pb-history-list"></div>
        </div>
    </div>

    <!-- ========================================
         Tab 3: MEGA MILLIONS
         ======================================== -->
    <div id="tab-mega" class="tab-content">
        <header>
            <div class="dragon-seal">
                <svg viewBox="0 0 100 100">
                    <defs>
                        <linearGradient id="dragonGold3" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFD700"/>
                            <stop offset="50%" style="stop-color:#FFA500"/>
                            <stop offset="100%" style="stop-color:#FFD700"/>
                        </linearGradient>
                    </defs>
                    <circle cx="50" cy="50" r="45" fill="none" stroke="url(#dragonGold3)" stroke-width="2"/>
                    <text x="50" y="58" text-anchor="middle" fill="url(#dragonGold3)" font-size="32" font-family="serif">é¾</text>
                </svg>
            </div>
            <h1>K-MUDANG</h1>
            <span class="game-title">MEGA MILLIONS</span>
            <p class="subtitle">The State of the Art Â· Algorithm + AI</p>
        </header>

        <div class="card">
            <h3>ğŸ“… Your Birth Date</h3>
            <div class="form-row" style="grid-template-columns: repeat(3, 1fr);">
                <div class="form-group"><label>Month</label><select id="mega-month"></select></div>
                <div class="form-group"><label>Day</label><select id="mega-day"></select></div>
                <div class="form-group"><label>Year</label><select id="mega-year"></select></div>
            </div>
            <button class="btn btn-secondary" onclick="generateMega('quick')">ğŸ² Quick Pick (Random)</button>
            <div style="margin-top:15px;padding:12px;background:rgba(255,215,0,0.05);border-radius:8px;border:1px solid rgba(212,175,55,0.2);">
                <p style="font-size:0.8rem;color:var(--gold);margin-bottom:8px;">ğŸ”® Want destiny-based numbers?</p>
                <button class="premium-unlock-btn" onclick="openPremiumCheckout()" style="padding:8px 16px;font-size:12px;">
                    ğŸ‘‘ Unlock Destiny Numbers
                </button>
            </div>
        </div>

        <div class="card" id="mega-result" style="display:none;">
            <h3>ğŸ° Your Numbers</h3>
            <div class="balls-container" id="mega-balls"></div>
            
            <!-- Premium Upsell -->
            <div style="text-align:center;margin-top:20px;padding:15px;background:rgba(255,215,0,0.05);border-radius:10px;">
                <p style="color:var(--gold);margin-bottom:10px;">ğŸ‘‘ Want AI-powered destiny analysis?</p>
                <button class="premium-unlock-btn" onclick="openPremiumCheckout()" style="padding:10px 20px;font-size:12px;">
                    Unlock Premium $20
                </button>
            </div>
        </div>

        <div class="card history-section" id="mega-history" style="display:none;">
            <h3>ğŸ“‹ History</h3>
            <div id="mega-history-list"></div>
        </div>
    </div>

</div>

<footer>
    <p style="color:var(--gold);margin-bottom:8px;">ğŸ”’ Pursuing pure scholarly research without any advertisements</p>
    <p style="font-size:0.85rem;color:var(--gray);margin-bottom:10px;">Ancient Korean Zodiac Algorithm Â· Four Pillars of Destiny</p>
    <p style="opacity:0.5;font-size:0.8rem;">Â© 2026 K-MUDANG Pro Â· Institute of Destiny Studies (å‘½ç†ç¡ç©¶æ‰€)</p>
</footer>

<div class="toast" id="toast"></div>

<script>
/* ========================================
   1. ê¸°ì´ˆ ë°ì´í„°
   ======================================== */

// Historical winning numbers
const PAST_WINNERS = [
[1,4,16,23,31,41],[10,23,29,33,37,40],[9,13,21,25,32,42],[11,16,19,21,27,31],[14,27,30,31,40,42],[16,24,29,40,41,42],
[14,15,26,27,40,42],[2,9,16,25,26,40],[8,19,25,34,37,39],[2,4,16,17,36,39],[9,25,30,33,41,44],[1,7,36,37,41,42],
[2,11,21,25,39,45],[22,34,36,37,42,44],[2,6,12,19,33,44],[1,4,9,23,34,45],[6,13,27,35,40,41],[4,14,22,38,39,45],
[6,8,14,21,23,38],[3,5,15,16,44,45],[8,13,14,26,28,43],[5,17,18,23,30,33],[4,5,7,9,24,42],[1,6,11,20,31,35],
[7,16,34,37,38,43],[4,9,12,14,24,44],[2,10,12,13,23,29],[2,14,16,18,28,43],[3,6,7,8,27,35],[1,5,23,24,35,37],
[9,14,20,23,33,34],[11,16,21,22,28,42],[8,18,21,27,29,45],[1,4,7,23,28,43],[3,13,24,29,34,40],[5,6,17,22,28,31],
[3,4,14,15,22,26],[1,4,15,25,29,30],[4,6,14,16,24,40],[5,6,11,22,25,38],[12,19,24,26,38,43],[5,13,26,28,41,42],
[4,16,17,21,31,45],[2,5,6,30,31,36],[1,9,16,19,21,25],[7,8,27,30,36,43],[4,10,14,27,29,41],[10,11,25,27,28,31],
[4,9,12,30,39,43],[4,13,22,24,40,42],[3,12,17,34,36,40],[1,13,22,25,34,41],[3,6,10,13,27,42],[3,4,18,30,32,35],
[6,9,11,17,18,25],[8,10,14,28,38,40],[2,8,16,21,27,44],[4,21,23,24,39,41],[2,3,5,8,18,29],[6,12,18,32,40,43]
];
const PAST_SET = new Set(PAST_WINNERS.map(arr => [...arr].sort((a,b)=>a-b).join(',')));

// Heavenly Stems
const STEM = [
    {c:'ç”²',k:'Wood+',e:'wood',y:true},{c:'ä¹™',k:'Wood-',e:'wood',y:false},
    {c:'ä¸™',k:'Fire+',e:'fire',y:true},{c:'ä¸',k:'Fire-',e:'fire',y:false},
    {c:'æˆŠ',k:'Earth+',e:'earth',y:true},{c:'å·±',k:'Earth-',e:'earth',y:false},
    {c:'åºš',k:'Metal+',e:'metal',y:true},{c:'è¾›',k:'Metal-',e:'metal',y:false},
    {c:'å£¬',k:'Water+',e:'water',y:true},{c:'ç™¸',k:'Water-',e:'water',y:false}
];

// Earthly Branches
const BRANCH = [
    {c:'å­',k:'Rat',e:'water',a:'Rat',m:'rat'},{c:'ä¸‘',k:'Ox',e:'earth',a:'Ox',m:'ox'},
    {c:'å¯…',k:'Tiger',e:'wood',a:'Tiger',m:'tiger'},{c:'å¯',k:'Rabbit',e:'wood',a:'Rabbit',m:'rabbit'},
    {c:'è¾°',k:'Dragon',e:'earth',a:'Dragon',m:'dragon'},{c:'å·³',k:'Snake',e:'fire',a:'Snake',m:'snake'},
    {c:'åˆ',k:'Horse',e:'fire',a:'Horse',m:'horse'},{c:'æœª',k:'Goat',e:'earth',a:'Goat',m:'goat'},
    {c:'ç”³',k:'Monkey',e:'metal',a:'Monkey',m:'monkey'},{c:'é…‰',k:'Rooster',e:'metal',a:'Rooster',m:'rooster'},
    {c:'æˆŒ',k:'Dog',e:'earth',a:'Dog',m:'dog'},{c:'äº¥',k:'Pig',e:'water',a:'Pig',m:'pig'}
];

// Hidden Stems(åœ°è—å¹²) - ä½™æ°£/ä¸­æ°£/æ­£æ°£ with days
// v4.14.1 FIX: í‘œì¤€ ì§€ì¥ê°„ ì™„ì „ ìˆ˜ì • (ì˜¤ì°¨ 0%)
// ìˆœì„œ: ä½™æ°£(ì—¬ê¸°) â†’ ä¸­æ°£(ì¤‘ê¸°) â†’ æ­£æ°£(ì •ê¸°)
const HIDDEN_STEMS = {
    0: [ // å­ (Rat) - å£¬ç™¸ ìˆ˜ê¸°
        {stem: 8, type: 'yeo', days: 10, name: 'å£¬(ä½™æ°£)'},  // Yang Water 10 days
        {stem: 9, type: 'jung', days: 20, name: 'ç™¸(æ­£æ°£)'}  // Yin Water 20 days
    ],
    1: [ // ä¸‘ (Ox) - ç™¸è¾›å·±
        {stem: 9, type: 'yeo', days: 9, name: 'ç™¸(ä½™æ°£)'},   // Yin Water 9 days
        {stem: 7, type: 'jung', days: 3, name: 'è¾›(ä¸­æ°£)'},  // Yin Metal 3 days
        {stem: 5, type: 'jung', days: 18, name: 'å·±(æ­£æ°£)'} // Yin Earth 18 days
    ],
    2: [ // å¯… (Tiger) - æˆŠä¸™ç”²
        {stem: 4, type: 'yeo', days: 7, name: 'æˆŠ(ä½™æ°£)'},   // Yang Earth 7 days
        {stem: 2, type: 'jung', days: 7, name: 'ä¸™(ä¸­æ°£)'},  // Yang Fire 7 days
        {stem: 0, type: 'jung', days: 16, name: 'ç”²(æ­£æ°£)'} // Yang Wood 16 days
    ],
    3: [ // å¯ (Rabbit) - ç”²ä¹™ ëª©ê¸°
        {stem: 0, type: 'yeo', days: 10, name: 'ç”²(ä½™æ°£)'},  // Yang Wood 10 days
        {stem: 1, type: 'jung', days: 20, name: 'ä¹™(æ­£æ°£)'} // Yin Wood 20 days
    ],
    4: [ // è¾° (Dragon) - ä¹™ç™¸æˆŠ
        {stem: 1, type: 'yeo', days: 9, name: 'ä¹™(ä½™æ°£)'},   // Yin Wood 9 days
        {stem: 9, type: 'jung', days: 3, name: 'ç™¸(ä¸­æ°£)'},  // Yin Water 3 days (æ°´æ ¹!)
        {stem: 4, type: 'jung', days: 18, name: 'æˆŠ(æ­£æ°£)'} // Yang Earth 18 days
    ],
    5: [ // å·³ (Snake) - æˆŠåºšä¸™
        {stem: 4, type: 'yeo', days: 7, name: 'æˆŠ(ä½™æ°£)'},   // Yang Earth 7 days
        {stem: 6, type: 'jung', days: 7, name: 'åºš(ä¸­æ°£)'},  // Yang Metal 7 days
        {stem: 2, type: 'jung', days: 16, name: 'ä¸™(æ­£æ°£)'} // Yang Fire 16 days
    ],
    6: [ // åˆ (Horse) - ä¸™å·±ä¸
        {stem: 2, type: 'yeo', days: 10, name: 'ä¸™(ä½™æ°£)'},  // Yang Fire 10 days
        {stem: 5, type: 'jung', days: 9, name: 'å·±(ä¸­æ°£)'},  // Yin Earth 9 days
        {stem: 3, type: 'jung', days: 11, name: 'ä¸(æ­£æ°£)'} // Yin Fire 11 days
    ],
    7: [ // æœª (Goat) - ä¸ä¹™å·±
        {stem: 3, type: 'yeo', days: 9, name: 'ä¸(ä½™æ°£)'},   // Yin Fire 9 days
        {stem: 1, type: 'jung', days: 3, name: 'ä¹™(ä¸­æ°£)'},  // Yin Wood 3 days
        {stem: 5, type: 'jung', days: 18, name: 'å·±(æ­£æ°£)'} // Yin Earth 18 days
    ],
    8: [ // ç”³ (Monkey) - æˆŠå£¬åºš
        {stem: 4, type: 'yeo', days: 7, name: 'æˆŠ(ä½™æ°£)'},   // Yang Earth 7 days
        {stem: 8, type: 'jung', days: 7, name: 'å£¬(ä¸­æ°£)'},  // Yang Water 7 days (æ°´æ ¹!)
        {stem: 6, type: 'jung', days: 16, name: 'åºš(æ­£æ°£)'} // Yang Metal 16 days
    ],
    9: [ // é…‰ (Rooster) - åºšè¾› ê¸ˆê¸°
        {stem: 6, type: 'yeo', days: 10, name: 'åºš(ä½™æ°£)'},  // Yang Metal 10 days
        {stem: 7, type: 'jung', days: 20, name: 'è¾›(æ­£æ°£)'} // Yin Metal 20 days
    ],
    10: [ // æˆŒ (Dog) - è¾›ä¸æˆŠ (NO WATER!)
        {stem: 7, type: 'yeo', days: 9, name: 'è¾›(ä½™æ°£)'},   // Yin Metal 9 days
        {stem: 3, type: 'jung', days: 3, name: 'ä¸(ä¸­æ°£)'},  // Yin Fire 3 days
        {stem: 4, type: 'jung', days: 18, name: 'æˆŠ(æ­£æ°£)'} // Yang Earth 18 days
    ],
    11: [ // äº¥ (Pig) - æˆŠç”²å£¬
        {stem: 4, type: 'yeo', days: 7, name: 'æˆŠ(ä½™æ°£)'},   // Yang Earth 7 days
        {stem: 0, type: 'jung', days: 7, name: 'ç”²(ä¸­æ°£)'},  // Yang Wood 7 days
        {stem: 8, type: 'jung', days: 16, name: 'å£¬(æ­£æ°£)'} // Yang Water 16 days
    ]
};

// Five Elements
const ELEMENT = {
    wood:{c:'æœ¨',k:'Wood',n:'æœ¨(Wood)',color:'#4CAF50',icon:'ğŸŒ³',nums:[3,8,13,18,23,28,33,38,43]},
    fire:{c:'ç«',k:'Fire',n:'ç«(Fire)',color:'#F44336',icon:'ğŸ”¥',nums:[2,7,12,17,22,27,32,37,42]},
    earth:{c:'åœŸ',k:'Earth',n:'åœŸ(Earth)',color:'#FF9800',icon:'ğŸŒ',nums:[5,10,15,20,25,30,35,40,45]},
    metal:{c:'é‡‘',k:'Metal',n:'é‡‘(Metal)',color:'#9E9E9E',icon:'âš™ï¸',nums:[4,9,14,19,24,29,34,39,44]},
    water:{c:'æ°´',k:'Water',n:'æ°´(Water)',color:'#2196F3',icon:'ğŸ’§',nums:[1,6,11,16,21,26,31,36,41]}
};
const EL_ORDER = ['wood','fire','earth','metal','water'];

// Directional Harmony (æ–¹åˆ) - ê°™ì€ ë°©í–¥ 3ì§€ì§€ê°€ ëª¨ì—¬ ê°•ë ¥í•œ ì˜¤í–‰ í˜•ì„±
const BANGHAP = [
    {branches: [2,3,4], element: 'wood', name: 'å¯…å¯è¾°(Tiger-Rabbit-Dragon) æ–¹åˆ(Directional Harmony)', dir: 'Eastern Wood Direction'},   // å¯…å¯è¾°
    {branches: [5,6,7], element: 'fire', name: 'å·³åˆæœª(Snake-Horse-Goat) æ–¹åˆ(Directional Harmony)', dir: 'Southern Fire'},   // å·³åˆæœª
    {branches: [8,9,10], element: 'metal', name: 'ç”³é…‰æˆŒ(Monkey-Rooster-Dog) æ–¹åˆ(Directional Harmony)', dir: 'Western Metal Direction'}, // ç”³é…‰æˆŒ
    {branches: [11,0,1], element: 'water', name: 'äº¥å­ä¸‘(Pig-Rat-Ox) æ–¹åˆ(Directional Harmony)', dir: 'Northern Water Direction'}  // äº¥å­ä¸‘
];

// Hidden Harmony (æš—åˆ) - Hidden Stemsë¼ë¦¬ì˜ ìˆ¨ì€ Harmony
const AMHAP = [
    {a: 2, b: 1, name: 'å¯…ä¸‘(Tiger-Ox) Hidden Harmony', desc: 'å¯…(Tiger) contains Yang Fire(ä¸™) harmonizing with ä¸‘(Ox) Yin Metal(è¾›)'},    // å¯…-ä¸‘
    {a: 3, b: 8, name: 'å¯ç”³(Rabbit-Monkey) Hidden Harmony', desc: 'å¯(Rabbit) contains Yin Wood(ä¹™) harmonizing with ç”³(Monkey) Yang Metal(åºš)'},    // å¯-ç”³
    {a: 4, b: 9, name: 'è¾°é…‰(Dragon-Rooster) Hidden Harmony', desc: 'è¾°(Dragon) contains Yin Wood(ä¹™) harmonizing with é…‰(Rooster) Yang Metal(åºš)'},    // è¾°-é…‰
    {a: 5, b: 8, name: 'å·³ç”³(Snake-Monkey) Hidden Harmony', desc: 'å·³(Snake) contains Yang Fire(ä¸™) harmonizing with ç”³(Monkey) Yang Metal(åºš)'},    // å·³-ç”³
    {a: 6, b: 1, name: 'åˆä¸‘(Horse-Ox) Hidden Harmony', desc: 'åˆ(Horse) contains Yin Fire(ä¸) harmonizing with ä¸‘(Ox) Yin Earth(å·±)'},    // åˆ-ä¸‘
    {a: 6, b: 11, name: 'åˆäº¥(Horse-Pig) Hidden Harmony', desc: 'åˆ(Horse) contains Yin Fire(ä¸) harmonizing with äº¥(Pig) Yang Water(å£¬)'}    // åˆ-äº¥
];

// Sound-Element (ç´éŸ³) - Cosmic resonance of the 60 Pillars
const NAPEUM = [
    {name: 'Sea Metal (æµ·ä¸­é‡‘)', element: 'metal', nameK: 'í•´ì¤‘ê¸ˆ', desc: 'Gold hidden beneath the ocean. A treasure waiting to be discovered within your soul.'},
    {name: 'Furnace Fire (çˆä¸­ç«)', element: 'fire', nameK: 'ë…¸ì¤‘í™”', desc: 'Flames within the forge. Your spirit transforms raw potential into refined greatness.'},
    {name: 'Forest Wood (å¤§æ—æœ¨)', element: 'wood', nameK: 'ëŒ€ë¦¼ëª©', desc: 'Towering trees of a great forest. Your presence commands respect and admiration.'},
    {name: 'Roadside Earth (è·¯å‚åœŸ)', element: 'earth', nameK: 'ë…¸ë°©í† ', desc: 'Earth along the path. You adapt gracefully wherever life takes you.'},
    {name: 'Sword Metal (åŠé‹’é‡‘)', element: 'metal', nameK: 'ê²€ë´‰ê¸ˆ', desc: 'The blade\'s edge. Sharp intuition and decisive action define your spirit.'},
    {name: 'Mountain Fire (å±±é ­ç«)', element: 'fire', nameK: 'ì‚°ë‘í™”', desc: 'Fire upon the peak. Lofty aspirations burn bright within you.'},
    {name: 'Valley Water (æ¾—ä¸‹æ°´)', element: 'water', nameK: 'ê°„í•˜ìˆ˜', desc: 'Crystal stream in the valley. Pure wisdom flows through your being.'},
    {name: 'Fortress Earth (åŸé ­åœŸ)', element: 'earth', nameK: 'ì„±ë‘í† ', desc: 'Earth of castle walls. Unwavering strength protects what you cherish.'},
    {name: 'Wax Metal (ç™½è Ÿé‡‘)', element: 'metal', nameK: 'ë°±ëê¸ˆ', desc: 'Polished precious metal. Refined elegance marks your every endeavor.'},
    {name: 'Willow Wood (æ¥ŠæŸ³æœ¨)', element: 'wood', nameK: 'ì–‘ë¥˜ëª©', desc: 'The graceful willow. Flexibility and beauty dance within your nature.'},
    {name: 'Spring Water (æ³‰ä¸­æ°´)', element: 'water', nameK: 'ì²œì¤‘ìˆ˜', desc: 'Ever-flowing spring. Boundless vitality rises from your depths.'},
    {name: 'Roof Earth (å±‹ä¸ŠåœŸ)', element: 'earth', nameK: 'ì˜¥ìƒí† ', desc: 'Earth upon the roof. You shelter and protect those you love.'},
    {name: 'Thunder Fire (éœ¹é‚ç«)', element: 'fire', nameK: 'ë²½ë ¥í™”', desc: 'Lightning\'s fire. Explosive brilliance illuminates your path.'},
    {name: 'Pine Wood (æ¾æ ¢æœ¨)', element: 'wood', nameK: 'ì†¡ë°±ëª©', desc: 'Evergreen pine. Eternal integrity through all seasons of life.'},
    {name: 'River Water (é•·æµæ°´)', element: 'water', nameK: 'ì¥ë¥˜ìˆ˜', desc: 'The long river. Your influence flows far and wide with gentle persistence.'},
    {name: 'Sand Metal (ç ‚ä¸­é‡‘)', element: 'metal', nameK: 'ì‚¬ì¤‘ê¸ˆ', desc: 'Gold within the sand. Hidden talents await their moment to shine.'},
    {name: 'Foothill Fire (å±±ä¸‹ç«)', element: 'fire', nameK: 'ì‚°í•˜í™”', desc: 'Fire at mountain\'s base. Dormant power ready to ignite.'},
    {name: 'Plain Wood (å¹³åœ°æœ¨)', element: 'wood', nameK: 'í‰ì§€ëª©', desc: 'Trees of the plains. Your influence spreads across vast horizons.'},
    {name: 'Wall Earth (å£ä¸ŠåœŸ)', element: 'earth', nameK: 'ë²½ìƒí† ', desc: 'Earth upon walls. Artistic sensibility adorns your soul.'},
    {name: 'Gilded Metal (é‡‘ç®”é‡‘)', element: 'metal', nameK: 'ê¸ˆë°•ê¸ˆ', desc: 'Precious gold leaf. Dazzling beauty with delicate grace.'},
    {name: 'Lantern Fire (è¦†ç‡ˆç«)', element: 'fire', nameK: 'ë³µë“±í™”', desc: 'Light of the lantern. Wisdom that illuminates the darkness for others.'},
    {name: 'Celestial Water (å¤©æ²³æ°´)', element: 'water', nameK: 'ì²œí•˜ìˆ˜', desc: 'Waters of the Milky Way. Cosmic dreams flow through your consciousness.'},
    {name: 'Crossroad Earth (å¤§é©›åœŸ)', element: 'earth', nameK: 'ëŒ€ì—­í† ', desc: 'Earth of the great station. Connection and exchange define your purpose.'},
    {name: 'Ornament Metal (é‡µé‡§é‡‘)', element: 'metal', nameK: 'ì°¨ì²œê¸ˆ', desc: 'Precious hairpin. Nobility and elegance grace your presence.'},
    {name: 'Mulberry Wood (æ¡‘æŸ˜æœ¨)', element: 'wood', nameK: 'ìƒìëª©', desc: 'The mulberry tree. Practical wisdom yields abundant blessings.'},
    {name: 'Canyon Water (å¤§æºªæ°´)', element: 'water', nameK: 'ëŒ€ê³„ìˆ˜', desc: 'Waters of the great canyon. Depth and breadth define your spirit.'},
    {name: 'Desert Earth (ç ‚ä¸­åœŸ)', element: 'earth', nameK: 'ì‚¬ì¤‘í† ', desc: 'Earth within sand. Patient foundation-building brings lasting success.'},
    {name: 'Heavenly Fire (å¤©ä¸Šç«)', element: 'fire', nameK: 'ì²œìƒí™”', desc: 'Fire in the heavens â€” the Sun itself. Your radiance touches all around you.'},
    {name: 'Pomegranate Wood (çŸ³æ¦´æœ¨)', element: 'wood', nameK: 'ì„ë¥˜ëª©', desc: 'The pomegranate tree. Abundant fruits of your labor await harvest.'},
    {name: 'Ocean Water (å¤§æµ·æ°´)', element: 'water', nameK: 'ëŒ€í•´ìˆ˜', desc: 'The vast ocean. Infinite capacity to embrace all of life\'s currents.'}
];

// Season
const SEASON = {0:'winter',1:'winter',2:'spring',3:'spring',4:'spring',5:'summer',6:'summer',7:'summer',8:'autumn',9:'autumn',10:'autumn',11:'winter'};

// US Month abbreviations
const MONTH_ABBR = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

// Ten Gods (åç¥) - The cosmic influences shaping your destiny
const TEN_GODS = {
    bijeon:{k:'æ¯”è‚© Peer',c:'æ¯”è‚©',e:'Peer',d:'The Alter Ego. Confidence and independence drive you. You thrive in equal partnerships.'},
    geupjae:{k:'åŠ«è²¡ Competitor',c:'åŠ«è²¡',e:'Competitor',d:'The Ambition. A fierce competitive spirit burns within. Channel this drive to conquer, not to conflict.'},
    siksin:{k:'é£Ÿç¥ Eating God',c:'é£Ÿç¥',e:'Eating God',d:'The Creator. Natural optimism and artistic talent flow through you. You are blessed with the joy of life.'},
    sanggwan:{k:'å‚·å®˜ Expressor',c:'å‚·å®˜',e:'Expressor',d:'The Innovator. You break rules to create new ones. Your sharp wit and expression are your greatest weapons.'},
    pyeonjae:{k:'åè²¡ Indirect Wealth',c:'åè²¡',e:'Indirect Wealth',d:'The Strategist. You see value where others don\'t. A risk-taker destined for dynamic wealth.'},
    jeongjae:{k:'æ­£è²¡ Direct Wealth',c:'æ­£è²¡',e:'Direct Wealth',d:'The Steward. Honest effort builds your empire. You value stability, trust, and tangible results.'},
    pyeongwan:{k:'åå®˜ Challenger',c:'åå®˜',e:'Challenger',d:'The Commander. Charisma and willpower define you. You are built to endure pressure and lead in crisis.'},
    jeonggwan:{k:'æ­£å®˜ Direct Officer',c:'æ­£å®˜',e:'Direct Officer',d:'The Guardian. Honor and principles guide your path. You shine in structured environments and leadership.'},
    pyeonin:{k:'åå° Indirect Seal',c:'åå°',e:'Indirect Seal',d:'The Philosopher. Unconventional wisdom and intuition are your guides. You see the hidden truths of the world.'},
    jeongin:{k:'æ­£å° Direct Seal',c:'æ­£å°',e:'Direct Seal',d:'The Scholar. Loved and supported by many. Wisdom and learning are your lifelong companions.'}
};

// åäºŒé‹æ˜Ÿ(Twelve Life Stages) (åäºŒé‹æ˜Ÿ) - The cycle of cosmic energy
const TWELVE_STATES = [
    {k:'é•·ç”Ÿ(Birth)',l:12,d:'New life awakens. Fresh beginnings and infinite hope bless this phase.'},
    {k:'æ²æµ´(Bath)',l:8,d:'The cleansing waters. Transformation brings temporary instability before renewal.'},
    {k:'å† å¸¶(Crown)',l:10,d:'Rising energy. Growth accelerates as opportunities unfold before you.'},
    {k:'è‡¨å®˜(Official)',l:11,d:'Peak vitality. Maximum energy propels you toward your greatest achievements.'},
    {k:'å¸æ—º(Peak)',l:12,d:'The summit. Power and status reach their zenith under heaven\'s favor.'},
    {k:'è¡°(Decline)',l:7,d:'Gentle descent. Wisdom accumulates as you embrace graceful transition.'},
    {k:'ç—…(Illness)',l:4,d:'Waning strength. Rest and reflection restore what ambition has spent.'},
    {k:'æ­»(Stillness)',l:3,d:'Completion approaches. Honor endings as you prepare for rebirth.'},
    {k:'å¢“(Storage)',l:2,d:'The hidden phase. Inner cultivation in silence precedes emergence.'},
    {k:'çµ¶(Void)',l:1,d:'Complete emptiness. From the void, new possibilities are born.'},
    {k:'èƒ(Conception)',l:5,d:'Life stirs. Seeds of future potential take root in cosmic soil.'},
    {k:'é¤Š(Nurture)',l:6,d:'Gentle growth. Patient development builds strength for the journey ahead.'}
];

// Solar Terms Data (1940-2100) - KST (Korea Standard Time, UTC+9)
// Source: Korea Astronomy and Space Science Institute (KASI) for 1940-2050
// Note: 2051-2100 data is estimated (KASI data not available)
// Index: 0=Ipchun(Feb),1=Gyeongchip(Mar),2=Cheongmyeong(Apr),3=Ipha(May),4=Mangjong(Jun),5=Soseo(Jul)
//        6=Ipchu(Aug),7=Baekro(Sep),8=Hanro(Oct),9=Ipdong(Nov),10=Daeseol(Dec),11=Sohan(Jan next year)
const SOLAR_TERMS = {
1940:[[2,5,1,8],[3,6,18,51],[4,5,23,17],[5,6,11,19],[6,6,15,30],[7,7,2,4],[8,8,11,44],[9,8,14,18],[10,9,5,53],[11,8,8,30],[12,7,1,15],[1,6,7,8]],
1941:[[2,4,6,50],[3,6,0,34],[4,5,5,3],[5,6,17,9],[6,6,21,22],[7,8,7,59],[8,8,17,40],[9,8,20,15],[10,9,11,51],[11,8,14,27],[12,7,7,12],[1,6,12,58]],
1942:[[2,4,12,34],[3,6,6,17],[4,5,10,49],[5,5,22,57],[6,6,3,11],[7,7,13,49],[8,7,23,31],[9,8,2,7],[10,8,17,43],[11,7,20,20],[12,7,13,5],[1,6,18,49]],
1943:[[2,4,18,21],[3,6,12,3],[4,5,16,36],[5,6,4,44],[6,6,8,59],[7,7,19,38],[8,8,5,21],[9,8,7,58],[10,8,23,35],[11,8,2,12],[12,7,18,57],[1,6,0,40]],
1944:[[2,5,0,23],[3,5,18,6],[4,4,22,42],[5,5,10,52],[6,5,15,9],[7,7,1,51],[8,7,11,36],[9,7,14,14],[10,8,5,51],[11,7,8,28],[12,7,1,12],[1,6,6,31]],
1945:[[2,4,6,19],[3,6,0,5],[4,5,4,41],[5,5,16,52],[6,5,21,9],[7,7,7,52],[8,7,17,38],[9,7,20,17],[10,8,11,54],[11,7,14,31],[12,7,7,14],[1,6,12,24]],
1946:[[2,4,12,3],[3,6,5,46],[4,5,10,21],[5,5,22,34],[6,6,2,53],[7,7,13,37],[8,7,23,25],[9,8,2,6],[10,8,17,44],[11,7,20,21],[12,7,13,5],[1,6,18,15]],
1947:[[2,4,17,51],[3,6,11,32],[4,5,16,6],[5,6,4,23],[6,6,8,44],[7,7,19,26],[8,8,5,16],[9,8,7,58],[10,8,23,37],[11,8,2,14],[12,7,18,58],[1,6,0,7]],
1948:[[2,4,23,42],[3,5,17,22],[4,4,21,57],[5,5,10,9],[6,5,14,30],[7,7,1,16],[8,7,11,7],[9,7,13,51],[10,8,5,29],[11,7,8,7],[12,7,0,50],[1,6,5,59]],
1949:[[2,4,5,22],[3,5,23,2],[4,5,3,35],[5,5,15,49],[6,5,20,13],[7,7,6,59],[8,7,16,53],[9,7,19,38],[10,8,11,18],[11,7,13,56],[12,7,6,39],[1,6,11,49]],
1950:[[2,4,11,3],[3,6,4,42],[4,5,9,14],[5,5,21,37],[6,6,2,2],[7,7,12,46],[8,7,22,43],[9,8,1,29],[10,8,17,9],[11,7,19,47],[12,7,12,30],[1,6,17,38]],
1951:[[2,4,16,52],[3,6,10,26],[4,5,14,59],[5,6,3,14],[6,6,7,42],[7,7,18,29],[8,8,4,26],[9,8,7,14],[10,8,22,55],[11,8,1,33],[12,7,18,16],[1,6,23,29]],
1952:[[2,4,22,53],[3,5,16,22],[4,4,20,56],[5,5,9,9],[6,5,13,35],[7,7,0,22],[8,7,10,19],[9,7,13,8],[10,8,4,48],[11,7,7,26],[12,7,0,9],[1,6,5,19]],
1953:[[2,4,4,45],[3,5,22,14],[4,5,2,48],[5,5,15,0],[6,5,19,25],[7,7,6,10],[8,7,16,7],[9,7,18,58],[10,8,10,39],[11,7,13,18],[12,7,6,1],[1,6,11,12]],
1954:[[2,4,10,30],[3,6,3,55],[4,5,8,28],[5,5,20,42],[6,6,1,10],[7,7,11,55],[8,7,21,54],[9,8,0,47],[10,8,16,29],[11,7,19,8],[12,7,11,52],[1,6,17,4]],
1955:[[2,4,16,17],[3,6,9,41],[4,5,14,15],[5,6,2,30],[6,6,6,59],[7,7,17,43],[8,8,3,44],[9,8,6,38],[10,8,22,21],[11,8,1,0],[12,7,17,44],[1,6,22,57]],
1956:[[2,4,22,12],[3,5,15,38],[4,4,20,12],[5,5,8,26],[6,5,12,54],[7,7,23,40],[8,7,9,40],[9,7,12,34],[10,8,4,16],[11,7,6,56],[12,6,23,40],[1,6,4,52]],
1957:[[2,4,3,55],[3,5,21,22],[4,5,1,57],[5,5,14,12],[6,5,18,42],[7,7,5,28],[8,7,15,28],[9,7,18,24],[10,8,10,7],[11,7,12,48],[12,7,5,33],[1,6,10,45]],
1958:[[2,4,9,48],[3,6,3,8],[4,5,7,42],[5,5,19,57],[6,6,0,27],[7,7,11,14],[8,7,21,16],[9,8,0,14],[10,8,15,58],[11,7,18,39],[12,7,11,24],[1,6,16,38]],
1959:[[2,4,15,42],[3,6,8,55],[4,5,13,28],[5,6,1,43],[6,6,6,14],[7,7,17,0],[8,8,3,2],[9,8,6,3],[10,8,21,49],[11,8,0,31],[12,7,17,16],[1,6,22,31]],
1960:[[2,4,21,42],[3,5,14,56],[4,4,19,30],[5,5,7,45],[6,5,12,16],[7,6,23,2],[8,7,8,59],[9,7,11,55],[10,8,3,37],[11,7,6,18],[12,6,23,3],[1,6,4,17]],
1961:[[2,4,3,23],[3,5,20,32],[4,5,1,6],[5,5,13,22],[6,5,17,55],[7,7,4,42],[8,7,14,41],[9,7,17,40],[10,8,9,23],[11,7,12,5],[12,7,4,51],[1,6,10,5]],
1962:[[2,4,9,18],[3,6,2,29],[4,5,6,59],[5,5,19,14],[6,5,23,46],[7,7,10,33],[8,7,20,33],[9,7,23,34],[10,8,15,18],[11,7,17,59],[12,7,10,45],[1,6,15,58]],
1963:[[2,4,15,8],[3,6,8,15],[4,5,12,44],[5,6,1,0],[6,6,5,32],[7,7,16,19],[8,8,2,21],[9,8,5,24],[10,8,21,9],[11,7,23,51],[12,7,16,37],[1,6,21,50]],
1964:[[2,4,21,5],[3,5,14,14],[4,4,18,44],[5,5,6,58],[6,5,11,28],[7,6,22,14],[8,7,8,14],[9,7,11,17],[10,8,3,2],[11,7,5,45],[12,6,22,32],[1,6,3,46]],
1965:[[2,4,2,46],[3,5,19,54],[4,5,0,27],[5,5,12,44],[6,5,17,18],[7,7,4,6],[8,7,14,6],[9,7,17,10],[10,8,8,55],[11,7,11,38],[12,7,4,25],[1,6,9,40]],
1966:[[2,4,8,38],[3,6,1,47],[4,5,6,18],[5,5,18,33],[6,5,23,6],[7,7,9,53],[8,7,19,54],[9,7,23,0],[10,8,14,46],[11,7,17,29],[12,7,10,17],[1,6,15,32]],
1967:[[2,4,14,31],[3,6,7,38],[4,5,12,8],[5,6,0,22],[6,6,4,55],[7,7,15,42],[8,8,1,44],[9,8,4,51],[10,8,20,38],[11,7,23,22],[12,7,16,11],[1,6,21,26]],
1968:[[2,4,20,27],[3,5,13,35],[4,4,18,4],[5,5,6,16],[6,5,10,47],[7,6,21,33],[8,7,7,34],[9,7,10,41],[10,8,2,29],[11,7,5,14],[12,6,22,3],[1,6,3,19]],
1969:[[2,4,2,8],[3,5,19,17],[4,4,23,47],[5,5,12,2],[6,5,16,36],[7,7,3,24],[8,7,13,27],[9,7,16,35],[10,8,8,23],[11,7,11,8],[12,7,3,56],[1,6,9,11]],
1970:[[2,4,7,46],[3,6,0,55],[4,5,5,26],[5,5,17,45],[6,5,22,21],[7,7,9,11],[8,7,19,16],[9,7,22,27],[10,8,14,16],[11,7,17,1],[12,7,9,50],[1,6,15,5]],
1971:[[2,4,13,26],[3,6,6,36],[4,5,11,9],[5,5,23,29],[6,6,4,6],[7,7,14,56],[8,8,1,2],[9,8,4,15],[10,8,20,5],[11,7,22,51],[12,7,15,40],[1,6,20,56]],
1972:[[2,4,19,20],[3,5,12,29],[4,4,17,0],[5,5,5,13],[6,5,9,48],[7,6,20,37],[8,7,6,42],[9,7,10,0],[10,8,1,50],[11,7,4,38],[12,6,21,28],[1,6,2,45]],
1973:[[2,4,1,4],[3,5,18,13],[4,4,22,44],[5,5,11,0],[6,5,15,39],[7,7,2,30],[8,7,12,36],[9,7,15,52],[10,8,7,42],[11,7,10,28],[12,7,3,18],[1,6,8,35]],
1974:[[2,4,6,59],[3,6,0,7],[4,5,4,36],[5,5,16,52],[6,5,21,29],[7,7,8,19],[8,7,18,26],[9,7,21,45],[10,8,13,36],[11,7,16,23],[12,7,9,13],[1,6,14,29]],
1975:[[2,4,12,59],[3,6,6,3],[4,5,10,30],[5,5,22,44],[6,6,3,19],[7,7,14,8],[8,8,0,14],[9,8,3,35],[10,8,19,27],[11,7,22,15],[12,7,15,6],[1,6,20,24]],
1976:[[2,4,18,40],[3,5,11,48],[4,4,16,17],[5,5,4,30],[6,5,9,6],[7,6,19,56],[8,7,6,2],[9,7,9,24],[10,8,1,16],[11,7,4,5],[12,6,20,56],[1,6,2,14]],
1977:[[2,4,0,34],[3,5,17,41],[4,4,22,10],[5,5,10,24],[6,5,15,1],[7,7,1,51],[8,7,11,58],[9,7,15,20],[10,8,7,11],[11,7,10,0],[12,7,2,51],[1,6,8,9]],
1978:[[2,4,6,27],[3,5,23,34],[4,5,4,4],[5,5,16,19],[6,5,20,56],[7,7,7,46],[8,7,17,53],[9,7,21,16],[10,8,13,7],[11,7,15,56],[12,7,8,47],[1,6,14,5]],
1979:[[2,4,12,13],[3,6,5,21],[4,5,9,50],[5,5,22,6],[6,6,2,43],[7,7,13,33],[8,7,23,42],[9,8,3,7],[10,8,18,59],[11,7,21,49],[12,7,14,40],[1,6,19,59]],
1980:[[2,4,18,10],[3,5,11,18],[4,4,15,47],[5,5,3,59],[6,5,8,35],[7,6,19,24],[8,7,5,31],[9,7,8,55],[10,8,0,47],[11,7,3,38],[12,6,20,30],[1,6,1,50]],
1981:[[2,3,23,56],[3,5,17,3],[4,4,21,33],[5,5,9,48],[6,5,14,26],[7,7,1,16],[8,7,11,25],[9,7,14,50],[10,8,6,42],[11,7,9,32],[12,7,2,23],[1,6,7,43]],
1982:[[2,4,5,46],[3,5,22,55],[4,5,3,25],[5,5,15,41],[6,5,20,18],[7,7,7,8],[8,7,17,17],[9,7,20,42],[10,8,12,34],[11,7,15,25],[12,7,8,17],[1,6,13,37]],
1983:[[2,4,11,40],[3,6,4,48],[4,5,9,18],[5,5,21,32],[6,6,2,8],[7,7,12,58],[8,7,23,7],[9,8,2,33],[10,8,18,26],[11,7,21,18],[12,7,14,10],[1,6,19,30]],
1984:[[2,4,17,19],[3,5,10,27],[4,4,14,56],[5,5,3,10],[6,5,7,48],[7,6,18,39],[8,7,4,49],[9,7,8,17],[10,8,0,11],[11,7,3,4],[12,6,19,57],[1,6,1,18]],
1985:[[2,3,23,12],[3,5,16,21],[4,4,20,51],[5,5,9,5],[6,5,13,43],[7,7,0,34],[8,7,10,44],[9,7,14,12],[10,8,6,5],[11,7,8,58],[12,7,1,50],[1,6,7,12]],
1986:[[2,4,5,8],[3,5,22,17],[4,5,2,46],[5,5,14,59],[6,5,19,35],[7,7,6,24],[8,7,16,33],[9,7,20,2],[10,8,11,55],[11,7,14,48],[12,7,7,41],[1,6,13,1]],
1987:[[2,4,10,52],[3,6,4,1],[4,5,8,31],[5,5,20,47],[6,6,1,25],[7,7,12,15],[8,7,22,24],[9,8,1,52],[10,8,17,44],[11,7,20,37],[12,7,13,29],[1,6,18,49]],
1988:[[2,4,16,43],[3,5,9,51],[4,4,14,19],[5,5,2,32],[6,5,7,9],[7,6,17,59],[8,7,4,9],[9,7,7,38],[10,7,23,32],[11,7,2,26],[12,6,19,18],[1,6,0,40]],
1989:[[2,3,22,27],[3,5,15,36],[4,4,20,6],[5,5,8,21],[6,5,12,59],[7,6,23,50],[8,7,10,0],[9,7,13,30],[10,8,5,23],[11,7,8,17],[12,7,1,10],[1,6,6,32]],
1990:[[2,4,4,14],[3,5,21,23],[4,5,1,53],[5,5,14,8],[6,5,18,46],[7,7,5,36],[8,7,15,46],[9,7,19,17],[10,8,11,10],[11,7,14,5],[12,7,6,57],[1,6,12,19]],
1991:[[2,4,10,8],[3,6,3,17],[4,5,7,47],[5,5,20,1],[6,6,0,38],[7,7,11,27],[8,7,21,37],[9,8,1,7],[10,8,17,0],[11,7,19,54],[12,7,12,47],[1,6,18,9]],
1992:[[2,4,15,48],[3,5,9,0],[4,4,13,30],[5,5,1,46],[6,5,6,25],[7,6,17,16],[8,7,3,27],[9,7,6,58],[10,7,22,52],[11,7,1,47],[12,6,18,40],[1,5,23,59]],
1993:[[2,3,21,37],[3,5,14,47],[4,4,19,18],[5,5,7,34],[6,5,12,12],[7,6,23,4],[8,7,9,15],[9,7,12,48],[10,8,4,41],[11,7,7,37],[12,7,0,30],[1,6,5,52]],
1994:[[2,4,3,31],[3,5,20,41],[4,5,1,11],[5,5,13,26],[6,5,18,3],[7,7,4,53],[8,7,15,3],[9,7,18,36],[10,8,10,30],[11,7,13,25],[12,7,6,18],[1,6,11,40]],
1995:[[2,4,9,13],[3,6,2,24],[4,5,6,55],[5,5,19,13],[6,5,23,52],[7,7,10,43],[8,7,20,54],[9,8,0,27],[10,8,16,19],[11,7,19,14],[12,7,12,6],[1,6,17,27]],
1996:[[2,4,14,8],[3,5,8,20],[4,4,12,51],[5,5,1,7],[6,5,5,47],[7,6,16,38],[8,7,2,49],[9,7,6,23],[10,7,22,17],[11,7,1,13],[12,6,18,6],[1,5,23,26]],
1997:[[2,4,2,4],[3,5,20,15],[4,5,0,47],[5,5,13,4],[6,5,17,43],[7,7,4,34],[8,7,14,45],[9,7,18,20],[10,8,10,14],[11,7,13,11],[12,7,6,4],[1,6,11,26]],
1998:[[2,4,7,57],[3,6,1,8],[4,5,5,40],[5,5,17,58],[6,5,22,37],[7,7,9,28],[8,7,19,40],[9,7,23,15],[10,8,15,9],[11,7,18,6],[12,7,10,58],[1,6,16,20]],
1999:[[2,4,13,57],[3,6,7,8],[4,5,11,39],[5,5,23,54],[6,6,4,31],[7,7,15,21],[8,8,1,32],[9,8,5,6],[10,8,20,59],[11,7,23,56],[12,7,16,48],[1,6,22,9]],
2000:[[2,4,19,40],[3,5,12,53],[4,4,17,25],[5,5,5,42],[6,5,10,22],[7,6,21,13],[8,7,7,25],[9,7,11,1],[10,8,2,55],[11,7,5,52],[12,6,22,44],[1,6,4,4]],
2001:[[2,4,1,29],[3,5,18,41],[4,4,23,14],[5,5,11,33],[6,5,16,13],[7,7,3,5],[8,7,13,18],[9,7,16,55],[10,8,8,48],[11,7,11,45],[12,7,4,37],[1,6,9,57]],
2002:[[2,4,7,24],[3,6,0,35],[4,5,5,6],[5,5,17,24],[6,5,22,3],[7,7,8,53],[8,7,19,7],[9,7,22,44],[10,8,14,37],[11,7,17,35],[12,7,10,27],[1,6,15,47]],
2003:[[2,4,13,5],[3,6,6,17],[4,5,10,50],[5,5,23,10],[6,6,3,50],[7,7,14,41],[8,8,0,55],[9,8,4,34],[10,8,20,27],[11,7,23,26],[12,7,16,18],[1,6,21,38]],
2004:[[2,4,18,56],[3,5,12,9],[4,4,16,43],[5,5,5,2],[6,5,9,43],[7,6,20,35],[8,7,6,49],[9,7,10,28],[10,8,2,22],[11,7,5,20],[12,6,22,11],[1,6,3,30]],
2005:[[2,4,0,43],[3,5,17,55],[4,4,22,29],[5,5,10,49],[6,5,15,32],[7,7,2,24],[8,7,12,40],[9,7,16,21],[10,8,8,14],[11,7,11,13],[12,7,4,4],[1,6,9,24]],
2006:[[2,4,6,27],[3,5,23,39],[4,5,4,15],[5,5,16,38],[6,5,21,21],[7,7,8,14],[8,7,18,32],[9,7,22,15],[10,8,14,8],[11,7,17,7],[12,7,9,58],[1,6,15,17]],
2007:[[2,4,12,18],[3,6,5,31],[4,5,10,6],[5,5,22,27],[6,6,3,10],[7,7,14,2],[8,8,0,21],[9,8,4,5],[10,8,19,58],[11,7,22,59],[12,7,15,50],[1,6,21,9]],
2008:[[2,4,18,0],[3,5,11,16],[4,4,15,53],[5,5,4,17],[6,5,9,0],[7,6,19,54],[8,7,6,13],[9,7,9,59],[10,8,1,52],[11,7,4,52],[12,6,21,42],[1,6,2,59]],
2009:[[2,3,23,50],[3,5,17,4],[4,4,21,43],[5,5,10,9],[6,5,14,54],[7,7,1,48],[8,7,12,8],[9,7,15,57],[10,8,7,50],[11,7,10,50],[12,7,3,40],[1,6,8,57]],
2010:[[2,4,5,42],[3,5,23,0],[4,5,3,41],[5,5,16,5],[6,5,20,51],[7,7,7,45],[8,7,17,59],[9,7,21,44],[10,8,13,36],[11,7,16,33],[12,7,9,22],[1,6,14,40]],
2011:[[2,4,11,33],[3,6,4,46],[4,5,9,23],[5,5,21,45],[6,6,2,33],[7,7,13,26],[8,7,23,47],[9,8,3,36],[10,8,19,29],[11,7,22,29],[12,7,15,18],[1,6,20,36]],
2012:[[2,4,17,22],[3,5,10,38],[4,4,15,18],[5,5,3,42],[6,5,8,30],[7,6,19,25],[8,7,5,46],[9,7,9,37],[10,8,1,30],[11,7,4,29],[12,6,21,17],[1,6,2,33]],
2013:[[2,3,23,13],[3,5,16,28],[4,4,21,10],[5,5,9,37],[6,5,14,27],[7,7,1,23],[8,7,11,45],[9,7,15,37],[10,8,7,30],[11,7,10,29],[12,7,3,17],[1,6,8,33]],
2014:[[2,4,5,3],[3,5,22,21],[4,5,2,59],[5,5,15,24],[6,5,20,14],[7,7,7,10],[8,7,17,32],[9,7,21,25],[10,8,13,18],[11,7,16,17],[12,7,9,5],[1,6,14,21]],
2015:[[2,4,10,58],[3,6,4,15],[4,5,8,55],[5,5,21,19],[6,6,2,9],[7,7,13,4],[8,7,23,26],[9,8,3,21],[10,8,19,13],[11,7,22,12],[12,7,15,0],[1,6,20,16]],
2016:[[2,4,16,46],[3,5,10,2],[4,4,14,42],[5,5,3,7],[6,5,7,57],[7,6,18,52],[8,7,5,15],[9,7,9,11],[10,8,1,4],[11,7,4,4],[12,6,20,51],[1,6,2,5]],
2017:[[2,3,22,34],[3,5,15,51],[4,4,20,32],[5,5,9,0],[6,5,13,50],[7,7,0,46],[8,7,11,9],[9,7,15,6],[10,8,6,58],[11,7,9,59],[12,7,2,46],[1,6,8,0]],
2018:[[2,4,4,28],[3,5,21,45],[4,5,2,26],[5,5,14,51],[6,5,19,42],[7,7,6,37],[8,7,16,59],[9,7,20,56],[10,8,12,49],[11,7,15,50],[12,7,8,38],[1,6,13,52]],
2019:[[2,4,10,14],[3,6,3,29],[4,5,8,9],[5,5,20,35],[6,6,1,26],[7,7,12,21],[8,7,22,45],[9,8,2,44],[10,8,18,37],[11,7,21,39],[12,7,14,26],[1,6,19,39]],
2020:[[2,4,16,3],[3,5,9,19],[4,4,13,59],[5,5,2,26],[6,5,7,18],[7,6,18,14],[8,7,4,37],[9,7,8,38],[10,8,0,31],[11,7,3,32],[12,6,20,19],[1,6,1,31]],
2021:[[2,3,21,58],[3,5,15,17],[4,4,19,59],[5,5,8,25],[6,5,13,14],[7,7,0,8],[8,7,10,30],[9,7,14,30],[10,8,6,23],[11,7,9,25],[12,7,2,13],[1,6,7,25]],
2022:[[2,4,3,50],[3,5,21,9],[4,5,1,50],[5,5,14,17],[6,5,19,6],[7,7,5,58],[8,7,16,20],[9,7,20,21],[10,8,12,15],[11,7,15,17],[12,7,8,5],[1,6,13,18]],
2023:[[2,4,9,42],[3,6,2,59],[4,5,7,38],[5,5,20,5],[6,6,0,55],[7,7,11,49],[8,7,22,11],[9,8,2,13],[10,8,18,6],[11,7,21,9],[12,7,13,57],[1,6,19,9]],
2024:[[2,4,15,27],[3,5,8,43],[4,4,13,23],[5,5,1,51],[6,5,6,42],[7,6,17,38],[8,7,4,1],[9,7,8,6],[10,7,23,59],[11,7,2,59],[12,6,19,46],[1,6,0,56]],
2025:[[2,3,21,10],[3,5,14,26],[4,4,19,6],[5,5,7,36],[6,5,12,28],[7,6,23,23],[8,7,9,46],[9,7,13,51],[10,8,5,44],[11,7,8,46],[12,7,1,33],[1,6,6,44]],
2026:[[2,4,3,2],[3,5,20,19],[4,5,0,58],[5,5,13,24],[6,5,18,14],[7,7,5,7],[8,7,15,29],[9,7,19,35],[10,8,11,28],[11,7,14,31],[12,7,7,19],[1,6,12,31]],
2027:[[2,4,8,46],[3,6,2,2],[4,5,6,42],[5,5,19,10],[6,6,0,0],[7,7,10,54],[8,7,21,18],[9,8,1,26],[10,8,17,19],[11,7,20,22],[12,7,13,10],[1,6,18,22]],
2028:[[2,4,14,31],[3,5,7,47],[4,4,12,27],[5,5,0,55],[6,5,5,46],[7,6,16,41],[8,7,3,5],[9,7,7,14],[10,7,23,8],[11,7,2,12],[12,6,19,0],[1,6,0,12]],
2029:[[2,3,20,20],[3,5,13,37],[4,4,18,17],[5,5,6,45],[6,5,11,36],[7,6,22,31],[8,7,8,56],[9,7,13,5],[10,8,4,58],[11,7,8,1],[12,7,0,48],[1,6,6,0]],
2030:[[2,4,2,8],[3,5,19,24],[4,5,0,3],[5,5,12,31],[6,5,17,21],[7,7,4,14],[8,7,14,38],[9,7,18,48],[10,8,10,42],[11,7,13,46],[12,7,6,35],[1,6,11,47]],
2031:[[2,4,7,58],[3,6,1,14],[4,5,5,52],[5,5,18,19],[6,5,23,9],[7,7,10,2],[8,7,20,26],[9,8,0,37],[10,8,16,31],[11,7,19,36],[12,7,12,25],[1,6,17,38]],
2032:[[2,4,13,48],[3,5,7,4],[4,4,11,42],[5,5,0,8],[6,5,4,58],[7,6,15,51],[8,7,2,15],[9,7,6,27],[10,7,22,21],[11,7,1,27],[12,6,18,16],[1,5,23,29]],
2033:[[2,3,19,33],[3,5,12,49],[4,4,17,26],[5,5,5,54],[6,5,10,45],[7,6,21,38],[8,7,8,3],[9,7,12,17],[10,8,4,11],[11,7,7,17],[12,7,0,6],[1,6,5,20]],
2034:[[2,4,1,27],[3,5,18,43],[4,4,23,21],[5,5,11,48],[6,5,16,37],[7,7,3,29],[8,7,13,53],[9,7,18,6],[10,8,10,0],[11,7,13,7],[12,7,5,57],[1,6,11,11]],
2035:[[2,4,7,15],[3,6,0,31],[4,5,5,9],[5,5,17,37],[6,5,22,27],[7,7,9,19],[8,7,19,44],[9,7,23,58],[10,8,15,53],[11,7,18,59],[12,7,11,49],[1,6,17,3]],
2040:[[2,4,12,18],[3,5,5,34],[4,4,10,12],[5,4,22,39],[6,5,3,29],[7,6,14,22],[8,7,0,48],[9,7,5,5],[10,7,21,0],[11,7,0,9],[12,6,17,0],[1,5,22,16]],
2050:[[2,4,0,32],[3,5,17,49],[4,4,22,26],[5,5,10,53],[6,5,15,42],[7,7,2,34],[8,7,12,58],[9,7,17,12],[10,8,9,5],[11,7,12,11],[12,7,5,1],[1,6,10,15]],
2051:[[2,3,23,3],[3,5,15,58],[4,4,20,24],[5,5,8,35],[6,5,13,13],[7,7,0,7],[8,7,10,22],[9,7,14,17],[10,8,6,7],[11,7,9,6],[12,7,1,52],[1,6,7,24]],
2052:[[2,4,4,48],[3,4,21,43],[4,4,2,11],[5,4,14,22],[6,4,19,0],[7,6,5,54],[8,6,16,9],[9,6,20,5],[10,8,11,55],[11,6,14,54],[12,6,7,40],[1,5,13,13]],
2053:[[2,3,10,38],[3,5,3,33],[4,4,7,59],[5,4,20,9],[6,5,0,47],[7,6,11,41],[8,6,21,57],[9,7,1,54],[10,7,17,44],[11,6,20,44],[12,6,13,30],[1,5,19,4]],
2054:[[2,3,16,27],[3,5,9,21],[4,4,13,47],[5,5,1,57],[6,5,6,35],[7,6,17,29],[8,7,3,44],[9,7,7,42],[10,7,23,33],[11,7,2,33],[12,6,19,20],[1,6,0,54]],
2055:[[2,3,22,15],[3,5,15,8],[4,4,19,33],[5,5,7,43],[6,5,12,21],[7,6,23,15],[8,7,9,31],[9,7,13,30],[10,8,5,21],[11,7,8,22],[12,7,1,9],[1,6,6,44]],
2056:[[2,4,4,1],[3,4,20,54],[4,4,1,20],[5,4,13,30],[6,4,18,8],[7,6,5,2],[8,6,15,18],[9,6,19,17],[10,8,11,8],[11,6,14,9],[12,6,6,56],[1,5,12,32]],
2057:[[2,3,9,51],[3,5,2,44],[4,4,7,9],[5,4,19,18],[6,5,23,55],[7,6,10,49],[8,6,21,5],[9,7,1,4],[10,7,16,55],[11,6,19,57],[12,6,12,45],[1,5,18,21]],
2058:[[2,3,15,39],[3,5,8,31],[4,4,12,55],[5,5,1,4],[6,5,5,41],[7,6,16,35],[8,7,2,52],[9,7,6,52],[10,7,22,44],[11,7,1,47],[12,6,18,35],[1,6,0,12]],
2059:[[2,3,21,27],[3,5,14,18],[4,4,18,42],[5,5,6,51],[6,5,11,28],[7,6,22,22],[8,7,8,39],[9,7,12,40],[10,8,4,32],[11,7,7,36],[12,7,0,25],[1,6,6,2]],
2060:[[2,4,3,13],[3,4,20,5],[4,4,0,29],[5,4,12,37],[6,4,17,14],[7,6,4,8],[8,6,14,25],[9,6,18,26],[10,8,10,18],[11,6,13,22],[12,6,6,11],[1,5,11,49]],
2061:[[2,3,9,2],[3,5,1,53],[4,4,6,17],[5,4,18,24],[6,4,23,0],[7,6,9,53],[8,6,20,10],[9,7,0,12],[10,7,16,4],[11,6,19,9],[12,6,11,59],[1,5,17,38]],
2062:[[2,3,14,50],[3,5,7,40],[4,4,12,3],[5,5,0,11],[6,5,4,47],[7,6,15,40],[8,7,1,57],[9,7,6,0],[10,7,21,53],[11,7,0,58],[12,6,17,48],[1,5,23,28]],
2063:[[2,3,20,37],[3,5,13,27],[4,4,17,49],[5,5,5,57],[6,5,10,33],[7,6,21,26],[8,7,7,44],[9,7,11,48],[10,8,3,41],[11,7,6,48],[12,6,23,38],[1,6,5,18]],
2064:[[2,4,2,23],[3,4,19,13],[4,3,23,35],[5,4,11,43],[6,4,16,19],[7,6,3,13],[8,6,13,30],[9,6,17,34],[10,8,9,26],[11,6,12,33],[12,6,5,24],[1,5,11,5]],
2065:[[2,3,8,12],[3,5,1,1],[4,4,5,23],[5,4,17,30],[6,4,22,5],[7,6,8,58],[8,6,19,15],[9,6,23,20],[10,7,15,13],[11,6,18,21],[12,6,11,12],[1,5,16,54]],
2066:[[2,3,14,0],[3,5,6,48],[4,4,11,10],[5,4,23,17],[6,5,3,52],[7,6,14,45],[8,7,1,2],[9,7,5,8],[10,7,21,2],[11,7,0,11],[12,6,17,2],[1,5,22,44]],
2067:[[2,3,19,47],[3,5,12,35],[4,4,16,56],[5,5,5,3],[6,5,9,38],[7,6,20,31],[8,7,6,49],[9,7,10,56],[10,8,2,50],[11,7,6,0],[12,6,22,52],[1,6,4,34]],
2068:[[2,4,1,32],[3,4,18,21],[4,3,22,42],[5,4,10,48],[6,4,15,23],[7,6,2,16],[8,6,12,33],[9,6,16,40],[10,8,8,33],[11,6,11,43],[12,6,4,35],[1,5,10,19]],
2069:[[2,3,7,21],[3,5,0,8],[4,4,4,29],[5,4,16,35],[6,4,21,9],[7,6,8,2],[8,6,18,19],[9,6,22,26],[10,7,14,20],[11,6,17,30],[12,6,10,22],[1,5,16,7]],
2070:[[2,3,13,8],[3,5,5,55],[4,4,10,15],[5,4,22,21],[6,5,2,55],[7,6,13,48],[8,7,0,5],[9,7,4,14],[10,7,20,9],[11,6,23,20],[12,6,16,13],[1,5,21,57]],
2071:[[2,3,18,55],[3,5,11,41],[4,4,16,1],[5,5,4,7],[6,5,8,41],[7,6,19,34],[8,7,5,52],[9,7,10,2],[10,8,1,57],[11,7,5,10],[12,6,22,2],[1,6,3,47]],
2072:[[2,4,0,40],[3,4,17,27],[4,3,21,47],[5,4,9,53],[6,4,14,27],[7,6,1,20],[8,6,11,37],[9,6,15,47],[10,8,7,42],[11,6,10,54],[12,6,3,47],[1,5,9,33]],
2073:[[2,3,6,29],[3,4,23,15],[4,4,3,34],[5,4,15,40],[6,4,20,13],[7,6,7,6],[8,6,17,23],[9,6,21,33],[10,7,13,28],[11,6,16,40],[12,6,9,34],[1,5,15,20]],
2074:[[2,3,12,16],[3,5,5,2],[4,4,9,21],[5,4,21,26],[6,5,1,59],[7,6,12,52],[8,6,23,9],[9,7,3,20],[10,7,19,16],[11,6,22,29],[12,6,15,22],[1,5,21,9]],
2075:[[2,3,18,3],[3,5,10,48],[4,4,15,7],[5,5,3,12],[6,5,7,45],[7,6,18,38],[8,7,4,56],[9,7,9,8],[10,8,1,4],[11,7,4,19],[12,6,21,12],[1,6,2,59]],
2076:[[2,3,23,49],[3,4,16,34],[4,3,20,52],[5,4,8,58],[6,4,13,31],[7,6,0,24],[8,6,10,41],[9,6,14,53],[10,8,6,49],[11,6,10,3],[12,6,2,57],[1,5,8,46]],
2077:[[2,3,5,37],[3,4,22,22],[4,4,2,40],[5,4,14,45],[6,4,19,17],[7,6,6,10],[8,6,16,27],[9,6,20,39],[10,7,12,35],[11,6,15,50],[12,6,8,44],[1,5,14,34]],
2078:[[2,3,11,25],[3,5,4,9],[4,4,8,26],[5,4,20,31],[6,5,1,3],[7,6,11,55],[8,6,22,13],[9,7,2,26],[10,7,18,23],[11,6,21,39],[12,6,14,34],[1,5,20,23]],
2079:[[2,3,17,12],[3,5,9,56],[4,4,14,13],[5,5,2,17],[6,5,6,49],[7,6,17,42],[8,7,3,59],[9,7,8,13],[10,8,0,10],[11,7,3,28],[12,6,20,22],[1,6,2,12]],
2080:[[2,3,22,58],[3,4,15,42],[4,3,19,58],[5,4,8,3],[6,4,12,35],[7,5,23,28],[8,6,9,45],[9,6,13,59],[10,8,5,55],[11,6,9,12],[12,6,2,7],[1,5,7,58]],
2081:[[2,3,4,46],[3,4,21,30],[4,4,1,46],[5,4,13,50],[6,4,18,22],[7,6,5,15],[8,6,15,32],[9,6,19,45],[10,7,11,42],[11,6,14,58],[12,6,7,54],[1,5,13,46]],
2082:[[2,3,10,34],[3,5,3,17],[4,4,7,33],[5,4,19,37],[6,5,0,8],[7,6,11,1],[8,6,21,18],[9,7,1,32],[10,7,17,30],[11,6,20,47],[12,6,13,43],[1,5,19,35]],
2083:[[2,3,16,21],[3,5,9,3],[4,4,13,19],[5,5,1,23],[6,5,5,54],[7,6,16,47],[8,7,3,5],[9,7,7,20],[10,7,23,18],[11,7,2,37],[12,6,19,33],[1,6,1,25]],
2084:[[2,3,22,7],[3,4,14,50],[4,3,19,5],[5,4,7,9],[6,4,11,40],[7,5,22,33],[8,6,8,50],[9,6,13,5],[10,8,5,3],[11,6,8,22],[12,6,1,18],[1,5,7,11]],
2085:[[2,3,3,55],[3,4,20,38],[4,4,0,53],[5,4,12,56],[6,4,17,26],[7,6,4,19],[8,6,14,36],[9,6,18,51],[10,7,10,49],[11,6,14,8],[12,6,7,4],[1,5,12,59]],
2086:[[2,3,9,43],[3,5,2,25],[4,4,6,40],[5,4,18,43],[6,4,23,13],[7,6,10,5],[8,6,20,22],[9,7,0,37],[10,7,16,36],[11,6,19,56],[12,6,12,53],[1,5,18,48]],
2087:[[2,3,15,30],[3,5,8,11],[4,4,12,26],[5,5,0,29],[6,5,4,59],[7,6,15,51],[8,7,2,9],[9,7,6,25],[10,7,22,24],[11,7,1,45],[12,6,18,42],[1,6,0,37]],
2088:[[2,3,21,16],[3,4,13,58],[4,3,18,12],[5,4,6,15],[6,4,10,45],[7,5,21,38],[8,6,7,55],[9,6,12,10],[10,8,4,9],[11,6,7,29],[12,6,0,26],[1,5,6,22]],
2089:[[2,3,3,4],[3,4,19,46],[4,4,0,0],[5,4,12,3],[6,4,16,32],[7,6,3,24],[8,6,13,41],[9,6,17,57],[10,7,9,56],[11,6,13,17],[12,6,6,14],[1,5,12,10]],
2090:[[2,3,8,52],[3,5,1,33],[4,4,5,46],[5,4,17,49],[6,4,22,18],[7,6,9,11],[8,6,19,28],[9,6,23,44],[10,7,15,43],[11,6,19,5],[12,6,12,3],[1,5,17,59]],
2091:[[2,3,14,39],[3,5,7,20],[4,4,11,34],[5,4,23,36],[6,5,4,5],[7,6,14,57],[8,7,1,14],[9,7,5,31],[10,7,21,31],[11,7,0,54],[12,6,17,52],[1,5,23,48]],
2092:[[2,3,20,25],[3,4,13,6],[4,3,17,19],[5,4,5,22],[6,4,9,51],[7,5,20,43],[8,6,7,0],[9,6,11,17],[10,8,3,16],[11,6,6,38],[12,5,23,36],[1,5,5,34]],
2093:[[2,3,2,13],[3,4,18,54],[4,3,23,7],[5,4,11,10],[6,4,15,38],[7,6,2,30],[8,6,12,47],[9,6,17,3],[10,7,9,3],[11,6,12,25],[12,6,5,23],[1,5,11,21]],
2094:[[2,3,8,1],[3,5,0,41],[4,4,4,53],[5,4,16,56],[6,4,21,24],[7,6,8,16],[8,6,18,33],[9,6,22,50],[10,7,14,50],[11,6,18,14],[12,6,11,12],[1,5,17,10]],
2095:[[2,3,13,48],[3,5,6,28],[4,4,10,40],[5,4,22,42],[6,5,3,10],[7,6,14,2],[8,7,0,19],[9,7,4,37],[10,7,20,38],[11,7,0,3],[12,6,17,1],[1,5,23,0]],
2096:[[2,3,19,34],[3,4,12,14],[4,3,16,26],[5,4,4,29],[6,4,8,57],[7,5,19,49],[8,6,6,5],[9,6,10,23],[10,8,2,23],[11,6,5,46],[12,5,22,45],[1,5,4,45]],
2097:[[2,3,1,23],[3,4,18,2],[4,3,22,14],[5,4,10,16],[6,4,14,43],[7,6,1,35],[8,6,11,52],[9,6,16,9],[10,7,8,9],[11,6,11,33],[12,6,4,32],[1,5,10,32]],
2098:[[2,3,7,10],[3,4,23,49],[4,4,4,1],[5,4,16,3],[6,4,20,30],[7,6,7,22],[8,6,17,39],[9,6,21,56],[10,7,13,57],[11,6,17,22],[12,6,10,21],[1,5,16,21]],
2099:[[2,3,12,57],[3,5,5,36],[4,4,9,47],[5,4,21,49],[6,5,2,16],[7,6,13,8],[8,6,23,25],[9,7,3,43],[10,7,19,44],[11,6,23,10],[12,6,16,9],[1,5,22,10]],
2100:[[2,3,18,44],[3,5,11,23],[4,4,15,34],[5,5,3,36],[6,5,8,3],[7,6,18,55],[8,7,5,11],[9,7,9,30],[10,8,1,31],[11,7,4,58],[12,6,21,57],[1,6,3,58]]
};

// Lunar calendar data (1900-2100) - hex encoded
const LUNAR_DATA=[
// 1900-1909
0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2,
// 1910-1919
0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977,
// 1920-1929
0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,
// 1930-1939
0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,
// 1940-1949
0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557,
// 1950-1959
0x06ca0,0x0b550,0x15355,0x04da0,0x0a5d0,0x14573,0x052d0,0x0a9a8,0x0e950,0x06aa0,
// 1960-1969
0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,0x05b57,0x056a0,
// 1970-1979
0x096d0,0x04dd5,0x04ad0,0x0a4d0,0x0d4d4,0x0d250,0x0d558,0x0b540,0x0b5a0,0x195a6,
// 1980-1989
0x095b0,0x049b0,0x0a974,0x0a4b0,0x0b27a,0x06a50,0x06d40,0x0af46,0x0ab60,0x09570,
// 1990-1999
0x04af5,0x04970,0x064b0,0x074a3,0x0ea50,0x06b58,0x055c0,0x0ab60,0x096d5,0x092e0,
// 2000-2009
0x0c960,0x0d954,0x0d4a0,0x0da50,0x07552,0x056a0,0x0abb7,0x025d0,0x092d0,0x0cab5,
// 2010-2019
0x0a950,0x0b4a0,0x0baa4,0x0ad50,0x055d9,0x04ba0,0x0a5b0,0x15176,0x052b0,0x0a930,
// 2020-2029
0x07954,0x06aa0,0x0ad50,0x05b52,0x04b60,0x0a6e6,0x0a4e0,0x0d260,0x0ea65,0x0d530,
// 2030-2039
0x05aa0,0x076a3,0x096d0,0x04bd7,0x04ad0,0x0a4d0,0x1d0b6,0x0d250,0x0d520,0x0dd45,
// 2040-2049
0x0b5a0,0x056d0,0x055b2,0x049b0,0x0a577,0x0a4b0,0x0aa50,0x1b255,0x06d20,0x0ada0,
// 2050-2059
0x14b63,0x09370,0x049f8,0x04970,0x064b0,0x168a6,0x0ea50,0x06b20,0x1a6c4,0x0aae0,
// 2060-2069
0x092e0,0x0d2e3,0x0c960,0x0d557,0x0d4a0,0x0da50,0x05d55,0x056a0,0x0a6d0,0x055d4,
// 2070-2079
0x052d0,0x0a9b8,0x0a950,0x0b4a0,0x0b6a6,0x0ad50,0x055a0,0x0aba4,0x0a5b0,0x052b0,
// 2080-2089
0x0b273,0x06930,0x07337,0x06aa0,0x0ad50,0x14b55,0x04b60,0x0a570,0x054e4,0x0d160,
// 2090-2099
0x0e968,0x0d520,0x0daa0,0x16aa6,0x056d0,0x04ae0,0x0a9d4,0x0a2d0,0x0d150,0x0f252,
// 2100
0x0d520
];
const LUNAR_START = 1900;

// Payment info
const MY_ACCOUNT = "ì¼€ì´ë±…í¬ 100150462483 ê¹€ëŒ€ì¸";

/* ========================================
   2. ë‹¤êµ­ì–´
   ======================================== */

/* ========================================
   3. ì „ì—­ ìƒíƒœ
   ======================================== */
let GENDER = 'm';
let CALENDAR = 'solar';
let SAJU = null;
let GODS = null;
let STRENGTH = null;  // ì‹ ê°•/ì‹ ì•½ ì •ë³´
let BIRTH_YEAR = null;
let BIRTH_MONTH = null;  // v4.15.1: ëŒ€ìš´ ì •ë°€ ê³„ì‚°ìš©
let BIRTH_DAY = null;    // v4.15.1: ëŒ€ìš´ ì •ë°€ ê³„ì‚°ìš©
let BIRTH_HOUR = null;   // v4.15.1: ëŒ€ìš´ ì •ë°€ ê³„ì‚°ìš©
let currentNumbers = [];
let history = [];

/* ========================================
   3-1. ì¹´ì¹´ì˜¤í†¡ ê³µìœ  ê¸°ëŠ¥
   ======================================== */
// Kakao SDK init (replace with real JS key for production)
// https://developers.kakao.com - register app and get JS key
const KAKAO_KEY = 'YOUR_KAKAO_JAVASCRIPT_KEY'; // TODO: Replace with real key

function initKakao() {
    if (typeof Kakao !== 'undefined' && !Kakao.isInitialized()) {
        try {
            Kakao.init(KAKAO_KEY);
            console.log('Kakao SDK initialized');
        } catch(e) {
            console.log('Kakao init skipped (key not set)');
        }
    }
}

function shareKakao() {
    const shareData = {
        title: 'ğŸ”® K-MUDANG Pro',
        text: 'Ancient destiny wisdom in a modern app\n\nâœ¨ Expert-level Four Pillars Analysis\nğŸ’• Scientific Compatibility Reading\nğŸ€ Lottery with historical exclusion',
        url: window.location.href
    };
    
    // 1. Web Share API supported (mobile browser)
    if (navigator.share) {
        navigator.share(shareData)
            .then(() => toast('Shared successfully! ğŸ‰'))
            .catch((err) => {
                if (err.name !== 'AbortError') {
                    copyShareLink();
                }
            });
        return;
    }
    
    // 2. If Kakao SDK initialized
    if (typeof Kakao !== 'undefined' && Kakao.isInitialized()) {
        try {
            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: 'ğŸ”® K-MUDANG Pro',
                    description: getShareText(),
                    imageUrl: getShareImageUrl(),
                    link: {
                        mobileWebUrl: window.location.href,
                        webUrl: window.location.href
                    }
                },
                buttons: [{
                    title: 'Check Your Fortune',
                    link: {
                        mobileWebUrl: window.location.href,
                        webUrl: window.location.href
                    }
                }]
            });
            return;
        } catch(e) {
            console.error('Kakao share error:', e);
        }
    }
    
    // 3. Fallback: copy link
    copyShareLink();
}

function getShareText() {
    return `Align your cosmic blueprint with fortune through authentic Korean astrology

âœ¨ Professional Four Pillars destiny analysis
ğŸ° Lottery numbers harmonized with your personal energy
â˜¯ Where millennia-old Eastern wisdom meets modern fortune

Discover your destined path ğŸ”®`;
}

function getShareImageUrl() {
    return 'https://raw.githubusercontent.com/shrmsdl-netizen/k-mudang/main/og-image.png';
}

function shareApp() {
    const shareData = {
        title: 'ğŸ”® K-MUDANG Pro - Korean Astrology & Fortune',
        text: 'Harness ancient Four Pillars wisdom to align your cosmic energy with destiny-based lottery numbers.',
        url: window.location.href
    };
    
    if (navigator.share) {
        navigator.share(shareData)
            .then(() => toast('Shared successfully! ğŸ‰'))
            .catch(() => copyShareLink());
    } else {
        copyShareLink();
    }
}

function copyShareLink() {
    const text = `ğŸ”® K-MUDANG Pro - Korean Astrology & Fortune

âœ¨ Professional Four Pillars Destiny Analysis
ğŸ° Lottery Numbers Aligned with Your Cosmic Energy
â˜¯ Where Ancient Eastern Wisdom Meets Modern Fortune

ğŸ‘‰ ${window.location.href}`;

    navigator.clipboard.writeText(text).then(() => {
        toast('ğŸ“‹ Link copied to clipboard!');
    }).catch(() => {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        toast('ğŸ“‹ Link copied to clipboard!');
    });
}

/* ========================================
   3-2. Fortune Talisman Card Generator
   ======================================== */
let talismanGenerated = false;
let talismanDataUrl = null;

function generateTalisman() {
    if (!SAJU || !SAJU.day) {
        toast('Please analyze your Four Pillars first! ğŸ”®');
        return;
    }
    
    // [v4.14.1] ì˜ì‹ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    const overlay = document.getElementById('talisman-ritual-overlay');
    overlay.classList.add('active');
    
    // ë¶“ìœ¼ë¡œ ê·¸ë¦¬ëŠ” ì• ë‹ˆë©”ì´ì…˜
    playRitualAnimation(() => {
        // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì‹¤ì œ ë¶€ì  ìƒì„±
        createHighResTalisman();
        overlay.classList.remove('active');
        
        document.getElementById('talisman-preview').style.display = 'block';
        document.getElementById('talisman-btn-wrapper').style.display = 'none';
        toast('ğŸ® Your fortune talisman has been created!');
    });
}

// [v4.14.1] ì˜ì‹ ì• ë‹ˆë©”ì´ì…˜
function playRitualAnimation(callback) {
    const canvas = document.getElementById('ritual-canvas');
    const ctx = canvas.getContext('2d');
    const W = 300, H = 400;
    
    ctx.fillStyle = '#0a0505';
    ctx.fillRect(0, 0, W, H);
    
    const yongEl = GODS && GODS.yong ? GODS.yong : 'fire';
    const colors = {
        fire: { main: '#C41E3A', accent: '#FFD700' },
        water: { main: '#1E3A5F', accent: '#87CEEB' },
        wood: { main: '#228B22', accent: '#90EE90' },
        metal: { main: '#B8860B', accent: '#FFD700' },
        earth: { main: '#8B4513', accent: '#DEB887' }
    };
    const color = colors[yongEl] || colors.fire;
    
    // v4.14.7: ç¬¦ ê¸€ìë¥¼ í…ìŠ¤íŠ¸ë¡œ ì ì  ë‚˜íƒ€ë‚˜ê²Œ í‘œì‹œ
    let opacity = 0;
    const interval = setInterval(() => {
        ctx.fillStyle = '#0a0505';
        ctx.fillRect(0, 0, W, H);
        
        // í…Œë‘ë¦¬
        ctx.strokeStyle = color.main;
        ctx.lineWidth = 3;
        ctx.strokeRect(20, 20, W-40, H-40);
        
        // ç¬¦ ê¸€ì (ì ì  ë‚˜íƒ€ë‚¨)
        opacity = Math.min(1, opacity + 0.08);
        ctx.fillStyle = `rgba(255, 215, 0, ${opacity})`;
        ctx.font = 'bold 180px "Noto Serif KR", serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('ç¬¦', W/2, H/2 - 30);
        
        // í•˜ë‹¨ í…ìŠ¤íŠ¸
        ctx.fillStyle = `rgba(139, 115, 85, ${opacity})`;
        ctx.font = '24px "Noto Sans KR", sans-serif';
        ctx.fillText('Fortune Talisman', W/2, H - 60);
        
        if (opacity >= 1) {
            clearInterval(interval);
            setTimeout(callback, 500);
        }
    }, 80);
}

// [v4.14.1] ê³ í•´ìƒë„ ë¶€ì  ìƒì„± (1080x1920, 9:16)
function createHighResTalisman() {
    const canvas = document.getElementById('talisman-canvas');
    const ctx = canvas.getContext('2d');
    
    const W = 1080, H = 1920;
    canvas.width = W;
    canvas.height = H;
    
    const yongEl = GODS && GODS.yong ? GODS.yong : 'fire';
    const themes = {
        fire: { bg1: '#1a0505', bg2: '#2d0a0a', bg3: '#1a0303', main: '#C41E3A', accent: '#FFD700', border: '#8B7355', symbol: 'é³³', symbolName: 'Phoenix', emoji: 'ğŸ”¥' },
        water: { bg1: '#050a1a', bg2: '#0a1a2d', bg3: '#03081a', main: '#1E4D8C', accent: '#87CEEB', border: '#4682B4', symbol: 'é¾', symbolName: 'Dragon', emoji: 'ğŸ’§' },
        wood: { bg1: '#051a05', bg2: '#0a2d0a', bg3: '#031a03', main: '#228B22', accent: '#90EE90', border: '#6B8E23', symbol: 'é¾', symbolName: 'Azure Dragon', emoji: 'ğŸŒ³' },
        metal: { bg1: '#1a1a1a', bg2: '#2d2d2d', bg3: '#0a0a0a', main: '#C0C0C0', accent: '#FFD700', border: '#B8860B', symbol: 'è™', symbolName: 'White Tiger', emoji: 'âš™ï¸' },
        earth: { bg1: '#1a1408', bg2: '#2d220a', bg3: '#1a1005', main: '#8B4513', accent: '#DEB887', border: '#D2691E', symbol: 'éºŸ', symbolName: 'Qilin', emoji: 'ğŸŒ' }
    };
    const theme = themes[yongEl] || themes.fire;
    
    const bgGrad = ctx.createLinearGradient(0, 0, 0, H);
    bgGrad.addColorStop(0, theme.bg1);
    bgGrad.addColorStop(0.5, theme.bg2);
    bgGrad.addColorStop(1, theme.bg3);
    ctx.fillStyle = bgGrad;
    ctx.fillRect(0, 0, W, H);
    
    ctx.strokeStyle = theme.border;
    ctx.lineWidth = 6;
    ctx.strokeRect(40, 40, W-80, H-80);
    ctx.strokeStyle = theme.accent;
    ctx.lineWidth = 2;
    ctx.strokeRect(55, 55, W-110, H-110);
    
    drawCornerOrnamentsHD(ctx, W, H, theme);
    drawTaegeukHD(ctx, W/2, 150, 60, theme);
    
    ctx.fillStyle = theme.accent;
    ctx.font = 'bold 64px "Noto Serif KR", serif';
    ctx.textAlign = 'center';
    ctx.fillText('äºŒã€‡äºŒå…­ é–‹é‹ç¬¦', W/2, 280);
    
    ctx.fillStyle = theme.border;
    ctx.font = '32px "Noto Sans KR", sans-serif';
    ctx.fillText('2026 Fortune Talisman', W/2, 330);
    
    ctx.strokeStyle = theme.border;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(150, 370);
    ctx.lineTo(W-150, 370);
    ctx.stroke();
    
    const mantras = {
        wood: { hanja: 'æœ¨å¾·ç”Ÿç™¼ è¬äº‹äº¨é€š', meaning: 'Wood virtue blooms, all things prosper' },
        fire: { hanja: 'ç«å¾·æ˜Œç›› å…‰æ˜å¤§å‰', meaning: 'Fire virtue blazes, great fortune shines' },
        earth: { hanja: 'åœŸå¾·åšè¼‰ è²¡ç¥¿è±Šç›ˆ', meaning: 'Earth virtue endures, wealth overflows' },
        metal: { hanja: 'é‡‘å¾·å …å›º ç™¾äº‹æˆå°±', meaning: 'Metal virtue strengthens, all goals achieved' },
        water: { hanja: 'æ°´å¾·æ½¤æ¾¤ æ™ºæ…§é€šé”', meaning: 'Water virtue nourishes, wisdom flows freely' }
    };
    const mantra = mantras[yongEl] || mantras.fire;
    
    ctx.fillStyle = theme.accent;
    ctx.font = 'bold 52px "Noto Serif KR", serif';
    ctx.fillText(mantra.hanja, W/2, 450);
    
    ctx.fillStyle = theme.border;
    ctx.font = '28px "Noto Sans KR", sans-serif';
    ctx.fillText(mantra.meaning, W/2, 500);
    
    // v4.14.7: ì¤‘ì•™ì— í° "ç¬¦" ì (ì„œì˜ˆì²´)
    ctx.fillStyle = theme.accent;
    ctx.font = 'bold 280px "Ma Shan Zheng", "Noto Serif KR", serif';
    ctx.fillText('ç¬¦', W/2, 750);
    
    // ì‘ì€ ìˆ˜í˜¸ì‹  ì‹¬ë³¼
    ctx.fillStyle = theme.main;
    ctx.font = 'bold 80px "Noto Serif KR", serif';
    ctx.fillText(theme.symbol, W/2, 850);
    
    ctx.fillStyle = theme.border;
    ctx.font = '28px "Noto Sans KR", sans-serif';
    ctx.fillText(`${theme.symbolName} Â· ${ELEMENT[yongEl].n}`, W/2, 890);
    
    const dayStem = SAJU.day.s.c;
    const dayBranch = SAJU.day.b.c;
    ctx.fillStyle = theme.accent;
    ctx.font = 'bold 90px "Ma Shan Zheng", "Noto Serif KR", serif';
    ctx.fillText(dayStem + dayBranch, W/2, 980);
    
    const iljuKey = dayStem + dayBranch;
    const dayDesc = (typeof ILJU_60 !== 'undefined' && ILJU_60[iljuKey]) ? ILJU_60[iljuKey].name : '';
    ctx.fillStyle = '#C0C0C0';
    ctx.font = '28px "Noto Sans KR", sans-serif';
    ctx.fillText(dayDesc + ' Day Master', W/2, 1025);
    
    ctx.fillStyle = 'rgba(139, 115, 85, 0.15)';
    roundRectHD(ctx, 100, 1060, W-200, 280, 20);
    ctx.fill();
    ctx.strokeStyle = theme.border;
    ctx.lineWidth = 2;
    roundRectHD(ctx, 100, 1060, W-200, 280, 20);
    ctx.stroke();
    
    ctx.textAlign = 'left';
    ctx.font = '32px "Noto Sans KR", sans-serif';
    
    const yongsinEl = ELEMENT[GODS.yong];
    const huisinEl = ELEMENT[GODS.hee];
    const gisinEl = ELEMENT[GODS.gi];
    
    ctx.fillStyle = '#FF6B6B';
    ctx.fillText('ç”¨ç¥ (Beneficial)', 150, 1130);
    ctx.fillStyle = theme.accent;
    ctx.fillText(`${yongsinEl.n} ${theme.emoji}`, 450, 1130);
    
    ctx.fillStyle = '#4ECDC4';
    ctx.fillText('å–œç¥ (Favorable)', 150, 1190);
    ctx.fillStyle = theme.accent;
    ctx.fillText(`${huisinEl.n}`, 450, 1190);
    
    ctx.fillStyle = '#95A5A6';
    ctx.fillText('å¿Œç¥ (Avoid)', 150, 1250);
    ctx.fillStyle = '#888';
    ctx.fillText(`${gisinEl.n}`, 450, 1250);
    
    ctx.fillStyle = theme.border;
    ctx.fillText('Body Strength', 150, 1310);
    ctx.fillStyle = theme.accent;
    const strType = STRENGTH ? (STRENGTH.type === 'strong' ? 'Strong' : STRENGTH.type === 'weak' ? 'Weak' : 'Balanced') : '?';
    const strPct = STRENGTH ? STRENGTH.pct + '%' : '';
    ctx.fillText(`${strType} ${strPct}`, 450, 1310);
    
    ctx.textAlign = 'center';
    ctx.fillStyle = theme.border;
    ctx.font = '28px "Noto Sans KR", sans-serif';
    ctx.fillText('â”€â”€â”€ 2026 ä¸™åˆå¹´ Fire Horse Year â”€â”€â”€', W/2, 1400);
    
    let bestMonth = '?', worstMonth = '?';
    try {
        const monthlyLuck = getYearlyMonthLuck(2026, SAJU, GODS);
        if (monthlyLuck && monthlyLuck.best) bestMonth = monthlyLuck.best.month;
        if (monthlyLuck && monthlyLuck.worst) worstMonth = monthlyLuck.worst.month;
    } catch(e) {}
    
    ctx.font = '32px "Noto Sans KR", sans-serif';
    ctx.fillStyle = '#4ECDC4';
    ctx.fillText(`âœ¨ Best Month: ${bestMonth}`, W/2 - 180, 1460);
    ctx.fillStyle = '#FF6B6B';
    ctx.fillText(`âš ï¸ Caution: ${worstMonth}`, W/2 + 180, 1460);
    
    ctx.strokeStyle = theme.border;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(150, 1520);
    ctx.lineTo(W-150, 1520);
    ctx.stroke();
    
    ctx.fillStyle = theme.accent;
    ctx.font = 'bold 44px "Ma Shan Zheng", "Noto Serif KR", serif';
    ctx.fillText('å„é€€ç¦ä¾† ç™¾äº‹å¤§å‰', W/2, 1590);
    
    ctx.fillStyle = theme.border;
    ctx.font = '26px "Noto Sans KR", sans-serif';
    ctx.fillText('Misfortune retreats, blessings arrive', W/2, 1640);
    
    ctx.fillStyle = theme.border;
    ctx.font = '22px "Noto Sans KR", sans-serif';
    ctx.fillText('K-MUDANG Pro â˜¯ kmudang.com', W/2, 1740);
    
    const serialNo = generateSerialNumber();
    ctx.fillStyle = 'rgba(139, 115, 85, 0.6)';
    ctx.font = '16px monospace';
    ctx.fillText(`No. ${serialNo}`, W/2, 1780);
    
    ctx.fillStyle = 'rgba(255,255,255,0.4)';
    ctx.font = '20px "Noto Sans KR", sans-serif';
    ctx.fillText('ğŸ“± Set as your phone wallpaper for daily fortune', W/2, 1840);
    
    talismanGenerated = true;
    talismanDataUrl = canvas.toDataURL('image/png', 1.0);
}

function generateSerialNumber() {
    const now = new Date();
    const year = now.getFullYear();
    const random = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
    const dayPillar = SAJU.day.s.c + SAJU.day.b.c;
    return `${year}-KMUDANG-${dayPillar}-${random}`;
}

function drawTaegeukHD(ctx, x, y, r, theme) {
    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.strokeStyle = theme.accent;
    ctx.lineWidth = 4;
    ctx.stroke();
    
    ctx.beginPath();
    ctx.arc(x, y, r * 0.85, 0, Math.PI, false);
    ctx.fillStyle = theme.main;
    ctx.fill();
    
    ctx.beginPath();
    ctx.arc(x, y, r * 0.85, Math.PI, Math.PI * 2, false);
    ctx.fillStyle = '#1E3A5F';
    ctx.fill();
    
    ctx.beginPath();
    ctx.arc(x - r * 0.35, y, r * 0.28, 0, Math.PI * 2);
    ctx.fillStyle = '#1E3A5F';
    ctx.fill();
    
    ctx.beginPath();
    ctx.arc(x + r * 0.35, y, r * 0.28, 0, Math.PI * 2);
    ctx.fillStyle = theme.main;
    ctx.fill();
}

function drawCornerOrnamentsHD(ctx, W, H, theme) {
    const size = 50;
    const offset = 70;
    ctx.strokeStyle = theme.accent;
    ctx.lineWidth = 3;
    
    ctx.beginPath();
    ctx.moveTo(offset, offset + size);
    ctx.lineTo(offset, offset);
    ctx.lineTo(offset + size, offset);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(W - offset - size, offset);
    ctx.lineTo(W - offset, offset);
    ctx.lineTo(W - offset, offset + size);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(offset, H - offset - size);
    ctx.lineTo(offset, H - offset);
    ctx.lineTo(offset + size, H - offset);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(W - offset - size, H - offset);
    ctx.lineTo(W - offset, H - offset);
    ctx.lineTo(W - offset, H - offset - size);
    ctx.stroke();
}

function roundRectHD(ctx, x, y, w, h, r) {
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.lineTo(x + w - r, y);
    ctx.quadraticCurveTo(x + w, y, x + w, y + r);
    ctx.lineTo(x + w, y + h - r);
    ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
    ctx.lineTo(x + r, y + h);
    ctx.quadraticCurveTo(x, y + h, x, y + h - r);
    ctx.lineTo(x, y + r);
    ctx.quadraticCurveTo(x, y, x + r, y);
    ctx.closePath();
}

// Taegeuk symbol drawing
function drawTaegeuk(ctx, x, y, r) {
    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.strokeStyle = '#D4AF37';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    ctx.beginPath();
    ctx.arc(x, y, r * 0.8, 0, Math.PI, false);
    ctx.fillStyle = '#C41E3A';
    ctx.fill();
    
    ctx.beginPath();
    ctx.arc(x, y, r * 0.8, Math.PI, Math.PI * 2, false);
    ctx.fillStyle = '#1E3A5F';
    ctx.fill();
    
    ctx.beginPath();
    ctx.arc(x - r * 0.35, y, r * 0.25, 0, Math.PI * 2);
    ctx.fillStyle = '#1E3A5F';
    ctx.fill();
    
    ctx.beginPath();
    ctx.arc(x + r * 0.35, y, r * 0.25, 0, Math.PI * 2);
    ctx.fillStyle = '#C41E3A';
    ctx.fill();
}

// Corner ornaments
function drawCornerOrnaments(ctx, W, H) {
    ctx.fillStyle = '#D4AF37';
    ctx.font = '14px serif';
    ctx.textAlign = 'center';
    ctx.fillText('ç¦', 35, 40);
    ctx.fillText('ç¥¿', W-35, 40);
    ctx.fillText('å£½', 35, H-25);
    ctx.fillText('å–œ', W-35, H-25);
}

// Rounded rectangle helper
function roundRect(ctx, x, y, w, h, r) {
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.lineTo(x + w - r, y);
    ctx.quadraticCurveTo(x + w, y, x + w, y + r);
    ctx.lineTo(x + w, y + h - r);
    ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
    ctx.lineTo(x + r, y + h);
    ctx.quadraticCurveTo(x, y + h, x, y + h - r);
    ctx.lineTo(x, y + r);
    ctx.quadraticCurveTo(x, y, x + r, y);
    ctx.closePath();
}

// Download talisman image
function downloadTalisman() {
    if (!talismanGenerated) {
        generateTalisman();
        if (!talismanGenerated) return;
    }
    
    const link = document.createElement('a');
    link.download = '2026_Fortune_Talisman_K-MUDANG.png';
    link.href = talismanDataUrl;
    link.click();
    toast('ğŸ“¥ Talisman image saved!');
}

// Share talisman
function shareTalisman() {
    if (!talismanGenerated) {
        generateTalisman();
        if (!talismanGenerated) return;
    }
    
    if (navigator.share && navigator.canShare) {
        const canvas = document.getElementById('talisman-canvas');
        canvas.toBlob(async (blob) => {
            const file = new File([blob], '2026_Fortune_Talisman.png', { type: 'image/png' });
            const shareData = {
                title: 'ğŸ® 2026 Fortune Talisman',
                text: 'My personalized fortune talisman from K-MUDANG Pro!\n\nğŸ‘‰ Create yours:',
                url: window.location.href,
                files: [file]
            };
            
            try {
                if (navigator.canShare(shareData)) {
                    await navigator.share(shareData);
                    toast('Shared successfully! ğŸ‰');
                    return;
                }
            } catch(e) {
                if (e.name !== 'AbortError') {
                    console.log('Share failed:', e);
                }
            }
            shareTalismanFallback();
        }, 'image/png');
        return;
    }
    
    shareTalismanFallback();
}

function shareTalismanFallback() {
    copyShareLink();
    toast('ğŸ’¡ Save the talisman image first, then share it manually!');
}

/* ========================================
   4. ì´ˆê¸°í™”
   ======================================== */
function init() {
    // Kakao SDK init
    initKakao();
    
    const cy = new Date().getFullYear();
    
    // Initialize birthdate selects
    ['birth-year', 'partner-year'].forEach(id => {
        const el = document.getElementById(id);
        if (el) for (let i = cy; i >= 1940; i--) el.innerHTML += `<option value="${i}">${i}</option>`;
    });
    
    ['birth-month', 'partner-month'].forEach(id => {
        const el = document.getElementById(id);
        if (el) for (let i = 1; i <= 12; i++) el.innerHTML += `<option value="${i}">${MONTH_ABBR[i - 1]}</option>`;
    });
    
    ['birth-day', 'partner-day'].forEach(id => {
        const el = document.getElementById(id);
        if (el) for (let i = 1; i <= 31; i++) el.innerHTML += `<option value="${i}">${i}</option>`;
    });
    
    // Time select
    const hourEl = document.getElementById('birth-hour');
    if (hourEl) {
        const hours = ['å­æ™‚(23:30-01:29)','ä¸‘æ™‚(01:30-03:29)','å¯…æ™‚(03:30-05:29)','å¯æ™‚(05:30-07:29)',
                       'è¾°æ™‚(07:30-09:29)','å·³æ™‚(09:30-11:29)','åˆæ™‚(11:30-13:29)','æœªæ™‚(13:30-15:29)',
                       'ç”³æ™‚(15:30-17:29)','é…‰æ™‚(17:30-19:29)','æˆŒæ™‚(19:30-21:29)','äº¥æ™‚(21:30-23:29)'];
        hours.forEach((t, i) => hourEl.innerHTML += `<option value="${i}">${t}</option>`);
        hourEl.innerHTML += `<option value="-1">Unknown</option>`;
    }
    
    // Update stats
    // Init complete
}

document.addEventListener('DOMContentLoaded', init);

/* ========================================
   5. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
   ======================================== */
// toast already defined at top - this is a backup
if (typeof toast !== 'function') {
    function toast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }
}

function getBallColor(n) {
    if (n <= 10) return 'y';
    if (n <= 20) return 'b';
    if (n <= 30) return 'r';
    if (n <= 40) return 'g';
    return 'p';
}

function createBall(n, sm = false) {
    return `<div class="ball ${sm ? 'sm' : ''} ${getBallColor(n)}">${n}</div>`;
}

function setGender(g) {
    GENDER = g;
    document.querySelectorAll('[data-gender]').forEach(b => b.classList.toggle('on', b.dataset.gender === g));
}

function setCalendar(c) {
    CALENDAR = c;
    document.querySelectorAll('[data-cal]').forEach(b => b.classList.toggle('on', b.dataset.cal === c));
    const notice = document.getElementById('lunar-notice');
    if (notice) notice.style.display = c === 'lunar' ? 'block' : 'none';
}

function switchTab(name) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.top-nav button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-footer').forEach(f => f.classList.remove('active'));
    document.getElementById('tab-' + name).classList.add('active');
    document.getElementById('footer-' + name)?.classList.add('active');
    event.currentTarget.classList.add('active');
}

function showFortune(type) {
    document.querySelectorAll('#fortune-tabs .sub-tab').forEach(t => t.classList.remove('on'));
    event.currentTarget.classList.add('on');
    renderFortune(type);
}

/* ========================================
   6. ë¡œë˜ ë²ˆí˜¸ ìƒì„±
   ======================================== */
function generateLotto() {
    try {
        const container = document.getElementById('lotto-balls');
        if (!container) { toast('Screen error'); return; }
        
        const btn = event?.currentTarget;
        if (btn) {
            btn.disabled = true;
            btn.textContent = 'ğŸ² Drawing...';
        }
        
        let counter = 0;
        const interval = setInterval(() => {
            const temp = Array.from({length: 6}, () => Math.floor(Math.random() * 45) + 1);
            container.innerHTML = temp.map(n => createBall(n)).join('');
            counter++;
            
            if (counter > 15) {
                clearInterval(interval);
                
                let nums, attempts = 0;
                do {
                    const pool = Array.from({length: 45}, (_, i) => i + 1);
                    nums = [];
                    for (let i = 0; i < 6; i++) {
                        const idx = Math.floor(Math.random() * pool.length);
                        nums.push(pool.splice(idx, 1)[0]);
                    }
                    nums.sort((a, b) => a - b);
                    attempts++;
                } while (PAST_SET.has(nums.join(',')) && attempts < 1000);
                
                currentNumbers = nums;
                container.innerHTML = nums.map(n => createBall(n)).join('');
                
                history.unshift(nums);
                if (history.length > 5) history.pop();
                
                document.getElementById('history-card').style.display = 'block';
                document.getElementById('history-list').innerHTML = history.map(h =>
                    `<div class="history-item">${h.map(n => createBall(n, true)).join('')}</div>`
                ).join('');
                
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'ğŸ² Generate Lucky Numbers';
                }
                
                if (SAJU) showTodayFortune();
            }
        }, 50);
    } catch (error) {
        console.error('ë¡œë˜ ìƒì„± ì˜¤ë¥˜:', error);
        toast('Error generating numbers.');
    }
}

function generateSajuLotto() {
    try {
        if (!GODS) { toast('Please analyze your Four Pillars first'); return; }
        
        const container = document.getElementById('saju-lotto-balls');
        if (!container) { toast('Screen error'); return; }
        
        const yongNums = ELEMENT[GODS.yong]?.nums || [];
        const heeNums = ELEMENT[GODS.hee]?.nums || [];
        const giNums = ELEMENT[GODS.gi]?.nums || [];
        
        let weightedPool = [];
        for (let i = 1; i <= 45; i++) {
            let weight = 1;
            if (yongNums.includes(i)) weight = 3;
            else if (heeNums.includes(i)) weight = 2;
            else if (giNums.includes(i)) weight = 0.5;
            for (let j = 0; j < weight * 2; j++) weightedPool.push(i);
        }
        
        let nums = [], attempts = 0;
        do {
            const selected = new Set();
            while (selected.size < 6) {
                const idx = Math.floor(Math.random() * weightedPool.length);
                selected.add(weightedPool[idx]);
            }
            nums = [...selected].sort((a, b) => a - b);
            attempts++;
        } while (PAST_SET.has(nums.join(',')) && attempts < 1000);
        
        currentNumbers = nums;
        container.innerHTML = nums.map(n => createBall(n)).join('');
        
        const yongCount = nums.filter(n => yongNums.includes(n)).length;
        toast(`Beneficial Element (${ELEMENT[GODS.yong].k}) Ã— ${yongCount} included!`);
    } catch (error) {
        console.error('ì‚¬ì£¼ ë¡œë˜ ìƒì„± ì˜¤ë¥˜:', error);
        toast('Error generating numbers.');
    }
}

/* ========================================
   7. [Pro] ì •ë°€ ë§Œì„¸ë ¥ ì—”ì§„ - ìŒë ¥/ì‹œì°¨/ì ˆê¸° ë³´ì •
   ======================================== */

// Lunar calendar data decoding (using LUNAR_DATA)
function getLunarYearDays(year) {
    const idx = year - LUNAR_START;
    if (idx < 0 || idx >= LUNAR_DATA.length) return null;
    const code = LUNAR_DATA[idx];
    
    const leapMonth = code & 0xF; // Leap month (0 if none)
    let totalDays = 0;
    const monthDays = [];
    
    // months 1-12 long/short
    for (let i = 0; i < 12; i++) {
        const bit = (code >> (16 - i)) & 1;
        const days = bit ? 30 : 29;
        monthDays.push(days);
        totalDays += days;
    }
    
    // Leap month
    let leapDays = 0;
    if (leapMonth > 0) {
        leapDays = ((code >> 16) & 1) ? 30 : 29;
        totalDays += leapDays;
    }
    
    return { leapMonth, monthDays, leapDays, totalDays };
}

function lunarToSolar(ly, lm, ld, isLeap = false) {
    if (ly < LUNAR_START || ly > LUNAR_START + LUNAR_DATA.length - 1) {
        return { year: ly, month: lm, day: ld };
    }
    
    // Base date: 1900-01-31 = Lunar 1900-01-01
    let offset = 0;
    
    // Yearly accumulation
    for (let y = LUNAR_START; y < ly; y++) {
        const data = getLunarYearDays(y);
        if (data) offset += data.totalDays;
    }
    
    // Monthly accumulation
    const yearData = getLunarYearDays(ly);
    if (yearData) {
        for (let m = 1; m < lm; m++) {
            offset += yearData.monthDays[m - 1];
            if (yearData.leapMonth === m) {
                offset += yearData.leapDays;
            }
        }
        if (isLeap && yearData.leapMonth === lm) {
            offset += yearData.monthDays[lm - 1];
        }
    }
    
    offset += ld - 1;
    
    // Calculate from base date
    const baseDate = new Date(1900, 0, 31);
    const resultDate = new Date(baseDate.getTime() + offset * 24 * 60 * 60 * 1000);
    
    return {
        year: resultDate.getFullYear(),
        month: resultDate.getMonth() + 1,
        day: resultDate.getDate()
    };
}

// v4.14.7: íƒ€ì„ì¡´ UI ì—…ë°ì´íŠ¸
function updateTimezoneInfo() {
    const loc = document.getElementById('birth-location')?.value || 'us-pacific';
    const info = document.getElementById('timezone-info');
    if (!info) return;
    
    // í•œêµ­ì€ ë©”ì‹œì§€ ì—†ìŒ, ë‚˜ë¨¸ì§€ëŠ” ìë™ ë³€í™˜ ì•ˆë‚´
    if (loc === 'korea' || loc === 'japan') {
        info.style.display = 'none';
    } else {
        info.textContent = 'ğŸ’¡ í˜„ì§€ ì¶œìƒì‹œê°„ â†’ í•œêµ­ í‘œì¤€ì‹œë¡œ ìë™ ë³€í™˜';
        info.style.display = 'block';
    }
}

// v4.14.7: ì§€ì—­ë³„ ì‹œì°¨ ê³„ì‚° (í•œêµ­ì‹œ UTC+9 ê¸°ì¤€ ì˜¤í”„ì…‹)
function getTimezoneOffset(location, year, month) {
    // ì„œë¨¸íƒ€ì„ ëŒ€ëµ ì²´í¬ (ë¶ë°˜êµ¬ 3~10ì›”, ë‚¨ë°˜êµ¬ëŠ” ë°˜ëŒ€)
    const isDST = (month >= 3 && month <= 10);
    
    // í•œêµ­ì‹œ(UTC+9) ê¸°ì¤€ ì˜¤í”„ì…‹ (í•´ë‹¹ ì§€ì—­ í˜„ì§€ì‹œê°„ì— ë”í•´ì„œ í•œêµ­ì‹œë¡œ ë³€í™˜)
    const offsets = {
        // í•œêµ­/ì¼ë³¸ (UTC+9) - ì˜¤í”„ì…‹ 0
        'korea': 0, 'japan': 0,
        
        // ë¯¸êµ­
        'us-pacific': isDST ? -16 : -17,      // CA, WA, OR (UTC-7/-8)
        'us-mountain': isDST ? -15 : -16,     // CO, AZ, UT, NV (UTC-6/-7)
        'us-central': isDST ? -14 : -15,      // TX, IL, MN (UTC-5/-6)
        'us-eastern': isDST ? -13 : -14,      // NY, FL, GA (UTC-4/-5)
        'us-alaska': isDST ? -17 : -18,       // UTC-8/-9
        'us-hawaii': -19,                      // UTC-10 (no DST)
        
        // ìºë‚˜ë‹¤
        'canada-west': isDST ? -16 : -17,
        'canada-east': isDST ? -13 : -14,
        
        // ì¤‘ë‚¨ë¯¸
        'mexico': isDST ? -14 : -15,
        'brazil': -12,                         // UTC-3
        
        // ë™ì•„ì‹œì•„ (UTC+8)
        'china': -1, 'taiwan': -1, 'hongkong': -1,
        'singapore': -1, 'philippines': -1,
        
        // ë™ë‚¨ì•„ì‹œì•„ (UTC+7)
        'vietnam': -2, 'thailand': -2, 'indonesia': -2,
        
        // ë‚¨ì•„ì‹œì•„/ì¤‘ë™
        'india': -3.5,                         // UTC+5:30
        'uae': -5,                             // UTC+4
        'israel': isDST ? -6 : -7,            // UTC+2/+3
        'saudi': -6,                           // UTC+3
        
        // ìœ ëŸ½ (CET = UTC+1/+2)
        'uk': isDST ? -8 : -9,                // UTC+0/+1
        'germany': isDST ? -7 : -8,
        'france': isDST ? -7 : -8,
        'spain': isDST ? -7 : -8,
        'italy': isDST ? -7 : -8,
        'russia': -6,                          // Moscow UTC+3
        
        // ì˜¤ì„¸ì•„ë‹ˆì•„ (ë‚¨ë°˜êµ¬ - DST ë°˜ëŒ€)
        'australia-east': isDST ? 1 : 2,      // UTC+10/+11
        'australia-west': -1,                  // UTC+8
        'newzealand': isDST ? 3 : 4           // UTC+12/+13
    };
    return offsets[location] || 0;
}

function adjustTime(y, m, d, h) {
    if (h < 0) return { y, m, d, h };
    let hour = h;
    
    // v4.14.7: ì§€ì—­ë³„ íƒ€ì„ì¡´ ë³´ì •
    const location = document.getElementById('birth-location')?.value || 'us-pacific';
    hour += getTimezoneOffset(location, y, m);
    while (hour >= 24) { hour -= 24; d += 1; }
    while (hour < 0) { hour += 24; d -= 1; }
    const daysInMonth = [31, (y % 4 === 0) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    if (d < 1) { m--; if (m < 1) { m = 12; y--; } d = daysInMonth[m - 1]; }
    if (d > daysInMonth[m - 1]) { d = 1; m++; if (m > 12) { m = 1; y++; } }
    
    // Korea DST correction (í•œêµ­ ì¶œìƒë§Œ)
    if (location === 'korea') {
        const isDST = ((y >= 1948 && y <= 1951) || (y >= 1955 && y <= 1960) || (y >= 1987 && y <= 1988));
        if (isDST) hour -= 1;
    }
    // True solar time correction
    hour = hour - 0.5;
    if (hour < 0) { hour += 12; d -= 1; }
    if (d < 1) { m -= 1; if (m < 1) { m = 12; y -= 1; } d = 28; }
    return { y, m, d, h: Math.floor(hour) };
}

/* ========================================
   8. [Pro] ì •ë°€ ì ˆê¸° ê³„ì‚° & ì‚¬ì£¼ ê¸°ë‘¥
   ======================================== */

// Solar term index: 0=Ipchun(Feb), 1=Gyeongchip(Mar)...10=Daeseol(Dec), 11=Sohan(Jan)
// Data format: [month, day, hour, minute]

// Precise solar term calculation (direct data lookup)
function getSolarTermTime(year, termIdx) {
    // Year with data, return directly
    if (SOLAR_TERMS[year] && SOLAR_TERMS[year][termIdx]) {
        const t = SOLAR_TERMS[year][termIdx];
        return { m: t[0], d: t[1], h: t[2], n: t[3] };
    }
    
    // Year without data, use nearest year
    const years = Object.keys(SOLAR_TERMS).map(Number).sort((a, b) => a - b);
    
    // Out of range
    if (year < years[0]) {
        const t = SOLAR_TERMS[years[0]][termIdx];
        return t ? { m: t[0], d: t[1], h: t[2], n: t[3] } : { m: termIdx + 2, d: 5, h: 12, n: 0 };
    }
    if (year > years[years.length - 1]) {
        const t = SOLAR_TERMS[years[years.length - 1]][termIdx];
        return t ? { m: t[0], d: t[1], h: t[2], n: t[3] } : { m: termIdx + 2, d: 5, h: 12, n: 0 };
    }
    
    // Find nearest year
    let closest = years[0];
    let minDiff = Math.abs(year - years[0]);
    for (const y of years) {
        if (Math.abs(year - y) < minDiff) {
            minDiff = Math.abs(year - y);
            closest = y;
        }
    }
    
    const t = SOLAR_TERMS[closest][termIdx];
    return t ? { m: t[0], d: t[1], h: t[2], n: t[3] } : { m: termIdx + 2, d: 5, h: 12, n: 0 };
}

// Date comparison: true if date1 >= date2
function isDateTimeGTE(m1, d1, h1, n1, m2, d2, h2, n2) {
    if (m1 !== m2) return m1 > m2;
    if (d1 !== d2) return d1 > d2;
    if (h1 !== h2) return h1 > h2;
    return n1 >= n2;
}

// Precise year pillar calculation (considers Ipchun time)
function calcYearPillar(y, m, d, h = 12) {
    // v4.15.1: ì…ë ¥ê°’ ê²€ì¦
    if (!y || !m || !d || isNaN(y) || isNaN(m) || isNaN(d)) {
        console.error('calcYearPillar: Invalid input', {y, m, d, h});
        return { s: STEM[0], b: BRANCH[0] };
    }
    
    // Calculate Ipchun time (termIdx = 0)
    const ipchun = getSolarTermTime(y, 0);
    
    // Convert current time to minutes (h is branch index, convert to time)
    // h=0(å­ì‹œ)=23-01ì‹œ, h=1(ä¸‘ì‹œ)=01-03ì‹œ, ..., h=6(åˆì‹œ)=11-13ì‹œ
    const hourMap = [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22];
    const currentHour = h >= 0 ? hourMap[h] || 12 : 12;
    const currentMin = 0;
    
    // Previous year if before Ipchun
    let adjY = y;
    if (m < ipchun.m || 
        (m === ipchun.m && d < ipchun.d) ||
        (m === ipchun.m && d === ipchun.d && currentHour < ipchun.h) ||
        (m === ipchun.m && d === ipchun.d && currentHour === ipchun.h && currentMin < ipchun.n)) {
        adjY--;
    }
    
    const si = (adjY - 4) % 10;
    const bi = (adjY - 4) % 12;
    return { s: STEM[si < 0 ? si + 10 : si], b: BRANCH[bi < 0 ? bi + 12 : bi] };
}

// Precise month pillar calculation (considers solar term time)
function calcMonthPillar(y, m, d, h = 12) {
    // Solar term mapping: solar month m term = termIdx m-2
    // Ipchun(Feb)=0, Gyeongchip(Mar)=1, Cheongmyeong(Apr)=2, ...
    // Daeseol(Dec)=10, Sohan(Jan)=11
    
    const hourMap = [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22];
    const currentHour = h >= 0 ? hourMap[h] || 12 : 12;
    const currentMin = 0;
    
    // Get solar term time for this month
    let termIdx, checkYear = y;
    
    if (m === 1) {
        // January: Sohan(termIdx=11) based
        // Before Sohan = ìì›”(å­), ì†Œí•œ í›„ = ì¶•ì›”(ä¸‘)
        const sohan = getSolarTermTime(y, 11);
        
        let isAfterSohan = false;
        if (d > sohan.d || 
            (d === sohan.d && currentHour > sohan.h) ||
            (d === sohan.d && currentHour === sohan.h && currentMin >= sohan.n)) {
            isAfterSohan = true;
        }
        
        if (!isAfterSohan) {
            // Before Sohan = Zi month (based on previous year stem)
            const prevYearPillar = calcYearPillar(y - 1, 12, 15);
            const ysi = STEM.indexOf(prevYearPillar.s);
            // Zi month = ëª…ë¦¬í•™ì  11ë²ˆì§¸ ë‹¬
            const sajuMonth = 11;
            const msi = ((ysi % 5) * 2 + sajuMonth + 1) % 10;
            const mbi = 0; // å­
            return { s: STEM[msi], b: BRANCH[mbi] };
        } else {
            // After Sohan = ì¶•ì›” (ì „ë…„ë„ ì—°ê°„ ê¸°ì¤€, ì…ì¶˜ ì „ì´ë¯€ë¡œ)
            const prevYearPillar = calcYearPillar(y - 1, 12, 15);
            const ysi = STEM.indexOf(prevYearPillar.s);
            const sajuMonth = 12; // Chou month
            const msi = ((ysi % 5) * 2 + sajuMonth + 1) % 10;
            const mbi = 1; // ä¸‘
            return { s: STEM[msi], b: BRANCH[mbi] };
        }
    }
    
    // 2ì›”~12ì›”
    termIdx = m - 2; // 2ì›”=0(ì…ì¶˜), 3ì›”=1(ê²½ì¹©), ...
    const term = getSolarTermTime(y, termIdx);
    
    // Determine before/after solar term
    let isAfterTerm = false;
    if (m > term.m || 
        (m === term.m && d > term.d) ||
        (m === term.m && d === term.d && currentHour > term.h) ||
        (m === term.m && d === term.d && currentHour === term.h && currentMin >= term.n)) {
        isAfterTerm = true;
    }
    
    // Calculate Saju month
    // After Ipchun=Yin(1), After Gyeongchip=Mao(2), ...
    // Previous month if before solar term
    let sajuMonth;
    if (isAfterTerm) {
        sajuMonth = m - 1; // Solar Feb after Ipchun = Yin(1)
    } else {
        sajuMonth = m - 2; // Solar Feb before Ipchun = Chou(12)
    }
    
    if (sajuMonth <= 0) sajuMonth += 12;
    
    // Get year stem (ì›”ì£¼ ê³„ì‚° ì‹œì—ëŠ” í•´ë‹¹ ì‹œì ì˜ ì—°ì£¼ë¥¼ ì¨ì•¼ í•¨)
    const yp = calcYearPillar(y, m, d, h);
    const ysi = STEM.indexOf(yp.s);
    
    // Month stem formula: (ì—°ê°„%5)*2 + ì›” + 1
    // ç”²å·±year=ä¸™å¯…, ä¹™åºšyear=æˆŠå¯…...
    const msi = ((ysi % 5) * 2 + sajuMonth + 1) % 10;
    
    // Month branch: ì¸ì›”(1)=å¯…(2), ë¬˜ì›”(2)=å¯(3), ...
    const mbi = (sajuMonth + 1) % 12;
    
    return { s: STEM[msi], b: BRANCH[mbi] };
}

// Day pillar calculation (existing accurate logic)
function calcDayPillar(y, m, d) {
    // v4.15.4 FIX: ì‚¬ì£¼ë¡œë˜ì™€ ë™ì¼í•œ 60ê°‘ì ì¸ë±ìŠ¤ ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •
    if (!y || !m || !d || isNaN(y) || isNaN(m) || isNaN(d)) {
        console.error('calcDayPillar: Invalid input', {y, m, d});
        return { s: STEM[0], b: BRANCH[0] };
    }
    
    const a = Math.floor((14 - m) / 12);
    const adjY = y + 4800 - a;
    const adjM = m + 12 * a - 3;
    const jdn = d + Math.floor((153 * adjM + 2) / 5) + 365 * adjY + Math.floor(adjY / 4) - Math.floor(adjY / 100) + Math.floor(adjY / 400) - 32045;
    
    // v4.15.4 FIX: ì‚¬ì£¼ë¡œë˜ ê²€ì¦ëœ baseJdn ì‚¬ìš© (100ê°œ í…ŒìŠ¤íŠ¸ í†µê³¼)
    // ê¸°ì¤€: 2000/1/1 = å£¬ç”³ (idx60=8), JDN=2451545
    // baseJdn = 2451545 - 8 = 2451537
    const baseJdn = 2451537;
    const idx60 = ((jdn - baseJdn) % 60 + 60) % 60;
    
    const stemIdx = idx60 % 10;
    const branchIdx = idx60 % 12;
    
    if (isNaN(stemIdx) || isNaN(branchIdx)) {
        console.error('calcDayPillar: NaN result', {y, m, d, jdn, idx60, stemIdx, branchIdx});
        return { s: STEM[0], b: BRANCH[0] };
    }
    
    return { s: STEM[stemIdx], b: BRANCH[branchIdx] };
}

// Hour pillar calculation (existing accurate logic)
function calcHourPillar(dayStem, h) {
    if (h < 0) return null;
    const hbi = h;
    const dsi = STEM.indexOf(dayStem);
    const hsi = (dsi * 2 + hbi) % 10;
    return { s: STEM[hsi], b: BRANCH[hbi] };
}

/* ========================================
   9. Hidden Stems/ì‹­ì‹ /12ìš´ì„±/StrongWeak
   ======================================== */

/* ----------------------------------------
   9-1. Complete Hidden Stems Analysis
   ---------------------------------------- */
function analyzeJijanggan(saju) {
    const dm = saju.day.s;
    const dmi = STEM.indexOf(dm);
    const result = { pillars: [], summary: { elements: {wood:0,fire:0,earth:0,metal:0,water:0}, gods: {}, tougans: [] } };
    
    const pillarNames = ['Year Branch', 'Month Branch', 'Day Branch', 'Hour Branch'];
    const branches = [saju.year?.b, saju.month?.b, saju.day?.b, saju.hour?.b];
    const stems = [saju.year?.s, saju.month?.s, saju.day?.s, saju.hour?.s];
    
    branches.forEach((branch, pIdx) => {
        if (!branch) return;
        const bi = BRANCH.findIndex(br => br.c === branch.c);
        const jj = HIDDEN_STEMS[bi];
        
        const pillarInfo = {
            name: pillarNames[pIdx],
            branch: branch,
            hidden: []
        };
        
        jj.forEach((h, hIdx) => {
            const hiddenStem = STEM[h.stem];
            const god = getTenGod(hiddenStem, dm);
            const isJunggi = hIdx === jj.length - 1; // Last is Main
            
            // Stem Emergence (Stem Reveal) ì²´í¬ - Hidden Stemsì´ ì²œê°„ì— ë‚˜íƒ€ë‚¬ëŠ”ì§€
            const tougan = stems.some((s, si) => s && STEM.indexOf(s) === h.stem);
            
            // Root Connection (Root Analysis) ì²´í¬ - ì²œê°„ì´ Hidden Stemsì— ë¿Œë¦¬ë¥¼ ë‘ì—ˆëŠ”ì§€
            const tonggeun = stems.some((s, si) => {
                if (!s) return false;
                return STEM.indexOf(s) === h.stem;
            });
            
            const hiddenInfo = {
                stem: hiddenStem,
                type: isJunggi ? 'Main' : (hIdx === 0 ? 'Side' : 'Middle'),
                days: h.days,
                god: god,
                tougan: tougan,
                tonggeun: tonggeun,
                strength: isJunggi ? 1.0 : (hIdx === 0 ? 0.3 : 0.5) // Main:1.0, Middle:0.5, Side:0.3
            };
            
            pillarInfo.hidden.push(hiddenInfo);
            
            // Summary count
            result.summary.elements[hiddenStem.e] += hiddenInfo.strength;
            if (!result.summary.gods[god.k]) result.summary.gods[god.k] = 0;
            result.summary.gods[god.k] += hiddenInfo.strength;
            
            // Record emergence
            if (tougan && !result.summary.tougans.find(t => t.stem === h.stem)) {
                result.summary.tougans.push({ 
                    stem: h.stem, 
                    name: hiddenStem.c + hiddenStem.k, 
                    from: pillarNames[pIdx],
                    god: god.k
                });
            }
        });
        
        result.pillars.push(pillarInfo);
    });
    
    return result;
}

/* ----------------------------------------
   9-2. Root/Reveal Analysis
   ---------------------------------------- */
function analyzeTonggeunTougan(saju) {
    const result = { tonggeun: [], tougan: [] };
    const dm = saju.day.s;
    const pillarNames = ['Year', 'Month', 'Day', 'Hour'];
    const branchNames = ['Year Branch', 'Month Branch', 'Day Branch', 'Hour Branch'];
    const branches = [saju.year?.b, saju.month?.b, saju.day?.b, saju.hour?.b];
    const stems = [saju.year?.s, saju.month?.s, saju.day?.s, saju.hour?.s];
    
    // ====== í†µê·¼ ë¶„ì„ (ê°™ì€ ì²œê°„ì€ í•˜ë‚˜ë¡œ í•©ì¹¨) ======
    const stemRootsMap = {}; // {stemChar: {stem, god, roots[]}}
    const processedStemChars = new Set(); // ì´ë¯¸ ì²˜ë¦¬í•œ ì²œê°„ ë¬¸ì
    
    stems.forEach((stem, sIdx) => {
        if (!stem) return;
        const si = STEM.indexOf(stem);
        const stemKey = stem.c; // ê°™ì€ ì²œê°„ ë¬¸ìë¡œ ê·¸ë£¹í™”
        
        // ì´ë¯¸ ì²˜ë¦¬í•œ ì²œê°„ì´ë©´ ìŠ¤í‚µ (ì¤‘ë³µ ë°©ì§€)
        if (processedStemChars.has(stemKey)) return;
        processedStemChars.add(stemKey);
        
        branches.forEach((branch, bIdx) => {
            if (!branch) return;
            const bi = BRANCH.findIndex(br => br.c === branch.c);
            const jj = HIDDEN_STEMS[bi];
            
            jj.forEach((h, hIdx) => {
                if (h.stem === si) {
                    const isJunggi = hIdx === jj.length - 1;
                    const rootInfo = {
                        pillar: branchNames[bIdx],
                        branch: branch.c,
                        type: isJunggi ? 'Main' : (hIdx === 0 ? 'Side' : 'Middle'),
                        strength: isJunggi ? 'Strong' : (hIdx === 0 ? 'Weak' : 'Medium')
                    };
                    
                    if (!stemRootsMap[stemKey]) {
                        stemRootsMap[stemKey] = {
                            stem: stem.c + stem.k,
                            god: sIdx === 2 ? 'Day Master' : getTenGod(stem, dm).k,
                            roots: []
                        };
                    }
                    
                    // ì¤‘ë³µ root ì²´í¬ (ê°™ì€ pillar+branch ì¡°í•©)
                    const exists = stemRootsMap[stemKey].roots.some(r => 
                        r.pillar === rootInfo.pillar && r.branch === rootInfo.branch
                    );
                    if (!exists) {
                        stemRootsMap[stemKey].roots.push(rootInfo);
                    }
                }
            });
        });
    });
    
    result.tonggeun = Object.values(stemRootsMap).filter(t => t.roots.length > 0);
    
    // ====== íˆ¬ê°„ ë¶„ì„ (ì¤‘ë³µ ì œê±°) ======
    const touganSet = new Set();
    branches.forEach((branch, bIdx) => {
        if (!branch) return;
        const bi = BRANCH.findIndex(br => br.c === branch.c);
        const jj = HIDDEN_STEMS[bi];
        
        jj.forEach(h => {
            stems.forEach((stem, sIdx) => {
                if (!stem) return;
                if (STEM.indexOf(stem) === h.stem) {
                    const key = stem.c;
                    if (!touganSet.has(key)) {
                        touganSet.add(key);
                        result.tougan.push({
                            stem: stem.c + stem.k,
                            pillar: pillarNames[sIdx],
                            from: branchNames[bIdx],
                            god: sIdx === 2 ? 'Day Master' : getTenGod(stem, dm).k
                        });
                    }
                }
            });
        });
    });
    
    return result;
}

/* ----------------------------------------
   9-3. Ten Gods Detailed Analysis
   ---------------------------------------- */
function getTenGod(stem, dayStem) {
    const dEl = EL_ORDER.indexOf(dayStem.e);
    const sEl = EL_ORDER.indexOf(stem.e);
    const diff = (sEl - dEl + 5) % 5;
    const samePol = (dayStem.y === stem.y);
    const godKeys = ['bijeon','geupjae','siksin','sanggwan','pyeonjae','jeongjae','pyeongwan','jeonggwan','pyeonin','jeongin'];
    const godMap = { 0: samePol ? 0 : 1, 1: samePol ? 2 : 3, 2: samePol ? 4 : 5, 3: samePol ? 6 : 7, 4: samePol ? 8 : 9 };
    return TEN_GODS[godKeys[godMap[diff]]];
}

function getTwelveState(dayStem, branch) {
    // ğŸ”¥ 12ìš´ì„± ê³„ì‚° ìˆ˜ì • - Gemini Round 10
    // ê° ì¼ê°„ì˜ ì¥ìƒ ìœ„ì¹˜ (ì§€ì§€ ì¸ë±ìŠ¤)
    // ç”²:äº¥(11), ä¹™:åˆ(6), ä¸™:å¯…(2), ä¸:é…‰(9), æˆŠ:å¯…(2), å·±:é…‰(9), åºš:å·³(5), è¾›:å­(0), å£¬:ç”³(8), ç™¸:å¯(3)
    const starts = [11, 6, 2, 9, 2, 9, 5, 0, 8, 3];
    const dsi = STEM.indexOf(dayStem);
    const bi = BRANCH.findIndex(br => br.c === branch.c);
    const start = starts[dsi];
    
    // ì–‘ê°„(é™½å¹²): ìˆœí–‰, ìŒê°„(é™°å¹²): ì—­í–‰
    // ì–‘ê°„: (bi - start + 12) % 12
    // ìŒê°„: (start - bi + 12) % 12
    const idx = dayStem.y ? (bi - start + 12) % 12 : (start - bi + 12) % 12;
    return TWELVE_STATES[idx];
}

/* ========================================
   Sound-Element (Sound Element) ê³„ì‚°
   ======================================== */
function calcNapeum(stem, branch) {
    const si = STEM.indexOf(stem);
    const bi = BRANCH.findIndex(br => br.c === branch.c);
    
    // v4.12.6 FIX: ì •í™•í•œ 60ê°‘ì ì¸ë±ìŠ¤ ê³„ì‚°
    const diff = (bi - si + 12) % 12;
    if (diff % 2 !== 0) {
        // ìŒì–‘ ë¶ˆì¼ì¹˜ (ì´ë¡ ìƒ ë°œìƒí•˜ë©´ ì•ˆë¨)
        console.warn('Napeum: ìŒì–‘ ë¶ˆì¼ì¹˜', stem.c, branch.c);
        return { name: 'Unknown', element: 'earth', elementK: 'í† ', desc: '' };
    }
    const idx60 = si + ((6 - diff / 2) % 6) * 10;
    const napeumIdx = Math.floor(idx60 / 2);
    
    const napeum = NAPEUM[napeumIdx];
    return {
        name: napeum.name,
        element: napeum.element,
        elementK: ELEMENT[napeum.element].k,
        desc: napeum.desc
    };
}

/* ========================================
   å‘½å®®(Life Palace) ê³„ì‚°
   ======================================== */
function calcMyunggung(monthBranch, hourBranch) {
    // å‘½å®®(Life Palace) = (14 - Month Branch - Hour Branch) % 12
    const mbi = BRANCH.findIndex(br => br.c === monthBranch.c);
    const hbi = BRANCH.findIndex(br => br.c === hourBranch.c);
    const mgIdx = (14 - mbi - hbi + 24) % 12;
    const mgBranch = BRANCH[mgIdx];
    
    // å‘½å®®(Life Palace) interpretations
    const mgDesc = {
        0: {name: 'å­(Rat) Palace (å­å®®)', trait: 'Wise and composed. Many secrets, active at night.', career: 'Research, Philosophy, Night industries'},
        1: {name: 'ä¸‘(Ox) Palace (ä¸‘å®®)', trait: 'Diligent with persistence. Talent for accumulating wealth.', career: 'Finance, Real Estate, Agriculture'},
        2: {name: 'å¯…(Tiger) Palace (å¯…å®®)', trait: 'Ambitious and brave. Strong leadership qualities.', career: 'Military, Politics, Sports'},
        3: {name: 'å¯(Rabbit) Palace (å¯å®®)', trait: 'Gentle and artistic. Naturally popular.', career: 'Arts, Design, Service industries'},
        4: {name: 'è¾°(Dragon) Palace (è¾°å®®)', trait: 'Unpredictable and mysterious. Big dreams.', career: 'Religion, Philosophy, Entrepreneurship'},
        5: {name: 'å·³(Snake) Palace (å·³å®®)', trait: 'Wise and cautious. Keeps secrets well.', career: 'Law, Medicine, Counseling'},
        6: {name: 'åˆ(Horse) Palace (åˆå®®)', trait: 'Passionate and proactive. Values honor.', career: 'Politics, Entertainment, Education'},
        7: {name: 'æœª(Goat) Palace (æœªå®®)', trait: 'Soft and artistic. Strong service spirit.', career: 'Arts, Religion, Healthcare'},
        8: {name: 'ç”³(Monkey) Palace (ç”³å®®)', trait: 'Clever and witty. Excellent communication skills.', career: 'Sales, Diplomacy, IT'},
        9: {name: 'é…‰(Rooster) Palace (é…‰å®®)', trait: 'Delicate perfectionist. Exceptional aesthetic sense.', career: 'Finance, Jewelry, Beauty'},
        10: {name: 'æˆŒ(Dog) Palace (æˆŒå®®)', trait: 'Loyal and faithful. Strong sense of responsibility.', career: 'Military, Police, Security'},
        11: {name: 'äº¥(Pig) Palace (äº¥å®®)', trait: 'Optimistic with great relationships. Much fortune.', career: 'Trade, Travel, Distribution'}
    };
    
    return {
        branch: mgBranch,
        index: mgIdx,
        ...mgDesc[mgIdx]
    };
}

/* ========================================
   íƒœì›(èƒå…ƒ) ê³„ì‚°
   ======================================== */
function calcTaewon(yearStem, monthStem, monthBranch) {
    // Conception Origin = Month Stem +1, Month Branch +3
    const msi = STEM.indexOf(monthStem);
    const mbi = BRANCH.findIndex(br => br.c === monthBranch.c);
    
    const tStem = STEM[(msi + 1) % 10];
    const tBranch = BRANCH[(mbi + 3) % 12];
    
    // Conception Origin influence on chart
    const napeum = calcNapeum(tStem, tBranch);
    
    return {
        stem: tStem,
        branch: tBranch,
        pillar: tStem.c + tBranch.c,
        napeum: napeum,
        desc: `Energy at conception. ${napeum.name} (${ELEMENT[napeum.element].k}) energy influence at birth.`
    };
}

/* ========================================
   Directional Harmony Analysis
   ======================================== */
function analyzeBanghap(saju) {
    const branches = [];
    if (saju.year) branches.push(BRANCH.findIndex(br => br.c === saju.year.b.c));
    if (saju.month) branches.push(BRANCH.findIndex(br => br.c === saju.month.b.c));
    if (saju.day) branches.push(BRANCH.findIndex(br => br.c === saju.day.b.c));
    if (saju.hour) branches.push(BRANCH.findIndex(br => br.c === saju.hour.b.c));
    
    // ğŸ”¥ ì›”ì§€ ì¸ë±ìŠ¤ (ì¤€ ë°©í•© íŒë‹¨ìš©) - Gemini Round 10
    const monthBranchIdx = saju.month ? BRANCH.findIndex(br => br.c === saju.month.b.c) : -1;
    
    const results = [];
    
    for (const bh of BANGHAP) {
        const has = bh.branches.map(b => branches.includes(b));
        const count = has.filter(x => x).length;
        
        if (count === 3) {
            // Complete Directional Harmony
            results.push({
                type: 'complete',
                name: bh.name,
                dir: bh.dir,
                element: bh.element,
                elementK: ELEMENT[bh.element].k,
                branches: bh.branches.map(b => BRANCH[b].c).join(''),
                power: 'Strong',
                desc: `${bh.dir} Complete! ${ELEMENT[bh.element].k} energy becomes very strong.`
            });
        } else if (count === 2) {
            // ğŸ”¥ ì¤€ ë°©í•©(Quasi Bureau) - ì›”ì§€ í¬í•¨ ì‹œ ë” ê°•ë ¥ - Gemini Round 10
            const missing = bh.branches.find((b, i) => !has[i]);
            const hasMonthBranch = has[bh.branches.indexOf(monthBranchIdx)] || bh.branches.some((b, i) => has[i] && b === monthBranchIdx);
            const isQuasi = bh.branches.filter((b, i) => has[i]).includes(monthBranchIdx);
            
            results.push({
                type: isQuasi ? 'quasi' : 'partial',
                name: isQuasi ? bh.name + ' Quasi Bureau' : bh.name + ' Incomplete',
                dir: bh.dir,
                element: bh.element,
                elementK: ELEMENT[bh.element].k,
                branches: bh.branches.filter((b, i) => has[i]).map(b => BRANCH[b].c).join(''),
                missing: BRANCH[missing].c,
                power: isQuasi ? 'Strong' : 'Medium',
                desc: isQuasi 
                    ? `Quasi ${bh.dir}! Month Branch included = ${ELEMENT[bh.element].k} energy is DOMINANT even without third branch.`
                    : `When ${BRANCH[missing].c} arrives, ${bh.dir} direction completes.`
            });
        }
    }
    
    return results;
}

/* ========================================
   Hidden Harmony Analysis
   ======================================== */
function analyzeAmhap(saju) {
    const branches = [];
    const pillars = ['Year Branch', 'Month Branch', 'Day Branch', 'Hour Branch'];
    
    if (saju.year) branches.push({idx: BRANCH.findIndex(br => br.c === saju.year.b.c), name: 'Year Branch', c: saju.year.b.c});
    if (saju.month) branches.push({idx: BRANCH.findIndex(br => br.c === saju.month.b.c), name: 'Month Branch', c: saju.month.b.c});
    if (saju.day) branches.push({idx: BRANCH.findIndex(br => br.c === saju.day.b.c), name: 'Day Branch', c: saju.day.b.c});
    if (saju.hour) branches.push({idx: BRANCH.findIndex(br => br.c === saju.hour.b.c), name: 'Hour Branch', c: saju.hour.b.c});
    
    const results = [];
    
    for (let i = 0; i < branches.length; i++) {
        for (let j = i + 1; j < branches.length; j++) {
            for (const ah of AMHAP) {
                if ((branches[i].idx === ah.a && branches[j].idx === ah.b) ||
                    (branches[i].idx === ah.b && branches[j].idx === ah.a)) {
                    results.push({
                        name: ah.name,
                        positions: `${branches[i].name}(${branches[i].c})â†”${branches[j].name}(${branches[j].c})`,
                        desc: ah.desc,
                        meaning: 'A hidden connection not visible on the surface. Represents secret bonds and unseen relationships.'
                    });
                }
            }
        }
    }
    
    return results;
}

/* ========================================
   Empty Void Resolution Analysis
   ======================================== */
function analyzeGongmangHaeso(saju, gongmang) {
    if (!gongmang || !gongmang.affected || gongmang.affected.length === 0) {
        return { hasGongmang: false, results: [] };
    }
    
    const branches = [];
    if (saju.year) branches.push(BRANCH.findIndex(br => br.c === saju.year.b.c));
    if (saju.month) branches.push(BRANCH.findIndex(br => br.c === saju.month.b.c));
    if (saju.day) branches.push(BRANCH.findIndex(br => br.c === saju.day.b.c));
    if (saju.hour) branches.push(BRANCH.findIndex(br => br.c === saju.hour.b.c));
    
    const results = [];
    
    for (const affected of gongmang.affected) {
        // Find void branches
        const gmBranchIdx = BRANCH.findIndex(b => affected.includes(b.k) || affected.includes(b.c));
        if (gmBranchIdx === -1) continue;
        
        let resolved = false;
        let resolveMethod = '';
        
        // Clash resolution check
        const chungPair = (gmBranchIdx + 6) % 12;
        if (branches.includes(chungPair)) {
            resolved = true;
            resolveMethod = `Resolved by ${BRANCH[chungPair].c} Clash`;
        }
        
        // Trinity resolution check
        const samhapSets = [[0,4,8], [1,5,9], [2,6,10], [3,7,11]];
        for (const set of samhapSets) {
            if (set.includes(gmBranchIdx)) {
                const others = set.filter(s => s !== gmBranchIdx);
                if (others.every(o => branches.includes(o))) {
                    resolved = true;
                    resolveMethod = `Resolved by Trinity (${set.map(s => BRANCH[s].c).join('')})`;
                }
            }
        }
        
        results.push({
            position: affected,
            branch: BRANCH[gmBranchIdx].c,
            resolved: resolved,
            method: resolveMethod,
            effect: resolved ? 
                'Void is resolved â€” this energy functions properly in your chart.' : 
                'Void remains unresolved â€” this energy is weakened. May be activated during favorable Annual or Life Cycles.'
        });
    }
    
    return { hasGongmang: true, results };
}

/* ========================================
   Divine Star Position Analysis
   ======================================== */
function analyzeSinsalPosition(saju) {
    const results = [];
    const positions = [
        {name: 'Year Branch', b: saju.year?.b, meaning: 'Ancestors, Society', age: 'Childhood (0-15)'},
        {name: 'Month Branch', b: saju.month?.b, meaning: 'Parents, Siblings', age: 'Youth (15-30)'},
        {name: 'Day Branch', b: saju.day?.b, meaning: 'Spouse, Self', age: 'Middle age (30-45)'},
        {name: 'Hour Branch', b: saju.hour?.b, meaning: 'Children, Later years', age: 'Later years (45+)'}
    ];
    
    const ybi = BRANCH.findIndex(br => br.c === saju.year?.b?.c);
    
    // Peach Blossom position analysis
    const taohua = {0:9,1:6,2:3,3:0,4:9,5:6,6:3,7:0,8:9,9:6,10:3,11:0};
    for (const pos of positions) {
        if (!pos.b) continue;
        const bi = BRANCH.findIndex(br => br.c === pos.b.c);
        if (bi === taohua[ybi]) {
            results.push({
                sinsal: 'Peach Blossom (æ¡ƒèŠ±æ®º)',
                position: pos.name,
                interpretation: pos.name === 'Year Branch' ? 'Popular since childhood. Early romance possible.' :
                               pos.name === 'Month Branch' ? 'Popular during school years. Entertainment star quality.' :
                               pos.name === 'Day Branch' ? 'Attractive spouse. You also radiate charm.' :
                               'Beautiful or popular children. Popular even in later years.',
                advice: pos.name === 'Day Branch' ? 'Be mindful of temptation in your relationship' : 'Use your charm as a strength'
            });
        }
    }
    
    // Traveling Horse position analysis
    const yima = {0:2,1:11,2:8,3:5,4:2,5:11,6:8,7:5,8:2,9:11,10:8,11:5};
    for (const pos of positions) {
        if (!pos.b) continue;
        const bi = BRANCH.findIndex(br => br.c === pos.b.c);
        if (bi === yima[ybi]) {
            results.push({
                sinsal: 'Traveling Horse (é©›é¦¬æ®º)',
                position: pos.name,
                interpretation: pos.name === 'Year Branch' ? 'Ancestors moved frequently or lived away from home.' :
                               pos.name === 'Month Branch' ? 'Moved often in childhood. Study abroad possible.' :
                               pos.name === 'Day Branch' ? 'Frequent travel for work. Spouse is a busy person.' :
                               'Active in later years. Children may live far away.',
                advice: 'Staying still is not good. Stay active!'
            });
        }
    }
    
    // Canopy Star position analysis
    const huagai = {0:4,1:1,2:10,3:7,4:4,5:1,6:10,7:7,8:4,9:1,10:10,11:7};
    for (const pos of positions) {
        if (!pos.b) continue;
        const bi = BRANCH.findIndex(br => br.c === pos.b.c);
        if (bi === huagai[ybi]) {
            results.push({
                sinsal: 'Canopy Star (è¯è“‹æ®º)',
                position: pos.name,
                interpretation: pos.name === 'Year Branch' ? 'Artists or religious figures among ancestors.' :
                               pos.name === 'Month Branch' ? 'Lonely during school years. Interest in art/philosophy.' :
                               pos.name === 'Day Branch' ? 'Spouse is artistic or spiritual. Values inner world.' :
                               'May dive into religion/philosophy in later years. Possible solitude.',
                advice: 'Find comfort in spiritual activities like art, religion, or academics'
            });
        }
    }
    
    return results;
}

/* ========================================
   Life Cycle Transition Analysis
   ======================================== */
function analyzeGyoungi(luck, birthYear, currentYear) {
    const age = currentYear - birthYear + 1;
    const results = [];
    
    for (let i = 0; i < luck.length - 1; i++) {
        const curr = luck[i];
        const next = luck[i + 1];
        
        // Cycle transition timing (å¤§é‹(Life Cycle)ì´ ë°”ë€Œê¸° 1ë…„ ì „ë¶€í„° 1ë…„ í›„)
        const transitionAge = next.startAge;
        const transitionYear = birthYear + transitionAge - 1;
        
        // Check if current age is near transition (Â±2ë…„)
        if (Math.abs(age - transitionAge) <= 2) {
            // Stems ë³€í™”
            const stemChange = `${curr.s.c}â†’${next.s.c}`;
            const branchChange = `${curr.b.c}â†’${next.b.c}`;
            
            // Five Elements ë³€í™”
            const fromEl = ELEMENT[curr.s.e].k + ELEMENT[curr.b.e].k;
            const toEl = ELEMENT[next.s.e].k + ELEMENT[next.b.e].k;
            
            // Check if drastic change
            let intensity = 'normal';
            let warning = '';
            
            // Dramatic change if elements become destructive
            const elIdx1 = EL_ORDER.indexOf(curr.s.e);
            const elIdx2 = EL_ORDER.indexOf(next.s.e);
            if (Math.abs(elIdx1 - elIdx2) === 2 || Math.abs(elIdx1 - elIdx2) === 3) {
                intensity = 'strong';
                warning = 'Major elemental shift period. Significant life changes may come.';
            }
            
            // From good luck to bad, or vice versa
            if (curr.rating !== next.rating) {
                intensity = 'strong';
                if (curr.rating === 'good' && next.rating === 'bad') {
                    warning += ' Transitioning from good to challenging luck. Prepare in advance.';
                } else if (curr.rating === 'bad' && next.rating === 'good') {
                    warning += ' Difficult luck ends and good luck comes. Have hope!';
                }
            }
            
            results.push({
                transitionAge: transitionAge,
                transitionYear: transitionYear,
                from: `${curr.s.c}${curr.b.c} (${fromEl})`,
                to: `${next.s.c}${next.b.c} (${toEl})`,
                stemChange: stemChange,
                branchChange: branchChange,
                intensity: intensity,
                warning: warning || 'Life Cycle transitions naturally.',
                advice: intensity === 'strong' ? 
                    'This period is a major turning point. Make big decisions carefully!' :
                    'Adapt naturally to the changes ahead.',
                isCurrent: Math.abs(age - transitionAge) <= 1
            });
        }
    }
    
    return results;
}

function calcStrength(saju) {
    const dm = saju.day.s;
    const dme = dm.e;
    const mbi = BRANCH.indexOf(saju.month.b);
    const season = SEASON[mbi];
    let score = 0;
    const factors = [];
    
    // ====== ì˜¤í–‰ ê´€ê³„ ì •ì˜ ======
    const peerEl = dme;  // ë¹„ê² (ê°™ì€ ì˜¤í–‰)
    const sealEl = EL_ORDER[(EL_ORDER.indexOf(dme) + 4) % 5];  // ì¸ì„± (ë‚˜ë¥¼ ìƒí•¨)
    const exprEl = EL_ORDER[(EL_ORDER.indexOf(dme) + 1) % 5];  // Expression (ë‚´ê°€ ìƒí•¨)
    const wealthEl = EL_ORDER[(EL_ORDER.indexOf(dme) + 2) % 5]; // ì¬ì„± (ë‚´ê°€ ê·¹í•¨)
    const officerEl = EL_ORDER[(EL_ORDER.indexOf(dme) + 3) % 5]; // ê´€ì„± (ë‚˜ë¥¼ ê·¹í•¨)
    const myEls = [peerEl, sealEl];
    
    // ====== ì§€ì¥ê°„ í…Œì´ë¸” (ì—¬ê¸°, ì¤‘ê¸°, ì •ê¸°) - v4.14.1 í‘œì¤€ ìˆ˜ì • ======
    const JIJANGGAN = {
        0: [{s:8, w:0.33}, {s:9, w:0.67}],                   // å­: å£¬(ì—¬ê¸°), ç™¸(ì •ê¸°)
        1: [{s:9, w:0.3}, {s:7, w:0.1}, {s:5, w:0.6}],      // ä¸‘: ç™¸, è¾›, å·±
        2: [{s:4, w:0.23}, {s:2, w:0.23}, {s:0, w:0.54}],   // å¯…: æˆŠ, ä¸™, ç”²
        3: [{s:0, w:0.33}, {s:1, w:0.67}],                   // å¯: ç”²(ì—¬ê¸°), ä¹™(ì •ê¸°)
        4: [{s:1, w:0.3}, {s:9, w:0.1}, {s:4, w:0.6}],      // è¾°: ä¹™, ç™¸(æ°´æ ¹!), æˆŠ
        5: [{s:4, w:0.23}, {s:6, w:0.23}, {s:2, w:0.54}],   // å·³: æˆŠ, åºš, ä¸™
        6: [{s:2, w:0.33}, {s:5, w:0.3}, {s:3, w:0.37}],    // åˆ: ä¸™(ì—¬ê¸°), å·±, ä¸
        7: [{s:3, w:0.3}, {s:1, w:0.1}, {s:5, w:0.6}],      // æœª: ä¸, ä¹™, å·±
        8: [{s:4, w:0.23}, {s:8, w:0.23}, {s:6, w:0.54}],   // ç”³: æˆŠ, å£¬(æ°´æ ¹!), åºš
        9: [{s:6, w:0.33}, {s:7, w:0.67}],                   // é…‰: åºš(ì—¬ê¸°), è¾›(ì •ê¸°)
        10:[{s:7, w:0.3}, {s:3, w:0.1}, {s:4, w:0.6}],      // æˆŒ: è¾›, ä¸, æˆŠ (NO WATER!)
        11:[{s:4, w:0.23}, {s:0, w:0.23}, {s:8, w:0.54}]    // äº¥: æˆŠ, ç”², å£¬
    };
    
    // ====== ì²œê°„ ìˆ˜ì§‘ ======
    const allStems = [saju.year.s, saju.month.s, saju.hour?.s].filter(s => s);
    const allBranches = [saju.year.b, saju.month.b, saju.day.b, saju.hour?.b].filter(b => b);
    const branchIndices = allBranches.map(b => BRANCH.indexOf(b));
    
    // ====== â˜…â˜…â˜… 1. ì²œê°„í•© ë¬´ë ¥í™” ì²´í¬ (v4.12.1 ì¸ì ‘ì„± ì²´í¬) â˜…â˜…â˜… ======
    // ì²œê°„í•©ì€ ì¸ì ‘í•œ ê¸°ë‘¥ë¼ë¦¬ë§Œ ì„±ë¦½! (ë…„-ì›”, ì›”-ì¼, ì¼-ì‹œ)
    // ë…„-ì‹œì²˜ëŸ¼ ë©€ë¦¬ ë–¨ì–´ì§„ ì²œê°„ì€ í•© ë¶ˆì„±ë¦½
    const STEM_COMBINE = [[0,5],[1,6],[2,7],[3,8],[4,9]]; // ç”²å·±, ä¹™åºš, ä¸™è¾›, ä¸å£¬, æˆŠç™¸
    
    let disabledSeals = [];  // í•©ìœ¼ë¡œ ë¬´ë ¥í™”ëœ ì¸ì„±
    let disabledPeers = [];  // í•©ìœ¼ë¡œ ë¬´ë ¥í™”ëœ ë¹„ê²
    
    // ì¸ì ‘í•œ ê¸°ë‘¥ ìŒë§Œ ê²€ì‚¬
    const adjacentPairs = [
        { pos1: 'year', pos2: 'month', s1: saju.year.s, s2: saju.month.s },
        { pos1: 'month', pos2: 'day', s1: saju.month.s, s2: saju.day.s },
        { pos1: 'day', pos2: 'hour', s1: saju.day.s, s2: saju.hour?.s }
    ];
    
    adjacentPairs.forEach(pair => {
        if (!pair.s1 || !pair.s2) return;
        const idx1 = STEM.indexOf(pair.s1);
        const idx2 = STEM.indexOf(pair.s2);
        
        // í•© ì¡°ê±´ ì²´í¬
        const isCombine = STEM_COMBINE.some(([a, b]) => 
            (idx1 === a && idx2 === b) || (idx1 === b && idx2 === a)
        );
        
        if (isCombine) {
            // ì¸ì ‘í•© ì„±ë¦½ â†’ í•´ë‹¹ ì²œê°„ë“¤ ë¬´ë ¥í™”
            // ë‹¨, ì¼ê°„ì€ ë¬´ë ¥í™”ë˜ì§€ ì•ŠìŒ (ë³¸ì¸ì€ í•©ê±° ì•ˆë¨)
            if (pair.pos1 !== 'day') {
                if (pair.s1.e === sealEl) disabledSeals.push(idx1);
                if (pair.s1.e === peerEl) disabledPeers.push(idx1);
            }
            if (pair.pos2 !== 'day') {
                if (pair.s2.e === sealEl) disabledSeals.push(idx2);
                if (pair.s2.e === peerEl) disabledPeers.push(idx2);
            }
            
            factors.push({ l: 'ğŸ”— å¤©å¹²åˆ', v: `${pair.s1.c}${pair.s2.c}åˆ (${pair.pos1}-${pair.pos2}) â†’ Neutralized`, p: false });
        }
    });
    
    // ====== â˜…â˜…â˜… 2. ì›”ë ¹ ë“ë ¹/ì‹¤ë ¹ (v4.12.1 ê°•í™” + í† ì™•ìš©ì‚¬) â˜…â˜…â˜… ======
    // í† ì™•ìš©ì‚¬: è¾°(4), æœª(7), æˆŒ(10), ä¸‘(1)ì€ åœŸê°€ ì™•ì„±í•œ ë‹¬
    const earthMonths = [1, 4, 7, 10]; // ä¸‘, è¾°, æœª, æˆŒ
    const isEarthMonth = earthMonths.includes(mbi);
    
    // ì›”ë ¹ë³„ ì˜¤í–‰ ì™•ì‡  (ë” ì •ë°€í•œ í…Œì´ë¸”)
    // å¯…å¯=æœ¨ì™•, å·³åˆ=ç«ì™•, ç”³é…‰=é‡‘ì™•, äº¥å­=æ°´ì™•, è¾°æˆŒä¸‘æœª=åœŸì™•
    const monthScore = {
        // å¯…(2), å¯(3) = æœ¨ì™•
        2: {wood:3, fire:1, earth:-2, metal:-2, water:-1},
        3: {wood:3, fire:2, earth:-2, metal:-2, water:-1},
        // è¾°(4) = åœŸì™• (ë´„â†’ì—¬ë¦„ ì „í™˜, ìŠµí† )
        4: {earth:2, wood:0, fire:-1, metal:-1, water:-1},
        // å·³(5), åˆ(6) = ç«ì™•
        5: {fire:3, earth:1, metal:-2, water:-2, wood:0},
        6: {fire:3, earth:2, metal:-2, water:-2, wood:0},
        // æœª(7) = åœŸì™• (ì—¬ë¦„â†’ê°€ì„ ì „í™˜, ì¡°í† )
        7: {earth:2, fire:1, wood:-1, metal:-1, water:-2},
        // ç”³(8), é…‰(9) = é‡‘ì™•
        8: {metal:3, water:1, wood:-2, fire:-2, earth:0},
        9: {metal:3, water:2, wood:-2, fire:-2, earth:0},
        // æˆŒ(10) = åœŸì™• (ê°€ì„â†’ê²¨ìš¸ ì „í™˜, ì¡°í† )
        10: {earth:2, metal:1, fire:-1, wood:-2, water:-1},
        // äº¥(11), å­(0) = æ°´ì™•
        11: {water:3, wood:1, fire:-2, earth:-2, metal:0},
        0: {water:3, wood:2, fire:-2, earth:-2, metal:0},
        // ä¸‘(1) = åœŸì™• (ê²¨ìš¸â†’ë´„ ì „í™˜, ìŠµí† )
        1: {earth:2, water:0, metal:-1, wood:-1, fire:-2}
    };
    
    const ms = monthScore[mbi][dme];
    const deukRyung = ms >= 2;
    score += ms * 6;  // ê°•í™”: *6
    
    const monthNames = ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
    factors.push({ l: 'æœˆä»¤ (Seasonal Power)', v: `${monthNames[mbi]}ì›” ${deukRyung ? 'âœ“ In Season' : 'âœ— Out of Season'} (${ms >= 0 ? '+' : ''}${ms*6})`, p: deukRyung });
    
    // ====== â˜…â˜…â˜… 3. ì‹¤ì œ í†µê·¼ ì²´í¬ (12ìš´ì„± ì•„ë‹Œ ì§€ì¥ê°„ ê¸°ì¤€) â˜…â˜…â˜… ======
    let realRootScore = 0;
    let hasRealRoot = { day: false, hour: false };
    
    allBranches.forEach((b, idx) => {
        const bi = BRANCH.indexOf(b);
        const position = ['year', 'month', 'day', 'hour'][idx];
        const posWeight = position === 'day' ? 1.5 : position === 'hour' ? 1.3 : position === 'month' ? 1.2 : 1.0;
        
        const hidden = JIJANGGAN[bi] || [];
        hidden.forEach(h => {
            const hStem = STEM[h.s];
            // ì§€ì¥ê°„ì— ë¹„ê²(ê°™ì€ ì˜¤í–‰) ë˜ëŠ” ì¸ì„±(ë‚˜ë¥¼ ìƒí•˜ëŠ” ì˜¤í–‰)ì´ ìˆìœ¼ë©´ ì§„ì§œ ë¿Œë¦¬
            if (hStem.e === peerEl || hStem.e === sealEl) {
                realRootScore += h.w * posWeight * 2;
                if (position === 'day') hasRealRoot.day = true;
                if (position === 'hour') hasRealRoot.hour = true;
            }
        });
    });
    
    score += Math.min(realRootScore, 10);
    const rootStrong = realRootScore >= 2;
    factors.push({ l: 'é€šæ ¹ (Root Strength)', v: rootStrong ? `âœ“ ${realRootScore.toFixed(1)}pts` : `âœ— No Root (${realRootScore.toFixed(1)})`, p: rootStrong });
    
    // ====== â˜…â˜…â˜… 4. ì²œê°„ ë¹„ê²/ì¸ì„± Revealed (í•© ë¬´ë ¥í™” ë°˜ì˜) â˜…â˜…â˜… ======
    let helpCount = 0;
    let attackCount = 0;
    let exprStemCount = 0;
    
    allStems.forEach((st, idx) => {
        const si = STEM.indexOf(st);
        
        // í•©ìœ¼ë¡œ ë¬´ë ¥í™”ëœ ì²œê°„ì€ ë„ì›€ ì•ˆë¨
        if (disabledSeals.includes(si) || disabledPeers.includes(si)) {
            factors.push({ l: 'âš ï¸ Merged Away', v: `${st.c} Neutralized`, p: false });
            return;
        }
        
        if (st.e === peerEl) { helpCount++; score += 2.5; }
        if (st.e === sealEl) { helpCount++; score += 2; }
        if (st.e === officerEl) { attackCount++; score -= 2; }
        if (st.e === wealthEl) { attackCount++; score -= 1; }
        if (st.e === exprEl) { 
            exprStemCount++; 
            score -= 2;  // Expression Drain
        }
    });
    
    if (helpCount > 0) factors.push({ l: 'å¤©å¹² (Stem) Peer/Seal', v: `${helpCount} Revealed`, p: true });
    if (attackCount > 0) factors.push({ l: 'å¤©å¹² (Stem) Officer/Wealth Pressure', v: `${attackCount}`, p: false });
    
    // ====== â˜…â˜…â˜… 5. Expression Overflow ê°•ë ¥ ê°ì  (v4.12.1 ê°•í™”) â˜…â˜…â˜… ======
    let exprTotal = exprStemCount;
    allBranches.forEach(b => { if (b.e === exprEl) exprTotal++; });
    
    if (exprTotal >= 3) {
        score -= 4;  // Expression 3ê°œ ì´ìƒ = ê°•ë ¥ Drain
        factors.push({ l: 'âš ï¸ Expression Overflow', v: `${exprTotal} â†’ Energy Drain (âˆ’4)`, p: false });
    } else if (exprStemCount >= 2) {
        score -= 2;
        factors.push({ l: 'âš ï¸ Expression Revealed', v: `${exprStemCount}å¤©å¹² (âˆ’2)`, p: false });
    }
    
    // ====== 6. Officer Pressure ======
    let officerTotal = 0;
    [...allStems, ...allBranches].forEach(p => { if (p.e === officerEl) officerTotal++; });
    if (officerTotal >= 2) { 
        score -= 2; 
        factors.push({ l: 'Officer Pressure', v: `${officerTotal} (âˆ’2)`, p: false }); 
    }
    
    // ====== 7. ë°©í•©(æ–¹åˆ) ì²´í¬ ======
    const DIRECTIONAL = [
        { branches: [2, 3, 4], element: 'wood', name: 'å¯…å¯è¾° ëª©êµ­' },
        { branches: [5, 6, 7], element: 'fire', name: 'å·³åˆæœª í™”êµ­' },
        { branches: [8, 9, 10], element: 'metal', name: 'ç”³é…‰æˆŒ ê¸ˆêµ­' },
        { branches: [11, 0, 1], element: 'water', name: 'äº¥å­ä¸‘ ìˆ˜êµ­' }
    ];
    
    let directionalFormed = null;
    DIRECTIONAL.forEach(d => {
        if (d.branches.every(b => branchIndices.includes(b))) {
            directionalFormed = d;
            if (d.element === peerEl) {
                score += 8;
                factors.push({ l: 'ğŸ”¥ æ–¹åˆ', v: `${d.name} â†’ Peer (+8)`, p: true });
            } else if (d.element === sealEl) {
                score += 6;
                factors.push({ l: 'ğŸ”¥ æ–¹åˆ', v: `${d.name} â†’ Seal (+6)`, p: true });
            } else if (d.element === exprEl) {
                score -= 5;
                factors.push({ l: 'âš ï¸ æ–¹åˆ', v: `${d.name} â†’ Drain (âˆ’5)`, p: false });
            } else if (d.element === officerEl) {
                score -= 6;
                factors.push({ l: 'âš ï¸ æ–¹åˆ', v: `${d.name} â†’ Pressure (âˆ’6)`, p: false });
            }
        }
    });
    
    // ====== 8. ì‚¼í•©(ä¸‰åˆ) ì²´í¬ ======
    const THREE_HARMONY = [
        { branches: [2, 6, 10], element: 'fire', name: 'å¯…åˆæˆŒ í™”êµ­' },
        { branches: [8, 0, 4], element: 'water', name: 'ç”³å­è¾° ìˆ˜êµ­' },
        { branches: [5, 9, 1], element: 'metal', name: 'å·³é…‰ä¸‘ ê¸ˆêµ­' },
        { branches: [11, 3, 7], element: 'wood', name: 'äº¥å¯æœª ëª©êµ­' }
    ];
    
    if (!directionalFormed) {
        THREE_HARMONY.forEach(th => {
            if (th.branches.every(b => branchIndices.includes(b))) {
                if (th.element === peerEl) {
                    score += 7;
                    factors.push({ l: 'ğŸ”¥ ä¸‰åˆ', v: `${th.name} â†’ Peer (+7)`, p: true });
                } else if (th.element === sealEl) {
                    score += 5;
                    factors.push({ l: 'ğŸ”¥ ä¸‰åˆ', v: `${th.name} â†’ Seal (+5)`, p: true });
                } else if (th.element === exprEl) {
                    score -= 4;
                    factors.push({ l: 'âš ï¸ ä¸‰åˆ', v: `${th.name} â†’ Drain (âˆ’4)`, p: false });
                }
            }
        });
    }
    
    // ====== ì‹ ê°•/ì‹ ì•½ íŒì • ======
    let type = 'balanced';
    let extreme = null;
    
    if (score >= 15) { type = 'strong'; extreme = 'Extreme Strong'; }
    else if (score >= 8) type = 'strong';
    else if (score >= 3) type = 'balanced';
    else if (score <= -5) { type = 'weak'; extreme = 'Extreme Weak'; }
    else if (score <= 2) type = 'weak';
    
    // ì‹¤ì œ ë¿Œë¦¬ê°€ ìˆìœ¼ë©´ ê·¹ì‹ ì•½ ë¶ˆê°€
    if ((hasRealRoot.day || hasRealRoot.hour) && extreme === 'Extreme Weak') {
        extreme = null;
        type = 'weak';
        factors.push({ l: 'âš¡ Root Adjustment', v: 'Extremely Weak â†’ Weak', p: true });
    }
    
    // ====== í¼ì„¼íŠ¸ ë³€í™˜ ======
    // score ë²”ìœ„: ì•½ -15 ~ +25
    let pct = Math.round(((score + 15) / 40) * 100);
    pct = Math.max(5, Math.min(95, pct));
    
    // ë¿Œë¦¬ ìˆìœ¼ë©´ ìµœì†Œ 15% ë³´ì¥
    if (hasRealRoot.hour && pct < 15) pct = 15;
    if (hasRealRoot.day && pct < 20) pct = 20;

    return { 
        type, 
        score: Math.round(score * 10) / 10, 
        pct, 
        factors, 
        extreme, 
        hourRoot: hasRealRoot.hour,
        dayRoot: hasRealRoot.day,
        disabledSeals,
        disabledPeers
    };
}

/* ========================================
   9-4. ì¡°í›„(èª¿å€™) ê³ ê¸‰ ì ìš©
   ======================================== */

// By month ì¡°í›„ìš©ì‹ í‘œ - Day Masterë³„ ê° ì›”ì˜ ì¡°í›„ìš©ì‹ 
const JOHU_TABLE = {
    // Yang Wood (ç”²æœ¨)
    0: {
        0: {yong:'fire', sub:'wood', desc:'Winter Yang Wood (ç”²) is frozen; it needs Fire for warmth'},  // å­(Rat) month
        1: {yong:'fire', sub:'wood', desc:'ä¸‘(Ox) month Earth-dominant season; Fire is needed to dispel the cold'},
        2: {yong:'water', sub:'fire', desc:'å¯…(Tiger) month spring begins, Water nourishes roots'},
        3: {yong:'water', sub:'fire', desc:'å¯(Rabbit) month Wood dominant, Water provides nourishment'},
        4: {yong:'water', sub:'metal', desc:'è¾°(Dragon) month strong Earth; Water provides balance'},
        5: {yong:'water', sub:'metal', desc:'å·³(Snake) month summer begins, with Water prevent dryness'},
        6: {yong:'water', sub:'metal', desc:'åˆ(Horse) month Fire dominant, Water is essential'},
        7: {yong:'water', sub:'metal', desc:'æœª(Goat) month Earth dominant season, with Water to remove hot dryness'},
        8: {yong:'water', sub:'fire', desc:'ç”³(Monkey) month strong Metal needs Water release'},
        9: {yong:'water', sub:'fire', desc:'é…‰(Rooster) month Metal at its peak; Water releases the energy'},
        10: {yong:'fire', sub:'water', desc:'æˆŒ(Dog) month Earth energy, Fire nurtures Wood'},
        11: {yong:'fire', sub:'water', desc:'äº¥(Pig) month strong Water needs Fire balance'}
    },
    // Yin Wood (ä¹™æœ¨)
    1: {
        0: {yong:'fire', sub:'water', desc:'Winter Yin Wood (ä¹™) is weak warming with Fire'},
        1: {yong:'fire', sub:'water', desc:'ä¸‘(Ox) month cold is strong, Fire essential'},
        2: {yong:'water', sub:'fire', desc:'å¯…(Tiger) month early spring, Water for growth'},
        3: {yong:'fire', sub:'water', desc:'å¯(Rabbit) month Tiger Wood peak, Fire release'},
        4: {yong:'water', sub:'fire', desc:'è¾°(Dragon) month Earth energy, Water nurtures Wood'},
        5: {yong:'water', sub:'metal', desc:'å·³(Snake) month strong Fire needs Water nourishment'},
        6: {yong:'water', sub:'metal', desc:'åˆ(Horse) month hot period Water is essential'},
        7: {yong:'water', sub:'metal', desc:'æœª(Goat) month hot dry, with Water cooling'},
        8: {yong:'fire', sub:'water', desc:'ç”³(Monkey) month Metal peak, Fire controls Metal'},
        9: {yong:'fire', sub:'water', desc:'é…‰(Rooster) month Metal peak, Fire protection'},
        10: {yong:'fire', sub:'water', desc:'æˆŒ(Dog) month Fire stored, warming with Fire'},
        11: {yong:'fire', sub:'wood', desc:'äº¥(Pig) month Water peak, Fire balance'}
    },
    // Yang Fire (ä¸™ç«)
    2: {
        0: {yong:'wood', sub:'earth', desc:'Winter Yang Fire (ä¸™) needs Wood nurturing'},
        1: {yong:'wood', sub:'fire', desc:'ä¸‘(Ox) month cold Earth, Wood nurtures Fire'},
        2: {yong:'water', sub:'metal', desc:'å¯…(Tiger) month Wood creates Fire peak, Water balance'},
        3: {yong:'water', sub:'metal', desc:'å¯(Rabbit) month Wood peak, Water balance'},
        4: {yong:'water', sub:'metal', desc:'è¾°(Dragon) month Earth energy, Water nourishment'},
        5: {yong:'water', sub:'metal', desc:'å·³(Snake) month Fire dominant, Water is essential'},
        6: {yong:'water', sub:'metal', desc:'åˆ(Horse) month sun at peak, with Water cooling down'},
        7: {yong:'water', sub:'metal', desc:'æœª(Goat) month hot dry, with Water cooling'},
        8: {yong:'wood', sub:'water', desc:'ç”³(Monkey) month Metal peak, Wood nurtures Fire'},
        9: {yong:'wood', sub:'water', desc:'é…‰(Rooster) month Metal peak, Wood reinforcement'},
        10: {yong:'wood', sub:'water', desc:'æˆŒ(Dog) month dry Earth, Wood nurtures Fire'},
        11: {yong:'wood', sub:'fire', desc:'äº¥(Pig) month Water dominant, with Wood bridging'}
    },
    // Yin Fire (ä¸ç«)
    3: {
        0: {yong:'wood', sub:'fire', desc:'Winter Yin Fire (ä¸) needs Wood to maintain flame'},
        1: {yong:'wood', sub:'fire', desc:'ä¸‘(Ox) month cold energy, Wood nurtures Fire'},
        2: {yong:'wood', sub:'water', desc:'å¯…(Tiger) month growing Wood, Water balance'},
        3: {yong:'wood', sub:'water', desc:'å¯(Rabbit) month Wood peak, Water balance'},
        4: {yong:'wood', sub:'water', desc:'è¾°(Dragon) month damp Earth, Wood nurtures Fire'},
        5: {yong:'water', sub:'wood', desc:'å·³(Snake) month Fire peak, Water for balance'},
        6: {yong:'water', sub:'wood', desc:'åˆ(Horse) month Fire at peak, Water is essential'},
        7: {yong:'water', sub:'wood', desc:'æœª(Goat) month hot dry, with Water cooling'},
        8: {yong:'wood', sub:'fire', desc:'ç”³(Monkey) month strong Metal needs Wood to nurture Fire'},
        9: {yong:'wood', sub:'fire', desc:'é…‰(Rooster) month Metal peak, Wood reinforcement'},
        10: {yong:'wood', sub:'fire', desc:'æˆŒ(Dog) month Fire energy stored, with Wood to sustain'},
        11: {yong:'wood', sub:'fire', desc:'äº¥(Pig) month Water controls Fire, with Wood bridging'}
    },
    // Yang Earth (æˆŠåœŸ)
    4: {
        0: {yong:'fire', sub:'wood', desc:'Winter Yang Earth (æˆŠ) needs warming with Fire'},
        1: {yong:'fire', sub:'wood', desc:'ä¸‘(Ox) month cold Earth, Fire warmth'},
        2: {yong:'fire', sub:'wood', desc:'å¯…(Tiger) month Wood controls Earth, Fire bridges'},
        3: {yong:'fire', sub:'metal', desc:'å¯(Rabbit) month Wood peak, Fire controls'},
        4: {yong:'metal', sub:'water', desc:'è¾°(Dragon) month Earth dominant, Metal release'},
        5: {yong:'water', sub:'metal', desc:'å·³(Snake) month Fire peak, Water for balance'},
        6: {yong:'water', sub:'metal', desc:'åˆ(Horse) month dry Earth, Water is essential'},
        7: {yong:'water', sub:'metal', desc:'æœª(Goat) month Earth dominant season, with Water nourishment'},
        8: {yong:'water', sub:'fire', desc:'ç”³(Monkey) month strong Metal needs Water balance'},
        9: {yong:'fire', sub:'water', desc:'é…‰(Rooster) month Metal peak, Fire balance'},
        10: {yong:'fire', sub:'water', desc:'æˆŒ(Dog) month Earth dominant, Fire nurtures Earth'},
        11: {yong:'fire', sub:'wood', desc:'äº¥(Pig) month Water peak, Fire warmth'}
    },
    // Yin Earth (å·±åœŸ)
    5: {
        0: {yong:'fire', sub:'wood', desc:'Winter Yin Earth (å·±) needs warming with Fire'},
        1: {yong:'fire', sub:'wood', desc:'ä¸‘(Ox) month cold damp Earth, with Fire for warmth'},
        2: {yong:'fire', sub:'water', desc:'å¯…(Tiger) month Wood controls Earth, Fire protects'},
        3: {yong:'fire', sub:'water', desc:'å¯(Rabbit) month Wood dominant, with Fire bridging'},
        4: {yong:'metal', sub:'water', desc:'è¾°(Dragon) month Earth dominant, Metal release'},
        5: {yong:'water', sub:'metal', desc:'å·³(Snake) month dry Earth, with Water nourishment'},
        6: {yong:'water', sub:'metal', desc:'åˆ(Horse) month Fire dominant, Water is essential'},
        7: {yong:'water', sub:'metal', desc:'æœª(Goat) month Earth dominant season, with Water damp balance'},
        8: {yong:'water', sub:'fire', desc:'ç”³(Monkey) month Metalenergy, with Water for moisture'},
        9: {yong:'fire', sub:'water', desc:'é…‰(Rooster) month Metal dominant, with Fire for balance'},
        10: {yong:'fire', sub:'water', desc:'æˆŒ(Dog) month Earth dominant, Fire nurtures Earth'},
        11: {yong:'fire', sub:'wood', desc:'äº¥(Pig) month Water dominant, with Fire to balance'}
    },
    // Yang Metal (åºšé‡‘)
    6: {
        0: {yong:'fire', sub:'earth', desc:'Winter Yang Metal (åºš) needs Fire for tempering'},
        1: {yong:'fire', sub:'earth', desc:'ä¸‘(Ox) month: Cold Metal needs Fire to melt'},
        2: {yong:'fire', sub:'water', desc:'å¯…(Tiger) month Wood energy, with Fire protection'},
        3: {yong:'fire', sub:'earth', desc:'å¯(Rabbit) month Wood dominant, with Fire bridging'},
        4: {yong:'water', sub:'fire', desc:'è¾°(Dragon) month Earthenergy, with Water ì„¤Metal'},
        5: {yong:'water', sub:'earth', desc:'å·³(Snake) month Fire peak, Water for balance'},
        6: {yong:'water', sub:'earth', desc:'åˆ(Horse) month Fire controls Metal, Water is essential'},
        7: {yong:'water', sub:'earth', desc:'æœª(Goat) month hot dry, with Water cooling down'},
        8: {yong:'water', sub:'fire', desc:'ç”³(Monkey) month Metal dominant, with Water to release'},
        9: {yong:'water', sub:'fire', desc:'é…‰(Rooster) month Metal at peak, Water/Fire needed'},
        10: {yong:'fire', sub:'water', desc:'æˆŒ(Dog) month EarthìƒMetal, with Fire for tempering'},
        11: {yong:'fire', sub:'earth', desc:'äº¥(Pig) month Water peak, Fire warmth'}
    },
    // Yin Metal (è¾›é‡‘)
    7: {
        0: {yong:'fire', sub:'earth', desc:'Winter Yin Metal (è¾›) needs Fire for warmth'},
        1: {yong:'fire', sub:'earth', desc:'ä¸‘(Ox) month: Cold Metal needs Fire for warmth'},
        2: {yong:'water', sub:'fire', desc:'å¯…(Tiger) month Wood energy, with Water cleansing'},
        3: {yong:'water', sub:'fire', desc:'å¯(Rabbit) month Wood dominant, with Water for moisture'},
        4: {yong:'water', sub:'fire', desc:'è¾°(Dragon) month Earthenergy, with Water for cleansing'},
        5: {yong:'water', sub:'earth', desc:'å·³(Snake) month Fire peak, Water for balance'},
        6: {yong:'water', sub:'earth', desc:'åˆ(Horse) month Fire controls Metal, Water is essential'},
        7: {yong:'water', sub:'earth', desc:'æœª(Goat) month hot dry, with Water cooling'},
        8: {yong:'water', sub:'fire', desc:'ç”³(Monkey) month Metal dominant, with Water to release'},
        9: {yong:'water', sub:'fire', desc:'é…‰(Rooster) month Metal at peak, with Water for cleansing'},
        10: {yong:'fire', sub:'water', desc:'æˆŒ(Dog) month Earthenergy, with Fire to shine'},
        11: {yong:'fire', sub:'earth', desc:'äº¥(Pig) month Water peak, Fire balance'}
    },
    // Yang Water (å£¬æ°´)
    8: {
        0: {yong:'fire', sub:'earth', desc:'Winter Yang Water (å£¬) needs Fire to melt the ice'},
        1: {yong:'fire', sub:'wood', desc:'ä¸‘(Ox) month: Cold Water needs Fire for warmth'},
        2: {yong:'earth', sub:'fire', desc:'å¯…(Tiger) month WaterìƒWood, Earth for control'},
        3: {yong:'earth', sub:'fire', desc:'å¯(Rabbit) month Wood energy, with Earth for balance'},
        4: {yong:'metal', sub:'fire', desc:'è¾°(Dragon) month Earthenergy, with Metal generates Water'},
        5: {yong:'metal', sub:'water', desc:'å·³(Snake) month Fire dominant, with Metal generates Water'},
        6: {yong:'metal', sub:'water', desc:'åˆ(Horse) month Fire at peak, Metal/Water needed'},
        7: {yong:'metal', sub:'water', desc:'æœª(Goat) month Earth dominant, with Metal bridging'},
        8: {yong:'fire', sub:'earth', desc:'ç”³(Monkey) month Metal generates Water, with Fire to balance'},
        9: {yong:'fire', sub:'earth', desc:'é…‰(Rooster) month Metal dominant, with Fire for balance'},
        10: {yong:'fire', sub:'wood', desc:'æˆŒ(Dog) month Earthenergy, with Fire for warmth'},
        11: {yong:'fire', sub:'wood', desc:'äº¥(Pig) month Water dominant, Fire is essential'}
    },
    // Yin Water (ç™¸æ°´)
    9: {
        0: {yong:'fire', sub:'wood', desc:'Winter Yin Water (ç™¸) needs Fire to melt the ice'},
        1: {yong:'fire', sub:'wood', desc:'ä¸‘(Ox) month: Cold Water needs Fire for warmth'},
        2: {yong:'fire', sub:'metal', desc:'å¯…(Tiger) month Wood energy, with Fire to release'},
        3: {yong:'fire', sub:'metal', desc:'å¯(Rabbit) month Wood dominant, with Fire for balance'},
        4: {yong:'fire', sub:'metal', desc:'è¾°(Dragon) month Earth controls Water, with Fire bridging'},
        5: {yong:'metal', sub:'water', desc:'å·³(Snake) month Fire dominant, with Metal generates Water'},
        6: {yong:'metal', sub:'water', desc:'åˆ(Horse) month Fire at peak, Metal/Water needed'},
        7: {yong:'metal', sub:'water', desc:'æœª(Goat) month Earth dominant, with Metal bridging'},
        8: {yong:'fire', sub:'wood', desc:'ç”³(Monkey) month Metal generates Water, with Fire to balance'},
        9: {yong:'fire', sub:'wood', desc:'é…‰(Rooster) month Metal dominant, with Fire to release Metal'},
        10: {yong:'fire', sub:'wood', desc:'æˆŒ(Dog) month Earthenergy, with Fire for warmth'},
        11: {yong:'fire', sub:'metal', desc:'äº¥(Pig) month Water dominant, Fire is essential'}
    }
};

// Temperature-Humidity Balance íŒë‹¨
function analyzeClimate(saju) {
    const mbi = BRANCH.findIndex(br => br.c === saju.month.b.c);
    const season = SEASON[mbi];
    
    let climate = {type: '', desc: '', needs: []};
    
    // Check branch Five Elements
    const brs = [saju.year?.b, saju.month?.b, saju.day?.b, saju.hour?.b].filter(b => b);
    const stems = [saju.year?.s, saju.month?.s, saju.day?.s, saju.hour?.s].filter(s => s);
    let fireCount = 0, waterCount = 0, earthCount = 0;
    brs.forEach(b => {
        if (b.e === 'fire') fireCount++;
        if (b.e === 'water') waterCount++;
        if (b.e === 'earth') earthCount++;
    });
    stems.forEach(s => {
        if (s.e === 'fire') fireCount++;
        if (s.e === 'water') waterCount++;
    });
    
    // Basic climate determination with resolution check
    if (season === 'winter') {
        // Winter needs Fire - check if Fire already exists
        if (fireCount >= 2) {
            climate.type = 'Warm Winter';
            climate.desc = 'Winter-born but Fire resolves the cold. Balanced and fortunate.';
            climate.needs = [];
        } else if (fireCount === 1) {
            climate.type = 'Mild Cold';
            climate.desc = 'Winter chart with some warmth. Additional Fire enhances fortune.';
            climate.needs = ['fire'];
        } else {
            climate.type = waterCount >= 2 ? 'Extreme Cold' : 'Cold';
            climate.desc = 'Cold chart. Needs warming Fire energy.';
            climate.needs = ['fire', 'wood'];
        }
    } else if (season === 'summer') {
        // Summer needs Water - check if Water already exists
        if (waterCount >= 2) {
            climate.type = 'Cool Summer';
            climate.desc = 'Summer-born but Water cools the heat. Balanced and fortunate.';
            climate.needs = [];
        } else if (waterCount === 1) {
            climate.type = 'Mild Hot';
            climate.desc = 'Summer chart with some cooling. Additional Water enhances fortune.';
            climate.needs = ['water'];
        } else {
            climate.type = fireCount >= 2 ? 'Extreme Dry' : 'Dry';
            climate.desc = 'Hot and dry chart. Needs cooling Water energy.';
            climate.needs = ['water', 'metal'];
        }
    } else if (mbi === 1 || mbi === 4 || mbi === 7 || mbi === 10) {
        // Earth dominant season
        if (earthCount >= 2) {
            climate.type = 'Humid';
            climate.desc = 'Humid chart. Needs Fire to dry.';
            climate.needs = ['fire', 'wood'];
        } else {
            climate.type = 'Balanced';
            climate.desc = 'Balanced climate chart.';
            climate.needs = [];
        }
    } else {
        climate.type = 'Mild';
        climate.desc = 'Mild and temperate chart.';
        climate.needs = [];
    }
    
    return climate;
}

// Finding Disease-Medicine Beneficial Element
function findByungYak(saju, strength) {
    const dm = saju.day.s;
    const dmi = STEM.indexOf(dm);
    const ec = countElements(saju);
    
    let byung = null, yak = null;
    
    // Most common element (illness)
    let maxEl = null, maxCount = 0;
    for (let e of EL_ORDER) {
        if (ec[e] > maxCount && e !== dm.e) {
            maxCount = ec[e];
            maxEl = e;
        }
    }
    
    if (maxCount >= 3) {
        byung = maxEl;
        // Find remedy - element that controls illness
        const kontrolIdx = (EL_ORDER.indexOf(maxEl) + 3) % 5;
        yak = EL_ORDER[kontrolIdx];
    }
    
    return { byung, yak, desc: byung ? `${ELEMENT[byung].k} is excessive - ${ELEMENT[yak].k} controls it` : null };
}

function calcGods(saju, str) {
    const dm = saju.day.s;
    const dmi = STEM.indexOf(dm);
    const mbi = BRANCH.indexOf(saju.month.b);
    const season = SEASON[mbi];
    let yong, hee, gi, johu = null, johuDesc = '';
    let isFollower = false;  // ì¢…ê²© ì—¬ë¶€
    let followerType = null; // ì¢…ê²© ì¢…ë¥˜
    
    // ====== 0. ê¸°í›„ ë¶„ì„ (ì¡°í›„ ì²´í¬ë¥¼ ìœ„í•´ ë¨¼ì € ì‹¤í–‰) ======
    const climate = analyzeClimate(saju);
    const isTooCold = climate && (climate.type === 'Cold' || climate.type === 'Very Cold');
    const isTooHot = climate && (climate.type === 'Hot' || climate.type === 'Very Hot');
    const isTooDamp = climate && (climate.type === 'Humid' || climate.type === 'Very Humid');
    
    // â˜… ì˜¤í–‰ ì¹´ìš´íŠ¸ (ì¸ì„± ê³¼ë‹¤/ì¢…ê²© ì²´í¬ìš©)
    const elCount = {wood:0, fire:0, earth:0, metal:0, water:0};
    const sealEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 4) % 5]; // ì¸ì„± ì˜¤í–‰
    const exprEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 1) % 5]; // Expression ì˜¤í–‰
    const wealthEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 2) % 5]; // ì¬ì„± ì˜¤í–‰
    const officerEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 3) % 5]; // ê´€ì„± ì˜¤í–‰
    
    [saju.year, saju.month, saju.day, saju.hour].forEach(p => {
        if (p && p.s) elCount[p.s.e]++;
        if (p && p.b) elCount[p.b.e]++;
    });
    
    // ====== 1. ì¢…ê²©(Follower) ì²´í¬ - v4.12.1 NEW ======
    // ì¡°ê±´: 10% ë¯¸ë§Œ + ì¼ì§€/ì‹œì§€ ëª¨ë‘ No Root
    const noRoot = !str.dayRoot && !str.hourRoot;
    
    if (str.pct < 10 && noRoot) {
        // ê·¹ì‹ ì•½ + No Root = ì¢…ê²© ê°€ëŠ¥ì„±
        // ì¼ê°„ ì˜¤í–‰ ì œì™¸í•˜ê³  ê°€ì¥ ê°•í•œ ì˜¤í–‰
        const dmEl = dm.e;
        let maxEl = null, maxCount = 0;
        Object.entries(elCount).forEach(([el, cnt]) => {
            if (el !== dmEl && cnt > maxCount) {
                maxEl = el;
                maxCount = cnt;
            }
        });
        
        if (maxCount >= 4) {
            // í•œ ì˜¤í–‰ì´ 4ê°œ ì´ìƒì´ë©´ ì¢…ê²© í™•ì •
            isFollower = true;
            
            // ì¢…ê²© ì¢…ë¥˜ íŒì •
            const relation = getElementRelation(dmEl, maxEl);
            if (relation === 'wealth') {
                followerType = 'ì¢…ì¬ê²©';
                yong = maxEl;
                hee = EL_ORDER[(EL_ORDER.indexOf(maxEl) + 1) % 5];
                gi = sealEl;
            } else if (relation === 'officer') {
                followerType = 'ì¢…ì‚´ê²©';
                yong = maxEl;
                hee = EL_ORDER[(EL_ORDER.indexOf(maxEl) + 4) % 5];
                gi = dm.e;
            } else if (relation === 'expression') {
                followerType = 'ì¢…ì•„ê²©';
                yong = maxEl;
                hee = EL_ORDER[(EL_ORDER.indexOf(maxEl) + 1) % 5];
                gi = sealEl;
            } else {
                followerType = 'ì¢…ê°•ê²©';
                yong = maxEl;
                hee = EL_ORDER[(EL_ORDER.indexOf(maxEl) + 4) % 5];
                gi = EL_ORDER[(EL_ORDER.indexOf(maxEl) + 3) % 5];
            }
        }
    }
    
    // ====== 2. ì¼ë°˜ ê²©êµ­ - ì‹ ê°•/ì‹ ì•½ ìš©ì‹  ======
    if (!isFollower) {
        if (str.type === 'strong') { 
            yong = wealthEl;
            hee = exprEl;
            gi = sealEl;
        }
        else if (str.type === 'weak') { 
            yong = sealEl;
            hee = dm.e;
            gi = officerEl;
            
            // â˜… í¸ì¸íƒœì™•(åå°å¤ªæ—º) ì²´í¬ - ì¸ì„± ê³¼ë‹¤ ì‹œ ìš©ì‹  ìˆ˜ì •
            if (elCount[sealEl] >= 3) {
                yong = exprEl;
                hee = wealthEl;
                gi = sealEl;
                johuDesc = 'åå°å¤ªæ—º - Excess Seal (3+) suffocates Day Master. Output needed to drain overflow.';
            }
        }
        else { 
            yong = exprEl;
            hee = wealthEl;
            gi = officerEl;
        }
    }
    
    // ====== 3. â˜…â˜…â˜… ì¡°í›„ ì˜ˆì™¸ ì²˜ë¦¬ (v4.12.1 ê°•í™”) â˜…â˜…â˜… ======
    const johuData = JOHU_TABLE[dmi] && JOHU_TABLE[dmi][mbi];
    
    if (johuData && !isFollower) {
        johu = johuData.yong;
        
        // í¸ì¸íƒœì™• ìƒíƒœë©´ ì¡°í›„ìš©ì‹ ë³´ë‹¤ í¸ì¸íƒœì™• ë¡œì§ ìš°ì„ 
        if (elCount[sealEl] >= 3 && str.type === 'weak') {
            johuDesc = johuDesc || johuData.desc;
        } else {
            johuDesc = johuData.desc;
            
            // â˜… ê¸ˆìˆ˜ìƒê´€ê²© íŠ¹ìˆ˜ ì²˜ë¦¬ (é‡‘æ°´å‚·å®˜å–œè¦‹å®˜)
            const isMetalDM = dm.e === 'metal';
            const isWinterMonth = [10, 11, 0, 1].includes(mbi);
            const waterCount = [saju.year, saju.month, saju.day, saju.hour].filter(p => 
                p && ((p.s && p.s.e === 'water') || (p.b && p.b.e === 'water'))
            ).length;
            const isGeumsooSanggwan = isMetalDM && isWinterMonth && waterCount >= 2;
            
            // ğŸ”¥ í•µì‹¬: ê·¹í•œ ê¸°í›„(ë„ˆë¬´ ì¶¥ê±°ë‚˜/ëœ¨ê²ê±°ë‚˜/ìŠµí•˜ë©´) ì¡°í›„ ìµœìš°ì„ 
            if (isTooCold || isTooHot || isTooDamp) {
                if (johu !== gi) {
                    const prevYong = yong;
                    yong = johu;
                    hee = prevYong;
                    johuDesc += ' (Climate Priority Override)';
                }
            } else if (johu !== gi || isGeumsooSanggwan) {
                // ê¸ˆìˆ˜ìƒê´€ê²©ì´ë©´ ê¸°ì‹ ë„ ë³€ê²½
                if (isGeumsooSanggwan && johu === 'fire') {
                    gi = 'earth';
                    johuDesc = 'é‡‘æ°´å‚·å®˜å–œè¦‹å®˜ - Winter Metal needs Fire. Fire is beneficial.';
                }
                hee = yong;
                yong = johu;
            }
        }
    }
    
    // ====== 4. ë³‘ì•½(ç—…è—¥) ë¶„ì„ ======
    const byungYak = findByungYak(saju, str);
    
    return { 
        yong, hee, gi, 
        type: str.type, 
        johu, johuDesc,
        climate,
        byungYak,
        sub: johuData?.sub || null,
        isFollower,
        followerType,
        sealExcess: elCount[sealEl] >= 3
    };
}

// ì˜¤í–‰ ê´€ê³„ íŒì • í—¬í¼ (ì¢…ê²©ìš©)
function getElementRelation(dmEl, targetEl) {
    const idx = EL_ORDER.indexOf(dmEl);
    const tgtIdx = EL_ORDER.indexOf(targetEl);
    const diff = (tgtIdx - idx + 5) % 5;
    
    if (diff === 1) return 'expression';
    if (diff === 2) return 'wealth';
    if (diff === 3) return 'officer';
    if (diff === 4) return 'seal';
    return 'peer';
}


/* ========================================
   9-5. Six Relations Precision Analysis
   ======================================== */

// Six Relations definitions
const YUKCHEON = {
    m: { // Male
        'æ¯”è‚© Peer': {relation: 'Brothers/Friends', desc: 'Equal relationship', detailed: 'Siblings, friends, colleagues, rivals'},
        'åŠ«è²¡ Competitor': {relation: 'Brothers/Rivals', desc: 'Competitive relationship', detailed: 'Half-siblings, cousins, competitors, partners'},
        'é£Ÿç¥ Eating God': {relation: 'Children(daughter)/Juniors', desc: 'What I create', detailed: 'Daughter, granddaughter, juniors, subordinates'},
        'å‚·å®˜ Expressor': {relation: 'Children(son)/Talent', desc: 'What I express', detailed: 'Son, grandson, creativity, ideas'},
        'åè²¡ Indirect Wealth': {relation: 'Father/Lover', desc: 'Wealth I control', detailed: 'Father, mistress, lover, entertainment, speculation'},
        'æ­£è²¡ Direct Wealth': {relation: 'Wife/Wealth', desc: 'Wealth I protect', detailed: 'Wife, salary, stable income'},
        'åå®˜ Challenger': {relation: 'Children(son)/Career', desc: 'What controls me', detailed: 'Son, boss, power, pressure'},
        'æ­£å®˜ Direct Officer': {relation: 'Children(daughter)/Honor', desc: 'What disciplines me', detailed: 'Daughter, honor, career, law'},
        'åå° Indirect Seal': {relation: 'Stepmother/Foster', desc: 'Unconventional nurturing', detailed: 'Stepmother, foster mother'},
        'æ­£å° Direct Seal': {relation: 'Mother/Studies', desc: 'Proper nurturing', detailed: 'Mother, studies, documents, certificates'}
    },
    f: { // Female
        'æ¯”è‚© Peer': {relation: 'Sisters/Friends', desc: 'Equal relationship', detailed: 'Sisters, friends, colleagues, rivals'},
        'åŠ«è²¡ Competitor': {relation: 'Sisters/Rivals', desc: 'Competitive relationship', detailed: 'Half-sisters, cousins, competitors'},
        'é£Ÿç¥ Eating God': {relation: 'Children(daughter)/Talent', desc: 'What I create', detailed: 'Daughter, granddaughter, expression, talent'},
        'å‚·å®˜ Expressor': {relation: 'Children(son)/Romance', desc: 'What I express', detailed: 'Son, grandson, lover, charm'},
        'åè²¡ Indirect Wealth': {relation: 'Father-in-law/Wealth', desc: 'Wealth I control', detailed: 'Father-in-law, speculative wealth, windfall'},
        'æ­£è²¡ Direct Wealth': {relation: 'Mother-in-law/Property', desc: 'Wealth I protect', detailed: 'Mother-in-law, stable income, salary'},
        'åå®˜ Challenger': {relation: 'Lover/Man', desc: 'What controls me', detailed: 'Lover, affair, passionate man'},
        'æ­£å®˜ Direct Officer': {relation: 'Husband/Honor', desc: 'What disciplines me', detailed: 'Husband, honor, career'},
        'åå° Indirect Seal': {relation: 'Stepmother/Obstacle', desc: 'Unconventional nurturing', detailed: 'Stepmother, foster mother, incomplete studies'},
        'æ­£å° Direct Seal': {relation: 'Mother/Studies', desc: 'Proper nurturing', detailed: 'Mother, studies, documents'}
    }
};

// Position meanings
const YUKCHEON_POSITION = {
    year: {name: 'Year Pillar', meaning: 'Ancestors, Society, Early years (Ages 1-15)', body: 'Head/Face'},
    month: {name: 'Month Pillar', meaning: 'Parents, Siblings, Career, Youth (Ages 16-30)', body: 'Chest/Shoulders'},
    day: {name: 'Day Pillar', meaning: 'Self, Spouse, Home, Middle age (Ages 31-45)', body: 'Waist/Abdomen'},
    hour: {name: 'Hour Pillar', meaning: 'Children, Juniors, Later years (Ages 46+)', body: 'Legs/Feet'}
};

// Six Relations Analysis
function analyzeYukcheon(saju, gender) {
    const dm = saju.day.s;
    const g = gender || GENDER || 'm';
    const yukData = YUKCHEON[g];
    
    const result = {
        positions: [],   // Six Relations by position
        counts: {},      // Count by Six Relations
        analysis: [],    // Comprehensive analysis
        spouse: null,    // Spouse Analysis
        children: null,  // Children Analysis
        parents: null    // Parents Analysis
    };
    
    const pillars = [
        {pos: 'year', pillar: saju.year},
        {pos: 'month', pillar: saju.month},
        {pos: 'day', pillar: saju.day},
        {pos: 'hour', pillar: saju.hour}
    ];
    
    // Each pillar analysis
    pillars.forEach(({pos, pillar}) => {
        if (!pillar) return;
        
        // Stem Ten Gods
        const stemGod = pos === 'day' ? {k: 'Day Master', c: 'æ—¥å¹²'} : getTenGod(pillar.s, dm);
        
        // Branch main stem Ten Gods
        const mainJJ = HIDDEN_STEMS[BRANCH.findIndex(br => br.c === pillar.b.c)];
        const mainStem = mainJJ && mainJJ.length > 0 ? STEM[mainJJ[mainJJ.length - 1].stem] : null;
        const branchGod = mainStem ? getTenGod(mainStem, dm) : null;
        
        const posInfo = YUKCHEON_POSITION[pos];
        const yukInfo = yukData[stemGod.k];
        
        result.positions.push({
            position: pos,
            posName: posInfo.name,
            posMeaning: posInfo.meaning,
            stem: pillar.s,
            branch: pillar.b,
            stemGod: stemGod.k,
            branchGod: branchGod ? branchGod.k : null,
            relation: yukInfo ? yukInfo.relation : 'Self',
            detailed: yukInfo ? yukInfo.detailed : 'ìê¸° ìì‹ '
        });
        
        // Count summary
        if (stemGod.k !== 'Day Master') {
            result.counts[stemGod.k] = (result.counts[stemGod.k] || 0) + 1;
        }
        if (branchGod) {
            result.counts[branchGod.k] = (result.counts[branchGod.k] || 0) + 0.5;
        }
    });
    
    // ========== Spouse Analysis ==========
    const spouseGod = g === 'm' ? 'æ­£è²¡(Direct Wealth)' : 'æ­£å®˜(Direct Officer)';
    const spouseAltGod = g === 'm' ? 'åè²¡(Indirect Wealth)' : 'åå®˜(Challenger)';
    const spouseCount = result.counts[spouseGod] || 0;
    const spouseAltCount = result.counts[spouseAltGod] || 0;
    const dayBranchState = getTwelveState(dm, saju.day.b);
    
    // ğŸ”¥ ì§€ì¥ê°„ì—ì„œ ë°°ìš°ìì„± ì°¾ê¸° (Hidden but Present) - Gemini feedback
    let hiddenSpouse = {found: false, position: '', damaged: false, damageDesc: ''};
    const spouseElement = g === 'm' ? 
        EL_ORDER[(EL_ORDER.indexOf(dm.e) + 2) % 5] :  // ì¬ì„±ì€ ë‚´ê°€ ê·¹í•˜ëŠ” ì˜¤í–‰
        EL_ORDER[(EL_ORDER.indexOf(dm.e) + 3) % 5];  // ê´€ì„±ì€ ë‚˜ë¥¼ ê·¹í•˜ëŠ” ì˜¤í–‰
    
    pillars.forEach(({pos, pillar}) => {
        if (!pillar) return;
        const jjList = HIDDEN_STEMS[BRANCH.findIndex(br => br.c === pillar.b.c)];
        if (jjList) {
            jjList.forEach(jj => {
                const stem = STEM[jj.stem];
                if (stem.e === spouseElement) {
                    hiddenSpouse.found = true;
                    hiddenSpouse.position = pos;
                    hiddenSpouse.stem = stem;
                    // í™”(Fire)ê°€ ë§ìœ¼ë©´ ê¸ˆ(Metal) ë°°ìš°ìì„±ì´ ë…¹ìŒ
                    if (spouseElement === 'metal') {
                        const fireCount = (result.counts['é£Ÿç¥(Eating God)'] || 0) + 
                                         (result.counts['å‚·å®˜(Expressor)'] || 0);
                        const fireEl = pillars.filter(p => p.pillar && 
                            (p.pillar.s.e === 'fire' || p.pillar.b.e === 'fire')).length;
                        if (fireEl >= 2) {
                            hiddenSpouse.damaged = true;
                            hiddenSpouse.damageDesc = 'Metal spouse melting under Fire excess';
                        }
                    }
                }
            });
        }
    });
    
    let spouseAnalysis = '';
    if (spouseCount === 0 && !hiddenSpouse.found) {
        spouseAnalysis = 'Spouse star absent. Marriage may come late or bonds may be weak. Romance arrives when it appears in å¤§é‹(Life Cycle).';
    } else if (spouseCount === 0 && hiddenSpouse.found) {
        // ì§€ì¥ê°„ì—ëŠ” ìˆì§€ë§Œ ì²œê°„ì— ì—†ìŒ
        if (hiddenSpouse.damaged) {
            spouseAnalysis = `Spouse star in ${hiddenSpouse.position} branch (hidden) but ${hiddenSpouse.damageDesc}. Early marriage may face obstacles. Living separately (weekend couple) may actually preserve the relationship.`;
        } else {
            spouseAnalysis = `Spouse star hidden in ${hiddenSpouse.position} branch. Quiet attraction. Spouse appears when timing is right.`;
        }
    } else if (spouseCount >= 2) {
        spouseAnalysis = 'Strong spouse energy. Popular with opposite sex but watch for infidelity! Focus on one person.';
    } else {
        spouseAnalysis = 'Good spouse energy. You can meet a good partner.';
    }
    
    result.spouse = {
        god: spouseGod,
        count: spouseCount,
        hiddenSpouse: hiddenSpouse,
        dayBranch: dayBranchState,
        analysis: spouseAnalysis
    };
    
    // ========== Children Analysis ==========
    const childGod = g === 'm' ? ['åå®˜(Challenger)', 'æ­£å®˜(Direct Officer)'] : ['é£Ÿç¥(Eating God)', 'å‚·å®˜(Expressor)'];
    const childCount = (result.counts[childGod[0]] || 0) + (result.counts[childGod[1]] || 0);
    const hourPillar = saju.hour;
    
    // ğŸ”¥ ì‹œì²œê°„ì— ìë…€ì„± Revealed ì²´í¬ - Gemini Round 4
    let hourStemChild = null;
    if (hourPillar) {
        const hourGod = getTenGod(hourPillar.s, dm);
        if (childGod.includes(hourGod.k)) {
            hourStemChild = {
                stem: hourPillar.s,
                god: hourGod.k,
                // í™”ê·¹ê¸ˆ ë“± ìƒíƒœ ì²´í¬
                underFire: hourPillar.b.e === 'fire' && hourPillar.s.e === 'metal'
            };
        }
    }
    
    let childAnalysis = '';
    if (!hourPillar) {
        childAnalysis = 'Birth hour needed for children analysis.';
    } else if (hourStemChild) {
        // ì‹œì²œê°„ì— ìë…€ì„± Revealed!
        if (hourStemChild.underFire) {
            childAnalysis = `Children star (${hourStemChild.god}) REVEALED on Hour Stem but sitting on Fire - children may face challenges or live far away. Early independence benefits them.`;
        } else {
            childAnalysis = `Children star (${hourStemChild.god}) REVEALED on Hour Stem. Children fortune is visible. Pay attention to their development.`;
        }
    } else if (childCount === 0) {
        childAnalysis = 'Children star absent. May have children late or few.';
    } else if (childCount >= 2) {
        childAnalysis = 'Strong children stars. Blessed with children fortune.';
    } else {
        childAnalysis = 'Moderate children fortune.';
    }
    
    result.children = {
        gods: childGod,
        count: childCount,
        hourStemChild: hourStemChild,
        analysis: childAnalysis
    };
    
    // ========== Parents Analysis ==========
    const fatherGod = 'åè²¡(Indirect Wealth)';
    const motherGod = 'æ­£å°(Direct Seal)';
    const fatherCount = result.counts[fatherGod] || 0;
    const motherCount = result.counts[motherGod] || 0;
    
    result.parents = {
        father: {god: fatherGod, count: fatherCount, analysis: fatherCount > 0 ? 'Strong father connection.' : 'Weak father connection.'},
        mother: {god: motherGod, count: motherCount, analysis: motherCount > 0 ? 'Deep mother connection.' : 'Somewhat weak mother connection.'}
    };
    
    // ========== ì¢…í•© ë¶„ì„ ==========
    // Six relations quantity analysis
    for (let [god, count] of Object.entries(result.counts)) {
        if (count >= 2) {
            const info = yukData[god];
            if (info) {
                result.analysis.push({
                    type: 'many',
                    god,
                    count,
                    meaning: `${god} appears many times. Significant life events related to this relation..`
                });
            }
        }
    }
    
    // Check missing relations
    const allGods = ['æ¯”è‚©(Peer)','åŠ«è²¡(Competitor)','é£Ÿç¥(Eating God)','å‚·å®˜(Expressor)','åè²¡(Indirect Wealth)','æ­£è²¡(Direct Wealth)','åå®˜(Challenger)','æ­£å®˜(Direct Officer)','åå°(Indirect Seal)','æ­£å°(Direct Seal)'];
    allGods.forEach(god => {
        if (!result.counts[god]) {
            const info = yukData[god];
            if (info) {
                result.analysis.push({
                    type: 'none',
                    god,
                    meaning: `${god}is missing. This connection may be weak in life..`
                });
            }
        }
    });
    
    return result;
}

/* ========================================
   10. ê²©êµ­(æ ¼å±€) ì •ë°€ íŒì •
   ======================================== */
   
// Regular Structure (8 types) data
const FORMATS_INNER = {
    'æ¯”è‚©(Peer)':{n:'Peer Structure (æ¯”è‚©æ ¼)',d:'The Self-Made Soul. Fierce independence and competitive fire drive you to forge your own path. Deep bonds with siblings and partners lead to success through collaboration. Channel your strong will with flexibility, and kingdoms will rise at your command.',b:'Entrepreneurship, Freelance, Athletics, Competition',lv:'Medium'},
    'åŠ«è²¡(Competitor)':{n:'Competitor Structure (åŠ«è²¡æ ¼)',d:'The Bold Challenger. Daring ambition and unshakeable courage propel you toward grand ventures. Your hunger for victory runs deep â€” balance boldness with patience, and fortune shall favor the persistent warrior.',b:'Investment, Venture Capital, Sales, High-Risk Enterprise',lv:'Challenging'},
    'é£Ÿç¥(Eating God)':{n:'Eating God Structure (é£Ÿç¥æ ¼)',d:'The Blessed Creator. Heaven has bestowed abundant talents and life\'s pleasures upon you. Artistic brilliance flows naturally, and fortune follows your optimistic spirit. Guard against complacency â€” your gifts multiply when cultivated with diligence.',b:'Culinary Arts, Entertainment, Education, Creative Fields',lv:'Excellent'},
    'å‚·å®˜(Expressor)':{n:'Expressor Structure (å‚·å®˜æ ¼)',d:'The Rebel Genius. Brilliant creativity and sharp wit define your unconventional soul. Your free spirit resists all chains â€” temper your tongue, for words cut deeper than swords. Channel rebellion into artistry, and the world will remember your name.',b:'Entertainment, Arts, Public Speaking, Innovation',lv:'Medium'},
    'åè²¡(Indirect Wealth)':{n:'Indirect Wealth Structure (åè²¡æ ¼)',d:'The Fortune Magnet. Business intuition and investment instincts run through your veins. Windfall opportunities find you naturally â€” wide social networks amplify your luck. Guard your wandering heart, for stability nurtures lasting prosperity.',b:'Trading, Investment, Sales, Networking',lv:'Excellent'},
    'æ­£è²¡(Direct Wealth)':{n:'Direct Wealth Structure (æ­£è²¡æ ¼)',d:'The Steady Builder. Honest accumulation and patient persistence build your empire brick by brick. Trustworthiness is your greatest currency â€” loyal partnerships and domestic harmony crown your efforts. Wealth grows slowly but eternally under your stewardship.',b:'Finance, Accounting, Management, Civil Service',lv:'Excellent'},
    'åå®˜(Challenger)':{n:'Challenger Structure (ä¸ƒæ®ºæ ¼)',d:'The Warrior Commander. Charisma and decisive action forge your path to power. The fire of ambition burns bright within â€” master this force, and you become a legendary leader. Unchecked, it creates enemies. Refined, it conquers worlds.',b:'Military, Law, Politics, Martial Arts, Athletics',lv:'Medium'},
    'æ­£å®˜(Direct Officer)':{n:'Direct Officer Structure (æ­£å®˜æ ¼)',d:'The Noble Authority. Dignity and honor illuminate your every step. Organizations recognize your worth and elevate you swiftly. The cosmos favor those who walk the righteous path â€” your integrity becomes your crown.',b:'Government, Corporation, Law, Education',lv:'Supreme'},
    'åå°(Indirect Seal)':{n:'Indirect Seal Structure (åå°æ ¼)',d:'The Mystic Scholar. Unconventional wisdom and esoteric knowledge call to your soul. Religious, philosophical, and occult matters fascinate your unique mind. Focus your scattered brilliance, and profound discoveries await.',b:'Research, Technology, Spirituality, Medicine',lv:'Medium'},
    'æ­£å°(Direct Seal)':{n:'Direct Seal Structure (æ­£å°æ ¼)',d:'The Blessed Scholar. Heaven\'s favor flows through maternal bonds and elder blessings. Academic pursuits and teaching call to your gentle soul. Your compassionate nature nurtures all who enter your sphere.',b:'Education, Publishing, Academia, Welfare',lv:'Excellent'}
};

// Special Structures (å¤–æ ¼) - Extraordinary destiny patterns
const FORMATS_SPECIAL = {
    'jongwang': {n:'Following Power (å¾æ—ºæ ¼)', d:'Your Guardian Element blazes with overwhelming force. The cosmos demand you forge your own empire â€” working under others suffocates your spirit. CEOs, entrepreneurs, and independent visionaries carry this rare blessing. Trust your unstoppable will.', b:'CEO, Entrepreneur, Political Leader, Independent Expert', lv:'Special'},
    'jonggang': {n:'Following Seal (å¾å¼·æ ¼)', d:'Guardian Element and Seal energy unite in formidable strength. Academic glory and institutional authority await your claim. Professors, researchers, and high officials often bear this distinguished pattern.', b:'Professor, Researcher, High Government Official', lv:'Special'},
    'jonga': {n:'Following Expression (å¾å…’æ ¼)', d:'Creative energy overflows from your soul. Artistic brilliance and expressive genius demand freedom â€” the stage, the canvas, the page all await your unique voice. Let your spirit roam free.', b:'Artist, Entertainer, Author, Content Creator', lv:'Special'},
    'jongjae': {n:'Following Wealth (å¾è²¡æ ¼)', d:'Wealth energy dominates your chart with magnetic force. Financial mastery flows through your veins â€” business empires and investment fortunes bend to your intuition. Money and you share a destined bond.', b:'Financier, Business Mogul, Investor, Real Estate', lv:'Special'},
    'jongsal': {n:'Following Authority (å¾æ®ºæ ¼)', d:'Commanding energy fills every corner of your being. Power and prestige call to your warrior soul â€” military leadership, political influence, and executive authority become your natural domain.', b:'Military Leader, Politician, Executive, Judge', lv:'Special'},
    'yangin': {n:'Sheep Blade Structure (ç¾Šåˆƒæ ¼)', d:'The cosmic blade rests in your Day Pillar (æ—¥æŸ±) â€” extraordinary power courses through you. Decisive action and crisis mastery define your path. Sharp edges may wound the careless, but heroes are forged from such steel.', b:'Military, Surgeon, Lawyer, Elite Athlete', lv:'Special'},
    'geonrok': {n:'Prime Structure (å»ºç¥¿æ ¼)', d:'Your Month Palace holds the Prime energy of your Guardian Element. Self-made success through persistent effort awaits â€” career stability and mid-life prosperity reward your steady climb.', b:'Civil Service, Professional, Self-Employed', lv:'Excellent'},
    'woldeok': {n:'Moon Virtue Structure (æœˆå¾·æ ¼)', d:'The Moon\'s blessing graces your chart. Virtue attracts aid in times of need â€” your trustworthy character opens doors that remain closed to others. Official fortune shines upon you.', b:'Government, Education, Religious Service', lv:'Excellent'}
};

// Structure success/failure(æˆæ•—) íŒë‹¨
function isFormatBroken(saju, formatGod) {
    const dm = saju.day.s;
    const dmEl = dm.e;
    const breakReasons = [];
    
    // Direct Officer break condition: Expressor breaks it
    if (formatGod === 'æ­£å®˜(Direct Officer)') {
        const allPillars = [saju.year, saju.month, saju.day, saju.hour].filter(p => p);
        for (let p of allPillars) {
            const god = getTenGod(p.s, dm);
            if (god.k === 'å‚·å®˜(Expressor)') {
                breakReasons.push('Expressor sees Officer: Expression clashes with Authority (broken)');
            }
        }
    }
    
    // Eating God break condition: Indirect Seal breaks it
    if (formatGod === 'é£Ÿç¥(Eating God)') {
        const allPillars = [saju.year, saju.month, saju.day, saju.hour].filter(p => p);
        for (let p of allPillars) {
            const god = getTenGod(p.s, dm);
            if (god.k === 'åå°(Indirect Seal)') {
                breakReasons.push('Owl steals food: Indirect Seal overcomes Eating God (broken)');
            }
        }
    }
    
    // Wealth break condition: Many Peers break it
    if (formatGod === 'æ­£è²¡(Direct Wealth)' || formatGod === 'åè²¡(Indirect Wealth)') {
        let biCount = 0;
        const allPillars = [saju.year, saju.month, saju.day, saju.hour].filter(p => p);
        for (let p of allPillars) {
            const god = getTenGod(p.s, dm);
            if (god.k === 'æ¯”è‚©(Peer)' || god.k === 'åŠ«è²¡(Competitor)') biCount++;
        }
        if (biCount >= 2) {
            breakReasons.push('Peers rob wealth: Too many Peers steal the wealth (broken)');
        }
    }
    
    return breakReasons;
}

// Special structures (ì¢…ê²©) íŒì •
function checkSpecialFormat(saju, strength) {
    if (!strength.extreme) return null;
    
    const dm = saju.day.s;
    const ec = countElements(saju);
    const allPillars = [saju.year, saju.month, saju.day, saju.hour].filter(p => p);
    
    // ğŸ”¥ Five Elementsë³„ ì‹­ì‹  ê°œìˆ˜ ì„¸ê¸° (ì²œê°„ + ì§€ì¥ê°„ í¬í•¨) - Gemini Round 9
    const godCounts = {bigeop:0, sikSang:0, jae:0, gwan:0, in:0};
    
    // ì²œê°„ ì‹­ì‹ 
    allPillars.forEach(p => {
        const god = getTenGod(p.s, dm);
        if (['æ¯”è‚©(Peer)','åŠ«è²¡(Competitor)'].includes(god.k)) godCounts.bigeop++;
        if (['é£Ÿç¥(Eating God)','å‚·å®˜(Expressor)'].includes(god.k)) godCounts.sikSang++;
        if (['åè²¡(Indirect Wealth)','æ­£è²¡(Direct Wealth)'].includes(god.k)) godCounts.jae++;
        if (['åå®˜(Challenger)','æ­£å®˜(Direct Officer)'].includes(god.k)) godCounts.gwan++;
        if (['åå°(Indirect Seal)','æ­£å°(Direct Seal)'].includes(god.k)) godCounts.in++;
    });
    
    // ğŸ”¥ ì§€ì¥ê°„ ì‹­ì‹ ë„ ì¹´ìš´íŠ¸ (ë³¸ê¸° ìœ„ì£¼)
    allPillars.forEach(p => {
        const bi = BRANCH.findIndex(br => br.c === p.b.c);
        const hidden = HIDDEN_STEMS[bi];
        if (hidden) {
            hidden.forEach(h => {
                if (h.type === 'jung') {  // ë³¸ê¸°(Main)ë§Œ ì¹´ìš´íŠ¸
                    const hiddenStem = STEM[h.stem];
                    const god = getTenGod(hiddenStem, dm);
                    if (['åè²¡(Indirect Wealth)','æ­£è²¡(Direct Wealth)'].includes(god.k)) godCounts.jae += 0.5;
                    if (['åå®˜(Challenger)','æ­£å®˜(Direct Officer)'].includes(god.k)) godCounts.gwan += 0.5;
                    if (['åå°(Indirect Seal)','æ­£å°(Direct Seal)'].includes(god.k)) godCounts.in += 0.5;
                }
            });
        }
    });
    
    if (strength.extreme === 'Extreme Strong') {
        // Jong-wang: Extremely many Peers
        if (godCounts.bigeop >= 3) return FORMATS_SPECIAL.jongwang;
        // Follower of Strength: ì¸ì„±ì´ ë§¤ìš° ë§ìŒ
        if (godCounts.in >= 2 && godCounts.bigeop >= 2) return FORMATS_SPECIAL.jonggang;
    }
    
    if (strength.extreme === 'Extreme Weak') {
        // Follower of Expression: Expressionì´ ë§¤ìš° ë§ìŒ
        if (godCounts.sikSang >= 3) return FORMATS_SPECIAL.jonga;
        // Follower of Wealth: ì¬ì„±ì´ ë§¤ìš° ë§ìŒ (ì§€ì¥ê°„ í¬í•¨ 2.5 ì´ìƒ)
        if (godCounts.jae >= 2.5) return {...FORMATS_SPECIAL.jongjae, fakeFollower: true};
        // Jong-sal: Extremely many Officers (ì§€ì¥ê°„ í¬í•¨ 2.5 ì´ìƒ)
        if (godCounts.gwan >= 2.5) return {...FORMATS_SPECIAL.jongsal, fakeFollower: true};
    }
    
    return null;
}

// Yang Blade Structure, Primeê²© ì²´í¬
function checkYangInGeonRok(saju) {
    const dm = saju.day.s;
    const dsi = STEM.indexOf(dm);
    const mbi = BRANCH.findIndex(br => br.c === saju.month.b.c);
    
    // Prime position (Day Masterë³„ Primeì§€)
    const geonrokMap = {0:2, 1:3, 2:5, 3:6, 4:5, 5:6, 6:8, 7:9, 8:11, 9:0}; // ç”²å¯…, ä¹™å¯...
    // Yang Blade position (Prime ë‹¤ìŒ)
    const yanginMap = {0:3, 1:2, 2:6, 3:5, 4:6, 5:5, 6:9, 7:8, 8:0, 9:11}; // ç”²å¯, ä¹™å¯…...
    
    // If Month Branch is Prime Primeê²©
    if (mbi === geonrokMap[dsi]) {
        return FORMATS_SPECIAL.geonrok;
    }
    
    // If Day Branch is Yang Blade ì–‘ì¸ê²©
    const dbi = BRANCH.findIndex(br => br.c === saju.day.b.c);
    if (dbi === yanginMap[dsi]) {
        return {...FORMATS_SPECIAL.yangin, hasYangIn: true};
    }
    
    return null;
}

// Comprehensive structure determination
function calcFormat(saju, strength) {
    const str = strength || calcStrength(saju);
    
    // 1. íŠ¹ìˆ˜ê²© ì²´í¬
    const specialFormat = checkSpecialFormat(saju, str);
    if (specialFormat) {
        return {...specialFormat, type:'special', god:'Special'};
    }
    
    // 2. ì–‘ì¸ê²©/Primeê²© ì²´í¬
    const yangInGeonRok = checkYangInGeonRok(saju);
    if (yangInGeonRok && yangInGeonRok.n.includes('ì–‘ì¸')) {
        return {...yangInGeonRok, type:'special', god:'Blade'};
    }
    
    // ğŸ”¥ 2.5 ì‹ì‹ ì œì‚´(é£Ÿç¥åˆ¶æ®º) ì²´í¬ - Gemini Round 6
    // í¸ê´€(ì¹ ì‚´)ì´ 2ê°œ ì´ìƒì´ê³  ì‹ì‹ ì´ 1ê°œ ì´ìƒì´ë©´ = ì‹ì‹ ì œì‚´
    const dm = saju.day.s;
    const allPillars = [saju.year, saju.month, saju.day, saju.hour].filter(p => p);
    let challengerCount = 0;
    let eatingGodCount = 0;
    allPillars.forEach(p => {
        const god = getTenGod(p.s, dm);
        if (god.k === 'åå®˜(Challenger)') challengerCount++;
        if (god.k === 'é£Ÿç¥(Eating God)') eatingGodCount++;
    });
    // ì§€ì§€ ìˆ¨ì€ ê°„ë„ ì²´í¬
    const allBranches = [saju.year.b, saju.month.b, saju.day.b, saju.hour?.b].filter(b => b);
    allBranches.forEach(b => {
        const bi = BRANCH.findIndex(br => br.c === b.c);
        const hidden = HIDDEN_STEMS[bi] || [];
        hidden.forEach(h => {
            const hStem = STEM[h.stem];
            const hGod = getTenGod(hStem, dm);
            if (hGod.k === 'åå®˜(Challenger)' && h.days >= 10) challengerCount += 0.5;
            if (hGod.k === 'é£Ÿç¥(Eating God)' && h.days >= 10) eatingGodCount += 0.5;
        });
    });
    
    if (challengerCount >= 2 && eatingGodCount >= 1) {
        return {
            n: 'Crisis Solver Structure (é£Ÿç¥åˆ¶æ®ºæ ¼)',
            d: 'The Warrior Healer. Fierce external pressure (Challenger) meets your sharp skills (Eating God). You thrive in crisis â€” solving problems others cannot. Not a peaceful artist, but a surgeon cutting through chaos. Your talent shines brightest under fire.',
            b: 'Medicine, Law, Engineering, Consulting, Crisis Management, Auditing',
            lv: 'Excellent',
            type: 'special',
            god: 'é£Ÿç¥åˆ¶æ®º',
            isSikSinJeSal: true
        };
    }
    
    // 3. ë‚´ê²© íŒì • (Month Branch Hidden Stems Mainì˜ ì‹­ì‹ )
    const mbi = BRANCH.findIndex(br => br.c === saju.month.b.c);
    const jj = HIDDEN_STEMS[mbi];
    
    // Find main stem
    const mainJj = jj.find(j => j.days >= 16) || jj[jj.length - 1];
    const mainStem = STEM[mainJj.stem];
    const god = getTenGod(mainStem, saju.day.s);
    
    // â˜…â˜…â˜… BUG-001 FIX: ë…„ê°„+ì›”ê°„ Revealed ìš°ì„  ì²´í¬ (v4.5 Patch) â˜…â˜…â˜…
    const validStructureGods = ['é£Ÿç¥(Eating God)','å‚·å®˜(Expressor)','åè²¡(Indirect Wealth)','æ­£è²¡(Direct Wealth)','åå®˜(Challenger)','æ­£å®˜(Direct Officer)','åå°(Indirect Seal)','æ­£å°(Direct Seal)'];
    
    // ë…„ê°„ ì‹­ì‹  ì²´í¬
    const yearGod = getTenGod(saju.year.s, saju.day.s);
    const yearStemIdx = STEM.indexOf(saju.year.s);
    const yearHasRoot = jj.some(j => j.stem === yearStemIdx) || 
                        [saju.year.b, saju.month.b, saju.day.b, saju.hour?.b].filter(b=>b).some(branch => {
                            const bi = BRANCH.indexOf(branch);
                            return (HIDDEN_STEMS[bi] || []).some(h => h.stem === yearStemIdx);
                        });
    
    // ì›”ê°„ ì‹­ì‹  ì²´í¬
    const monthGod = getTenGod(saju.month.s, saju.day.s);
    const monthStemIdx = STEM.indexOf(saju.month.s);
    const monthHasRoot = jj.some(j => j.stem === monthStemIdx);
    
    // Revealed ì‹­ì‹  ì§‘ê³„
    let emergentGods = {};
    if (validStructureGods.includes(yearGod.k) && yearHasRoot) {
        emergentGods[yearGod.k] = (emergentGods[yearGod.k] || 0) + 1;
    }
    if (validStructureGods.includes(monthGod.k) && monthHasRoot) {
        emergentGods[monthGod.k] = (emergentGods[monthGod.k] || 0) + 1;
    }
    
    // ê°€ì¥ ë§ì´ Revealedëœ ì‹­ì‹ ì„ ê²©êµ­ìœ¼ë¡œ (Revealedì´ ì—†ìœ¼ë©´ ì›”ì§€ ë³¸ê¸° ì‚¬ìš©)
    let finalGod = god.k;
    const emergentEntries = Object.entries(emergentGods);
    if (emergentEntries.length > 0) {
        // ê°€ì¥ ë§ì´ Revealedëœ ê²ƒ ì„ íƒ
        emergentEntries.sort((a,b) => b[1] - a[1]);
        finalGod = emergentEntries[0][0];
    }
    
    // Check Prime structure
    if (yangInGeonRok && yangInGeonRok.n.includes('è‡¨å®˜(Official)')) {
        return {...yangInGeonRok, type:'inner', god:'è‡¨å®˜(Official)'};
    }
    
    // 4. ğŸ”¥ ì‹ì‹ ì œì‚´(é£Ÿç¥åˆ¶æ®º) êµ¬ì¡° ì²´í¬ - Gemini Round 6
    // í¸ê´€(ì¹ ì‚´)ì´ 2ê°œ ì´ìƒì´ê³ , ì‹ì‹ ì´ 1ê°œ ì´ìƒì´ë©´ = ì‹ì‹ ì œì‚´
    let siksinJesal = false;
    const allPillarsForCheck = [saju.year, saju.month, saju.day, saju.hour].filter(p => p);
    let salCount = 0, sikCount = 0;
    allPillarsForCheck.forEach(p => {
        const stemGod = getTenGod(p.s, saju.day.s);
        if (stemGod.k === 'åå®˜(Challenger)') salCount++;
        if (stemGod.k === 'é£Ÿç¥(Eating God)') sikCount++;
    });
    // ì§€ì§€ì˜ ì§€ì¥ê°„ë„ ì²´í¬
    [saju.month.b, saju.hour?.b].filter(b => b).forEach(b => {
        const bi = BRANCH.findIndex(br => br.c === b.c);
        const jjList = HIDDEN_STEMS[bi] || [];
        jjList.forEach(jjItem => {
            const hiddenStem = STEM[jjItem.stem];
            const hiddenGod = getTenGod(hiddenStem, saju.day.s);
            if (hiddenGod.k === 'é£Ÿç¥(Eating God)' && jjItem.days >= 10) sikCount++;
        });
    });
    
    if (salCount >= 2 && sikCount >= 1) {
        siksinJesal = true;
        // ì‹ì‹ ì œì‚´ê²©ìœ¼ë¡œ ì¬ì •ì˜
        return {
            n: 'Solving Structure (é£Ÿç¥åˆ¶æ®ºæ ¼)',
            d: 'The Crisis Manager. Your sharp skills (Eating God) neutralize overwhelming pressure (Challenger). You thrive in chaos where others crumble. Problem-solving, medicine, law, engineering, and turnaround consulting are your battlegrounds. Not a peaceful artist, but a surgeon with a scalpel.',
            b: 'Medicine, Law, Engineering, Consulting, Auditing, Crisis Management',
            lv: 'Excellent',
            god: 'é£Ÿç¥åˆ¶æ®º',
            type: 'special',
            siksinJesal: true
        };
    }
    
    // 5. Check if structure is broken
    const breakReasons = isFormatBroken(saju, finalGod);
    
    // Convert key format: 'æ¯”è‚© Peer' â†’ 'æ¯”è‚©(Peer)'
    const formatKey = finalGod.replace(' ', '(') + ')';
    const f = FORMATS_INNER[formatKey] || FORMATS_INNER['æ­£å®˜(Direct Officer)'];
    return {
        ...f,
        god: finalGod,
        type: 'inner',
        broken: breakReasons.length > 0,
        breakReasons,
        tougan: monthGod.k !== god.k ? monthGod.k : null
    };
}

// Existing simple version (for compatibility)
function calcFormatSimple(saju) {
    const god = getTenGod(saju.month.s, saju.day.s);
    const f = FORMATS_INNER[god.k] || FORMATS_INNER['æ­£å®˜(Direct Officer)'];
    f.god = god.k;
    return f;
}

function getIljuDesc(ds, db) {
    // 60ê°‘ì Day ìƒì„¸ í•´ì„¤
    const iljuData = {
        'ç”²å­':{t:'ç”²å­Day - Great tree above the ocean',d:'Rat Water nurtures Yang Wood - Brilliant mind with scholarly gifts. Intelligent and organized though sometimes prone to excessive worry. Night birth is especially favorable. Deep bond with spouse.',s:'Spouse is intellectual and supportive. Younger partners suit you. Water brings romantic encounters.'},
        'ç”²å¯…':{t:'ç”²å¯…Day - Tree riding a tiger',d:'Same element as Day Branch brings strong pride and independence. Firstborn qualities with leadership potential. Stubborn and competitive nature.',s:'Spouse also has strong pride â€” expect clashes. Mutual compromise is essential.'},
        'ç”²è¾°':{t:'ç”²è¾°Day - Tree ascending on a dragon',d:'Dragon Earth roots the Wood, bringing abundant talent. Great ambition with desire for success. Scholar star energy grants academic prowess and social recognition.',s:'Spouse is reliable with wealth fortune. Good compatibility with Rabbit and Rooster signs.'},
        'ç”²åˆ':{t:'ç”²åˆDay - Tree standing tall under the sun',d:'Wood creates Fire bringing talent to bloom. Glamorous with exceptional artistic sense. Quick-tempered, passionate, and popular.',s:'Spouse is lively and sociable. Fiery temperaments may clash â€” mutual respect is key.'},
        'ç”²ç”³':{t:'ç”²ç”³Day - Tree struck by an axe',d:'Metal controls Wood bringing trials but overcoming makes you stronger. Develops decisiveness, drive, and resilience. Career fortune is present.',s:'Conflicts with spouse may arise. Accept differences and show consideration.'},
        'ç”²æˆŒ':{t:'ç”²æˆŒDay - Tree on autumn mountain',d:'Dog Earth contains Metal attacking Wood bringing solitude. Artistic talent with interest in religion and philosophy. Late bloomer type.',s:'Late marriage likely. Guard against separation.'},
        'ä¹™ä¸‘':{t:'ä¹™ä¸‘Day - Small grass in winter soil',d:'Ox Earth roots the Tiger Wood bringing persistence. Diligent, realistic, steadily accumulates wealth. May be introverted and passive.',s:'Spouse is dependable and financially stable.'},
        'ä¹™å¯':{t:'ä¹™å¯Day - Spring flower',d:'Same element brings clear personal principles. Delicate, artistic, and popular. Gentle appearance hides stubborn nature.',s:'Spouse shares similar traits. With mutual respect, a blessed union.'},
        'ä¹™å·³':{t:'ä¹™å·³Day - Flower bathed in sunlight',d:'Wood creates Fire releasing talents. Brilliant speaker with great social skills. Popular with the opposite sex and blessed with romantic fortune.',s:'Spouse is passionate and fiery. Guard against infidelity!'},
        'ä¹™æœª':{t:'ä¹™æœªDay - Garden flower in summer',d:'Wood controls Earth bringing business acumen. Artistic sense with investment ability. Especially favorable Day for women.',s:'Spouse is gentle and family-oriented. Wealth grows after marriage.'},
        'ä¹™é…‰':{t:'ä¹™é…‰Day - Flower touched by autumn frost',d:'Metal controls Wood bringing trials but patience brings success. Sharp and critical with strong potential for professional success.',s:'Conflicts with spouse may arise. Effort to harmonize is essential.'},
        'ä¹™äº¥':{t:'ä¹™äº¥Day - Duckweed floating on water',d:'Water nurtures Wood bringing abundant talent. Wise and scholarly with easy access to noble helpers. Flexible and adaptable nature.',s:'Spouse is intelligent with strong life skills.'},
        'ä¸™å­':{t:'ä¸™å­Day - Sun in the night sky',d:'Water controls Fire bringing trials but inner strength prevails. Duality like warm sun reflected in cold water.',s:'Personality differences with spouse may arise. Complementing each other creates blessed union.'},
        'ä¸™å¯…':{t:'ä¸™å¯…Day - Sun rising from the east',d:'Wood creates Fire making talents shine. Bright and energetic with leadership. Like morning sun brings hope and energy.',s:'Spouse is solid and dependable. Excellent spousal support awaits.'},
        'ä¸™è¾°':{t:'ä¸™è¾°Day - Sun above the clouds',d:'Dragon Earth channels Fire energy for talent expression. Great ambition with strong potential for social success.',s:'Spouse brings stability and wealth fortune.'},
        'ä¸™åˆ':{t:'ä¸™åˆDay - Midday sun',d:'Fire energy peaks bringing passion and vitality. Quick-tempered with a strong competitive drive. Leadership qualities present.',s:'Spouse also has a fiery personality. Arguments happen but love burns passionate.'},
        'ä¸™ç”³':{t:'ä¸™ç”³Day - Evening sunset',d:'Fire controls Metal bringing financial acumen. Good business sense with wealth fortune. Type that improves in later years.',s:'Spouse is talented and earns well.'},
        'ä¸™æˆŒ':{t:'ä¸™æˆŒDay - Bonfire on the mountain',d:'Dog Earth channels Fire bringing stability. Careful, responsible, and trusted. Strong interest in religion and philosophy.',s:'Spouse is solid and trustworthy. Late marriage may be favorable.'},
        'ä¸ä¸‘':{t:'ä¸ä¸‘Day - Candlelight',d:'Ox Earth channels Fire bringing calm. Introverted but warm-hearted. Steady effort type.',s:'Spouse is diligent and family-oriented. Stable married life awaits.'},
        'ä¸å¯':{t:'ä¸å¯Day - Firefly in the forest',d:'Wood creates Fire bringing exceptional talent. Artistic sense with delicate nature. Easy to receive help from noble ones.',s:'Spouse is affectionate and artistic.'},
        'ä¸å·³':{t:'ä¸å·³Day - Blazing candle',d:'Strong Fire energy brings passion. Good focus, potential for success in one field. May have quick temper.',s:'Spouse is passionate and dynamic.'},
        'ä¸æœª':{t:'ä¸æœªDay - Evening sunset',d:'Fire creates Earth bringing children fortune. Warm and embracing nature caring for others. Strong interest in religion and service.',s:'Spouse is gentle and family-oriented.'},
        'ä¸é…‰':{t:'ä¸é…‰Day - Flame that melts jewels',d:'Fire controls Metal bringing ability to handle wealth. Good with hands suited for technical work. Particular and perfectionist.',s:'Spouse is talented but personalities may clash.'},
        'ä¸äº¥':{t:'ä¸äº¥Day - Lighthouse over the sea',d:'Water controls Fire bringing trials but you bring hope to others. Wise with deep thoughts.',s:'Personality differences with spouse may arise.'},
        'æˆŠå­':{t:'æˆŠå­Day - Embankment by the water',d:'Earth controls Water bringing wealth acquisition. Good business sense with wealth fortune. Realistic with quick calculations.',s:'Spouse is intelligent with strong vitality.'},
        'æˆŠå¯…':{t:'æˆŠå¯…Day - Mountain in the forest',d:'Wood controls Earth but roots embrace the mountain. Blessed with virtue and noble helpers. scholarly talent present.',s:'Spouse is astute and resourceful.'},
        'æˆŠè¾°':{t:'æˆŠè¾°Day - Mountain where a dragon dwells',d:'Strong Earth energy brings reliability and trust. Great ambition with desire for success. Wealth and career fortune present.',s:'Spouse is trustworthy and stable.'},
        'æˆŠåˆ':{t:'æˆŠåˆDay - Earth bathed in sunlight',d:'Fire creates Earth overflowing with energy. Active social and popular. Easy early success.',s:'Spouse is bright and energetic.'},
        'æˆŠç”³':{t:'æˆŠç”³Day - Mountain of minerals',d:'Earth creates Metal bringing wealth creation ability. Good business sense with investment ability. Practical and realistic.',s:'Spouse is brilliant and capable.'},
        'æˆŠæˆŒ':{t:'æˆŠæˆŒDay - Tall mountain',d:'Earth energy peaks bringing stubbornness and determination. Once decided follows through to the end.',s:'May have stubbornness battles with spouse. Compromise is essential.'},
        'å·±ä¸‘':{t:'å·±ä¸‘Day - Fertile farmland',d:'Double Earth energy brings stability and steadiness. Real estate fortune with good saving habits.',s:'Spouse is diligent and family-oriented.'},
        'å·±å¯':{t:'å·±å¯Day - Soil of the garden',d:'Wood controls Earth but like good soil nurturing flowers. Good children fortune with virtuous nature.',s:'Spouse is astute and resourceful.'},
        'å·±å·³':{t:'å·±å·³Day - Warm earth',d:'Fire creates Earth bringing noble helpers. Brilliant with many talents. Popular with great social fortune.',s:'Spouse is bright and lively.'},
        'å·±æœª':{t:'å·±æœªDay - Summer garden',d:'Double Earth energy brings steadiness. Good real estate fortune with comfortable later years.',s:'Spouse is gentle and family-oriented.'},
        'å·±é…‰':{t:'å·±é…‰Day - Autumn field',d:'Earth creates Metal bringing wealth creation ability. Talented with artistic sense. Harvest time fortune.',s:'Spouse is brilliant and capable.'},
        'å·±äº¥':{t:'å·±äº¥Day - Embankment by the water',d:'Earth controls Water bringing wealth acquisition. Wise with quick calculations. Business acumen fortune.',s:'Spouse has strong life skills.'},
        'åºšå­':{t:'åºšå­Day - Rock in winter sea',d:'Metal creates Water bringing exceptional wisdom. Intelligent with scholarly talent present. Cool and analytical.',s:'Spouse is intellectual and brilliant.'},
        'åºšå¯…':{t:'åºšå¯…Day - Rock in the forest',d:'Metal controls Wood bringing financial acumen. Decisive with strong drive.',s:'May clash with spouse. Mutual compromise needed.'},
        'åºšè¾°':{t:'åºšè¾°Day - Swordsman riding a dragon',d:'Earth creates Metal bringing noble helpers. Career fortune with strong potential for social success.',s:'Spouse is trustworthy and solid.'},
        'åºšåˆ':{t:'åºšåˆDay - Iron forged in fire',d:'Fire forges Metal making you stronger. Overcoming trials brings great success.',s:'Spouse is lively but conflicts may arise.'},
        'åºšç”³':{t:'åºšç”³Day - Steel',d:'Metal energy peaks bringing strength. Excellent decisiveness and execution. Warrior qualities present.',s:'Spouse also has a strong personality. Mutual respect is essential.'},
        'åºšæˆŒ':{t:'åºšæˆŒDay - Ore within the mountain',d:'Earth creates Metal with deep roots. Late bloomer but achieves great success.',s:'Spouse is dependable and stable.'},
        'è¾›ä¸‘':{t:'è¾›ä¸‘Day - Gem beneath the earth',d:'Earth creates Metal with precious talent hidden. Late recognition but shines in the end.',s:'Spouse is diligent and family-oriented.'},
        'è¾›å¯':{t:'è¾›å¯Day - Jewel hanging on a tree',d:'Metal controls Wood bringing financial acumen. Delicate with artistic sense.',s:'Spouse is affectionate but conflicts may arise.'},
        'è¾›å·³':{t:'è¾›å·³Day - Metal in the furnace',d:'Fire forges Metal through refinement. Overcoming trials makes you a shining jewel. Supported by noble helpers.',s:'Spouse is passionate but clashes may occur.'},
        'è¾›æœª':{t:'è¾›æœªDay - Dew on summer grass',d:'Earth creates Metal bringing stability. Artistic sense with rich emotions.',s:'Spouse is gentle and family-oriented.'},
        'è¾›é…‰':{t:'è¾›é…‰Day - Perfect jewel',d:'Double Metal energy brings sharpness. Perfectionist with excellent aesthetic sense. artistic and technical talent present.',s:'Spouse may also be particular. Effort to harmonize is essential.'},
        'è¾›äº¥':{t:'è¾›äº¥Day - Pearl in the ocean',d:'Metal creates Water with wisdom flowing. Brilliant with rich emotions. exceptional artistic talent present.',s:'Spouse is intellectual and emotional.'},
        'å£¬å­':{t:'å£¬å­Day - Deep ocean',d:'Water energy peaks bringing deep wisdom. Brilliant mind with scholarly talent present.',s:'Spouse is brilliant. Deep conversations are possible.'},
        'å£¬å¯…':{t:'å£¬å¯…Day - Spring rain',d:'Water nurtures Wood reviving all things. Virtuous nature who loves giving. Receives help from noble ones.',s:'Spouse is solid and capable.'},
        'å£¬è¾°':{t:'å£¬è¾°Day - Water where a dragon dwells',d:'Earth blocks Water but dragon rides water to ascend. Great ambition with career fortune.',s:'Spouse is reliable with wealth fortune.'},
        'å£¬åˆ':{t:'å£¬åˆDay - Summer shower',d:'Water controls Fire bringing trials but inner strength prevails. Emotional fluctuations possible.',s:'Different personalities but complement well.'},
        'å£¬ç”³':{t:'å£¬ç”³Day - Valley stream',d:'Metal creates Water bringing clarity and brilliance. Intelligent with exceptional technical talent. eloquent speaking ability present.',s:'Spouse is brilliant and capable.'},
        'å£¬æˆŒ':{t:'å£¬æˆŒDay - Water blocked by a dam',d:'Earth blocks Water but eventually breaks through. Patience brings great success.',s:'Conflicts with spouse may arise.'},
        'ç™¸ä¸‘':{t:'ç™¸ä¸‘Day - Frozen spring',d:'Ox Earth hides Water energy within. Quiet but thinks deeply. Late bloomer type.',s:'Spouse is diligent and family-oriented.'},
        'ç™¸å¯':{t:'ç™¸å¯Day - Morning dew',d:'Water nurtures Wood growing all things. Virtuous with children fortune. Delicate and emotional.',s:'Spouse is affectionate and artistic.'},
        'ç™¸å·³':{t:'ç™¸å·³Day - Hot steam',d:'Water controls Fire bringing many changes. Good adaptability with quick judgment.',s:'Spouse is active and passionate.'},
        'ç™¸æœª':{t:'ç™¸æœªDay - Summer evening rain',d:'Earth controls Water but moistens the earth. Embracing nature caring for others.',s:'Spouse is gentle and family-oriented.'},
        'ç™¸é…‰':{t:'ç™¸é…‰Day - Clear spring water',d:'Metal creates Water bringing brilliance and artistry. Excellent aesthetic sense with intuitive fortune.',s:'Spouse is delicate and artistic.'},
        'ç™¸äº¥':{t:'ç™¸äº¥Day - Deep ocean',d:'Water energy peaks bringing deep wisdom. Excellent intuition with spiritual side.',s:'Spouse is intellectual. Deep conversations possible.'}
    };
    
    const key = ds.c + db.c;
    if (iljuData[key]) {
        return { title: iljuData[key].t, desc: iljuData[key].d, spouse: iljuData[key].s };
    }
    
    // Default interpretation (if no data)
    const stemDesc = {'ç”²':'progressive and leadership-oriented','ä¹™':'flexible and adaptable','ä¸™':'bright and passionate','ä¸':'warm and delicate','æˆŠ':'reliable and stable','å·±':'embracing and realistic','åºš':'decisive and strong','è¾›':'delicate and sensitive','å£¬':'wise and fluid','ç™¸':'intuitive and emotional'};
    const branchTrait = ['active','diligent','progressive','delicate','flexible','clever','passionate','devoted','confident','stylish','loyal','wise'];
    return { 
        title: `${ds.c}${db.c} Day`, 
        desc: `You have a ${stemDesc[ds.c]} personality. The ${ELEMENT[ds.e].n}(${ds.c}) Day Master sitting on ${db.c}(${db.m}) gives you an inherently ${branchTrait[BRANCH.findIndex(br => br.c === db.c)]} nature.`, 
        spouse: `Your spouse may be ${branchTrait[BRANCH.findIndex(br => br.c === db.c)]} like the ${db.m}. Good connections possible in ${db.m} years.` 
    };
}

/* ========================================
   11. å¤§é‹(Life Cycle) - v4.15.1 ì •ë°€ ê³„ì‚° ë²„ì „
   ======================================== */

// ========== v4.15.1: ëŒ€ìš´ ì •ë°€ ê³„ì‚° í—¬í¼ í•¨ìˆ˜ë“¤ ==========

/**
 * ì ˆê¸° ì¸ë±ìŠ¤ â†’ ì ˆê¸°ëª… ë§¤í•‘
 */
const TERM_NAMES = {
    0: {k: 'ì…ì¶˜', e: 'Ipchun', m: 2},      // å¯…ì›” ì‹œì‘
    1: {k: 'ê²½ì¹©', e: 'Gyeongchip', m: 3},  // å¯ì›” ì‹œì‘
    2: {k: 'ì²­ëª…', e: 'Cheongmyeong', m: 4}, // è¾°ì›” ì‹œì‘
    3: {k: 'ì…í•˜', e: 'Ipha', m: 5},        // å·³ì›” ì‹œì‘
    4: {k: 'ë§ì¢…', e: 'Mangjong', m: 6},    // åˆì›” ì‹œì‘
    5: {k: 'ì†Œì„œ', e: 'Soseo', m: 7},       // æœªì›” ì‹œì‘
    6: {k: 'ì…ì¶”', e: 'Ipchu', m: 8},       // ç”³ì›” ì‹œì‘
    7: {k: 'ë°±ë¡œ', e: 'Baekro', m: 9},      // é…‰ì›” ì‹œì‘
    8: {k: 'í•œë¡œ', e: 'Hallo', m: 10},      // æˆŒì›” ì‹œì‘
    9: {k: 'ì…ë™', e: 'Ipdong', m: 11},     // äº¥ì›” ì‹œì‘
    10: {k: 'ëŒ€ì„¤', e: 'Daeseol', m: 12},   // å­ì›” ì‹œì‘
    11: {k: 'ì†Œí•œ', e: 'Sohan', m: 1}       // ä¸‘ì›” ì‹œì‘
};

/**
 * ì •ë°€ ëŒ€ìš´ ì‹œì‘ ì •ë³´ ê³„ì‚°
 * @returns {Object} {firstAge, firstAgeExact, startYear, startMonth, startDay, daysToTerm, direction}
 */
function calcPreciseDaeunStart(saju, birthYear, birthMonth, birthDay, birthHour, gender) {
    const isYang = saju.year.s.y;
    const isMale = gender === 'm';
    const forward = (isYang && isMale) || (!isYang && !isMale);
    
    const mbi = BRANCH.findIndex(br => br.c === saju.month.b.c);
    
    // ì›”ì§€ â†’ ì ˆê¸° ì¸ë±ìŠ¤ ë§¤í•‘ (å¯…=0=ì…ì¶˜, å¯=1=ê²½ì¹©...)
    const monthBranchToTermIdx = {2:0, 3:1, 4:2, 5:3, 6:4, 7:5, 8:6, 9:7, 10:8, 11:9, 0:10, 1:11};
    const currentTermIdx = monthBranchToTermIdx[mbi];
    
    // ê¸°ë³¸ê°’ ì„¤ì •
    let result = {
        firstAge: 3,
        firstAgeExact: 3.0,
        startYear: birthYear + 3,
        startMonth: birthMonth,
        startDay: birthDay,
        daysToTerm: 9,
        direction: forward ? 'ìˆœí–‰(é †è¡Œ)' : 'ì—­í–‰(é€†è¡Œ)',
        directionEn: forward ? 'Forward' : 'Backward',
        targetTerm: null,
        calculationMethod: 'default'
    };
    
    if (!birthMonth || !birthDay) return result;
    
    // ì‹œê°„ì„ ë¶„ìœ¼ë¡œ ë³€í™˜ (birthHourê°€ ì§€ì§€ ì¸ë±ìŠ¤ì¸ ê²½ìš°)
    let birthHourNum = 12, birthMinNum = 0;
    if (typeof birthHour === 'number') {
        if (birthHour >= 0 && birthHour <= 11) {
            // ì§€ì§€ ì¸ë±ìŠ¤ â†’ ì‹œê°„ ë³€í™˜
            const hourMap = [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22];
            birthHourNum = hourMap[birthHour] || 12;
        } else if (birthHour >= 0 && birthHour <= 23) {
            birthHourNum = birthHour;
        }
    }
    
    try {
        let targetTermIdx, targetYear, searchYear;
        
        if (forward) {
            // ìˆœí–‰: ë‹¤ìŒ ì ˆì…ì¼ê¹Œì§€ì˜ ì¼ìˆ˜
            targetTermIdx = (currentTermIdx + 1) % 12;
            searchYear = birthYear;
            
            // ë‹¤ìŒ ì ˆê¸°ê°€ ë‹¤ìŒ í•´ì¸ ê²½ìš°
            if (targetTermIdx === 0 && currentTermIdx >= 10) {
                searchYear = birthYear + 1;
            } else if (targetTermIdx <= currentTermIdx && currentTermIdx !== 11) {
                searchYear = birthYear + 1;
            }
            
            // 1ì›”ìƒ íŠ¹ìˆ˜ ì²˜ë¦¬: ì†Œí•œ(11) ë‹¤ìŒì€ ì…ì¶˜(0) = ê°™ì€ í•´ ë˜ëŠ” ë‹¤ìŒ í•´
            if (birthMonth === 1 && currentTermIdx === 11) {
                searchYear = birthYear; // ì…ì¶˜ì€ 2ì›”ì´ë¯€ë¡œ ê°™ì€ í•´
            }
        } else {
            // ì—­í–‰: í˜„ì¬ ì›”ì˜ ì ˆì…ì¼(ì´ì „ ì ˆì…ì¼)ê¹Œì§€ì˜ ì¼ìˆ˜
            targetTermIdx = currentTermIdx;
            searchYear = birthYear;
            
            // 1ì›”ìƒì´ê³  ì¶•ì›”(ä¸‘)ì¸ ê²½ìš° ì†Œí•œì€ ê°™ì€ í•´ 1ì›”
            // 1ì›”ìƒì´ê³  ìì›”(å­)ì¸ ê²½ìš° ëŒ€ì„¤ì€ ì „ë…„ë„ 12ì›”
            if (birthMonth === 1 && currentTermIdx === 10) {
                searchYear = birthYear - 1; // ëŒ€ì„¤ì€ ì „ë…„ë„ 12ì›”
            }
        }
        
        // ëª©í‘œ ì ˆê¸° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const termTime = getSolarTermTime(searchYear, targetTermIdx);
        if (!termTime) return result;
        
        // ì •í™•í•œ ë‚ ì§œ/ì‹œê°„ ê°ì²´ ìƒì„±
        const birthDate = new Date(birthYear, birthMonth - 1, birthDay, birthHourNum, birthMinNum);
        const termDate = new Date(searchYear, termTime.m - 1, termTime.d, termTime.h, termTime.n);
        
        // ë°€ë¦¬ì´ˆ ì°¨ì´ ê³„ì‚°
        let msDiff;
        if (forward) {
            msDiff = termDate - birthDate;
        } else {
            msDiff = birthDate - termDate;
        }
        
        // ìŒìˆ˜ë©´ ì—°ë„ ì¡°ì • í•„ìš”
        if (msDiff < 0) {
            if (forward) {
                const newTermTime = getSolarTermTime(searchYear + 1, targetTermIdx);
                if (newTermTime) {
                    const newTermDate = new Date(searchYear + 1, newTermTime.m - 1, newTermTime.d, newTermTime.h, newTermTime.n);
                    msDiff = newTermDate - birthDate;
                    searchYear++;
                }
            } else {
                const newTermTime = getSolarTermTime(searchYear - 1, targetTermIdx);
                if (newTermTime) {
                    const newTermDate = new Date(searchYear - 1, newTermTime.m - 1, newTermTime.d, newTermTime.h, newTermTime.n);
                    msDiff = birthDate - newTermDate;
                    searchYear--;
                }
            }
        }
        
        // ì¼ìˆ˜ ì°¨ì´ ê³„ì‚°
        const daysDiff = msDiff / (1000 * 60 * 60 * 24);
        
        // 3ì¼ = 1ë…„ í™˜ì‚° (ì •ë°€ ê³„ì‚°)
        const exactAge = daysDiff / 3;
        const roundedAge = Math.round(exactAge);
        const finalAge = Math.max(1, Math.min(10, roundedAge));
        
        // ëŒ€ìš´ ì‹œì‘ ì—°ì›”ì¼ ê³„ì‚°
        const startYear = birthYear + finalAge;
        const startDate = new Date(birthDate);
        startDate.setFullYear(startYear);
        
        result = {
            firstAge: finalAge,
            firstAgeExact: Math.round(exactAge * 10) / 10,
            startYear: startYear,
            startMonth: startDate.getMonth() + 1,
            startDay: startDate.getDate(),
            daysToTerm: Math.round(daysDiff * 10) / 10,
            direction: forward ? 'ìˆœí–‰(é †è¡Œ)' : 'ì—­í–‰(é€†è¡Œ)',
            directionEn: forward ? 'Forward' : 'Backward',
            targetTerm: TERM_NAMES[targetTermIdx],
            targetTermYear: searchYear,
            calculationMethod: 'precise'
        };
        
    } catch (e) {
        console.warn('Daeun calculation error:', e);
    }
    
    return result;
}

/**
 * êµìš´ê¸°(äº¤é‹æœŸ) ë¶„ì„ - ëŒ€ìš´ì´ ë°”ë€ŒëŠ” ì‹œê¸° ê²½ê³ 
 */
function analyzeGyoungiPrecise(periods, birthYear, currentYear) {
    const gyoungiList = [];
    const currentAge = currentYear - birthYear;
    
    for (let i = 0; i < periods.length; i++) {
        const period = periods[i];
        const transitionAge = period.startAge;
        const transitionYear = birthYear + transitionAge;
        
        // êµìš´ê¸°: ëŒ€ìš´ ì‹œì‘ ì „í›„ 1ë…„
        const isNearTransition = Math.abs(currentAge - transitionAge) <= 1;
        const yearsToTransition = transitionAge - currentAge;
        
        if (isNearTransition || (yearsToTransition > 0 && yearsToTransition <= 3)) {
            const nextPeriod = periods[i];
            const prevPeriod = i > 0 ? periods[i - 1] : null;
            
            let warning = '';
            let severity = 'info';
            
            if (yearsToTransition === 0) {
                warning = `ğŸ”„ ì˜¬í•´ êµìš´ê¸°! ${nextPeriod.s.c}${nextPeriod.b.c} ëŒ€ìš´ ì‹œì‘`;
                severity = 'major';
            } else if (yearsToTransition === 1) {
                warning = `â³ ë‚´ë…„ êµìš´ê¸° ì§„ì… (${nextPeriod.s.c}${nextPeriod.b.c} ëŒ€ìš´)`;
                severity = 'warning';
            } else if (yearsToTransition === -1) {
                warning = `ğŸŒŸ ì‘ë…„ ìƒˆ ëŒ€ìš´ ì‹œì‘ - ì ì‘ê¸°`;
                severity = 'info';
            }
            
            // ëŒ€ìš´ ê°„ ê²©ì°¨ ë¶„ì„
            if (prevPeriod && nextPeriod) {
                const scoreDiff = nextPeriod.score - prevPeriod.score;
                if (scoreDiff >= 3) {
                    warning += ' | å‰é‹ ì§„ì…! ë°œë³µ ì‹œì‘';
                } else if (scoreDiff <= -3) {
                    warning += ' | ì£¼ì˜ í•„ìš” - ì•ˆì • ì¶”êµ¬';
                }
            }
            
            gyoungiList.push({
                year: transitionYear,
                age: transitionAge,
                period: nextPeriod,
                warning,
                severity,
                yearsAway: yearsToTransition
            });
        }
    }
    
    return gyoungiList;
}

function calcLuck(saju, birthYear, gender, gods, birthMonth, birthDay, birthHour = 12) {
    const isYang = saju.year.s.y;
    const isMale = gender === 'm';
    const forward = (isYang && isMale) || (!isYang && !isMale);
    const periods = [];
    const msi = STEM.indexOf(saju.month.s);
    const mbi = BRANCH.findIndex(br => br.c === saju.month.b.c);
    const curYear = new Date().getFullYear();
    const curAge = curYear - birthYear;
    
    // ========== v4.15.1: ì •ë°€ ëŒ€ìš´ ì‹œì‘ ê³„ì‚° ==========
    const daeunStart = calcPreciseDaeunStart(saju, birthYear, birthMonth, birthDay, birthHour, gender);
    const firstAge = daeunStart.firstAge;
    // ========== ì •ë°€ ëŒ€ìš´ ê³„ì‚° ë ==========
    
    for (let i = 0; i < 10; i++) {
        const si = forward ? (msi + i + 1) % 10 : (msi - i - 1 + 10) % 10;
        const bi = forward ? (mbi + i + 1) % 12 : (mbi - i - 1 + 12) % 12;
        const age = firstAge + i * 10;
        const isCur = curAge >= age && curAge < age + 10;
        const s = STEM[si], b = BRANCH[bi];
        
        let score = 0;
        let climateClash = false;
        
        if ([s.e, b.e].includes(gods.yong)) score += 2;
        if ([s.e, b.e].includes(gods.hee)) score += 1;
        if ([s.e, b.e].includes(gods.gi)) score -= 2;
        
        // ğŸ”¥ ì¡°í›„ ì—­ìš´ ì²´í¬ (Climate Clash) - Gemini feedback
        if (gods.climate) {
            const daeunEls = [s.e, b.e];
            // Extreme Dry + Fire ëŒ€ìš´ = penalty
            if ((gods.climate.type.includes('Dry') || gods.climate.type.includes('Hot')) && 
                daeunEls.filter(e => e === 'fire').length >= 1) {
                score -= 2;
                climateClash = true;
            }
            // Extreme Cold + Water ëŒ€ìš´ = penalty
            if ((gods.climate.type.includes('Cold') || gods.climate.type.includes('Extreme Cold')) && 
                daeunEls.filter(e => e === 'water').length >= 1) {
                score -= 2;
                climateClash = true;
            }
        }
        
        // v4.15.1: ëŒ€ìš´ ì‹œì‘ ì—°ë„ ê³„ì‚°
        const startYear = birthYear + age;
        const endYear = birthYear + age + 9;
        
        periods.push({ 
            s, b, 
            startAge: age, 
            endAge: age + 9, 
            startYear,
            endYear,
            isCur, 
            climateClash, 
            rating: score >= 2 ? 'good' : score <= -1 ? 'bad' : 'neutral', 
            score,
            // v4.15.1 ì¶”ê°€ ì •ë³´
            daeunInfo: i === 0 ? daeunStart : null
        });
    }
    
    // v4.15.1: ë©”íƒ€ë°ì´í„° ì¶”ê°€
    periods.meta = {
        direction: forward ? 'forward' : 'backward',
        directionK: forward ? 'ìˆœí–‰' : 'ì—­í–‰',
        firstAgeExact: daeunStart.firstAgeExact,
        daysToTerm: daeunStart.daysToTerm,
        targetTerm: daeunStart.targetTerm,
        calculationMethod: daeunStart.calculationMethod
    };
    
    return periods;
}

/* ========================================
   11-2. å¤§é‹(Life Cycle)/æ­²é‹(Annual Fortune)/Monthly Fortune êµì°¨ ë¶„ì„
   ======================================== */
   
// Calculate Annual Fortune for specific year
/* ========================================
   11-2. YEAR LUCK ANALYSIS (æ­²é‹) - v4.0 Refactored
   Modularized with CONFIG + Helper Functions
   ======================================== */

// ===== YEAR LUCK CONFIGURATION =====
const YEAR_LUCK_CONFIG = {
    // ì²œê°„í•© (ç”²å·±åˆåœŸ, ä¹™åºšåˆé‡‘, ä¸™è¾›åˆæ°´, ä¸å£¬åˆæœ¨, æˆŠç™¸åˆç«)
    stemCombineMap: [[0,5,'earth'],[1,6,'metal'],[2,7,'water'],[3,8,'wood'],[4,9,'fire']],
    // ìœ¡í•© (å­ä¸‘, å¯…äº¥, å¯æˆŒ, è¾°é…‰, å·³ç”³, åˆæœª)
    branchCombineMap: [[0,1,'earth'],[2,11,'wood'],[3,10,'fire'],[4,9,'metal'],[5,8,'water'],[6,7,'fire']],
    // ìœ¡í•´ (å­æœª, ä¸‘åˆ, å¯…å·³, å¯è¾°, ç”³äº¥, é…‰æˆŒ)
    harmPairs: [[0,7],[1,6],[2,5],[3,4],[8,11],[9,10]],
    // ìí˜• (è¾°è¾°, åˆåˆ, é…‰é…‰, äº¥äº¥)
    selfPunishBranches: [4, 6, 9, 11],
    // ì˜¤í–‰ ìƒê·¹
    keMap: {wood:'earth', earth:'water', water:'fire', fire:'metal', metal:'wood'},
    // ì‚¼í•©
    samhapPatterns: [[2,6,10,'fire'],[8,0,4,'water'],[5,9,1,'metal'],[11,3,7,'wood']],
    // ì–‘ì¸ ìœ„ì¹˜
    yanginBranches: {
        'wood+':3,'wood-':2,'fire+':6,'fire-':5,'earth+':6,'earth-':5,
        'metal+':9,'metal-':8,'water+':0,'water-':11
    }
};

// ===== YEAR LUCK HELPER FUNCTIONS =====

// ìš©ì‹ /ê¸°ì‹  ê¸°ë³¸ ì ìˆ˜
function ylCheckYongGi(yp, gods) {
    let score = 0;
    if ([yp.s.e, yp.b.e].includes(gods.yong)) score += 3;
    if ([yp.s.e, yp.b.e].includes(gods.hee)) score += 2;
    if ([yp.s.e, yp.b.e].includes(gods.gi)) score -= 3;
    return { score };
}

// ìš©ì‹  í”¼ê³µê²©
function ylCheckYongAttack(yp, gods) {
    const { keMap } = YEAR_LUCK_CONFIG;
    let active = false, desc = '', score = 0;
    [yp.s.e, yp.b.e].forEach(ye => {
        if (keMap[ye] === gods.yong) {
            active = true; score = -4;
            desc = `âš ï¸ BENEFICIAL ELEMENT UNDER ATTACK! ${ELEMENT[ye].n.toUpperCase()} destroys your ${ELEMENT[gods.yong].n} (${ye}å…‹${gods.yong}). Preserve, don't expand!`;
        }
    });
    return { active, desc, score };
}

// êµ°ê²ìŸì¬
function ylCheckRobWealth(yp, saju, gods, strength) {
    const god = getTenGod(yp.s, saju.day.s);
    const isPeer = ['æ¯”è‚©(Peer)', 'åŠ«è²¡(Competitor)'].includes(god.k);
    if (strength.type === 'strong' && isPeer) {
        return { active: true, score: -3, desc: `âš”ï¸ ROBBERY WARNING (ç¾¤åŠ«çˆ­è²¡)! Strong chart + Peer year = Competitors steal wealth. Avoid partnerships.` };
    }
    return { active: false, score: 0, desc: '' };
}

// ìƒê´€ê²©+ë¹„ê²ìš´
function ylCheckExpressorPeer(yp, saju, strength) {
    const god = getTenGod(yp.s, saju.day.s);
    const isPeer = ['æ¯”è‚©(Peer)', 'åŠ«è²¡(Competitor)'].includes(god.k);
    try {
        const format = calcFormat(saju, strength);
        if (format.god && (format.god.includes('å‚·å®˜') || format.god.includes('Expressor')) && isPeer) {
            return { active: true, score: -2, desc: `âš ï¸ REBEL + BAD FRIENDS (å‚·å®˜+æ¯”åŠ«): High lawsuit risk! Channel energy into CREATION only.` };
        }
    } catch(e) {}
    return { active: false, score: 0, desc: '' };
}

// ì¡°í›„ ì—­ìš´
function ylCheckClimateClash(yp, gods) {
    if (!gods.climate) return { active: false, score: 0, desc: '' };
    const yearEls = [yp.s.e, yp.b.e];
    const climate = gods.climate.type;
    if ((climate.includes('Dry') || climate.includes('Hot')) && yearEls.includes('fire')) {
        return { active: true, score: -(yearEls.filter(e => e === 'fire').length * 3), desc: 'Fire on Dry! Health/wealth at risk.' };
    }
    if ((climate.includes('Cold') || climate.includes('Extreme Cold')) && yearEls.includes('water')) {
        return { active: true, score: -(yearEls.filter(e => e === 'water').length * 3), desc: 'Water on Cold! Depression risk.' };
    }
    return { active: false, score: 0, desc: '' };
}

// ì‚¼í•© í˜•ì„± + ì„¸ìš´+ì¼ì§€ ë°˜í•© ì²´í¬
function ylCheckBureau(yp, saju) {
    const { samhapPatterns } = YEAR_LUCK_CONFIG;
    const ypBi = BRANCH.findIndex(br => br.c === yp.b.c);
    const dayBi = BRANCH.findIndex(br => br.c === saju.day.b.c);
    const allBr = [BRANCH.findIndex(br => br.c === saju.year.b.c), BRANCH.findIndex(br => br.c === saju.month.b.c), dayBi];
    if (saju.hour) allBr.push(BRANCH.findIndex(br => br.c === saju.hour.b.c));
    
    // 1. ì‚¼í•© ì™„ì„± ì²´í¬ (ì„¸ìš´ + ì›êµ­ 2ê°œ = 3ê°œ)
    for (const [a, b, c, el] of samhapPatterns) {
        if (ypBi === b && allBr.includes(a) && allBr.includes(c)) {
            return { active: true, score: 3, element: el, desc: `ğŸ”¥ ${BRANCH[a].c}${BRANCH[b].c}${BRANCH[c].c} ${ELEMENT[el].n} Bureau formed! Clash NEUTRALIZED.` };
        }
        if ((ypBi === a || ypBi === c) && allBr.includes(b) && ((ypBi === a) ? allBr.includes(c) : allBr.includes(a))) {
            return { active: true, score: 3, element: el, desc: `ğŸ”¥ ${BRANCH[a].c}${BRANCH[b].c}${BRANCH[c].c} ${ELEMENT[el].n} Bureau formed!` };
        }
    }
    
    // 2. [v4.14.1 NEW] ì„¸ìš´+ì¼ì§€ ë°˜í•© ì²´í¬ (ì™•ì§€ í¬í•¨ 2ê°œë§Œìœ¼ë¡œ ë°˜í•© ì¸ì •)
    const halfBureauPatterns = [
        { pair: [2, 6], wangji: 6, element: 'fire', name: 'å¯…åˆ Fire Half-Bureau' },
        { pair: [6, 10], wangji: 6, element: 'fire', name: 'åˆæˆŒ Fire Half-Bureau' },
        { pair: [8, 0], wangji: 0, element: 'water', name: 'ç”³å­ Water Half-Bureau' },
        { pair: [0, 4], wangji: 0, element: 'water', name: 'å­è¾° Water Half-Bureau' },
        { pair: [5, 9], wangji: 9, element: 'metal', name: 'å·³é…‰ Metal Half-Bureau' },
        { pair: [9, 1], wangji: 9, element: 'metal', name: 'é…‰ä¸‘ Metal Half-Bureau' },
        { pair: [11, 3], wangji: 3, element: 'wood', name: 'äº¥å¯ Wood Half-Bureau' },
        { pair: [3, 7], wangji: 3, element: 'wood', name: 'å¯æœª Wood Half-Bureau' }
    ];
    
    for (const hb of halfBureauPatterns) {
        if ((ypBi === hb.pair[0] && dayBi === hb.pair[1]) || 
            (ypBi === hb.pair[1] && dayBi === hb.pair[0])) {
            return { 
                active: true, 
                score: 2, 
                element: hb.element, 
                isHalfBureau: true,
                desc: `ğŸ”¥ ${hb.name} formed (Year+Day)! ${ELEMENT[hb.element].n} energy AMPLIFIED!` 
            };
        }
    }
    
    return { active: false, score: 0, element: null, desc: '' };
}

// ì›”ì§€ì¶©
function ylCheckMonthClash(yp, saju, bureauFormed) {
    if (bureauFormed) return { active: false, score: 0, desc: '' };
    const ypBi = BRANCH.findIndex(br => br.c === yp.b.c), mbi = BRANCH.findIndex(br => br.c === saju.month.b.c);
    if (Math.abs(ypBi - mbi) === 6) {
        const wang = [0, 3, 6, 9];
        const isWang = wang.includes(ypBi) && wang.includes(mbi);
        return { active: true, score: isWang ? -4 : -2, desc: `${yp.b.c}â†”${saju.month.b.c} CLASH! Career/social turbulence.` };
    }
    return { active: false, score: 0, desc: '' };
}

// ì¼ì§€ì¶©
function ylCheckDayClash(yp, saju) {
    const ypBi = BRANCH.findIndex(br => br.c === yp.b.c), dbi = BRANCH.findIndex(br => br.c === saju.day.b.c);
    if (Math.abs(ypBi - dbi) === 6) {
        return { active: true, desc: `${yp.b.c}â†”${saju.day.b.c} CLASH attacks Day Branch (Spouse/Self)!` };
    }
    return { active: false, desc: '' };
}

// ì–‘ì¸ì¶©
function ylCheckYanginClash(yp, saju) {
    const { yanginBranches } = YEAR_LUCK_CONFIG;
    const dm = saju.day.s, dmKey = dm.e + (dm.p ? '+' : '-');
    const yanginIdx = yanginBranches[dmKey];
    const ypBi = BRANCH.findIndex(br => br.c === yp.b.c), dbi = BRANCH.findIndex(br => br.c === saju.day.b.c);
    if (dbi === yanginIdx && Math.abs(ypBi - dbi) === 6) {
        return { active: true, desc: `âš”ï¸ SHEEP BLADE CLASH (æ²–ç¾Šåˆƒ)! High Risk High Return - Surgery OR windfall.` };
    }
    return { active: false, desc: '' };
}

// ì‚¼ì¤‘ì²©
function ylCheckTripleBranch(yp, saju) {
    const ypBi = BRANCH.findIndex(br => br.c === yp.b.c);
    const allBr = [BRANCH.findIndex(br => br.c === saju.year.b.c), BRANCH.findIndex(br => br.c === saju.month.b.c), BRANCH.findIndex(br => br.c === saju.day.b.c)];
    if (saju.hour) allBr.push(BRANCH.findIndex(br => br.c === saju.hour.b.c));
    const cnt = allBr.filter(b => b === ypBi).length;
    if (cnt >= 1) {
        const clash = (ypBi + 6) % 12;
        if (allBr.includes(clash)) {
            return { active: true, target: yp.b, desc: `${yp.b.c} energy DOUBLED! ${BRANCH[clash].c} overwhelmed (${cnt + 1}:1 attack).` };
        }
    }
    return { active: false, target: null, desc: '' };
}

// í†µê´€ ë¶€ì¬
function ylCheckMissingBridge(yp, saju, gods) {
    const elCount = {};
    [saju.year.s.e, saju.year.b.e, saju.month.s.e, saju.month.b.e, saju.day.s.e, saju.day.b.e].forEach(e => elCount[e] = (elCount[e]||0)+1);
    if (saju.hour) { elCount[saju.hour.s.e] = (elCount[saju.hour.s.e]||0)+1; elCount[saju.hour.b.e] = (elCount[saju.hour.b.e]||0)+1; }
    
    if ((elCount['water']||0) >= 3 && gods.yong === 'fire' && !(elCount['wood']||0) && [yp.s.e, yp.b.e].includes('fire')) {
        return { active: true, desc: `ğŸŒŠğŸ”¥ WATER-FIRE WAR without Bridge! No Wood to mediate. Remedy: Add Wood activities.` };
    }
    if ((elCount['metal']||0) >= 3 && gods.yong === 'fire' && !(elCount['earth']||0) && [yp.s.e, yp.b.e].includes('fire')) {
        return { active: true, desc: `âš”ï¸ğŸ”¥ METAL-FIRE WAR without Bridge! No Earth to mediate.` };
    }
    return { active: false, desc: '' };
}

// ì²œê°„í•©
function ylCheckStemCombine(yp, saju, gods) {
    const { stemCombineMap } = YEAR_LUCK_CONFIG;
    const ypSi = STEM.indexOf(yp.s);
    const allSi = [STEM.indexOf(saju.year.s), STEM.indexOf(saju.month.s), STEM.indexOf(saju.day.s)];
    if (saju.hour) allSi.push(STEM.indexOf(saju.hour.s));
    
    for (const [a, b, resEl] of stemCombineMap) {
        if (ypSi === a || ypSi === b) {
            const tgt = ypSi === a ? b : a;
            if (allSi.includes(tgt)) {
                const tgtStem = STEM[tgt], myGod = getTenGod(tgtStem, saju.day.s);
                const ypGod = getTenGod(yp.s, saju.day.s);
                let desc = `ğŸ”— ${yp.s.c}+${tgtStem.c} COMBINE â†’ ${ELEMENT[resEl].n}.`;
                let score = 0;
                
                // ğŸ”¥ ì²œê°„í•© ë°°ì‹  ì‹œë‚˜ë¦¬ì˜¤ - Gemini Round 10
                // ë¹„ê²(ì¡°ë ¥ì)ì´ ì¬ì„±(ëˆ)ê³¼ í•©í•˜ì—¬ ê´€ì„±(Pressure)ìœ¼ë¡œ ë³€í•˜ë©´ ë°°ì‹ 
                const isPeer = ['æ¯”è‚©(Peer)', 'åŠ«è²¡(Competitor)'].includes(ypGod.k);
                const isWealth = ['åè²¡(Indirect Wealth)', 'æ­£è²¡(Direct Wealth)'].includes(myGod.k);
                const resultIsGi = resEl === gods.gi;
                const resultIsGwan = ['water', 'earth'].includes(resEl) && 
                    ((saju.day.s.e === 'fire' && resEl === 'water') || 
                     (saju.day.s.e === 'wood' && resEl === 'metal'));
                
                if (isPeer && isWealth && resultIsGi) {
                    desc = `âš ï¸ ${yp.s.c}+${tgtStem.c} COMBINE â†’ ${ELEMENT[resEl].n} (BETRAYAL): Your helper (${ypGod.k}) meets your wealth (${myGod.k}) and transforms into PRESSURE. Trust no one with money this year. Reject partnership offers.`;
                    score = -2;
                } else if (resultIsGi) {
                    desc = `âš ï¸ ${yp.s.c}+${tgtStem.c} COMBINE â†’ ${ELEMENT[resEl].n} (å¿Œç¥): Combine creates unfavorable element. Hidden sabotage.`;
                    score = -1;
                } else if (yp.s.e === gods.yong && ['é£Ÿç¥(Eating God)', 'å‚·å®˜(Expressor)'].includes(myGod.k)) {
                    desc = `ğŸ”— ${yp.s.c}+${tgtStem.c} COMBINE (ç¾ˆçµ†): Promotion comes but freedom decreases. Golden handcuffs.`;
                    score = 1;
                }
                return { active: true, from: yp.s, to: tgtStem, result: resEl, targetGod: myGod.k, desc, score };
            }
        }
    }
    return { active: false, from: null, to: null, result: null, targetGod: null, desc: '', score: 0 };
}

// ìœ¡í•©
function ylCheckBranchCombine(yp, saju, gods, strength) {
    const { branchCombineMap } = YEAR_LUCK_CONFIG;
    const ypBi = BRANCH.findIndex(br => br.c === yp.b.c);
    const allBr = [BRANCH.findIndex(br => br.c === saju.year.b.c), BRANCH.findIndex(br => br.c === saju.month.b.c), BRANCH.findIndex(br => br.c === saju.day.b.c)];
    if (saju.hour) allBr.push(BRANCH.findIndex(br => br.c === saju.hour.b.c));
    
    for (const [a, b, resEl] of branchCombineMap) {
        if (ypBi === a || ypBi === b) {
            const tgt = ypBi === a ? b : a;
            if (allBr.includes(tgt)) {
                const tgtBr = BRANCH[tgt];
                let desc = `ğŸ¤ ${yp.b.c}+${tgtBr.c} COMBINE â†’ ${ELEMENT[resEl].n}.`;
                let score = 0;
                
                // ğŸ”¥ ì‹ ê°•/ì‹ ì•½ì— ë”°ë¥¸ í•©ì˜ ê¸¸í‰ íŒë‹¨ - Gemini Round 9
                const isWeak = strength && strength.pct < 30;
                const combineIsGi = resEl === gods.gi;  // í•©í™” ê²°ê³¼ê°€ ê¸°ì‹ ì´ë©´
                const combineIsYong = resEl === gods.yong;  // í•©í™” ê²°ê³¼ê°€ ìš©ì‹ ì´ë©´
                
                if (saju.hour && BRANCH.findIndex(br => br.c === saju.hour.b.c) === tgt) {
                    if (isWeak && combineIsGi) {
                        // ì‹ ì•½ì¸ë° ê¸°ì‹ ìœ¼ë¡œ í•©í™” = ìœ„í—˜
                        desc = `âš ï¸ ${yp.b.c}+${tgtBr.c} COMBINE â†’ ${ELEMENT[resEl].n}! WARNING: Weak chart but combine strengthens unfavorable element. Late-life/children axis under pressure. Health warning for kidneys/reproductive system.`;
                        score = -2;
                    } else if (combineIsYong) {
                        desc = `ğŸ¤ ${yp.b.c}+${tgtBr.c} COMBINE â†’ ${ELEMENT[resEl].n}! Hour branch strengthened with Beneficial Element. Late-life foundation solidified.`;
                        score = 2;
                    } else {
                        desc = `ğŸ¤ ${yp.b.c}+${tgtBr.c} COMBINE â†’ ${ELEMENT[resEl].n}! Hour branch strengthened.`;
                        score = 1;
                    }
                } else if (BRANCH.findIndex(br => br.c === saju.day.b.c) === tgt) {
                    if (isWeak && combineIsGi) {
                        desc = `âš ï¸ ${yp.b.c}+${tgtBr.c} COMBINE â†’ ${ELEMENT[resEl].n}! Spouse Palace transforms to unfavorable element. Relationship stress.`;
                        score = -1;
                    } else {
                        desc = `ğŸ¤ ${yp.b.c}+${tgtBr.c} COMBINE â†’ ${ELEMENT[resEl].n}! Spouse Palace harmonized.`;
                        score = 1;
                    }
                }
                return { active: true, from: yp.b, to: tgtBr, result: resEl, desc, score };
            }
        }
    }
    return { active: false, from: null, to: null, result: null, desc: '', score: 0 };
}

// ìí˜•
function ylCheckSelfPunishment(yp, saju) {
    const { selfPunishBranches } = YEAR_LUCK_CONFIG;
    const ypBi = BRANCH.findIndex(br => br.c === yp.b.c);
    if (!selfPunishBranches.includes(ypBi)) return { active: false, desc: '' };
    
    const allBr = [BRANCH.findIndex(br => br.c === saju.year.b.c), BRANCH.findIndex(br => br.c === saju.month.b.c), BRANCH.findIndex(br => br.c === saju.day.b.c)];
    if (saju.hour) allBr.push(BRANCH.findIndex(br => br.c === saju.hour.b.c));
    
    // v4.14.9: ì›êµ­ì— ê°™ì€ ì§€ì§€ ê°œìˆ˜ ì¹´ìš´íŠ¸
    const sameCount = allBr.filter(b => b === ypBi).length;
    if (sameCount < 1) return { active: false, desc: '' };
    
    const bn = yp.b.c;
    const totalCount = sameCount + 1; // ì„¸ìš´ í¬í•¨
    
    // Triple (3ê°œ) ì´ìƒì´ë©´ Nuclear Event!
    if (totalCount >= 3) {
        const tripleDescMap = {
            11: `ğŸš¨ ${bn}${bn}${bn} TRIPLE SELF-PUNISHMENT: NUCLEAR Water energy! Severe depression risk. Seek help immediately.`,
            6: `ğŸŒ‹ ${bn}${bn}${bn} TRIPLE SELF-PUNISHMENT: VOLCANIC Fire explosion! Extreme impulsiveness, burnout, heart/blood danger. CRITICAL health year.`,
            9: `âš ï¸ ${bn}${bn}${bn} TRIPLE SELF-PUNISHMENT: Obsessive Metal pressure! Respiratory/skin crisis.`,
            4: `âš ï¸ ${bn}${bn}${bn} TRIPLE SELF-PUNISHMENT: Crushing Earth weight! Digestive/immune collapse.`
        };
        return { active: true, isTriple: true, desc: tripleDescMap[ypBi] || `ğŸš¨ ${bn}${bn}${bn} TRIPLE SELF-PUNISHMENT. NUCLEAR EVENT!` };
    }
    
    // Double (2ê°œ)
    const descMap = {
        11: `ğŸ˜” ${bn}${bn} SELF-PUNISHMENT: Doubled Water = depression, overthinking.`,
        6: `ğŸ”¥ ${bn}${bn} SELF-PUNISHMENT: Doubled Fire = impulsiveness, burnout.`,
        9: `âš ï¸ ${bn}${bn} SELF-PUNISHMENT: Doubled Metal = obsessive perfectionism.`,
        4: `âš ï¸ ${bn}${bn} SELF-PUNISHMENT: Doubled Earth = stubbornness.`
    };
    return { active: true, isTriple: false, desc: descMap[ypBi] || `âš ï¸ ${bn}${bn} SELF-PUNISHMENT.` };
}

// ìƒ‰ë‚œ ê²½ê³ 
function ylCheckScandal(yp, saju) {
    if (!saju.hour) return { active: false, score: 0, desc: '' };
    const dm = saju.day.s;
    const hourGod = getTenGod(saju.hour.s, dm), ypGod = getTenGod(yp.s, dm);
    if (hourGod.k !== 'åè²¡(Indirect Wealth)' || ypGod.k !== 'åè²¡(Indirect Wealth)') return { active: false, score: 0, desc: '' };
    
    const { selfPunishBranches } = YEAR_LUCK_CONFIG;
    const ypBi = BRANCH.findIndex(br => br.c === yp.b.c), hBi = BRANCH.findIndex(br => br.c === saju.hour.b.c);
    if (ypBi === hBi && selfPunishBranches.includes(ypBi)) {
        return { active: true, score: -2, desc: `ğŸš¨ SCANDAL ALERT (è‰²é›£)! Hour Pillar + Indirect Wealth DOUBLED + Self-Punishment. High risk of scandal/gambling.` };
    }
    return { active: true, score: -2, desc: `âš ï¸ AFFAIR WARNING (è‰²é›£): Indirect Wealth Echo on Hour Pillar. Temptation is a TRAP.` };
}

// ìš©ì‹  ë¶€ì¬
function ylCheckMissingYong(saju, gods, yongAttacked) {
    const els = {};
    [saju.year.s.e, saju.year.b.e, saju.month.s.e, saju.month.b.e, saju.day.s.e, saju.day.b.e].forEach(e => els[e] = true);
    if (saju.hour) { els[saju.hour.s.e] = true; els[saju.hour.b.e] = true; }
    if (els[gods.yong]) return { active: false, score: 0, desc: '' };
    
    let desc = `ğŸ›¡ï¸ NO SHIELD (ç”¨ç¥ä¸åœ¨): Beneficial Element (${ELEMENT[gods.yong].n}) MISSING! No defense when crisis hits.`;
    let score = 0;
    if (yongAttacked) { desc += ` AND this year attacks that absent element - DOUBLE DANGER!`; score = -2; }
    return { active: true, desc, score };
}

// ìœ¡í•´ ë°°ì‹ 
function ylCheckHarmBetrayal(saju) {
    const { harmPairs } = YEAR_LUCK_CONFIG;
    const dBi = BRANCH.findIndex(br => br.c === saju.day.b.c), mBi = BRANCH.findIndex(br => br.c === saju.month.b.c);
    for (const [a, b] of harmPairs) {
        if ((mBi === a && dBi === b) || (mBi === b && dBi === a)) {
            if ((mBi === 3 && dBi === 4) || (mBi === 4 && dBi === 3)) {
                return { active: true, desc: `ğŸ—¡ï¸ BETRAYAL RISK (å¯è¾°å®³): Month HARMS Day. Words or betrayal may damage foundation. Never co-sign loans.` };
            }
            return { active: true, desc: `âš ï¸ HARM (å…­å®³): Close relationships face friction.` };
        }
    }
    return { active: false, desc: '' };
}

// v4.12.6 NEW: ì‡ ì‹ ì¶©ì™•(è¡°ç¥æ²–æ—º) - ìš©ì‹ ì´ ì™€ë„ ê¸°ì‹ ì— ì••ë„ë¨
function ylCheckYongOverwhelmed(saju, gods) {
    const elCount = {wood:0, fire:0, earth:0, metal:0, water:0};
    [saju.year, saju.month, saju.day, saju.hour].forEach(p => {
        if (p?.s) elCount[p.s.e]++;
        if (p?.b) elCount[p.b.e]++;
    });
    const yongCount = elCount[gods.yong] || 0;
    const giCount = elCount[gods.gi] || 0;
    if (giCount >= 3 && yongCount <= 1 && giCount >= yongCount * 3) {
        return { active: true, score: -2, desc: `âš ï¸ ì‡ ì‹ ì¶©ì™•(è¡°ç¥æ²–æ—º): ê¸°ì‹ (${ELEMENT[gods.gi].k}) ${giCount}ê°œ vs ìš©ì‹ (${ELEMENT[gods.yong].k}) ${yongCount} â†’ ìš©ì‹ ì´ ì™€ë„ ì••ë„ë¨!` };
    }
    return { active: false, score: 0, desc: '' };
}

// v4.12.6 NEW: í¸ì¸ë„ì‹(åå°å€’é£Ÿ) - ì‹ì‹ ê²©ì¸ë° í¸ì¸ì´ ì¶©í•˜ë©´ ë°¥ê·¸ë¦‡ ê¹¨ì§
function ylCheckPyunInDoShik(saju, gods) {
    const dm = saju.day.s;
    const monthBi = BRANCH.findIndex(b => b.c === saju.month.b.c);
    const shikShinEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 1) % 5];
    const pyunInEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 4) % 5];
    if (saju.month.b.e !== shikShinEl) return { active: false, score: 0, desc: '' };
    const clashPairs = [[0,6],[1,7],[2,8],[3,9],[4,10],[5,11]];
    const branches = [saju.year.b, saju.month.b, saju.day.b, saju.hour?.b].filter(b => b);
    let found = false, detail = '';
    branches.forEach(b => {
        if (b.e === pyunInEl) {
            const bi = BRANCH.findIndex(br => br.c === b.c);
            clashPairs.forEach(([a, c]) => {
                if ((bi === a && monthBi === c) || (bi === c && monthBi === a)) {
                    found = true;
                    detail = `${b.c}(í¸ì¸)â†”${saju.month.b.c}(ì‹ì‹ )`;
                }
            });
        }
    });
    if (found) {
        return { active: true, score: -2, desc: `âš ï¸ í¸ì¸ë„ì‹(åå°å€’é£Ÿ): ${detail} ì¶© â†’ ì¬ëŠ¥ì€ ìˆìœ¼ë‚˜ ì˜ˆë¯¼í•¨ ë•Œë¬¸ì— ê¸°íšŒë¥¼ ê±·ì–´ì°¨ëŠ” í˜•êµ­!` };
    }
    return { active: false, score: 0, desc: '' };
}

// v4.12.6 NEW: ì™•ì‹ ì¶©ë°œ(æ—ºç¥æ²–ç™¼) - 4ê°œ ì´ìƒ ì™•í•œ ì˜¤í–‰ì„ ì„¸ìš´ì´ ì¶©í•˜ë©´ í­ë°œ
function ylCheckWangShinChungBal(yp, saju) {
    const elCount = {wood:0, fire:0, earth:0, metal:0, water:0};
    [saju.year, saju.month, saju.day, saju.hour].forEach(p => {
        if (p?.s) elCount[p.s.e]++;
        if (p?.b) elCount[p.b.e]++;
    });
    const wangElements = Object.entries(elCount).filter(([el, cnt]) => cnt >= 4);
    if (wangElements.length === 0) return { active: false, score: 0, desc: '' };
    const clashPairs = {'å­':'åˆ','åˆ':'å­','ä¸‘':'æœª','æœª':'ä¸‘','å¯…':'ç”³','ç”³':'å¯…','å¯':'é…‰','é…‰':'å¯','è¾°':'æˆŒ','æˆŒ':'è¾°','å·³':'äº¥','äº¥':'å·³'};
    const yearBranch = yp.b.c;
    const clashTarget = clashPairs[yearBranch];
    if (!clashTarget) return { active: false, score: 0, desc: '' };
    const branches = [saju.year.b, saju.month.b, saju.day.b, saju.hour?.b].filter(b => b);
    const targetBranches = branches.filter(b => b.c === clashTarget);
    if (targetBranches.length === 0) return { active: false, score: 0, desc: '' };
    const targetEl = targetBranches[0].e;
    const isWang = wangElements.some(([el]) => el === targetEl);
    if (isWang) {
        const wangCount = elCount[targetEl];
        return { active: true, score: -3, desc: `ğŸš¨ ì™•ì‹ ì¶©ë°œ(æ—ºç¥æ²–ç™¼): ${yearBranch}(ì„¸ìš´)ì´ ${clashTarget}(ì›êµ­)ì„ ì¶©! ${ELEMENT[targetEl].k}ì´ ${wangCount}ê°œë¡œ ì™•í•œë° ê±´ë“œë¦¼ â†’ ëŒ€ê²©ë³€/ì‚¬ê³ /íŒŒì¬ ê·¹ë„ ì£¼ì˜!` };
    }
    return { active: false, score: 0, desc: '' };
}

// ===== Rating ê²°ì • =====
function ylDetermineRating(r, score) {
    // v4.12.6 NEW: ì™•ì‹ ì¶©ë°œ > ì‡ ì‹ ì¶©ì™• > í¸ì¸ë„ì‹ (ê°€ì¥ ìœ„í—˜í•œ ìˆœ)
    if (r.wangShinChungBal && r.wangShinChungBal.active) return 'wang_shin_chung_bal';
    if (r.yongOverwhelmed && r.yongOverwhelmed.active) return 'yong_overwhelmed';
    if (r.pyunInDoShik && r.pyunInDoShik.active) return 'pyunin_doshik';
    if (r.bureau.active && r.yongGi.score > 0) return 'breakthrough';
    if (r.yongAttack.active) return 'yong_attacked';
    if (r.robWealth.active) return 'rob_wealth';
    if (r.yanginClash.active) return 'surgery_risk';
    if (r.dayClash.active && r.yongGi.score > 0) return 'volatile_wealth';
    if (r.monthClash.active && score > 0) return 'volatile';
    if (score >= 4) return 'great';
    if (score >= 1) return 'good';
    if (score <= -4) return 'danger';
    if (score <= -2) return 'bad';
    return 'neutral';
}

// ===== MAIN: calcYearLuck (v4.0 Refactored) =====
function calcYearLuck(year, saju, gods) {
    const yp = calcYearPillar(year, 6, 1);
    const dm = saju.day.s;
    const god = getTenGod(yp.s, dm);
    const state = getTwelveState(dm, yp.b);
    const strength = calcStrength(saju);
    
    // ëª¨ë“  ì²´í¬ ì‹¤í–‰
    const r = {
        yongGi: ylCheckYongGi(yp, gods),
        yongAttack: ylCheckYongAttack(yp, gods),
        robWealth: ylCheckRobWealth(yp, saju, gods, strength),
        expressorPeer: ylCheckExpressorPeer(yp, saju, strength),
        climateClash: ylCheckClimateClash(yp, gods),
        bureau: ylCheckBureau(yp, saju),
        monthClash: ylCheckMonthClash(yp, saju, false),
        dayClash: ylCheckDayClash(yp, saju),
        yanginClash: ylCheckYanginClash(yp, saju),
        tripleBranch: ylCheckTripleBranch(yp, saju),
        missingBridge: ylCheckMissingBridge(yp, saju, gods),
        stemCombine: ylCheckStemCombine(yp, saju, gods),
        branchCombine: ylCheckBranchCombine(yp, saju, gods, strength),
        selfPunishment: ylCheckSelfPunishment(yp, saju),
        scandal: ylCheckScandal(yp, saju),
        missingYong: ylCheckMissingYong(saju, gods, false),
        harmBetrayal: ylCheckHarmBetrayal(saju),
        // v4.12.6 NEW
        yongOverwhelmed: ylCheckYongOverwhelmed(saju, gods),
        pyunInDoShik: ylCheckPyunInDoShik(saju, gods),
        wangShinChungBal: ylCheckWangShinChungBal(yp, saju)
    };
    
    // ì‚¼í•©ì´ë©´ ì›”ì§€ì¶© ë¬´íš¨
    if (r.bureau.active) r.monthClash = { active: false, score: 0, desc: '' };
    
    // [v4.14.1 NEW] ë°˜í•©ì´ ìš©ì‹  ì˜¤í–‰ì´ë©´ ì‡ ì‹ ì¶©ì™• ë¬´íš¨í™”
    if (r.bureau.active && r.bureau.element === gods.yong && r.yongOverwhelmed.active) {
        r.yongOverwhelmed = { 
            active: false, 
            score: 0, 
            desc: '',
            overridden: true,
            overrideReason: `ğŸ”¥ ${r.bureau.desc} Beneficial Element (${ELEMENT[gods.yong].n}) AMPLIFIED! ì‡ ì‹ ì¶©ì™• ë¬´íš¨í™” â†’ BREAKTHROUGH!`
        };
    }
    
    // ìš©ì‹  ë¶€ì¬ + í”¼ê³µê²© ì¬ê³„ì‚°
    r.missingYong = ylCheckMissingYong(saju, gods, r.yongAttack.active);
    
    // ì´ì 
    const score = Object.values(r).reduce((s, x) => s + (x.score || 0), 0);
    
    // Rating
    const rating = ylDetermineRating(r, score);
    
    // ê³µë§ íƒˆì¶œ
    let voidBreak = false, voidBreakDesc = '';
    try {
        const gm = calcGongmang(saju);
        const ypBi = BRANCH.findIndex(br => br.c === yp.b.c);
        if (gm && gm.indices) {
            gm.indices.forEach(vi => {
                if (Math.abs(ypBi - vi) === 6) {
                    voidBreak = true;
                    voidBreakDesc = `ğŸ”“ ${yp.b.c} breaks Void (${BRANCH[vi].c})! Liberation year.`;
                }
            });
        }
    } catch(e) {}
    
    return {
        year, pillar: yp, god, state, score, rating,
        // Legacy compatibility
        climateClash: r.climateClash.active, climateClashDesc: r.climateClash.desc,
        monthClash: r.monthClash.active, monthClashDesc: r.monthClash.desc,
        bureauFormed: r.bureau.active, bureauDesc: r.bureau.desc,
        voidBreak, voidBreakDesc,
        dayClash: r.dayClash.active, dayClashDesc: r.dayClash.desc,
        yanginClash: r.yanginClash.active, yanginClashDesc: r.yanginClash.desc,
        tripleBranch: r.tripleBranch.active, tripleBranchDesc: r.tripleBranch.desc, tripleBranchTarget: r.tripleBranch.target,
        missingBridge: r.missingBridge.active, missingBridgeDesc: r.missingBridge.desc,
        stemCombine: r.stemCombine.active ? r.stemCombine : null, stemCombineDesc: r.stemCombine.desc,
        branchCombine: r.branchCombine.active ? r.branchCombine : null, branchCombineDesc: r.branchCombine.desc,
        selfPunishment: r.selfPunishment.active, selfPunishmentDesc: r.selfPunishment.desc,
        yongUnderAttack: r.yongAttack.active, yongAttackDesc: r.yongAttack.desc,
        robWealthThreat: r.robWealth.active, robWealthDesc: r.robWealth.desc,
        expressorPeerClash: r.expressorPeer.active, expressorPeerDesc: r.expressorPeer.desc,
        scandalWarning: r.scandal.active, scandalWarningDesc: r.scandal.desc,
        missingYong: r.missingYong.active, missingYongDesc: r.missingYong.desc,
        harmBetrayalWarning: r.harmBetrayal.active, harmBetrayalDesc: r.harmBetrayal.desc,
        // v4.12.6 NEW
        yongOverwhelmed: r.yongOverwhelmed.active, yongOverwhelmedDesc: r.yongOverwhelmed.desc,
        yongOverwhelmedOverridden: r.yongOverwhelmed.overridden || false,
        yongOverwhelmedOverrideReason: r.yongOverwhelmed.overrideReason || '',
        bureauElement: r.bureau.element || null,
        pyunInDoShik: r.pyunInDoShik.active, pyunInDoShikDesc: r.pyunInDoShik.desc,
        wangShinChungBal: r.wangShinChungBal.active, wangShinChungBalDesc: r.wangShinChungBal.desc
    };
}


// Life Cycles(Life Cycle) + æ­²é‹(Annual Fortune) êµì°¨ ë¶„ì„
function analyzeLuckCross(saju, birthYear, gender, gods, targetYear, birthMonth, birthDay, birthHour) {
    const luck = calcLuck(saju, birthYear, gender, gods, birthMonth, birthDay, birthHour);
    const curAge = targetYear - birthYear;
    const curDaeun = luck.find(l => curAge >= l.startAge && curAge < l.endAge) || luck[0];
    const yearLuck = calcYearLuck(targetYear, saju, gods);
    
    const result = {
        daeun: curDaeun,
        saeun: yearLuck,
        analysis: []
    };
    
    // Life Cycles(Life Cycle)-æ­²é‹(Annual Fortune) ê´€ê³„ ë¶„ì„
    const dEl = [curDaeun.s.e, curDaeun.b.e];
    const sEl = [yearLuck.pillar.s.e, yearLuck.pillar.b.e];
    
    // Life Cycles(Life Cycle)-æ­²é‹(Annual Fortune) Harmony
    const ganHap = [[0,5],[1,6],[2,7],[3,8],[4,9]];
    const dsi = STEM.indexOf(curDaeun.s), ssi = STEM.indexOf(yearLuck.pillar.s);
    for (let [a,b] of ganHap) {
        if ((dsi===a && ssi===b) || (dsi===b && ssi===a)) {
            result.analysis.push({type:'good', text:'Life Cycle-Annual Fortune stem harmony! Fortune flows smoothly.'});
        }
    }
    
    // Life Cycles(Life Cycle)-æ­²é‹(Annual Fortune) Clash
    const dbi = BRANCH.findIndex(br => br.c === curDaeun.b.c), sbi = BRANCH.findIndex(br => br.c === yearLuck.pillar.b.c);
    if (Math.abs(dbi - sbi) === 6 || Math.abs(dbi - sbi) === 6) {
        result.analysis.push({type:'bad', text:'Life Cycle-Annual Fortune branch clash! Changes and challenges may arise.'});
    }
    
    // Life Cycles(Life Cycle)-ì›êµ­ ê´€ê³„
    const allBi = [BRANCH.findIndex(br => br.c === saju.year.b.c), BRANCH.findIndex(br => br.c === saju.month.b.c), BRANCH.findIndex(br => br.c === saju.day.b.c)];
    if (saju.hour) allBi.push(BRANCH.findIndex(br => br.c === saju.hour.b.c));
    
    allBi.forEach((bi, idx) => {
        const positions = ['Year Branch','Month Branch','Day Branch','Hour Branch'];
        // Annual Fortune clash with natal chart
        if (Math.abs(bi - sbi) === 6) {
            result.analysis.push({type:'warning', text:`Annual Fortune clashes with ${positions[idx]}! ${idx===2 ? 'Watch spouse or health!' : idx===0 ? 'Family elder matters possible.' : idx===1 ? 'Career or business changes possible.' : 'Children or junior matters possible.'}`});
        }
    });
    
    // â˜…â˜…â˜… BUG-002 FIX: ì„¸ìš´+ì›êµ­ ë°©í•© ì™„ì„± ì²´í¬ (v4.5 Patch) â˜…â˜…â˜…
    const DIRECTIONAL_BUREAU = [
        {branches: [2,3,4], element: 0, name: 'å¯…å¯è¾°(Tiger-Rabbit-Dragon) æœ¨å±€ Eastern Wood'},
        {branches: [5,6,7], element: 1, name: 'å·³åˆæœª(Snake-Horse-Goat) ç«å±€ Southern Fire'},
        {branches: [8,9,10], element: 3, name: 'ç”³é…‰æˆŒ(Monkey-Rooster-Dog) é‡‘å±€ Western Metal'},
        {branches: [11,0,1], element: 4, name: 'äº¥å­ä¸‘(Pig-Rat-Ox) æ°´å±€ Northern Water'}
    ];
    
    DIRECTIONAL_BUREAU.forEach(bureau => {
        // ì›êµ­ì— 2ê°œ ìˆê³  ì„¸ìš´ì´ ë‚˜ë¨¸ì§€ 1ê°œë¥¼ ì±„ìš°ëŠ”ì§€ ì²´í¬
        const natalMatches = bureau.branches.filter(b => allBi.includes(b));
        const yearCompletes = bureau.branches.includes(sbi) && !allBi.includes(sbi);
        
        if (natalMatches.length >= 2 && yearCompletes) {
            const elNames = ['Wood','Fire','Earth','Metal','Water'];
            result.analysis.push({
                type: 'critical',
                text: `ğŸ”¥ğŸ”¥ğŸ”¥ ${bureau.name} Bureau COMPLETED! ${elNames[bureau.element]} energy explosion!`
            });
            
            // ë°©í•© ì˜¤í–‰ì´ ê¸°ì‹ ì´ë©´ ì¶”ê°€ ê²½ê³ 
            if (gods && bureau.element === gods.gi) {
                result.analysis.push({
                    type: 'danger',
                    text: `âš ï¸ Bureau result is UNFAVORABLE (å¿Œç¥)! Health and wealth at extreme risk!`
                });
                result.bureauDanger = true;
            }
        }
    });
    
    // â˜…â˜…â˜… BUG-003 FIX: ìœ¡í•© ê¸°ì‹  ë³€í™” ì²´í¬ (v4.5 Patch) â˜…â˜…â˜…
    const COMBINE_PAIRS = [[0,1,'earth'],[2,11,'wood'],[3,10,'fire'],[4,9,'metal'],[5,8,'water'],[6,7,'fire']];
    const elNameToIdx = {'wood':0,'fire':1,'earth':2,'metal':3,'water':4};
    
    allBi.forEach((bi, idx) => {
        COMBINE_PAIRS.forEach(([a, b, resultEl]) => {
            if ((bi === a && sbi === b) || (bi === b && sbi === a)) {
                const resultElIdx = elNameToIdx[resultEl];
                if (gods && resultElIdx === gods.gi) {
                    const positions = ['Year','Month','Day(Spouse)','Hour(Children)'];
                    result.analysis.push({
                        type: 'warning',
                        text: `âš ï¸ ${BRANCH[sbi].c}+${BRANCH[bi].c} combine â†’ ${resultEl.toUpperCase()}(å¿Œç¥)! ${positions[idx]} area affected.`
                    });
                }
            }
        });
    });
    
    // Total score
    result.totalScore = curDaeun.score + yearLuck.score;
    result.totalRating = result.totalScore >= 4 ? 'excellent' : 
                         result.totalScore >= 2 ? 'good' : 
                         result.totalScore >= 0 ? 'neutral' : 
                         result.totalScore >= -2 ? 'caution' : 'difficult';
    
    return result;
}

// Life Cycles(Life Cycle) ì²œê°„/ì§€ì§€ 5ë…„ì”© ë¶„ë¦¬ í•´ì„
function analyzeDaeunDetail(daeun, saju, gods, startYear) {
    const dm = saju.day.s;
    
    // First 5 years: Heavenly Stem dominant
    const stemGod = getTenGod(daeun.s, dm);
    const stemAnalysis = {
        period: 'First Half',
        dominant: 'Stem',
        pillar: daeun.s.c,
        god: stemGod.k,
        element: daeun.s.e,
        isYong: daeun.s.e === gods.yong,
        isGi: daeun.s.e === gods.gi,
        desc: `${stemGod.k} energy dominates this period.`
    };
    
    // Last 5 years: Earthly Branch dominant
    const branchGod = getTenGod({e: daeun.b.e, y: true, c: '', k: ''}, dm); // Temp object
    const branchAnalysis = {
        period: 'Second Half',
        dominant: 'Branch',
        pillar: daeun.b.c,
        element: daeun.b.e,
        isYong: daeun.b.e === gods.yong,
        isGi: daeun.b.e === gods.gi,
        state: getTwelveState(dm, daeun.b),
        desc: `${ELEMENT[daeun.b.e].k}(${daeun.b.c}) energy is active in this cycle.`
    };
    
    return { stem: stemAnalysis, branch: branchAnalysis };
}

// 10Year Fortune ë¯¸ë¦¬ë³´ê¸°
function getNext10Years(saju, birthYear, gender, gods, birthMonth, birthDay, birthHour) {
    const curYear = new Date().getFullYear();
    const years = [];
    
    for (let i = 0; i < 10; i++) {
        const year = curYear + i;
        const cross = analyzeLuckCross(saju, birthYear, gender, gods, year, birthMonth, birthDay, birthHour);
        years.push({
            year,
            age: year - birthYear,
            rating: cross.totalRating,
            score: cross.totalScore,
            daeun: cross.daeun,
            saeun: cross.saeun
        });
    }
    
    // Find best year and caution year
    const bestYear = years.reduce((a, b) => a.score > b.score ? a : b);
    const worstYear = years.reduce((a, b) => a.score < b.score ? a : b);
    
    return { years, bestYear, worstYear };
}

// Monthly Fortune(æœˆé‹) ê³„ì‚°
function calcMonthLuck(year, month, saju, gods) {
    const mp = calcMonthPillar(year, month, 15);
    const dm = saju.day.s;
    const god = getTenGod(mp.s, dm);
    
    let score = 0;
    let climateClash = false;
    
    if ([mp.s.e, mp.b.e].includes(gods.yong)) score += 2;
    if ([mp.s.e, mp.b.e].includes(gods.hee)) score += 1;
    if ([mp.s.e, mp.b.e].includes(gods.gi)) score -= 2;
    
    // ğŸ”¥ ì¡°í›„ ì—­ìš´ ì²´í¬ (Climate Clash) - Gemini feedback
    if (gods.climate) {
        const monthEls = [mp.s.e, mp.b.e];
        // Extreme Dry + Fire month = DANGER
        if ((gods.climate.type.includes('Dry') || gods.climate.type.includes('Hot')) && 
            monthEls.filter(e => e === 'fire').length >= 1) {
            score -= 3;
            climateClash = true;
        }
        // Extreme Cold + Water month = DANGER
        if ((gods.climate.type.includes('Cold') || gods.climate.type.includes('Extreme Cold')) && 
            monthEls.filter(e => e === 'water').length >= 1) {
            score -= 3;
            climateClash = true;
        }
    }
    
    return {
        month,
        pillar: mp,
        god,
        score,
        climateClash,
        rating: score >= 2 ? 'good' : score <= -2 ? 'bad' : 'neutral'
    };
}

// 12ê°œì›” Monthly Fortune ë¶„ì„
function getYearlyMonthLuck(year, saju, gods) {
    const months = [];
    const mbi = BRANCH.findIndex(br => br.c === saju.month.b.c);  // ì›êµ­ ì›”ì§€
    
    for (let m = 1; m <= 12; m++) {
        const monthData = calcMonthLuck(year, m, saju, gods);
        
        // ğŸ”¥ ì™•ì§€ì¶©(æ—ºæ”¯æ²–) ì²´í¬ - Gemini feedback
        // í™”ê³¼ë‹¤(Fire Excess) ì‚¬ì£¼ì—ì„œ ìì˜¤ì¶©(å­åˆæ²–)ì€ í­ë°œì 
        const monthBi = BRANCH.findIndex(br => br.c === monthData.pillar.b.c);
        const isWangClash = Math.abs(monthBi - mbi) === 6;  // 6 = ì¶©
        
        if (isWangClash && gods.climate && 
            (gods.climate.type.includes('Dry') || gods.climate.type.includes('Hot'))) {
            // í™”ê³¼ë‹¤ ì‚¬ì£¼ + ìˆ˜(Water)ì›” = ì™•ìì¶©ë°œ(æ—ºè€…æ²–ç™¼) ìœ„í—˜
            if (monthData.pillar.b.e === 'water') {
                monthData.score -= 3;  // Heavy penalty
                monthData.wangClash = true;
                monthData.wangClashDesc = 'Fire-Water Clash! Risk of cardiovascular shock.';
            }
        }
        
        months.push(monthData);
    }
    
    // Best month: climateClashë‚˜ wangClashê°€ ì—†ëŠ” ë‹¬ ì¤‘ì—ì„œ ì„ íƒ
    const safeBest = months.filter(m => !m.climateClash && !m.wangClash);
    const best = safeBest.length > 0 
        ? safeBest.reduce((a, b) => a.score > b.score ? a : b)
        : months.reduce((a, b) => a.score > b.score ? a : b);
    
    // Worst month
    const worst = months.reduce((a, b) => a.score < b.score ? a : b);
    
    // Wang Clash months
    const wangClashMonths = months.filter(m => m.wangClash).map(m => m.month);
    
    return { months, best, worst, wangClashMonths };
}

/* ========================================
   12. Complete Divine Stars (30ê°œ+)
   ======================================== */
function calcSinsal(saju) {
    const ss = [];
    const dmi = STEM.indexOf(saju.day.s);
    const ybi = BRANCH.findIndex(br => br.c === saju.year.b.c);
    const dbi = BRANCH.findIndex(br => br.c === saju.day.b.c);
    const mbi = BRANCH.findIndex(br => br.c === saju.month.b.c);
    const hbi = saju.hour ? BRANCH.findIndex(br => br.c === saju.hour.b.c) : -1;
    const brs = [ybi, mbi, dbi];
    if (hbi >= 0) brs.push(hbi);
    
    // Stems ì¸ë±ìŠ¤ë“¤
    const ysi = STEM.indexOf(saju.year.s);
    const msi = STEM.indexOf(saju.month.s);
    const hsi = saju.hour ? STEM.indexOf(saju.hour.s) : -1;
    
    // ========== ê¸¸ì‹ (å‰ç¥) ==========
    
    // 1. å¤©ä¹™è²´äºº(Heavenly Noble) (å¤©ä¹™è²´äºº) - ìµœê³  ê¸¸ì‹ 
    const guiren = {0:[1,7],1:[0,8],2:[11,9],3:[11,9],4:[1,7],5:[0,8],6:[7,1],7:[6,2],8:[5,3],9:[5,3]};
    if (guiren[dmi] && brs.some(b => guiren[dmi].includes(b))) ss.push({n:'å¤©ä¹™è²´äºº(Heavenly Noble)',t:'good',d:'Supreme blessing! A guardian angel appears in every crisis. Official fortune and protection surround you.',i:'ğŸ‘¼',lv:'ìµœìƒ'});
    
    // 2. ì²œë•ê·€ì¸ (å¤©å¾·è²´äºº)
    const tiande = [9,8,7,6,5,4,3,2,1,0,9,8]; // By month
    if (mbi < 12 && (dmi === tiande[mbi] || brs.some(b => b === tiande[mbi]))) ss.push({n:'å¤©å¾·è²´äºº(Heavens Virtue Noble)',t:'good',d:'Heavens virtue shines upon you! Living righteously multiplies your blessings tenfold.',i:'ğŸŒŸ',lv:'ìƒ'});
    
    // 3. ì›”ë•ê·€ì¸ (æœˆå¾·è²´äºº)
    const yuede = [2,6,2,6,4,8,4,8,0,6,0,6]; // By month ì²œê°„
    if (mbi < 12 && dmi === yuede[mbi]) ss.push({n:'æœˆå¾·è²´äºº(Moons Virtue Noble)',t:'good',d:'Moons blessing graces your path! Natural charisma draws trust and admiration. Official positions favor you.',i:'ğŸŒ™',lv:'ìƒ'});
    
    // 4. ë¬¸ì°½ê·€ì¸ (æ–‡æ˜Œè²´äºº)
    const munchang = {0:5,1:6,2:8,3:9,4:8,5:9,6:11,7:0,8:2,9:3};
    if (brs.includes(munchang[dmi])) ss.push({n:'æ–‡æ˜Œè²´äºº(Scholar Star)',t:'good',d:'Brilliant scholarly mind! Exams, certifications, and academic pursuits bend to your will. Writing flows naturally.',i:'ğŸ“š',lv:'ìƒ'});
    
    // 5. í•™ë‹¹ê·€ì¸ (å­¸å ‚è²´äºº)
    const xuetang = {0:11,1:6,2:2,3:9,4:2,5:9,6:5,7:0,8:8,9:3};
    if (brs.includes(xuetang[dmi])) ss.push({n:'å­¸å ‚è²´äºº(Academy Noble)',t:'good',d:'Scholars destiny! Research and education lead to greatness. Professorship and expertise await.',i:'ğŸ“',lv:'ìƒ'});
    
    // 6. ì¥ì„±ê·€ì¸ (å°‡æ˜Ÿè²´äºº)
    const jiangx = {0:0,1:9,2:6,3:3,4:0,5:9,6:6,7:3,8:0,9:9,10:6,11:3}; // By Year Branch
    if (brs.includes(jiangx[ybi])) ss.push({n:'å°‡æ˜Ÿ(General Star)',t:'good',d:'Commanders spirit! Natural leadership draws followers. You are destined to lead.',i:'ğŸ–ï¸',lv:'ìƒ'});
    
    // 7. é‡‘è¼¿(Golden Carriage) (é‡‘è¼¿) - ë°°ìš°ì ë³µ
    const jinyu = {0:4,1:5,2:7,3:8,4:7,5:8,6:10,7:11,8:1,9:2};
    if (brs.includes(jinyu[dmi])) ss.push({n:'é‡‘è¼¿(Golden Carriage)',t:'good',d:'Supreme spouse fortune! Marriage unlocks your destiny. An ideal partner awaits.',i:'ğŸ’',lv:'ìƒ'});
    
    // 8. ë³µì„±ê·€ì¸ (ç¦æ˜Ÿè²´äºº)
    const fuxing = {0:2,1:3,2:5,3:6,4:5,5:6,6:8,7:9,8:11,9:0};
    if (brs.includes(fuxing[dmi])) ss.push({n:'ç¦æ˜Ÿè²´äºº(Fortune Noble)',t:'good',d:'Blessed chart! No worries about necessities. Lifetime abundance.',i:'ğŸ€',lv:'ìƒ'});
    
    // 9. ì•”ë¡ (æš—ç¥¿) - ìˆ¨ì€ ë…¹
    const anlu = {0:11,1:10,2:1,3:0,4:1,5:0,6:3,7:2,8:5,9:4};
    if (brs.includes(anlu[dmi])) ss.push({n:'æš—ç¥¿(Hidden Fortune)',t:'good',d:'Hidden blessings flow! Invisible support guides you when you least expect it.',i:'ğŸ',lv:'Medium'});
    
    // 10. Prime (å»ºç¥¿)
    const jianlu = {0:2,1:3,2:5,3:6,4:5,5:6,6:8,7:9,8:11,9:0};
    if (brs.includes(jianlu[dmi])) ss.push({n:'å»ºç¥¿(Prime)',t:'good',d:'Self-made type! Success through own efforts. Stable career.',i:'ğŸ ',lv:'ìƒ'});
    
    // 11. ì²œì˜ì„± (å¤©é†«æ˜Ÿ)
    const tianyi = [11,0,1,2,3,4,5,6,7,8,9,10]; // By month
    if (mbi < 12 && brs.includes(tianyi[mbi])) ss.push({n:'å¤©é†«æ˜Ÿ(Heavenly Doctor)',t:'good',d:'Medical calling! Doctors, nurses, pharmacists â€” healing professions bring great fortune.',i:'ğŸ’Š',lv:'Medium'});
    
    // ========== ì¤‘ì„±(ä¸­æ€§) ==========
    
    // 12. é©›é¦¬(Traveling Horse) (é©›é¦¬æ®º)
    const yima = {0:2,1:11,2:8,3:5,4:2,5:11,6:8,7:5,8:2,9:11,10:8,11:5};
    if (brs.includes(yima[ybi])) ss.push({n:'é©›é¦¬(Traveling Horse)',t:'neutral',d:'Movement awakens fortune! Travel, relocation, overseas ventures â€” motion is your medicine.',i:'ğŸ',lv:'Medium'});
    
    // 13. æ¡ƒèŠ±(Peach Blossom) (æ¡ƒèŠ±æ®º)
    const taohua = {0:9,1:6,2:3,3:0,4:9,5:6,6:3,7:0,8:9,9:6,10:3,11:0};
    if (brs.includes(taohua[ybi])) ss.push({n:'æ¡ƒèŠ±(Peach Blossom)',t:'neutral',d:'Irresistible charm! Magnetic attraction to opposite sex. Star quality â€” guard against wandering heart.',i:'ğŸŒ¸',lv:'Medium'});
    
    // 14. Fireê°œì‚´ (è¯è“‹æ®º)
    const huagai = {0:4,1:1,2:10,3:7,4:4,5:1,6:10,7:7,8:4,9:1,10:10,11:7};
    if (brs.includes(huagai[ybi])) ss.push({n:'è¯è“‹(Canopy Star)',t:'neutral',d:'Artists soul! Music, art, and writing flow naturally. Spiritual and philosophical depths call to you.',i:'ğŸ¨',lv:'Medium'});
    
    // 15. í™ì—¼ì‚´ (ç´…è‰¶æ®º) - ì´ì„± ì¸ê¸°
    const hongyan = {0:6,1:5,2:8,3:7,4:8,5:7,6:9,7:8,8:11,9:10};
    if (brs.includes(hongyan[dmi])) ss.push({n:'ç´…è‰¶(Red Romance)',t:'neutral',d:'Sexy charm! Attractive to opposite sex. Entertainment aptitude, watch infidelity!',i:'ğŸ’‹',lv:'Medium'});
    
    // ========== í‰ì‹ (å‡¶ç¥) ==========
    
    // 16. ê´´ê°•ì‚´ (é­ç½¡æ®º)
    const kuigang = [[6,4],[],[6,4],[],[6,10],[],[6,10],[],[],[]]; // Day Branch by Day Master
    if (kuigang[dmi] && kuigang[dmi].includes(dbi)) ss.push({n:'é­ç½¡(Fierce Star)',t:'bad',d:'Fierce fire spirit! Charismatic leader potential â€” temper your autocratic tendencies.',i:'âš¡',lv:'ìƒ'});
    
    // 17. ì–‘ì¸ì‚´ (ç¾Šåˆƒæ®º)
    const yangren = {0:3,1:2,2:6,3:5,4:6,5:5,6:9,7:8,8:0,9:11};
    if (dbi === yangren[dmi]) ss.push({n:'Sheep Blade (ç¾Šåˆƒ)',t:'bad',d:'Sharp blade energy! Decisive but sharp. Suits military, surgeons, lawyers.',i:'ğŸ—¡ï¸',lv:'ìƒ'});
    
    // 18. ë°±í˜¸ì‚´ (ç™½è™æ®º)
    const baihu = [6,7,8,9,10,11,0,1,2,3,4,5]; // By month
    if (mbi < 12 && brs.includes(baihu[mbi])) ss.push({n:'ç™½è™(White Tiger)',t:'bad',d:'Accident alert! However, professions involving blood (medicine, culinary) transform this into blessing.',i:'ğŸ¯',lv:'Medium'});
    
    // ğŸ”¥ 18-2. ì¼ì£¼ ë°±í˜¸ëŒ€ì‚´ (æ—¥æŸ±ç™½è™) - Gemini Round 10
    // ì „í†µ: ç”²è¾°, ä¹™å·³, ä¸™æˆŒ, ä¸ä¸‘, æˆŠè¾°, å·±æœª, åºšæˆŒ, è¾›ä¸‘, å£¬è¾°, ç™¸ä¸‘
    const dayPillarStr = saju.day.s.c + saju.day.b.c;
    const whiteTigerDays = ['ç”²è¾°', 'ä¹™å·³', 'ä¸™æˆŒ', 'ä¸ä¸‘', 'æˆŠè¾°', 'å·±æœª', 'åºšæˆŒ', 'è¾›ä¸‘', 'å£¬è¾°', 'ç™¸ä¸‘'];
    if (whiteTigerDays.includes(dayPillarStr)) {
        ss.push({n:'Day Pillar White Tiger (æ—¥æŸ±ç™½è™)',t:'bad',d:'White Tiger in your core pillar! Gentle normally, fierce when provoked. Blood-related events possible for self/spouse/children. Medical, religious, or healing professions transform this into blessing. For women: watch for difficult childbirth.',i:'ğŸ…',lv:'High'});
    }
    
    // 19. ê²ì‚´ (åŠ«æ®º)
    const jiesha = {0:5,1:2,2:11,3:8,4:5,5:2,6:11,7:8,8:5,9:2,10:11,11:8};
    if (brs.includes(jiesha[ybi])) ss.push({n:'åŠ«æ®º(Robbery Star)',t:'bad',d:'Financial vulnerability! Guard against theft, fraud, bad investments. Never co-sign loans!',i:'ğŸ’¸',lv:'Medium'});
    
    // 20. ë§ì‹ ì‚´ (äº¡ç¥æ®º)
    const wangshen = {0:9,1:6,2:3,3:0,4:9,5:6,6:3,7:0,8:9,9:6,10:3,11:0};
    if (brs.includes(wangshen[ybi]) && wangshen[ybi] !== taohua[ybi]) ss.push({n:'äº¡ç¥(Disgrace Star)',t:'bad',d:'Reputation vulnerability! Guard social media, drinking occasions carefully.',i:'ğŸ˜°',lv:'Medium'});
    
    // 21. ì›ì§„ì‚´ (æ€¨å—”æ®º)
    const yuanchen = [[7],[6],[5],[4],[3],[2],[1],[0],[11],[10],[9],[8]];
    if (yuanchen[ybi] && brs.some(b => yuanchen[ybi].includes(b))) ss.push({n:'æ€¨å—”(Resentment Star)',t:'bad',d:'Love-hate bonds entangle you. Navigate close relationships with care.',i:'ğŸ’”',lv:'Medium'});
    
    // 22. ê·€ë¬¸ê´€ì‚´ (é¬¼é–€é—œæ®º)
    const guimen = [[5,6],[6,7],[7,8],[8,9],[9,10],[10,11],[11,0],[0,1],[1,2],[2,3],[3,4],[4,5]];
    if (guimen[ybi] && brs.some(b => guimen[ybi].includes(b))) ss.push({n:'é¬¼é–€é—œ(Spirit Gate)',t:'neutral',d:'Highly intuitive and spiritually sensitive. You have a sixth sense for art and people. Meditation is your power source.',i:'ğŸ”®',lv:'Medium'});
    
    // 23. í˜„ì¹¨ì‚´ (æ‡¸é‡æ®º) - ç”², ç”³, è¾›ì— ì„¸ë¡œíš
    if ([0,7].includes(dmi)) ss.push({n:'æ‡¸é‡(Needle Star)',t:'bad',d:'Needle-sharp energy! Critical perfectionist. Talent for acupuncture, precision crafts.',i:'ğŸ“',lv:'í•˜'});
    
    // 24. ìœ¡í•´ì‚´ (å…­å®³æ®º)
    const liuhai = [[7],[6],[5],[4],[3],[2],[1],[0],[11],[10],[9],[8]];
    if (liuhai[dbi] && brs.some(b => liuhai[dbi].includes(b) && b !== dbi)) ss.push({n:'å…­å®³(Six Harms)',t:'bad',d:'Vulnerability through close ones. Navigate spouse and sibling relationships carefully.',i:'âš ï¸',lv:'Medium'});
    
    // 25. ì²œë¼ì§€ë§ (å¤©ç¾…åœ°ç¶²)
    const tianluodiwang = (dbi === 10 && [5,6].includes(mbi)) || (dbi === 11 && [9,10].includes(mbi));
    if (tianluodiwang) ss.push({n:'å¤©ç¾…åœ°ç¶²(Heavens Net)',t:'bad',d:'Caught in heavens net. Guard against gossip, lawsuits. Feelings of entrapment may arise.',i:'ğŸ•¸ï¸',lv:'Medium'});
    
    // 26. ê³ ë€ì‚´ (å­¤é¸æ®º) - í˜¼ì ìˆëŠ” ê¸°ëŸ¬ê¸°
    const guluanM = [[0,2],[1,3],[2,5],[3,6],[4,5],[5,6],[6,8],[7,9],[8,11],[9,0]]; // Day Master+Branch combo (male)
    const guluanF = [[1,3],[0,2],[3,6],[2,5],[3,6],[2,5],[7,9],[6,8],[9,0],[8,11]]; // female
    const guluanCheck = GENDER === 'm' ? guluanM : guluanF;
    if (guluanCheck[dmi] && guluanCheck[dmi][1] === dbi) ss.push({n:'å­¤é¸(Lonely Swan)',t:'bad',d:'Solitary spirit dwells within. Late marriage or single tendencies. Solitude becomes your companion.',i:'ğŸ¦¢',lv:'í•˜'});
    
    // 27. ì‚¼ì¬ (ä¸‰ç½) - Year Branch ê¸°ì¤€
    // ì‚¼í•© ê¸°ì¤€: å·³é…‰ä¸‘â†’å¯…å¯è¾°, å¯…åˆæˆŒâ†’ç”³é…‰æˆŒ, ç”³å­è¾°â†’å·³åˆæœª, äº¥å¯æœªâ†’äº¥å­ä¸‘
    // ì¸ë±ìŠ¤: å­0,ä¸‘1,å¯…2,å¯3,è¾°4,å·³5,åˆ6,æœª7,ç”³8,é…‰9,æˆŒ10,äº¥11
    const sanzai = {
        5:[2,3,4], 9:[2,3,4], 1:[2,3,4],    // å·³é…‰ä¸‘ë  â†’ å¯…å¯è¾°ë…„ ì‚¼ì¬
        2:[8,9,10], 6:[8,9,10], 10:[8,9,10], // å¯…åˆæˆŒë  â†’ ç”³é…‰æˆŒë…„ ì‚¼ì¬
        8:[5,6,7], 0:[5,6,7], 4:[5,6,7],    // ç”³å­è¾°ë  â†’ å·³åˆæœªë…„ ì‚¼ì¬
        11:[11,0,1], 3:[11,0,1], 7:[11,0,1]  // äº¥å¯æœªë  â†’ äº¥å­ä¸‘ë…„ ì‚¼ì¬
    };
    const curYear = new Date().getFullYear();
    const curYearBranch = (curYear - 4) % 12;
    if (sanzai[ybi] && sanzai[ybi].includes(curYearBranch)) ss.push({n:'ä¸‰ç½(Three Calamities)',t:'bad',d:'Three Calamities period active! Exercise caution for 3 years. Avoid reckless expansion and major moves.',i:'ğŸ”¥',lv:'Medium'});
    
    // 28. ë°˜ì•ˆì‚´ (æ”€éæ®º)
    const panan = {0:2,1:3,2:5,3:6,4:5,5:6,6:8,7:9,8:11,9:0};
    if (brs.includes(panan[dmi])) ss.push({n:'æ”€é(Climbing Saddle)',t:'good',d:'Good career luck! Promotion type in stable organizations. Suits corporations.',i:'ğŸ’º',lv:'Medium'});
    
    // 29. ì²œì£¼ê·€ì¸ (å¤©å»šè²´äºº) - ì‹ë³µ
    const tianchu = {0:5,1:6,2:8,3:9,4:8,5:9,6:11,7:0,8:2,9:3};
    if (brs.includes(tianchu[dmi])) ss.push({n:'å¤©å»šè²´äºº(Heavenly Kitchen)',t:'good',d:'Blessed with food fortune! Never worry about hunger. Culinary talent awaits discovery.',i:'ğŸ½ï¸',lv:'Medium'});
    
    // 30. ì²œì‚¬(å¤©èµ¦) - í•˜ëŠ˜ì´ ìš©ì„œí•˜ëŠ” ë‚ 
    const tiansha = [[2,0],[3,1],[5,2],[6,3],[8,4],[9,5],[11,6],[0,7],[2,8],[3,9]]; // [Branch,Stem] combination
    if (tiansha.some(ts => dbi === ts[0] && dmi === ts[1])) ss.push({n:'å¤©èµ¦æ—¥(Heavens Pardon)',t:'good',d:'å¤©èµ¦æ—¥(Heavens Pardon) Day! Misfortunes transform into blessings. Divine forgiveness surrounds you.',i:'ğŸ•Šï¸',lv:'ìƒ'});
    
    return ss.length ? ss : [{n:'No Special Stars',t:'neutral',d:'No exceptional divine stars. A peacefully balanced chart brings steady fortune.',i:'â˜¯ï¸',lv:'Medium'}];
}

/* ========================================
   13. í•©ì¶©í˜•íŒŒí•´ (í™•ì¥íŒ)
   ======================================== */
function calcInteractions(saju) {
    const res = [];
    const stems = [STEM.indexOf(saju.year.s), STEM.indexOf(saju.month.s), STEM.indexOf(saju.day.s)];
    const brs = [BRANCH.findIndex(br => br.c === saju.year.b.c), BRANCH.findIndex(br => br.c === saju.month.b.c), BRANCH.findIndex(br => br.c === saju.day.b.c)];
    if (saju.hour) { stems.push(STEM.indexOf(saju.hour.s)); brs.push(BRANCH.findIndex(br => br.c === saju.hour.b.c)); }
    
    // â˜… ì¤‘ë³µ ì œê±°ìš© Set
    const addedCombines = new Set();
    
    // StemsHarmony
    const stComb = [[0,5,'ç”²å·± (Wood+Earth) combine to Earth'],[1,6,'ä¹™åºš (Wood+Metal) combine to Metal'],[2,7,'ä¸™è¾› (Fire+Metal) combine to Water'],[3,8,'ä¸å£¬ (Fire+Water) combine to Wood'],[4,9,'æˆŠç™¸ (Earth+Water) combine to Fire']];
    for (let [a,b,n] of stComb) {
        for (let i = 0; i < stems.length; i++) {
            for (let j = i+1; j < stems.length; j++) {
                if ((stems[i]===a && stems[j]===b) || (stems[i]===b && stems[j]===a)) {
                    const key = `å¤©åˆ:${Math.min(a,b)}-${Math.max(a,b)}`;
                    if (!addedCombines.has(key)) {
                        addedCombines.add(key);
                        res.push({t:'å¤©åˆ',c:`${STEM[a].c}+${STEM[b].c}`,m:n,d:'ğŸ’« Heavenly stems unite to create new energy! This harmony brings smooth relationships, good timing, and opportunities. A blessing in your chart.'});
                    }
                }
            }
        }
    }
    
    // Stemsì¶© (å¤©å¹²æ²–) - ìƒˆë¡œ ì¶”ê°€
    const stClash = [
        [0,6,'ç”²åºš (Wood vs Metal) clash','Strong decisiveness but many conflicts. Leadership vs authority!'],
        [1,7,'ä¹™è¾› (Wood vs Metal) clash','Inner conflict. Flexibility vs rigidity collide.'],
        [2,8,'ä¸™å£¬ (Fire vs Water) clash','Passion vs wisdom clash. Watch impulsiveness!'],
        [3,9,'ä¸ç™¸ (Fire vs Water) clash','Emotion and reason clash. Mood swings possible.'],
        [4,4,'æˆŠæˆŠ (Earth+Earth) Peer','Stubborn with strong self-assertion.'],
        [5,5,'å·±å·± (Earth+Earth) Peer','Pure but may be indecisive.']
    ];
    for (let [a,b,n,desc] of stClash) {
        for (let i = 0; i < stems.length; i++) {
            for (let j = i+1; j < stems.length; j++) {
                if ((stems[i]===a && stems[j]===b) || (stems[i]===b && stems[j]===a)) {
                    res.push({t:'å¤©æ²–',c:`${STEM[a].c}â†”${STEM[b].c}`,m:n,d:desc});
                }
            }
        }
    }
    
    // Branch Six Harmony
    const hap = [[0,1,'å­ä¸‘(Rat-Ox) combine to Earth'],[2,11,'å¯…äº¥(Tiger-Pig) combine to Wood'],[3,10,'å¯æˆŒ(Rabbit-Dog) combine to Fire'],[4,9,'è¾°é…‰(Dragon-Rooster) combine to Metal'],[5,8,'å·³ç”³(Snake-Monkey) combine to Water'],[6,7,'åˆæœª(Horse-Goat) combine to Fire']];
    for (let [a,b,n] of hap) {
        if (brs.includes(a) && brs.includes(b)) res.push({t:'å…­åˆ',c:`${BRANCH[a].c}+${BRANCH[b].c}`,m:n,d:'ğŸ’• Six Harmony brings natural affinity and attraction. People find you likeable and trustworthy. Great for partnerships and relationships!'});
    }
    
    // Trinity
    const samhap = [[2,6,10,'å¯…åˆæˆŒ(Tiger-Horse-Dog) Fire combination'],[5,9,1,'å·³é…‰ä¸‘(Snake-Rooster-Ox) Metal combination'],[8,0,4,'ç”³å­è¾°(Monkey-Rat-Dragon) Water combination'],[11,3,7,'äº¥å¯æœª(Pig-Rabbit-Goat) Wood combination']];
    for (let [a,b,c,n] of samhap) {
        const has = [brs.includes(a), brs.includes(b), brs.includes(c)];
        if (has.filter(x=>x).length === 3) res.push({t:'ä¸‰åˆ',c:`${BRANCH[a].c}${BRANCH[b].c}${BRANCH[c].c}`,m:n,d:'ğŸŒŸ Complete Trinity! Three branches unite to form a powerful elemental force. This brings strong support, teamwork, and the ability to achieve big goals.'});
        else if (has.filter(x=>x).length === 2 && has[1]) res.push({t:'åŠåˆ',c:has[0]?`${BRANCH[a].c}${BRANCH[b].c}`:has[2]?`${BRANCH[b].c}${BRANCH[c].c}`:'',m:n.split(' ')[0]+' half-combination',d:'â­ Partial Trinity forming. The energy is building but not yet complete. When the missing branch appears in luck cycles, expect major positive changes!'});
    }
    
    // Clash
    const clash = [[0,6,'å­åˆ(Rat-Horse) clash','North-south collision! Heart and reality conflict.'],[1,7,'ä¸‘æœª(Ox-Goat) clash','Wealth-related changes coming.'],[2,8,'å¯…ç”³(Tiger-Monkey) clash','Activity increases. Watch traffic safety!'],[3,9,'å¯é…‰(Rabbit-Rooster) clash','Document and contract issues may arise.'],[4,10,'è¾°æˆŒ(Dragon-Dog) clash','Stubborn nature causes conflicts.'],[5,11,'å·³äº¥(Snake-Pig) clash','Plans may not go as expected.']];
    for (let [a,b,n,desc] of clash) {
        const ia = brs.indexOf(a), ib = brs.indexOf(b);
        if (ia >= 0 && ib >= 0) {
            const dist = Math.abs(ia - ib);
            const strength = dist === 1 ? 'âš¡Strong clash' : dist === 2 ? 'Moderate clash' : 'Weak clash';
            res.push({t:'æ²–',c:`${BRANCH[a].c}â†”${BRANCH[b].c}`,m:`${n} (${strength})`,d:desc});
        }
    }
    
    // Punishment (detailed) - ì‚¼í˜•, ìƒí˜•, ìí˜•
    // 1. ì‚¼í˜• (ä¸‰åˆ‘) - ì¸ì‚¬ì‹ 
    if (brs.includes(2) && brs.includes(5) && brs.includes(8)) {
        res.push({t:'ä¸‰åˆ‘',c:'å¯…å·³ç”³',m:'Punishment of Ingratitude',d:'âš ï¸ Triple Punishment present. Life may test you through unexpected betrayals or accidents. Stay humble, show gratitude, and be extra careful with safety. Challenges make you stronger.'});
    }
    // 2. ì¶•ìˆ ë¯¸ ì‚¼í˜•
    if (brs.includes(1) && brs.includes(10) && brs.includes(7)) {
        res.push({t:'ä¸‰åˆ‘',c:'ä¸‘æˆŒæœª',m:'Punishment of Disrespect',d:'âš ï¸ Triple Earth Punishment. Your strong convictions can come across as stubbornness. Practice flexibility and respect others viewpoints. Softening your approach brings harmony.'});
    }
    // 3. ìƒí˜• (ç›¸åˆ‘) - ë‘ ê¸€ì
    const brHyung = [
        [2,5,'å¯…å·³(Tiger-Snake) punishment','Part of ingratitude. Watch for betrayal and gossip!'],
        [5,8,'å·³ç”³(Snake-Monkey) punishment','Part of ingratitude. Cold and conflict-prone.'],
        [2,8,'å¯…ç”³(Tiger-Monkey) punishment','Attraction despite clashing. Watch traffic safety!'],
        [1,10,'ä¸‘æˆŒ(Ox-Dog) punishment','Part of disrespect. Stubbornness causes conflicts!'],
        [10,7,'æˆŒæœª(Dog-Goat) punishment','Part of disrespect. Earth signs clash!'],
        [1,7,'ä¸‘æœª(Ox-Goat) punishment','Part of disrespect. Wealth conflicts!'],
        [0,3,'å­å¯(Rat-Rabbit) punishment','Disrespect type. Easy to lose manners. Watch your words!']
    ];
    for (let [a,b,n,desc] of brHyung) {
        const ia = brs.indexOf(a), ib = brs.indexOf(b);
        if (ia >= 0 && ib >= 0) {
            // Skip if already in triple punishment
            if (!(brs.includes(2) && brs.includes(5) && brs.includes(8) && [2,5,8].includes(a) && [2,5,8].includes(b)) &&
                !(brs.includes(1) && brs.includes(10) && brs.includes(7) && [1,10,7].includes(a) && [1,10,7].includes(b))) {
                res.push({t:'åˆ‘',c:`${BRANCH[a].c}â†”${BRANCH[b].c}`,m:n,d:desc});
            }
        }
    }
    // 4. ìí˜• (è‡ªåˆ‘) - ê°™ì€ ê¸€ìë¼ë¦¬
    const selfPunish = {4:'è¾°è¾°(Dragon-Dragon) self-punishment',6:'åˆåˆ(Horse-Horse) self-punishment',9:'é…‰é…‰(Rooster-Rooster) self-punishment',11:'äº¥äº¥(Pig-Pig) self-punishment'};
    for (let i = 0; i < brs.length; i++) {
        for (let j = i+1; j < brs.length; j++) {
            if (brs[i] === brs[j] && selfPunish[brs[i]]) {
                res.push({t:'è‡ªåˆ‘',c:`${BRANCH[brs[i]].c}+${BRANCH[brs[j]].c}`,m:selfPunish[brs[i]],d:'ğŸª Self-Punishment energy. You tend to be hard on yourself. Your greatest critic lives within. Practice self-compassion and celebrate small wins. You deserve kindness from yourself.'});
            }
        }
    }
    
    // Break
    const brPa = [[0,9,'å­é…‰(Rat-Rooster) destruction','Relationships may break easily.'],[3,6,'å¯åˆ(Rabbit-Horse) destruction','Plans may go awry.'],[2,11,'å¯…äº¥(Tiger-Pig) destruction','Complete tasks properly.'],[4,1,'è¾°ä¸‘(Dragon-Ox) destruction','Foundation may shake.']];
    for (let [a,b,n,desc] of brPa) {
        if (brs.includes(a) && brs.includes(b)) res.push({t:'ç ´',c:`${BRANCH[a].c}â†”${BRANCH[b].c}`,m:n,d:desc});
    }
    
    // Harm
    const brHae = [[0,7,'å­æœª(Rat-Goat) harm','Close ones may hold you back.'],[1,6,'ä¸‘åˆ(Ox-Horse) harm','Watch partnerships!'],[2,5,'å¯…å·³(Tiger-Snake) harm','Jealousy may arise. Avoid showing off.'],[3,4,'å¯è¾°(Rabbit-Dragon) harm','Small matters may cause big fights.']];
    for (let [a,b,n,desc] of brHae) {
        if (brs.includes(a) && brs.includes(b)) res.push({t:'å®³',c:`${BRANCH[a].c}â†”${BRANCH[b].c}`,m:n,d:desc});
    }
    
    // Resentment - Important for compatibility
    const wonJin = [[0,7,'å­æœª(Rat-Goat) resentment'],[1,6,'ä¸‘åˆ(Ox-Horse) resentment'],[2,5,'å¯…å·³(Tiger-Snake) resentment'],[3,4,'å¯è¾°(Rabbit-Dragon) resentment'],[4,3,'è¾°å¯(Dragon-Rabbit) resentment'],[5,2,'å·³å¯…(Snake-Tiger) resentment'],[6,1,'åˆä¸‘(Horse-Ox) resentment'],[7,0,'æœªå­(Goat-Rat) resentment'],[8,11,'ç”³äº¥(Monkey-Pig) resentment'],[9,10,'é…‰æˆŒ(Rooster-Dog) resentment'],[10,9,'æˆŒé…‰(Dog-Rooster) resentment'],[11,8,'äº¥ç”³(Pig-Monkey) resentment']];
    for (let [a,b,n] of wonJin) {
        if (brs.includes(a) && brs.includes(b)) {
            res.push({t:'æ€¨å—”',c:`${BRANCH[a].c}â†”${BRANCH[b].c}`,m:n,d:'ğŸ’” Resentment energy. A complex love-hate dynamic â€” you cant live with them, cant live without them. In relationships, acknowledge the tension and communicate openly to transform it into growth.'});
        }
    }
    
    // Ghost Gate
    const guiMen = [[2,7,'å¯…æœª(Tiger-Goat) Spirit Gate'],[3,8,'å¯ç”³(Rabbit-Monkey) Intuitive Flash'],[4,9,'è¾°é…‰(Dragon-Rooster) Artistic Nerves'],[5,10,'å·³æˆŒ(Snake-Dog) Deep Insight'],[6,11,'åˆäº¥(Horse-Pig) Mystic Gate'],[1,6,'ä¸‘åˆ(Ox-Horse) Emotional Depth']];
    for (let [a,b,n] of guiMen) {
        if (brs.includes(a) && brs.includes(b)) {
            res.push({t:'é¬¼é–€',c:`${BRANCH[a].c}â†”${BRANCH[b].c}`,m:n,d:'ğŸ‘ï¸ Spirit Gate open. You possess extraordinary intuition and can sense what others cannot. This is a gift! Channel it through art, spirituality, meditation, or counseling. Trust your inner voice.'});
        }
    }
    
    return res.length ? res : [{t:'-',c:'none',m:'No special interactions',d:'No significant clash or harmony. A peaceful, balanced chart!'}];
}

/* ========================================
   14. ê³µë§
   ======================================== */
function calcGongmang(saju) {
    if (!saju || !saju.day) return { gm: [], names: [], affected: [] };

    const stemIdx = STEM.findIndex(s => s.c === saju.day.s.c);
    const branchIdx = BRANCH.findIndex(b => b.c === saju.day.b.c);

    // Calculate remaining to Gui(9)
    const toGui = 9 - stemIdx; 
    const gm1 = (branchIdx + toGui + 1) % 12; // First emptiness
    const gm2 = (branchIdx + toGui + 2) % 12; // Second emptiness

    const gm = [gm1, gm2];
    const names = [BRANCH[gm1].c, BRANCH[gm2].c];
    
    const affected = [];
    const pillars = ['Year Branch','Month Branch','Day Branch','Hour Branch'];
    const brs = [
        BRANCH.findIndex(b => b.c === saju.year.b.c),
        BRANCH.findIndex(b => b.c === saju.month.b.c),
        BRANCH.findIndex(b => b.c === saju.day.b.c)
    ];
    if (saju.hour) brs.push(BRANCH.findIndex(b => b.c === saju.hour.b.c));

    brs.forEach((b, i) => { 
        if (gm.includes(b)) affected.push(pillars[i]); 
    });

    return { gm, names, affected };
}

/* ========================================
   14-0-1. Six Relations - Parents/Siblings/Children/Spouse fortune
   ======================================== */
function analyzeYukChinRon(saju, gender) {
    const dm = saju.day.s;
    const result = {
        father: null,    // Father (åè²¡/Indirect Wealth)
        mother: null,    // Mother (Direct Seal/Indirect Seal)
        sibling: null,   // Sibling (Peer/Competitor)
        spouse: null,    // Spouse (M:Wealth, F:Officer)
        children: null   // Children (M:Officer, F:Food/Hurt)
    };
    
    // Ten Gods distribution analysis
    const godCount = {};
    const godPositions = {};
    const pillars = [
        {name: 'Year Pillar', pillar: saju.year},
        {name: 'Month', pillar: saju.month},
        {name: 'Day', pillar: saju.day},
    ];
    if (saju.hour) pillars.push({name: 'Hour', pillar: saju.hour});
    
    pillars.forEach(p => {
        if (p.name === 'Day') return; // Exclude Day Master
        const sGod = getTenGod(p.pillar.s, dm);
        const bGod = getTenGod(p.pillar.b, dm); // Based on branch main stem
        
        [sGod, bGod].forEach(god => {
            if (god) {
                if (!godCount[god.k]) godCount[god.k] = 0;
                if (!godPositions[god.k]) godPositions[god.k] = [];
                godCount[god.k]++;
                godPositions[god.k].push(p.name);
            }
        });
    });
    
    // 1. ë¶€ì¹œìš´ (åè²¡/Indirect Wealth)
    const fatherGod = 'åè²¡(Indirect Wealth)';
    const fatherCount = godCount[fatherGod] || 0;
    if (fatherCount >= 2) {
        result.father = {status: 'strong', desc: 'Deep bond with father. You receive paternal support and blessings.', icon: 'ğŸ‘¨â€ğŸ‘¦'};
    } else if (fatherCount === 1) {
        result.father = {status: 'normal', desc: 'Normal relationship with father. Healthy distance works well.', icon: 'ğŸ‘¨'};
    } else {
        result.father = {status: 'weak', desc: 'Weak father bond or early separation possible.', icon: 'ğŸ‘¤'};
    }
    
    // 2. ëª¨ì¹œìš´ (Direct Seal/Indirect Seal)
    const motherCount = (godCount['æ­£å°(Direct Seal)'] || 0) + (godCount['åå°(Indirect Seal)'] || 0);
    if (motherCount >= 2) {
        result.mother = {status: 'strong', desc: 'Deep bond with mother. You receive abundant maternal love.', icon: 'ğŸ‘©â€ğŸ‘¦'};
    } else if (motherCount === 1) {
        result.mother = {status: 'normal', desc: 'Normal relationship with mother.', icon: 'ğŸ‘©'};
    } else {
        result.mother = {status: 'weak', desc: 'Weak mother bond or early independence likely.', icon: 'ğŸ‘¤'};
    }
    
    // 3. Sibling fortune (Peer/Competitor)
    const siblingCount = (godCount['æ¯”è‚©(Peer)'] || 0) + (godCount['åŠ«è²¡(Competitor)'] || 0);
    if (siblingCount >= 2) {
        result.sibling = {status: 'strong', desc: 'Many siblings or deep sibling bonds. Some competition possible.', icon: 'ğŸ‘«'};
    } else if (siblingCount === 1) {
        result.sibling = {status: 'normal', desc: 'Average relationship with siblings.', icon: 'ğŸ§‘â€ğŸ¤â€ğŸ§‘'};
    } else {
        result.sibling = {status: 'weak', desc: 'Few siblings or weak connection. Strong independence.', icon: 'ğŸ§'};
    }
    
    // 4. Spouse Fortune (ë‚¨:ì¬ì„±, ì—¬:ê´€ì„±)
    let spouseCount, spouseGods;
    if (gender === 'm') {
        spouseCount = (godCount['æ­£è²¡(Direct Wealth)'] || 0) + (godCount['åè²¡(Indirect Wealth)'] || 0);
        spouseGods = ['æ­£è²¡(Direct Wealth)', 'åè²¡(Indirect Wealth)'];
    } else {
        spouseCount = (godCount['æ­£å®˜(Direct Officer)'] || 0) + (godCount['åå®˜(Challenger)'] || 0);
        spouseGods = ['æ­£å®˜(Direct Officer)', 'åå®˜(Challenger)'];
    }
    
    // Day Branch(Spouse Palace) ë¶„ì„
    const spouseGod = getTenGod(saju.day.b, dm);
    const spouseGodMatch = spouseGod && spouseGods.includes(spouseGod.k);
    
    if (spouseCount >= 2 && spouseGodMatch) {
        result.spouse = {status: 'excellent', desc: 'Excellent spouse fortune! You will meet a great partner.', icon: 'ğŸ’‘'};
    } else if (spouseCount >= 1 || spouseGodMatch) {
        result.spouse = {status: 'good', desc: 'Good spouse fortune. Marriage brings stability.', icon: 'ğŸ’'};
    } else {
        result.spouse = {status: 'normal', desc: 'Average spouse connection. Meeting later is fine.', icon: 'ğŸ’’'};
    }
    
    // 5. Children fortune (M:Officer, F:Food/Hurt)
    let childCount;
    if (gender === 'm') {
        childCount = (godCount['æ­£å®˜(Direct Officer)'] || 0) + (godCount['åå®˜(Challenger)'] || 0);
    } else {
        childCount = (godCount['é£Ÿç¥(Eating God)'] || 0) + (godCount['å‚·å®˜(Expressor)'] || 0);
    }
    
    // Hour(Children Palace) ë¶„ì„
    const hasHour = !!saju.hour;
    if (childCount >= 2) {
        result.children = {status: 'strong', desc: 'Excellent children fortune! Your children will make you proud.', icon: 'ğŸ‘¶ğŸ‘¶'};
    } else if (childCount === 1) {
        result.children = {status: 'normal', desc: 'Normal children fortune. 1-2 children recommended.', icon: 'ğŸ‘¶'};
    } else {
        result.children = {status: 'weak', desc: 'Weak children bond or late arrival possible. Effort is essential.', icon: 'ğŸ¼'};
    }
    
    return result;
}

/* ========================================
   14-0-2. ì§ˆë³‘ë¡ (ç–¾ç—…è«–) - ì˜¤í–‰ë³„ ê±´ê°•
   ======================================== */
function analyzeHealth(saju, gods) {
    const result = {
        strong: [],  // Strong elements (excess)
        weak: [],    // Weak elements (deficient)
        advice: []   // Health advice
    };
    
    // Five Elements calculation
    const elCount = {wood:0, fire:0, earth:0, metal:0, water:0};
    [saju.year, saju.month, saju.day, saju.hour].forEach(p => {
        if (p && p.s) elCount[p.s.e]++;
        if (p && p.b) elCount[p.b.e]++;
    });
    
    // Five Elementsë³„ ì¥ê¸°/ì§ˆë³‘ ë§¤í•‘
    const healthMap = {
        wood: {
            organ: 'Liver, Gallbladder, Eyes, Muscles, Nails',
            excess: 'Headaches, red eyes, muscle cramps, irritability',
            deficient: 'Poor vision, fatigue, weak muscles, brittle nails',
            advice: 'Eat green vegetables, rest eyes, stretch regularly'
        },
        fire: {
            organ: 'Heart, Small Intestine, Tongue, Blood Vessels',
            excess: 'Insomnia, palpitations, tongue sores, high blood pressure',
            deficient: 'Low blood pressure, cold hands/feet, depression, lethargy',
            advice: 'Red foods (tomatoes, dates), cardio exercise, meditation'
        },
        earth: {
            organ: 'Spleen, Stomach, Lips, Flesh',
            excess: 'Poor digestion, obesity, cracked lips, excessive worry',
            deficient: 'Poor appetite, thinness, weak digestion, fatigue',
            advice: 'Yellow foods (sweet potato, pumpkin), regular meals, avoid overeating'
        },
        metal: {
            organ: 'Lungs, Large Intestine, Nose, Skin, Body Hair',
            excess: 'Skin problems, constipation, respiratory sensitivity',
            deficient: 'Frequent colds, dry skin, weak colon, sadness',
            advice: 'White foods (radish, pear, bellflower), breathing exercises, moisturize skin'
        },
        water: {
            organ: 'Kidneys, Bladder, Ears, Bones, Hair',
            excess: 'Swelling, bedwetting, excessive fear',
            deficient: 'Weak lower back, hair loss, tinnitus, low vitality, weak bones',
            advice: 'Black foods (black beans, seaweed), stay hydrated, lower back exercises'
        }
    };
    
    const elNames = {wood:'Wood(æœ¨)', fire:'Fire(ç«)', earth:'Earth(åœŸ)', metal:'Metal(é‡‘)', water:'Water(æ°´)'};
    
    // Analysis
    for (const el in elCount) {
        const count = elCount[el];
        const info = healthMap[el];
        
        if (count >= 3) {
            result.strong.push({
                element: elNames[el],
                count: count,
                organ: info.organ,
                symptom: info.excess,
                icon: 'âš ï¸'
            });
        } else if (count === 0) {
            result.weak.push({
                element: elNames[el],
                count: count,
                organ: info.organ,
                symptom: info.deficient,
                icon: 'â—'
            });
        }
    }
    
    // Yongsin/ê¸°ì‹  ê¸°ë°˜ ì¡°ì–¸
    if (gods.yong) {
        const yongInfo = healthMap[gods.yong];
        if (yongInfo) {
            result.advice.push({
                title: `Beneficial Element (${elNames[gods.yong]}) reinforcement`,
                desc: yongInfo.advice,
                icon: 'ğŸ’ª'
            });
        }
    }
    
    // Find weakest element
    let minEl = null, minCount = 10;
    for (const el in elCount) {
        if (elCount[el] < minCount) {
            minCount = elCount[el];
            minEl = el;
        }
    }
    if (minEl && healthMap[minEl]) {
        result.advice.push({
            title: `Lacking ${elNames[minEl]} reinforcement`,
            desc: healthMap[minEl].advice,
            icon: 'ğŸ©º'
        });
    }
    
    // Season ì¡°ì–¸ (Month Branch ê¸°ì¤€)
    const monthEl = saju.month.b.e;
    if (monthEl === 'water' || monthEl === 'metal') {
        result.advice.push({
            title: 'Watch for cold energy',
            desc: 'Born in autumn/winter - body may run cold. Stay warm!',
            icon: 'ğŸ”¥'
        });
    } else if (monthEl === 'fire') {
        result.advice.push({
            title: 'Watch for hot energy',
            desc: 'Born in summer - body may run hot. Stay cool!',
            icon: 'â„ï¸'
        });
    }
    
    return result;
}

/* ========================================
   14-0. ê¶ìœ„(å®®ä½) ë¶„ì„
   ======================================== */
function analyzeGungwi(saju, birthYear) {
    const dm = saju.day.s;
    const curAge = new Date().getFullYear() - birthYear;
    
    // Palace definitions
    const gungwi = [
        {
            name: 'Year Pillar',
            alias: 'Ancestor PalaceÂ·Social Palace',
            pillar: saju.year,
            ageRange: 'Ages 1-15',
            represents: 'Ancestors, grandparents, social environment, early fortune',
            bodyPart: 'Head, face',
            relationM: 'Grandparents, maternal family',
            relationF: 'Grandmother, maternal family'
        },
        {
            name: 'Month(æœˆæŸ±)',
            alias: 'Parents PalaceÂ·Career Palace',
            pillar: saju.month,
            ageRange: 'Ages 16-30',
            represents: 'Parents, siblings, career, business, youth fortune',
            bodyPart: 'Chest, shoulders',
            relationM: 'Father, siblings',
            relationF: 'Mother, sisters'
        },
        {
            name: 'Day(æ—¥æŸ±)',
            alias: 'Spouse PalaceÂ·Self Palace',
            pillar: saju.day,
            ageRange: 'Ages 31-45',
            represents: 'Self, spouse, family, middle age fortune',
            bodyPart: 'Waist, abdomen',
            relationM: 'Spouse, self',
            relationF: 'Husband, self'
        },
        {
            name: 'Hour(æ™‚æŸ±)',
            alias: 'Children PalaceÂ·Later Years Palace',
            pillar: saju.hour,
            ageRange: 'Ages 46+',
            represents: 'Children, students, juniors, later years, outcomes',
            bodyPart: 'Legs, feet',
            relationM: 'Children, juniors',
            relationF: 'Children, juniors'
        }
    ];
    
    // Analyze each palace
    return gungwi.map((g, idx) => {
        if (!g.pillar) return {...g, analysis: 'No hour data', god: null, state: null};
        
        const god = idx !== 2 ? getTenGod(g.pillar.s, dm) : null;
        const state = getTwelveState(dm, g.pillar.b);
        
        // Analyze palace status
        let analysis = '';
        let rating = 'neutral';
        
        // Determine palace energy by Twelve States
        if (state.l >= 9) {
            analysis = 'Strong energy period! Active and dynamic time.';
            rating = 'good';
        } else if (state.l >= 6) {
            analysis = 'Stable energy. A smooth and fortunate period.';
            rating = 'good';
        } else if (state.l >= 3) {
            analysis = 'Moderate energy. A period requiring effort.';
            rating = 'neutral';
        } else {
            analysis = 'Weak energy period. Avoid overexertion.';
            rating = 'bad';
        }
        
        // Additional analysis by Ten Gods
        if (god) {
            if (['æ­£å®˜(Direct Officer)','æ­£è²¡(Direct Wealth)','æ­£å°(Direct Seal)'].includes(god.k)) {
                analysis += ` ${god.k} brings stability to this period.`;
                rating = 'good';
            } else if (['åå®˜(Challenger)','åŠ«è²¡(Competitor)'].includes(god.k)) {
                analysis += ` ${god.k} brings transformation and challenges to this period.`;
            }
        }
        
        // Check if current age matches palace
        let isCurrent = false;
        if (idx === 0 && curAge <= 15) isCurrent = true;
        else if (idx === 1 && curAge >= 16 && curAge <= 30) isCurrent = true;
        else if (idx === 2 && curAge >= 31 && curAge <= 45) isCurrent = true;
        else if (idx === 3 && curAge >= 46) isCurrent = true;
        
        return {
            ...g,
            god,
            state,
            analysis,
            rating,
            isCurrent
        };
    });
}

/* ========================================
   14-0-2. 12ìš´ì„± ì™„ì „ ë¶„ì„
   ======================================== */
function analyzeTwelveStates(saju) {
    const dm = saju.day.s;
    const result = {
        pillars: [],
        summary: '',
        dominant: null,
        lifeFlow: []
    };
    
    const pillarNames = ['Year Pillar', 'Month', 'Day', 'Hour'];
    const pillars = [saju.year, saju.month, saju.day, saju.hour];
    
    // Twelve States for each pillar
    pillars.forEach((p, idx) => {
        if (!p) return;
        const state = getTwelveState(dm, p.b);
        result.pillars.push({
            name: pillarNames[idx],
            branch: p.b,
            state: state,
            energy: state.l
        });
    });
    
    // Life flow analysis (12ìš´ì„± ìˆœì„œëŒ€ë¡œ)
    const lifeStages = [
        {stage: 'Birth(é•·ç”Ÿ)', desc: 'New beginning, hope and possibilities', life: 'Infancy'},
        {stage: 'Bath(æ²æµ´)', desc: 'Change and instability, new environment', life: 'Adolescence'},
        {stage: 'Crown(å† å¸¶)', desc: 'Growth and development, independence', life: 'Youth'},
        {stage: 'Prime(å»ºç¥¿)', desc: 'Stability and prosperity, prime time', life: 'Adulthood'},
        {stage: 'Peak(å¸æ—º)', desc: 'Peak, zenith, power', life: 'Middle age'},
        {stage: 'Decline(è¡°)', desc: 'Beginning of descent, consolidation', life: 'Late middle age'},
        {stage: 'Illness(ç—…)', desc: 'Weakness, watch health', life: 'Early elderly'},
        {stage: 'Stillness(æ­»)', desc: 'Completion, ending', life: 'Elderly'},
        {stage: 'Storage(å¢“)', desc: 'Storage, accumulation, retirement', life: 'Late elderly'},
        {stage: 'Void(çµ¶)', desc: 'Emptiness, severance', life: 'Later years'},
        {stage: 'Conception(èƒ)', desc: 'Conception, preparation', life: 'New preparation'},
        {stage: 'Nurture(é¤Š)', desc: 'Nurturing, protection', life: 'Recovery'}
    ];
    
    // Determine base energy by Day Branch Twelve States
    const dayState = getTwelveState(dm, saju.day.b);
    if (dayState.l >= 10) {
        result.summary = 'Very strong base energy! Full of vitality and drive.';
        result.dominant = 'strong';
    } else if (dayState.l >= 7) {
        result.summary = 'Good base energy. Stable and consistent.';
        result.dominant = 'good';
    } else if (dayState.l >= 4) {
        result.summary = 'Average base energy. Compensate with effort.';
        result.dominant = 'neutral';
    } else {
        result.summary = 'Weak base energy. Health management is important.';
        result.dominant = 'weak';
    }
    
    // Life flow (ë…„â†’ì›”â†’ì¼â†’ì‹œ)
    result.lifeFlow = result.pillars.map((p, idx) => {
        const ageRange = ['Early years(1-15)', 'Youth(16-30)', 'Middle age(31-45)', 'Later years(46+)'][idx];
        return {
            period: ageRange,
            state: p.state.k,
            energy: p.energy,
            advice: p.energy >= 8 ? 'Active period!' : p.energy >= 5 ? 'Stable period' : p.energy >= 3 ? 'Patience period' : 'Recovery period'
        };
    });
    
    return result;
}

/* ========================================
   14-0-3. Advanced Harmony/Clash Analysis (Transformation, Resolution)
   ======================================== */
function analyzeAdvancedInteractions(saju) {
    const result = {
        hapHwa: [],      // Transformation analysis
        chungHaeso: [],  // Clash resolution analysis
        samhapGuk: [],   // Trinity analysis
        warnings: []
    };
    
    const mbi = BRANCH.findIndex(br => br.c === saju.month.b.c);
    const season = SEASON[mbi];
    const stems = [saju.year?.s, saju.month?.s, saju.day?.s, saju.hour?.s].filter(s => s);
    const stemIdxs = stems.map(s => STEM.indexOf(s));
    const brs = [BRANCH.findIndex(br => br.c === saju.year.b.c), BRANCH.findIndex(br => br.c === saju.month.b.c), BRANCH.findIndex(br => br.c === saju.day.b.c)];
    if (saju.hour) brs.push(BRANCH.findIndex(br => br.c === saju.hour.b.c));
    
    // ========== Stem Transformation Conditions ==========
    const ganHap = [
        {pair: [0,5], result: 'earth', name: 'ç”²å·± (Wood+Earth) combine to Earth(ç”²å·±åˆåœŸ)', condition: 'Earthì›”(è¾°æˆŒä¸‘æœªæœˆ) ë˜ëŠ” Earthê°€ ì™•ì„±í•  ë•Œ'},
        {pair: [1,6], result: 'metal', name: 'ä¹™åºš (Wood+Metal) combine to Metal(ä¹™åºšåˆé‡‘)', condition: 'Metalì›”(ç”³é…‰æœˆ) ë˜ëŠ” Metalì´ ì™•ì„±í•  ë•Œ'},
        {pair: [2,7], result: 'water', name: 'ä¸™è¾› (Fire+Metal) combine to Water(ä¸™è¾›åˆæ°´)', condition: 'Waterì›”(äº¥å­æœˆ) ë˜ëŠ” Waterê°€ ì™•ì„±í•  ë•Œ'},
        {pair: [3,8], result: 'wood', name: 'ä¸å£¬ (Fire+Water) combine to Wood(ä¸å£¬åˆæœ¨)', condition: 'Woodì›”(å¯…å¯æœˆ) ë˜ëŠ” Woodì´ ì™•ì„±í•  ë•Œ'},
        {pair: [4,9], result: 'fire', name: 'æˆŠç™¸ (Earth+Water) combine to Fire(æˆŠç™¸åˆç«)', condition: 'Fireì›”(å·³åˆæœˆ) ë˜ëŠ” Fireê°€ ì™•ì„±í•  ë•Œ'}
    ];
    
    for (let gh of ganHap) {
        if (stemIdxs.includes(gh.pair[0]) && stemIdxs.includes(gh.pair[1])) {
            // Harmony exists
            const resultEl = gh.result;
            let isHwa = false;
            let reason = '';
            let isFake = false;
            let fakeReason = '';
            
            // Check if month energy matches element
            const seasonEl = {spring:'wood', summer:'fire', autumn:'metal', winter:'water'};
            if (seasonEl[season] === resultEl) {
                isHwa = true;
                reason = `Month energy is ${ELEMENT[resultEl].k} - Combination formed!`;
            }
            // Check if branches have many of this element
            const resultElCount = brs.filter(b => BRANCH[b].e === resultEl).length;
            if (resultElCount >= 2) {
                isHwa = true;
                reason = `Branches have ${ELEMENT[resultEl].k} x${resultElCount} - Combination formed!`;
            }
            
            // v4.14.9: Check for FAKE COMBINE (ê±°ì§“ëœ í•©)
            // í•©í™”ë˜ë ¤ëŠ” ì˜¤í–‰ì„ ê·¹í•˜ëŠ” ì˜¤í–‰ì´ ì§€ì§€ì— ê°•í•˜ê²Œ ìˆìœ¼ë©´ í•©í™” ë¶ˆì„±ë¦½
            const elementKills = {wood:'metal', fire:'water', earth:'wood', metal:'fire', water:'earth'};
            const killerEl = elementKills[resultEl];
            const killerCount = brs.filter(b => BRANCH[b].e === killerEl).length;
            
            if (isHwa && killerCount >= 1) {
                // í•©í™” ì˜¤í–‰ì„ ê·¹í•˜ëŠ” ì˜¤í–‰ì´ ìˆìœ¼ë©´ ê±°ì§“ëœ í•©
                isFake = true;
                fakeReason = `âš ï¸ FAKE COMBINE: ${ELEMENT[killerEl].k} in branches blocks transformation to ${ELEMENT[resultEl].k}. Energy is tied up but cannot transform.`;
                isHwa = false; // í•©í™” ì·¨ì†Œ
            }
            
            result.hapHwa.push({
                name: gh.name,
                stems: `${STEM[gh.pair[0]].c}+${STEM[gh.pair[1]].c}`,
                result: isHwa ? ELEMENT[resultEl].k : null,
                isHwa,
                isFake,
                reason: isFake ? fakeReason : (isHwa ? reason : 'ğŸ’« Harmony exists but hasnt transformed yet. The energy is bonded but waiting for the right conditions to fully activate.')
            });
        }
    }
    
    // ========== Branch Trinity Formation Check ==========
    const samhap = [
        {branches: [2,6,10], result: 'fire', name: 'å¯…åˆæˆŒ(Tiger-Horse-Dog) Fire combination(å¯…åˆæˆŒ ç«å±€)'},
        {branches: [5,9,1], result: 'metal', name: 'å·³é…‰ä¸‘(Snake-Rooster-Ox) Metal combination(å·³é…‰ä¸‘ é‡‘å±€)'},
        {branches: [8,0,4], result: 'water', name: 'ç”³å­è¾°(Monkey-Rat-Dragon) Water combination(ç”³å­è¾° æ°´å±€)'},
        {branches: [11,3,7], result: 'wood', name: 'äº¥å¯æœª(Pig-Rabbit-Goat) Wood combination(äº¥å¯æœª æœ¨å±€)'}
    ];
    
    for (let sh of samhap) {
        const hasCount = sh.branches.filter(b => brs.includes(b)).length;
        if (hasCount >= 2) {
            const hasCenter = brs.includes(sh.branches[1]); // Center branch (ì˜¤í–‰ì˜ ì™•ì§€)
            result.samhapGuk.push({
                name: sh.name,
                complete: hasCount === 3,
                hasCenter,
                result: ELEMENT[sh.result].k,
                desc: hasCount === 3 ? 
                    `Complete ${sh.name} formed! ${ELEMENT[sh.result].k} energy is strong.` :
                    hasCenter ? 
                    `${sh.name} half-combination. Center branch (${BRANCH[sh.branches[1]].c}) present - strong power.` :
                    `${sh.name} half-combination but lacks center branch - weak power.`
            });
        }
    }
    
    // ========== Clash Resolution Check ==========
    const clashPairs = [[0,6],[1,7],[2,8],[3,9],[4,10],[5,11]];
    for (let [a,b] of clashPairs) {
        if (brs.includes(a) && brs.includes(b)) {
            // Clash exists
            let isResolved = false;
            let resolveReason = '';
            
            // Check if resolved by harmony (Six Harmony)
            const hapPairs = [[0,1],[2,11],[3,10],[4,9],[5,8],[6,7]];
            for (let [ha, hb] of hapPairs) {
                if ((brs.includes(a) && (brs.includes(ha) && a === hb) || (brs.includes(hb) && a === ha)) ||
                    (brs.includes(b) && (brs.includes(ha) && b === hb) || (brs.includes(hb) && b === ha))) {
                    // If one of the clash parties í•©ì„ ë§Œë‚˜ë©´ ì¶©ì´ ì•½í•´ì§
                    isResolved = true;
                    resolveReason = 'âœ… Harmony energy neutralizes the clash. Conflicts are softened and transitions become smoother.';
                }
            }
            
            result.chungHaeso.push({
                clash: `${BRANCH[a].c}${BRANCH[b].c} Clash`,
                isResolved,
                reason: isResolved ? resolveReason : 'Active clash energy. Expect changes, conflicts, or restlessness. Stay flexible and avoid major decisions during turbulent times.'
            });
        }
    }
    
    // ========== ê²½ê³  ì‚¬í•­ ==========
    // Check Expressor-Officer clash
    const dm = saju.day.s;
    const godCounts = {};
    stems.forEach((s, idx) => {
        if (idx === 2) return; // Day Master ì œì™¸
        const god = getTenGod(s, dm);
        godCounts[god.k] = (godCounts[god.k] || 0) + 1;
    });
    
    if (godCounts['å‚·å®˜(Expressor)'] && godCounts['æ­£å®˜(Direct Officer)']) {
        result.warnings.push({
            type: 'Officer Conflict (å‚·å®˜è¦‹å®˜)',
            desc: 'âš¡ Creative energy conflicts with authority. You may struggle in hierarchical environments. Embrace entrepreneurship, freelancing, or creative careers where you set your own rules!'
        });
    }
    
    if (godCounts['åå°(Indirect Seal)'] && godCounts['é£Ÿç¥(Eating God)']) {
        result.warnings.push({
            type: 'Blocked Expression (æ¢Ÿç¥å¥ªé£Ÿ)',
            desc: 'ğŸŒ«ï¸ Your creative talents may feel suppressed. Dont let overthinking stop you from expressing yourself. Physical exercise and creative hobbies help release this blocked energy.'
        });
    }
    
    return result;
}

/* ========================================
   14-1. Hidden Stems(åœ°è—å¹²) ë¶„ì„
   ======================================== */
// Return Hidden Stems info for specific branch
function getJijanggan(branch) {
    const bi = BRANCH.findIndex(br => br.c === branch.c);
    return HIDDEN_STEMS[bi] || [];
}

// Check if specific stem exists in Hidden Stems (Revealed ì—¬ë¶€)
function hasHiddenStem(branch, stemIdx) {
    const jj = getJijanggan(branch);
    return jj.some(j => j.stem === stemIdx);
}

// Analyze Day Master root connection (Root Analysis)í•˜ëŠ”ì§€ ë¶„ì„
// Root: Same element as Day Master Hidden Stemsì— ìˆëŠ” ê²½ìš°
function analyzeRoot(dayStem, branch) {
    const jj = getJijanggan(branch);
    const dsEl = dayStem.e;
    const roots = [];
    
    jj.forEach(j => {
        const hiddenStem = STEM[j.stem];
        if (hiddenStem.e === dsEl) {
            // Root found
            const strength = j.days >= 16 ? 'strong' : j.days >= 7 ? 'medium' : 'weak';
            roots.push({
                stem: hiddenStem,
                days: j.days,
                type: j.type,
                strength,
                name: j.name
            });
        }
    });
    return roots;
}

// Analyze stem emergence in branches (Stem Reveal)í–ˆëŠ”ì§€ ë¶„ì„
// Emergence: stem character Hidden Stemsì—ë„ ì¡´ì¬í•˜ëŠ” ê²½ìš°
function analyzeTougan(saju) {
    const result = [];
    const allStems = [
        {pillar: 'Year', stem: saju.year.s},
        {pillar: 'Month', stem: saju.month.s},
        {pillar: 'Day Master', stem: saju.day.s},
    ];
    if (saju.hour) allStems.push({pillar: 'Hour', stem: saju.hour.s});
    
    const allBranches = [
        {pillar: 'Year Branch', branch: saju.year.b},
        {pillar: 'Month Branch', branch: saju.month.b},
        {pillar: 'Day Branch', branch: saju.day.b},
    ];
    if (saju.hour) allBranches.push({pillar: 'Hour Branch', branch: saju.hour.b});
    
    allStems.forEach(st => {
        const si = STEM.indexOf(st.stem);
        allBranches.forEach(br => {
            const jj = getJijanggan(br.branch);
            jj.forEach(j => {
                if (j.stem === si) {
                    result.push({
                        stem: st.stem,
                        stemPillar: st.pillar,
                        branch: br.branch,
                        branchPillar: br.pillar,
                        days: j.days,
                        type: j.type,
                        desc: `${st.stem.c}(${st.pillar})ì´ ${br.branch.c}(${br.pillar})ì— ë¿Œë¦¬ë‚´ë¦¼`
                    });
                }
            });
        });
    });
    return result;
}

// Full Saju root analysis
function analyzeAllRoots(saju) {
    const dm = saju.day.s;
    const branches = [
        {name: 'Year Branch', branch: saju.year.b},
        {name: 'Month Branch', branch: saju.month.b},
        {name: 'Day Branch', branch: saju.day.b}
    ];
    if (saju.hour) branches.push({name: 'Hour Branch', branch: saju.hour.b});
    
    const allRoots = [];
    let totalScore = 0;
    
    branches.forEach(b => {
        const roots = analyzeRoot(dm, b.branch);
        roots.forEach(r => {
            let score = 0;
            if (r.strength === 'strong') score = 3;
            else if (r.strength === 'medium') score = 2;
            else score = 1;
            
            // Month Branch root is 2x
            if (b.name === 'Month Branch') score *= 2;
            // Day Branch root is 1.5x
            if (b.name === 'Day Branch') score *= 1.5;
            
            totalScore += score;
            allRoots.push({
                ...r,
                position: b.name,
                branch: b.branch,
                score
            });
        });
    });
    
    return { roots: allRoots, totalScore };
}

// Element count calculation (including Hidden Stems)
function countElementsAdvanced(saju) {
    const ec = {wood:0, fire:0, earth:0, metal:0, water:0};
    const details = {wood:[], fire:[], earth:[], metal:[], water:[]};
    
    // Stems (100% ë°˜ì˜)
    const stems = [
        {pos:'Year', s:saju.year.s},
        {pos:'Month', s:saju.month.s},
        {pos:'Day Master', s:saju.day.s}
    ];
    if (saju.hour) stems.push({pos:'Hour', s:saju.hour.s});
    
    stems.forEach(st => {
        ec[st.s.e] += 1;
        details[st.s.e].push(`${st.s.c}(${st.pos}) 1.0`);
    });
    
    // Branch main stem (100% ë°˜ì˜)
    const branches = [
        {pos:'Year Branch', b:saju.year.b},
        {pos:'Month Branch', b:saju.month.b},
        {pos:'Day Branch', b:saju.day.b}
    ];
    if (saju.hour) branches.push({pos:'Hour Branch', b:saju.hour.b});
    
    branches.forEach(br => {
        ec[br.b.e] += 1;
        details[br.b.e].push(`${br.b.c}(${br.pos}) 1.0`);
    });
    
    // Hidden Stems (ë¹„ìœ¨ ë°˜ì˜)
    branches.forEach(br => {
        const bi = BRANCH.findIndex(x => x.c === br.b.c);
        const jj = HIDDEN_STEMS[bi] || [];
        jj.forEach(j => {
            const hiddenStem = STEM[j.stem];
            const ratio = j.days / 30; // daysì— ë”°ë¥¸ ë¹„ìœ¨
            ec[hiddenStem.e] += ratio * 0.5; // Hidden Stemsì€ 50% ê°€ì¤‘ì¹˜
            details[hiddenStem.e].push(`${hiddenStem.c}(${br.pos}è—) ${(ratio*0.5).toFixed(2)}`);
        });
    });
    
    return { counts: ec, details };
}

/* ========================================
   14-1-2. ì˜¤í–‰ ê°œìˆ˜ ê³„ì‚° (ë‹¨ìˆœ)
   ======================================== */
function countElements(saju) {
    const ec = {wood:0, fire:0, earth:0, metal:0, water:0};
    [saju.year, saju.month, saju.day, saju.hour].forEach(p => {
        if (!p) return;
        ec[p.s.e]++;
        ec[p.b.e]++;
    });
    return ec;
}

/* ========================================
   14-2. Detailed Analysis - Today's Fortune
   ======================================== */
function genTodayFortune(saju, gods) {
    const now = new Date();
    const ty = now.getFullYear(), tm = now.getMonth() + 1, td = now.getDate();
    const dp = calcDayPillar(ty, tm, td);
    const dm = saju.day.s;
    const god = getTenGod(dp.s, dm);
    const state = getTwelveState(dm, dp.b);
    
    const godMeaning = {
        'æ¯”è‚©(Peer)': {r:3, l:'ğŸ¥Š Competitive Day', d:'Today, similar energies surround you. Rivals may appear or you may assert your opinions strongly.<br><br><strong>ğŸ’¡ Tip:</strong> Focus on solo tasks today.'},
        'åŠ«è²¡(Competitor)': {r:2, l:'ğŸ’¸ Spending Alert', d:'Money tends to slip away today! Avoid impulse purchases or lending money to friends.<br><br><strong>ğŸ’¡ Tip:</strong> "Let me think about it tomorrow" is your magic spell!'},
        'é£Ÿç¥(Eating God)': {r:4, l:'ğŸ½ï¸ Delightful Day', d:'Everything feels relaxed and pleasant! Great for good food and hobbies.<br><br><strong>ğŸ’¡ Tip:</strong> Enjoy your favorite meal and let inspiration flow.'},
        'å‚·å®˜(Expressor)': {r:3, l:'ğŸ¤ Expression UP', d:'Words flow smoothly today! Presentations will go well. But watch out â€” you might want to challenge authority!<br><br><strong>ğŸ’¡ Tip:</strong> Think for 3 seconds before speaking.'},
        'åè²¡(Indirect Wealth)': {r:4, l:'ğŸ’° Unexpected Fortune', d:'Surprise money or great opportunities may come your way!<br><br><strong>ğŸ’¡ Tip:</strong> Get moving! Luck won\'t find you at home.'},
        'æ­£è²¡(Direct Wealth)': {r:4, l:'ğŸ’µ Stable Day', d:'Financial matters go smoothly. Good for contracts and deals.<br><br><strong>ğŸ’¡ Tip:</strong> Great day to start saving.'},
        'åå®˜(Challenger)': {r:2, l:'ğŸ˜° Tense Day', d:'Sudden tasks or pressure may arise. Unexpected work might drop on you.<br><br><strong>ğŸ’¡ Tip:</strong> Manage your energy. Don\'t overexert.'},
        'æ­£å®˜(Direct Officer)': {r:5, l:'ğŸ† Recognition Day', d:'Your best day! Your efforts may be recognized and praised.<br><br><strong>ğŸ’¡ Tip:</strong> Schedule important meetings today.'},
        'åå°(Indirect Seal)': {r:3, l:'ğŸ“š Solo Time', d:'You\'d rather be alone than in crowds. Perfect for study or reading.<br><br><strong>ğŸ’¡ Tip:</strong> How about reading a book at a quiet cafÃ©?'},
        'æ­£å°(Direct Seal)': {r:4, l:'ğŸ¤ Supportive Day', d:'Good day to receive help from others! Ask if you need anything.<br><br><strong>ğŸ’¡ Tip:</strong> Great for paperwork and contracts.'}
    };
    
    const info = godMeaning[god.k] || {r:3, l:'â˜€ï¸ Calm Day', d:'A peaceful day without major events.'};
    let bonus = '';
    if ([dp.s.e, dp.b.e].includes(gods.yong)) {
        info.r = Math.min(5, info.r + 1);
        bonus = '<div class="info-box good" style="margin-top:12px;"><p>âœ¨ <strong>Lucky energy flows today!</strong> Things will go better than usual!</p></div>';
    } else if ([dp.s.e, dp.b.e].includes(gods.gi)) {
        info.r = Math.max(1, info.r - 1);
        bonus = '<div class="info-box warn" style="margin-top:12px;"><p>âš ï¸ <strong>Be cautious today!</strong> Postpone big decisions to tomorrow.</p></div>';
    }
    
    // Good/Bad hours
    const goodH = [], badH = [];
    const hourNames = ['ë°¤ 11ì‹œ~ìƒˆë²½ 1ì‹œ','ìƒˆë²½ 1~3ì‹œ','ìƒˆë²½ 3~5ì‹œ','ì•„ì¹¨ 5~7ì‹œ','ì•„ì¹¨ 7~9ì‹œ','ì˜¤ì „ 9~11ì‹œ','ë‚® 11ì‹œ~ì˜¤í›„ 1ì‹œ','ì˜¤í›„ 1~3ì‹œ','ì˜¤í›„ 3~5ì‹œ','ì €ë… 5~7ì‹œ','ì €ë… 7~9ì‹œ','ë°¤ 9~11ì‹œ'];
    for (let i = 0; i < 12; i++) {
        const hEl = BRANCH[i].e;
        if (hEl === gods.yong) goodH.push(hourNames[i]);
        else if (hEl === gods.gi) badH.push(hourNames[i]);
    }
    
    return `
        <div class="info-box gold">
            <p><strong>ğŸ“… Month ${tm}, Day ${td} Today's Fortune</strong></p>
            <p style="font-size:0.85rem;color:var(--gray);margin-top:5px;">Today's energy: ${dp.s.c}${dp.b.c} (${dp.b.m} Day)</p>
        </div>
        <div style="text-align:center;margin:15px 0;">
            <span style="font-size:2rem;">${'â­'.repeat(info.r)}${'â˜†'.repeat(5-info.r)}</span>
        </div>
        <div class="info-box">
            <p><strong>${info.l}</strong></p>
            <p style="margin-top:10px;line-height:1.8;">${info.d}</p>
        </div>
        ${bonus}
        <div class="info-box good" style="margin-top:12px;">
            <p><strong>â° Lucky Hours</strong><br>${goodH.length ? goodH.join(', ') : 'None in particular'}</p>
        </div>
        <div class="info-box warn" style="margin-top:12px;">
            <p><strong>â° Caution Hours</strong><br>${badH.length ? badH.join(', ') : 'None in particular'}</p>
        </div>
        <div class="info-box" style="margin-top:12px;">
            <p><strong>ğŸ“Œ Today's Energy: ${state.k}</strong><br>${state.d}</p>
        </div>`;
}

/* ========================================
   14-3. Detailed Analysis - Annual Fortune
   ======================================== */
function genYearFortune(saju, gods, year) {
    const yp = calcYearPillar(year, 2, 5);
    const dm = saju.day.s;
    const god = getTenGod(yp.s, dm);
    const state = getTwelveState(dm, yp.b);
    
    let rating = 3, desc = '';
    if ([yp.s.e, yp.b.e].includes(gods.yong)) { rating = 5; desc = 'Great year with Beneficial Element! Move actively!'; }
    else if ([yp.s.e, yp.b.e].includes(gods.hee)) { rating = 4; desc = 'Good year with Supporting Element! Things go smoothly.'; }
    else if ([yp.s.e, yp.b.e].includes(gods.gi)) { rating = 2; desc = 'Challenging Element year. Be cautious and avoid overexertion.'; }
    else { desc = 'A steady year. Keep working consistently.'; }
    
    if (state.l >= 9) { rating = Math.min(5, rating + 1); desc += ' 12ìš´ì„±ì´ ê°•í•´ì„œ Energyê°€ ë„˜ì³ìš”!'; }
    else if (state.l <= 3) { rating = Math.max(1, rating - 1); desc += ' 12ìš´ì„±ì´ ì•½í•´ì„œ ì²´ë ¥ ê´€ë¦¬ê°€ is essential.'; }
    
    // Monthly points - v4.14.7: ìš©ì‹  ê¸°ë°˜ìœ¼ë¡œ í†µì¼
    const months = [];
    const monthlyData = getYearlyMonthLuck(year, saju, gods);
    for (let m = 1; m <= 12; m++) {
        const mData = monthlyData.months[m - 1];
        let tip = '', bg = 'rgba(255,255,255,0.05)';
        if (mData.climateClash) { tip = 'ğŸ”´ ìœ„í—˜'; bg = 'rgba(244,67,54,0.2)'; }
        else if (mData.score >= 2) { tip = 'ğŸŸ¢ ê¸¸'; bg = 'rgba(76,175,80,0.2)'; }
        else if (mData.score <= -2) { tip = 'ğŸ”´ í‰'; bg = 'rgba(244,67,54,0.15)'; }
        else { tip = 'ğŸŸ¡ í‰'; }
        months.push(`<span style="display:inline-block;margin:3px;padding:5px 8px;background:${bg};border-radius:5px;font-size:0.75rem;">${m}ì›” ${tip}</span>`);
    }
    
    return `
        <div class="info-box gold">
            <p><strong>ğŸ“† ${year}Year Fortune</strong></p>
            <p style="font-size:0.85rem;color:var(--gray);margin-top:5px;">${yp.s.c}${yp.b.c}ë…„ (${yp.b.m} ${yp.b.a}ì˜ í•´)</p>
        </div>
        <div style="text-align:center;margin:15px 0;">
            <span style="font-size:2rem;">${'â­'.repeat(rating)}${'â˜†'.repeat(5-rating)}</span>
        </div>
        <div class="info-box">
            <p><strong>This Year's God: ${god.k}</strong></p>
            <p style="margin-top:10px;line-height:1.8;">${desc}</p>
        </div>
        <div class="info-box" style="margin-top:12px;">
            <p><strong>ğŸ“Œ Annual Energy: ${state.k}</strong><br>${state.d}</p>
        </div>
        <div class="info-box" style="margin-top:12px;">
            <p><strong>ğŸ—“ï¸ Monthly Highlights</strong></p>
            <div style="margin-top:10px;">${months.join('')}</div>
        </div>`;
}

/* ========================================
   14-4. Detailed Analysis - Career Fortune
   ======================================== */
function genCareerFortune(saju, str, gods) {
    const dm = saju.day.s;
    const ec = countElements(saju);
    const jaeEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 2) % 5];
    const gwanEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 3) % 5];
    const sikEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 1) % 5];
    
    let rating = 3, style = '', advice = '';
    
    if (str.type === 'strong' && ec[jaeEl] >= 2) {
        rating = 5; style = 'CEO Type';
        advice = 'Strong chart with many Wealth stars - natural entrepreneur! Excellent money management. Starting your own business leads to great success.';
    } else if (str.type === 'strong' && ec[gwanEl] >= 2) {
        rating = 4; style = 'Executive Type';
        advice = 'Strong chart with many Officer stars - you rise in organizations! Can reach high positions in government, corporations, or politics.';
    } else if (str.type === 'weak') {
        rating = 3; style = 'Specialist Type';
        advice = 'Weak chart suits teamwork over solo. Diving deep into a specialty can make you a recognized expert.';
    } else {
        rating = 4; style = 'ë­ë“  ì˜í•˜ëŠ” ìŠ¤íƒ€ì¼';
        advice = 'Well balanced! You can adapt and succeed in any field.';
    }
    
    // Check Eating God
    if (ec[sikEl] >= 2) {
        advice += '<br><br>âœ¨ <strong>With many Eating Gods, you make money through talent!</strong> You shine in art, technology, and creative fields.';
    }
    
    const careerByElement = {
        wood: 'êµìœ¡, ì¶œíŒ, ì˜ë¥˜, ê°€êµ¬, ì¡°ê²½, ë†ì—…, í•œì˜í•™',
        fire: 'ì—°ì˜ˆ, ë°©ì†¡, ì˜ˆìˆ , IT, ì „energy, ì¡°ëª…, ìŒì‹',
        earth: 'ë¶€ë™ì‚°, ê±´ì¶•, ë†ì—…, ì¤‘ê°œ, ìœ í†µ, ì°½ê³ ì—…',
        metal: 'ê¸ˆìœµ, ì œì¡°, ìë™ì°¨, ê¸°ê³„, ì˜ë£Œê¸°energy, ë²•ì¡°',
        water: 'ë¬´ì—­, ìœ í†µ, ê´€ê´‘, ì–´ì—…, ìŒë£Œ, Waterë¥˜, ì²­ì†Œ'
    };
    
    return `
        <div class="info-box gold">
            <p><strong>ğŸ’¼ Career Fortune Analysis</strong></p>
        </div>
        <div style="text-align:center;margin:15px 0;">
            <span style="font-size:2rem;">${'â­'.repeat(rating)}${'â˜†'.repeat(5-rating)}</span>
            <p style="margin-top:10px;font-size:1.1rem;color:var(--gold);">${style}</p>
        </div>
        <div class="info-box">
            <p style="line-height:1.8;">${advice}</p>
        </div>
        <div class="info-box good" style="margin-top:12px;">
            <p><strong>ğŸ¯ ìš©ì‹ (${ELEMENT[gods.yong].k}) ê´€ë ¨ ì§ì—…</strong></p>
            <p style="margin-top:8px;">${careerByElement[gods.yong]}</p>
        </div>`;
}

/* ========================================
   14-5. Detailed Analysis - Love Fortune
   ======================================== */
function genLoveFortune(saju, str, gods) {
    const dm = saju.day.s;
    const dbi = BRANCH.findIndex(br => br.c === saju.day.b.c);
    const ec = countElements(saju);
    
    // Spouse element (M:Wealth, F:Officer)
    const spouseEl = GENDER === 'm' ? 
        EL_ORDER[(EL_ORDER.indexOf(dm.e) + 2) % 5] : 
        EL_ORDER[(EL_ORDER.indexOf(dm.e) + 3) % 5];
    const spouseCount = ec[spouseEl];
    
    let rating = 3, desc = '';
    
    // Interpretation by spouse element count
    if (spouseCount === 0) {
        rating = 2;
        desc = 'Weak energy in spouse position. Connection may come late or not last long. Do not be too hasty!';
    } else if (spouseCount === 1) {
        rating = 4;
        desc = 'One true spouse connection! Cherish this person â€” they are your destiny.';
    } else if (spouseCount === 2) {
        rating = 3;
        desc = 'Two spouse connections... Possible remarriage or choosing between two people.';
    } else {
        rating = 2;
        desc = 'Strong spouse connections. Be mindful of temptation! Focus on one person.';
    }
    
    // Spouse image from Day Branch
    const spouseByBranch = {
        0: 'Your spouse is smart and perceptive. Deep thinker who excels academically. May worry a lot though.',
        1: 'Your spouse is steady and diligent. The slow-and-steady type. Very reliable.',
        2: 'Your spouse is active and adventurous. Full of curiosity and energy!',
        3: 'Your spouse is sensitive and delicate. Artistic sense with skilled hands.',
        4: 'Your spouse is embracing and sociable. Has many friends and leadership qualities.',
        5: 'Your spouse is clever and articulate. Quick-witted with people skills.',
        6: 'Your spouse is bright and passionate. May be impatient but full of energy!',
        7: 'Your spouse is gentle and affectionate. Considerate and kind-hearted.',
        8: 'Your spouse is decisive and confident. Strong willpower and independence.',
        9: 'Your spouse is neat and stylish. May have talent in arts or beauty.',
        10: 'Your spouse is stubborn but loyal. Once decided, follows through to the end.',
        11: 'Your spouse is wise and adaptable. Gets along anywhere with flexibility.'
    };
    
    return `
        <div class="info-box gold">
            <p><strong>ğŸ’• Love & Marriage Fortune Analysis</strong></p>
        </div>
        <div style="text-align:center;margin:15px 0;">
            <span style="font-size:2rem;">${'â­'.repeat(rating)}${'â˜†'.repeat(5-rating)}</span>
        </div>
        <div class="info-box">
            <p style="line-height:1.8;">${desc}</p>
        </div>
        <div class="info-box" style="margin-top:12px;background:rgba(255,182,193,0.15);">
            <p><strong>ğŸ’‘ Spouse Image from Day Branch</strong></p>
            <p style="margin-top:10px;line-height:1.8;">${spouseByBranch[dbi]}</p>
        </div>`;
}

/* ========================================
   14-6. Detailed Analysis - Wealth Fortune
   ======================================== */
function genWealthFortune(saju, str, gods) {
    const dm = saju.day.s;
    const ec = countElements(saju);
    const jaeEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 2) % 5];
    const sikEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 1) % 5];
    const jaeCount = ec[jaeEl];
    const sikCount = ec[sikEl];
    
    let rating = 3, desc = '';
    
    if (str.type === 'strong' && jaeCount >= 2) {
        rating = 5;
        desc = 'Great wealth fortune! Strong chart with many Wealth stars means both ability and luck for money. Big success in business or investments possible!';
    } else if (str.type === 'strong' && jaeCount === 1) {
        rating = 4;
        desc = 'Steady earner type. Better with stable income like salary than big windfalls.';
    } else if (str.type === 'weak' && jaeCount >= 2) {
        rating = 2;
        desc = 'Money comes but goes easily. Weak chart with many Wealth stars is overwhelming. Build saving habits!';
    } else if (jaeCount === 0) {
        rating = 2;
        desc = 'Missing Wealth stars - Less interest in money or difficulty earning. Develop specialized skills!';
    } else {
        rating = 3;
        desc = 'Average wealth fortune. Steady effort can lead to upper-middle class lifestyle.';
    }
    
    // Check Eating God
    if (sikCount >= 2) {
        rating = Math.min(5, rating + 1);
        desc += '<br><br>âœ¨ <strong>With many Eating Gods, you make money through talent!</strong> Wealth comes through art, technology, and creative work.';
    }
    
    return `
        <div class="info-box gold">
            <p><strong>ğŸ’° Wealth Fortune Analysis</strong></p>
        </div>
        <div style="text-align:center;margin:15px 0;">
            <span style="font-size:2rem;">${'â­'.repeat(rating)}${'â˜†'.repeat(5-rating)}</span>
        </div>
        <div class="info-box">
            <p style="line-height:1.8;">${desc}</p>
        </div>
        <div class="info-box good" style="margin-top:12px;">
            <p><strong>ğŸ¯ ì¬Water ìš´ ì˜¬ë¦¬ëŠ” ë²•</strong></p>
            <p style="margin-top:8px;">Your Beneficial Element is <strong>${ELEMENT[gods.yong].k}</strong> energy!<br>Lucky Number: ${ELEMENT[gods.yong].nums.slice(0,5).join(', ')}</p>
        </div>`;
}

/* ========================================
   14-7. Detailed Analysis - Health Fortune
   ======================================== */
function genHealthFortune(saju, str, gods) {
    const dm = saju.day.s;
    const ec = countElements(saju);
    
    const healthData = {
        wood: {o:'Liver, Gallbladder, Eyes', s:'Fatigue, poor vision, muscle cramps, brittle nails', a:'Eat green vegetables, stretch, rest eyes'},
        fire: {o:'Heart, Small Intestine, Tongue', s:'Palpitations, insomnia, tongue inflammation', a:'Regular sleep, meditation, red foods'},
        earth: {o:'Stomach, Spleen, Lips', s:'Indigestion, bloating, cracked lips', a:'Regular meals, yellow foods, walking'},
        metal: {o:'Lungs, Large Intestine, Nose', s:'Respiratory issues, skin problems, constipation', a:'Deep breathing, hiking, white foods, probiotics'},
        water: {o:'Kidneys, Bladder, Ears', s:'Swelling, back pain, reproductive issues, hearing loss', a:'Stay hydrated, black beans, warm baths'}
    };
    
    const sorted = Object.entries(ec).sort((a,b) => a[1] - b[1]);
    const weakest = sorted[0];
    const strongest = Object.entries(ec).sort((a,b) => b[1] - a[1])[0];
    
    let rating = str.type === 'weak' ? 3 : 4;
    
    return `
        <div class="info-box gold">
            <p><strong>ğŸ¥ Health Fortune Analysis</strong></p>
        </div>
        <div style="text-align:center;margin:15px 0;">
            <span style="font-size:2rem;">${'â­'.repeat(rating)}${'â˜†'.repeat(5-rating)}</span>
        </div>
        <div class="info-box">
            <p><strong>Vulnerable Organs:</strong> ${healthData[dm.e].o}</p>
            <p style="margin-top:10px;"><strong>Watch for symptoms:</strong><br>${healthData[dm.e].s}</p>
            <p style="margin-top:10px;"><strong>Health Tips:</strong><br>${healthData[dm.e].a}</p>
        </div>
        ${weakest[1] === 0 ? `<div class="info-box warn" style="margin-top:12px;"><p><strong>âš ï¸ ${ELEMENT[weakest[0]].k} energy is missing!</strong><br>${healthData[weakest[0]].o} related health needs attention!<br><br>${healthData[weakest[0]].a}</p></div>` : ''}
        ${strongest[1] >= 4 ? `<div class="info-box" style="margin-top:12px;"><p><strong>ğŸ“Œ ${ELEMENT[strongest[0]].k} energy is excessive</strong><br>${healthData[strongest[0]].o} organs may be strained. Balance is key!</p></div>` : ''}
        <div class="info-box good" style="margin-top:12px;">
            <p><strong>ğŸ—“ï¸ ê³„ì ˆë³„ ê±´ê°• ê´€ë¦¬</strong></p>
            <p style="margin-top:8px;line-height:1.8;">
                â€¢ ë´„: ê°„, ëˆˆ ê´€ë¦¬ / ìŠ¤íŠ¸ë ˆì¹­<br>
                â€¢ ì—¬ë¦„: ì‹¬ì¥, í˜ˆê´€ / Drink plenty of water<br>
                â€¢ í™˜ì ˆê¸°: ì†ŒFireê¸° / ê·œì¹™ì ì¸ ì‹ì‚¬<br>
                â€¢ ê°€ì„: í, í˜¸í¡ê¸° / ë“±ì‚°, ì‹¬í˜¸í¡<br>
                â€¢ ê²¨ìš¸: ì‹ ì¥, ë¼ˆ / ë³´ì˜¨, ë°˜ì‹ ìš•
            </p>
        </div>`;
}

/* ========================================
   14-8. Compatibility Analysis
   ======================================== */
function runMatch() {
    if (!SAJU) { toast('Please analyze your chart first!'); return; }
    
    const py = +document.getElementById('partner-year').value;
    const pm = +document.getElementById('partner-month').value;
    const pd = +document.getElementById('partner-day').value;
    
    if (!py || !pm || !pd) { toast('ìƒëŒ€ë°© Please enter your birth date'); return; }
    
    const pSaju = {
        year: calcYearPillar(py, pm, pd),
        month: calcMonthPillar(py, pm, pd),
        day: calcDayPillar(py, pm, pd)
    };
    
    let score = 50, details = [];
    
    // 1. Day Master compatibility (Stem harmony)
    const myDm = STEM.indexOf(SAJU.day.s), pDm = STEM.indexOf(pSaju.day.s);
    const ganHap = [[0,5],[1,6],[2,7],[3,8],[4,9]];
    let ganMatch = false;
    for (let [a,b] of ganHap) if ((myDm===a && pDm===b) || (myDm===b && pDm===a)) { ganMatch = true; break; }
    if (ganMatch) { score += 20; details.push({t:'good', txt:'ğŸ’• Stem Harmony! Your Day Masters are soulmates!'}); }
    
    // 2. Day Branch compatibility (Branch harmony/clash)
    const myDb = BRANCH.findIndex(br => br.c === SAJU.day.b.c), pDb = BRANCH.findIndex(br => br.c === pSaju.day.b.c);
    const jiHap = [[0,1],[2,11],[3,10],[4,9],[5,8],[6,7]];
    const jiChung = [[0,6],[1,7],[2,8],[3,9],[4,10],[5,11]];
    for (let [a,b] of jiHap) if ((myDb===a && pDb===b) || (myDb===b && pDb===a)) { score += 15; details.push({t:'good', txt:'ğŸ¤ Day Branch Six Harmony! í•¨ê»˜ ìˆìœ¼ë©´ í¸ì•ˆí•˜ê³  ì•ˆì •ê°ì„ ëŠê»´ìš”.'}); break; }
    for (let [a,b] of jiChung) if ((myDb===a && pDb===b) || (myDb===b && pDb===a)) { score -= 15; details.push({t:'bad', txt:'ğŸ’¥ Day Branch clash! Friction is likely. Compromise is essential.'}); break; }
    
    // 3. Element generation/destruction
    const myEl = EL_ORDER.indexOf(SAJU.day.s.e), pEl = EL_ORDER.indexOf(pSaju.day.s.e);
    const saeng = [[0,2],[2,1],[1,3],[3,4],[4,0]];
    const keuk = [[0,3],[3,1],[1,4],[4,2],[2,0]];
    for (let [a,b] of saeng) if ((myEl===a && pEl===b) || (myEl===b && pEl===a)) { score += 10; details.push({t:'good', txt:`ğŸŒ± Five Elements harmony! ${ELEMENT[SAJU.day.s.e].k}ê³¼ ${ELEMENT[pSaju.day.s.e].k} support each other.`}); break; }
    for (let [a,b] of keuk) if ((myEl===a && pEl===b) || (myEl===b && pEl===a)) { score -= 10; details.push({t:'bad', txt:`âš”ï¸ Element Clash! Effort to harmonize is essential.`}); break; }
    if (SAJU.day.s.e === pSaju.day.s.e) { score += 5; details.push({t:'neutral', txt:`ğŸ”„ ê°™ì€ ${ELEMENT[SAJU.day.s.e].k} element! Similar tendencies connect you.`}); }
    
    // 4. Zodiac Harmony
    const myTti = BRANCH.findIndex(br => br.c === SAJU.year.b.c), pTti = BRANCH.findIndex(br => br.c === pSaju.year.b.c);
    for (let [a,b] of jiHap) if ((myTti===a && pTti===b) || (myTti===b && pTti===a)) { score += 5; details.push({t:'good', txt:`ğŸ¾ Zodiac Six Harmony! ${BRANCH[myTti].a}and ${BRANCH[pTti].a}are a great match.`}); break; }
    for (let [a,b] of jiChung) if ((myTti===a && pTti===b) || (myTti===b && pTti===a)) { score -= 5; details.push({t:'bad', txt:`ğŸ¾ Zodiac Clash! ${BRANCH[myTti].a}and ${BRANCH[pTti].a}may have conflicts.`}); break; }
    
    score = Math.max(0, Math.min(100, score));
    
    let grade, color, summary;
    if (score >= 80) { grade = 'ğŸ’– Soulmates'; color = '#e91e63'; summary = 'You two are a perfect match! Best compatibility.'; }
    else if (score >= 65) { grade = 'ğŸ’• Good Match'; color = '#9c27b0'; summary = 'You match well! A little effort brings happiness.'; }
    else if (score >= 50) { grade = 'ğŸ’› Average Match'; color = '#ff9800'; summary = 'Average compatibility. Acknowledging differences improves it.'; }
    else if (score >= 35) { grade = 'ğŸ’” Effort Needed'; color = '#ff5722'; summary = 'Some friction exists. Compromise and understanding needed.'; }
    else { grade = 'ğŸ˜¢ Challenging Match'; color = '#f44336'; summary = 'Challenging compatibility. But love can overcome it!'; }
    
    document.getElementById('match-result').innerHTML = `
        <div class="info-box" style="text-align:center;">
            <p style="font-size:2rem;color:${color}">${grade}</p>
            <p style="font-size:1.5rem;font-weight:bold;margin-top:10px;">${score}ì </p>
            <div style="background:#333;border-radius:10px;height:20px;margin:15px 0;">
                <div style="background:linear-gradient(90deg,#ff6b6b,#ee5a24);height:100%;border-radius:10px;width:${score}%"></div>
            </div>
            <p>${summary}</p>
        </div>
        <div class="info-box" style="margin-top:15px;">
            <p><strong>ğŸ“Š Detailed Analysis</strong></p>
            <p style="margin-top:8px;"><strong>Me:</strong> ${SAJU.day.s.c}${SAJU.day.b.c}Day (${ELEMENT[SAJU.day.s.e].k})</p>
            <p><strong>Partner:</strong> ${pSaju.day.s.c}${pSaju.day.b.c}Day (${ELEMENT[pSaju.day.s.e].k})</p>
        </div>
        ${details.map(d => `<div class="info-box ${d.t === 'good' ? 'good' : d.t === 'bad' ? 'warn' : ''}" style="margin-top:10px;"><p>${d.txt}</p></div>`).join('')}
        <div class="info-box" style="margin-top:15px;">
            <p><strong>ğŸ’¡ Compatibility Tips</strong></p>
            <p style="margin-top:8px;">${score >= 65 ? 'Praise each others strengths!' : score >= 50 ? 'Acknowledge and respect your differences.' : 'Communicate more. Respect each others space.'}</p>
        </div>`;
}

// v4.14.7: ì‚¬ì£¼ íƒ­ ìƒë…„ì›”ì¼ì„ Powerball/Mega íƒ­ì— ë™ê¸°í™”
function syncBirthDateToLottery(year, month, day) {
    // Powerball íƒ­ ë™ê¸°í™”
    const pbYear = document.getElementById('pb-year');
    const pbMonth = document.getElementById('pb-month');
    const pbDay = document.getElementById('pb-day');
    if (pbYear) pbYear.value = year;
    if (pbMonth) pbMonth.value = month;
    if (pbDay) pbDay.value = day;
    
    // Mega Millions íƒ­ ë™ê¸°í™”
    const megaYear = document.getElementById('mega-year');
    const megaMonth = document.getElementById('mega-month');
    const megaDay = document.getElementById('mega-day');
    if (megaYear) megaYear.value = year;
    if (megaMonth) megaMonth.value = month;
    if (megaDay) megaDay.value = day;
}

/* ========================================
   15. ì‚¬ì£¼ ë¶„ì„ ì‹¤í–‰
   ======================================== */
function analyzeSaju() {
    try {
        const y = +document.getElementById('saju-year').value;
        const m = +document.getElementById('saju-month').value;
        const d = +document.getElementById('saju-day').value;
        const h = document.getElementById('saju-hour').value;
        const hourVal = h === '' ? -1 : +h;
        
        // Validate input
        if (!y || !m || !d) { toast('Please enter your birth date'); return; }
        if (y < 1900 || y > 2100) { toast('Year must be between 1900-2100'); return; }
        if (m < 1 || m > 12) { toast('Month must be between 1-12'); return; }
        if (d < 1 || d > 31) { toast('Day must be between 1-31'); return; }
        
        let sy = y, sm = m, sd = d;
        if (CALENDAR === 'lunar') {
            const conv = lunarToSolar(y, m, d);
            if (!conv || !conv.year) { toast('Lunar conversion error. Try solar calendar'); return; }
            sy = conv.year; sm = conv.month; sd = conv.day;
        }
        
        const adj = adjustTime(sy, sm, sd, hourVal);
        if (!adj || !adj.y) { toast('Time adjustment error'); return; }
        
        // v4.15.1 FIX: ì‹œê°„(0-23)ì„ ì§€ì§€ ì¸ë±ìŠ¤(0-11)ë¡œ ë³€í™˜
        // adj.hëŠ” ì‹œê°„(0-23), calcHourPillarëŠ” ì§€ì§€ ì¸ë±ìŠ¤(0-11) í•„ìš”
        let hourBranchIdx = -1;
        if (hourVal >= 0 && adj.h >= 0) {
            // 23ì‹œ, 0ì‹œ â†’ å­(0), 1-2ì‹œ â†’ ä¸‘(1), 3-4ì‹œ â†’ å¯…(2), ...
            if (adj.h === 23 || adj.h === 0) hourBranchIdx = 0;
            else hourBranchIdx = Math.floor((adj.h + 1) / 2);
            if (hourBranchIdx > 11) hourBranchIdx = 0; // ì•ˆì „ì¥ì¹˜
        }
        
        SAJU = {
            year: calcYearPillar(adj.y, adj.m, adj.d),
            month: calcMonthPillar(adj.y, adj.m, adj.d),
            day: calcDayPillar(adj.y, adj.m, adj.d),
            hour: hourBranchIdx >= 0 ? calcHourPillar(calcDayPillar(adj.y, adj.m, adj.d).s, hourBranchIdx) : null
        };
        
        // Validate Saju calculation
        if (!SAJU.year || !SAJU.month || !SAJU.day) { 
            toast('Four Pillars calculation error. Please try again'); 
            return; 
        }
        
        BIRTH_YEAR = y;
        BIRTH_MONTH = sm;  // v4.15.1: ì–‘ë ¥ ì›” ì €ì¥ (ëŒ€ìš´ ê³„ì‚°ìš©)
        BIRTH_DAY = sd;    // v4.15.1: ì–‘ë ¥ ì¼ ì €ì¥ (ëŒ€ìš´ ê³„ì‚°ìš©)
        BIRTH_HOUR = hourVal >= 0 ? adj.h : 12;  // v4.15.1: ì‹œê°„ ì €ì¥
        const str = calcStrength(SAJU);
        if (!str) { toast('Strength calculation error'); return; }
        STRENGTH = str;  // ì „ì—­ ì €ì¥
        
        GODS = calcGods(SAJU, str);
        if (!GODS) { toast('Beneficial element calculation error'); return; }
        
        renderSaju(str);
        document.getElementById('saju-result').style.display = 'block';
        
        // Update my-info-display if exists
        const infoDisplay = document.getElementById('my-info-display');
        if (infoDisplay) {
            infoDisplay.innerHTML = `<p style="color:var(--gold);">${SAJU.day.s.c}${SAJU.day.b.c}Day (${ELEMENT[SAJU.day.s.e].k})</p>`;
        }
        
        // v4.14.7: Powerball/Mega íƒ­ì— ìƒë…„ì›”ì¼ ë™ê¸°í™”
        syncBirthDateToLottery(y, m, d);
        
        toast('ğŸ”® Fortune analysis complete!');
    } catch (error) {
        console.error('Four Pillars analysis error:', error);
        toast('Analysis error. Please check your input.');
    }
}

/* ========================================
   16. ë Œë”ë§ í•¨ìˆ˜ë“¤
   ======================================== */
function renderSaju(str) {
    try {
    // Saju pillars
    const pillars = ['hour','day','month','year'];
    const labels = ['Hour','Day','Month','Year'];
    document.getElementById('pillars').innerHTML = pillars.map((p, i) => {
        const pillar = SAJU[p];
        if (!pillar) return `<div class="pillar"><div class="pillar-label">${labels[i]}</div><div class="pillar-stem">-</div><div class="pillar-branch">-</div></div>`;
        const god = p !== 'day' ? getTenGod(pillar.s, SAJU.day.s) : null;
        return `<div class="pillar ${p === 'day' ? 'dm' : ''}">
            <div class="pillar-label">${labels[i]}</div>
            <div class="pillar-stem el-${pillar.s.e}">${pillar.s.c}</div>
            <div class="pillar-branch el-${pillar.b.e}">${pillar.b.c}</div>
            <div class="pillar-sub">${pillar.s.k}${pillar.b.k}</div>
            ${god ? `<div class="pillar-god">${god.k}</div>` : '<div class="pillar-god">Day Master</div>'}
        </div>`;
    }).join('');
    
    // Twelve States
    const un12 = getTwelveState(SAJU.day.s, SAJU.day.b);
    document.getElementById('twelve-states').innerHTML = `<div class="info-box"><p><strong>Day Branch Twelve State:</strong> ${un12.k} (Energy ${un12.l}/12)</p></div>`;
    
    // Strong/Weak
    const typeLabel = {strong:'Strong',weak:'Weak',balanced:'Balanced'};
    document.getElementById('strength-box').innerHTML = `
        <div class="strength-header">
            <span class="strength-title">Day Master Strength</span>
            <span class="strength-badge ${str.type}">${typeLabel[str.type]}${str.extreme ? ` (${str.extreme})` : ''}</span>
        </div>
        <div class="strength-bar"><div class="strength-fill ${str.type}" style="width:${str.pct}%"></div></div>
        <div class="factors">${str.factors.map(f => `<div class="factor"><span class="factor-label">${f.l}</span><span class="factor-value ${f.p ? 'pos' : 'neg'}">${f.v}</span></div>`).join('')}</div>
    `;
    
    // ========== ç´éŸ³(Sound Element)/å‘½å®®(Life Palace)/Conception (NEW) ==========
    const dayNapeum = calcNapeum(SAJU.day.s, SAJU.day.b);
    const yearNapeum = calcNapeum(SAJU.year.s, SAJU.year.b);
    const myunggung = SAJU.hour ? calcMyunggung(SAJU.month.b, SAJU.hour.b) : null;
    const taewon = calcTaewon(SAJU.year.s, SAJU.month.s, SAJU.month.b);
    
    document.getElementById('napeum-myunggung').innerHTML = `
        <div class="info-box" style="margin-bottom:10px;">
            <p><strong>ğŸµ Sound-Element (Sound Element)</strong></p>
            <p style="font-size:0.85rem;color:var(--gray);margin-top:5px;">Sound elements based on the 60 Sexagenary cycle</p>
            <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div style="padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;">
                    <p style="font-size:0.8rem;color:var(--gray);">Day Sound Element</p>
                    <p style="font-weight:bold;margin-top:5px;color:var(--gold);">${SAJU.day.s.c}${SAJU.day.b.c} â†’ ${dayNapeum.name}</p>
                    <p style="font-size:0.85rem;margin-top:5px;">${dayNapeum.desc}</p>
                </div>
                <div style="padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;">
                    <p style="font-size:0.8rem;color:var(--gray);">Year Sound Element</p>
                    <p style="font-weight:bold;margin-top:5px;">${SAJU.year.s.c}${SAJU.year.b.c} â†’ ${yearNapeum.name}</p>
                    <p style="font-size:0.85rem;margin-top:5px;">${yearNapeum.desc}</p>
                </div>
            </div>
        </div>
        
        ${myunggung ? `
        <div class="info-box" style="margin-bottom:10px;">
            <p><strong>ğŸ  Life Palace (å‘½å®®)</strong></p>
            <p style="font-size:0.85rem;color:var(--gray);margin-top:5px;">Life direction calculated from Month+Hour Branch</p>
            <div style="margin-top:12px;padding:15px;background:rgba(253,216,53,0.1);border-radius:8px;border-left:3px solid var(--gold);">
                <p style="font-weight:bold;font-size:1.1rem;color:var(--gold);">${myunggung.name}</p>
                <p style="margin-top:8px;"><strong>Tendency:</strong> ${myunggung.trait}</p>
                <p style="margin-top:5px;"><strong>Suitable fields:</strong> ${myunggung.career}</p>
            </div>
        </div>
        ` : '<div class="info-box" style="margin-bottom:10px;"><p><strong>ğŸ  Life Palace (å‘½å®®)</strong></p><p style="color:var(--gray);margin-top:5px;">Birth hour required to calculate Life Palace.</p></div>'}
        
        <div class="info-box">
            <p><strong>ğŸŒ± Conception Origin (èƒå…ƒ)</strong></p>
            <p style="font-size:0.85rem;color:var(--gray);margin-top:5px;">Conception point: Month Stem+1, Month Branch+3</p>
            <div style="margin-top:12px;padding:15px;background:rgba(255,255,255,0.05);border-radius:8px;">
                <p style="font-weight:bold;font-size:1.1rem;">${taewon.pillar}</p>
                <p style="margin-top:8px;">Sound Element: ${taewon.napeum.name} (${ELEMENT[taewon.napeum.element].k})</p>
                <p style="margin-top:5px;font-size:0.9rem;color:var(--gray);">${taewon.desc}</p>
            </div>
        </div>
    `;
    
    // ========== Hidden Stems Analysis (NEW) ==========
    const jjAnalysis = analyzeJijanggan(SAJU);
    document.getElementById('jijanggan-analysis').innerHTML = `
        <div class="info-box">
            <p style="margin-bottom:10px;font-size:0.85rem;color:var(--gray);">Hidden Heavenly Stems within Earthly Branches</p>
            ${jjAnalysis.pillars.map(p => `
                <div style="margin-bottom:15px;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;">
                    <p style="font-weight:bold;color:var(--gold);">${p.name}: ${p.branch.c} ${p.branch.k}</p>
                    <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;">
                        ${p.hidden.map(h => `
                            <span style="padding:4px 10px;border-radius:15px;font-size:0.8rem;
                                background:${h.type === 'Main' ? 'rgba(76,175,80,0.3)' : h.type === 'Middle' ? 'rgba(255,152,0,0.3)' : 'rgba(158,158,158,0.3)'};
                                border:1px solid ${h.type === 'Main' ? 'var(--wood)' : h.type === 'Middle' ? 'var(--earth)' : 'var(--metal)'};">
                                ${h.stem.c} ${h.stem.k} Â· ${h.type} Â· ${h.days}d Â· ${h.god.e || h.god.k}
                                ${h.tougan ? '<span style="color:var(--gold);">â˜…</span>' : ''}
                            </span>
                        `).join('')}
                    </div>
                </div>
            `).join('')}
        </div>
        <div class="info-box" style="margin-top:10px;">
            <p><strong>ğŸ“Š Hidden Stems Element Distribution</strong></p>
            <div style="margin-top:10px;display:flex;justify-content:space-around;">
                ${EL_ORDER.map(e => `
                    <div style="text-align:center;">
                        <div class="el-${e}" style="font-size:1.3rem;">${ELEMENT[e].icon}</div>
                        <div style="font-size:0.9rem;font-weight:bold;margin-top:2px;">${ELEMENT[e].c}</div>
                        <div style="font-size:0.65rem;color:var(--gray);">${ELEMENT[e].k}</div>
                        <div style="font-size:1rem;margin-top:5px;font-weight:bold;color:${ELEMENT[e].color};">${jjAnalysis.summary.elements[e].toFixed(1)}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    // ========== Root & Stem Analysis (NEW) ==========
    const ttAnalysis = analyzeTonggeunTougan(SAJU);
    document.getElementById('tonggeun-analysis').innerHTML = `
        <div class="info-box">
            <p><strong>ğŸŒ³ Root Connection</strong> - Heavenly Stems rooted in Earthly Branches</p>
            <div style="margin-top:10px;">
                ${ttAnalysis.tonggeun.length ? ttAnalysis.tonggeun.map(t => `
                    <div style="padding:8px;margin:5px 0;background:rgba(76,175,80,0.1);border-radius:6px;border-left:3px solid var(--wood);">
                        <span style="font-weight:bold;">${t.pillar} ${t.stem}</span> (${t.god}) â†’
                        ${t.roots.map(r => `<span style="margin-left:5px;padding:2px 6px;background:rgba(255,255,255,0.1);border-radius:4px;font-size:0.8rem;">${r.pillar}${r.branch} ${r.type}(${r.strength})</span>`).join('')}
                    </div>
                `).join('') : '<p style="color:var(--gray);font-size:0.9rem;">No rooted stems. Weak foundation.</p>'}
            </div>
        </div>
        <div class="info-box" style="margin-top:10px;">
            <p><strong>â˜€ï¸ Stem Emergence</strong> - Hidden Stems revealed in Heavenly Stems</p>
            <div style="margin-top:10px;">
                ${ttAnalysis.tougan.length ? ttAnalysis.tougan.map(t => `
                    <div style="padding:8px;margin:5px 0;background:rgba(253,216,53,0.1);border-radius:6px;border-left:3px solid var(--gold);">
                        <span style="font-weight:bold;">${t.stem}</span> (${t.god}) - from ${t.pillar} â†’ ${t.from} revealed
                    </div>
                `).join('') : '<p style="color:var(--gray);font-size:0.9rem;">No revealed hidden stems.</p>'}
            </div>
        </div>
    `;
    
    // Yongsin
    document.getElementById('gods').innerHTML = `
        <div class="god yong"><div class="god-title">Beneficial Element</div><div class="god-element el-${GODS.yong}">${ELEMENT[GODS.yong].c}</div><div class="god-name">${ELEMENT[GODS.yong].n}</div></div>
        <div class="god hee"><div class="god-title">Favorable Element</div><div class="god-element el-${GODS.hee}">${ELEMENT[GODS.hee].c}</div><div class="god-name">${ELEMENT[GODS.hee].n}</div></div>
        <div class="god gi"><div class="god-title">Unfavorable Element</div><div class="god-element el-${GODS.gi}">${ELEMENT[GODS.gi].c}</div><div class="god-name">${ELEMENT[GODS.gi].n}</div></div>
    `;
    
    // Yongsin ìƒì„¸ + ì¡°í›„ ê³ ê¸‰
    let godsDetailHtml = `<div class="info-box gold"><p>${ELEMENT[GODS.yong].n} energy brings you good fortune.</p></div>`;
    
    // Climate balance details
    if (GODS.johu) {
        godsDetailHtml += `
            <div class="info-box" style="margin-top:10px;">
                <p><strong>ğŸŒ¡ï¸ Climate Adjustment Analysis</strong></p>
                <p style="margin-top:8px;font-size:0.9rem;">${GODS.johuDesc || 'Seasonal adjustment applied.'}</p>
                ${GODS.sub ? `<p style="margin-top:5px;font-size:0.85rem;color:var(--gray);">Secondary beneficial: ${ELEMENT[GODS.sub].k}(${ELEMENT[GODS.sub].c})</p>` : ''}
            </div>
        `;
    }
    
    // Cold-Warm-Damp balance
    if (GODS.climate) {
        godsDetailHtml += `
            <div class="info-box ${GODS.climate.needs.length ? 'warn' : ''}" style="margin-top:10px;">
                <p><strong>ğŸŒ¡ï¸ Temperature-Humidity Balance: ${GODS.climate.type}</strong></p>
                <p style="margin-top:8px;font-size:0.9rem;">${GODS.climate.desc}</p>
                ${GODS.climate.needs.length ? `<p style="margin-top:5px;font-size:0.85rem;">Needed energy: ${GODS.climate.needs.map(e => ELEMENT[e].k).join(', ')}</p>` : ''}
            </div>
        `;
    }
    
    // Disease-Medicine
    if (GODS.byungYak && GODS.byungYak.byung) {
        godsDetailHtml += `
            <div class="info-box" style="margin-top:10px;">
                <p><strong>ğŸ’Š Disease-Medicine Analysis</strong></p>
                <p style="margin-top:8px;font-size:0.9rem;">
                    ë³‘(ç—…): ${ELEMENT[GODS.byungYak.byung].k}(${ELEMENT[GODS.byungYak.byung].c}) excess<br>
                    ì•½(è—¥): ${ELEMENT[GODS.byungYak.yak].k}(${ELEMENT[GODS.byungYak.yak].c}) controls it
                </p>
            </div>
        `;
    }
    
    document.getElementById('gods-detail').innerHTML = godsDetailHtml;
    
    // ========== Six Relations (å…­è¦ª) Analysis (NEW) ==========
    const yukcheon = analyzeYukcheon(SAJU, GENDER);
    document.getElementById('yukcheon-analysis').innerHTML = `
        <div class="info-box" style="margin-bottom:10px;">
            <p style="font-size:0.85rem;color:var(--gray);">Analyzing family and relationships through the Ten Gods</p>
        </div>
        
        <!-- ìœ„ì¹˜ë³„ ìœ¡ì¹œ -->
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:15px;">
            ${yukcheon.positions.map(p => `
                <div style="padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;">
                    <p style="font-size:0.8rem;color:var(--gray);">${p.posName}</p>
                    <p style="font-weight:bold;margin:5px 0;">${p.stem.c}${p.branch.c}</p>
                    <p style="font-size:0.9rem;">Stem: <span style="color:var(--gold);">${p.stemGod}</span></p>
                    ${p.branchGod ? `<p style="font-size:0.85rem;color:var(--gray);">Branch: ${p.branchGod}</p>` : ''}
                    <p style="font-size:0.8rem;margin-top:5px;">${p.relation}</p>
                </div>
            `).join('')}
        </div>
        
        <!-- Spouse Analysis -->
        <div class="info-box ${yukcheon.spouse.count > 0 ? 'good' : 'warn'}" style="margin-bottom:10px;">
            <p><strong>ğŸ’• Spouse Analysis</strong></p>
            <p style="margin-top:8px;font-size:0.9rem;">
                Spouse star (${yukcheon.spouse.god}): ${yukcheon.spouse.count > 0 ? yukcheon.spouse.count + '' : 'hidden'}<br>
                Day Branch Twelve State: ${yukcheon.spouse.dayBranch.k}
            </p>
            <p style="margin-top:5px;font-size:0.85rem;">${yukcheon.spouse.analysis}</p>
        </div>
        
        <!-- Children Analysis -->
        <div class="info-box" style="margin-bottom:10px;">
            <p><strong>ğŸ‘¶ Children Analysis</strong></p>
            <p style="margin-top:8px;font-size:0.9rem;">
                Children star (${yukcheon.children.gods.join('/')}): ${yukcheon.children.count > 0 ? yukcheon.children.count.toFixed(1) + '' : 'hidden'}
            </p>
            <p style="margin-top:5px;font-size:0.85rem;">${yukcheon.children.analysis}</p>
        </div>
        
        <!-- Parents Analysis -->
        <div class="info-box" style="margin-bottom:10px;">
            <p><strong>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Parents Analysis</strong></p>
            <p style="margin-top:8px;font-size:0.9rem;">
                Father (åè²¡/Indirect Wealth): ${yukcheon.parents.father.count > 0 ? 'present' : 'none'} - ${yukcheon.parents.father.analysis}<br>
                Mother (æ­£å°/Direct Seal): ${yukcheon.parents.mother.count > 0 ? 'present' : 'none'} - ${yukcheon.parents.mother.analysis}
            </p>
        </div>
        
        <!-- Six Relations (å…­è¦ª) Special Notes -->
        ${yukcheon.analysis.length ? `
            <div class="info-box warn">
                <p><strong>ğŸ“Œ Six Relations (å…­è¦ª) Special Notes</strong></p>
                ${yukcheon.analysis.slice(0, 5).map(a => `
                    <p style="margin-top:8px;font-size:0.85rem;">
                        ${a.type === 'many' ? 'âš¡' : 'â­•'} ${a.meaning}
                    </p>
                `).join('')}
            </div>
        ` : ''}
    `;
    
    // Structure
    const fmt = calcFormat(SAJU);
    document.getElementById('format').innerHTML = `
        <div class="info-box gold">
            <p><strong>${fmt.n}</strong></p>
            <p style="margin-top:10px;line-height:1.8;">${fmt.d}</p>
            <p style="margin-top:10px;color:var(--gold);">ğŸ’¼ <strong>Suitable fields:</strong> ${fmt.b}</p>
        </div>`;
    
    // Day analysis
    const ilju = getIljuDesc(SAJU.day.s, SAJU.day.b);
    document.getElementById('ilju').innerHTML = `
        <div class="info-box">
            <p><strong style="font-size:16px;">${ilju.title}</strong></p>
            <p style="margin-top:12px;line-height:1.8;">${ilju.desc}</p>
            <div style="margin-top:15px;padding:12px;background:rgba(255,182,193,0.15);border-radius:8px;">
                <p>ğŸ’• <strong>Spouse Fortune</strong></p>
                <p style="margin-top:8px;line-height:1.6;">${ilju.spouse}</p>
            </div>
        </div>`;
    
    // ========== ê¶ìœ„(å®®ä½) ë¶„ì„ (NEW) ==========
    const gungwi = analyzeGungwi(SAJU, BIRTH_YEAR);
    document.getElementById('gungwi-analysis').innerHTML = `
        <div class="info-box" style="margin-bottom:10px;">
            <p style="font-size:0.85rem;color:var(--gray);">The Four Pillars represent different life periods and relationships</p>
        </div>
        ${gungwi.map(g => `
            <div class="info-box ${g.rating === 'good' ? 'good' : g.rating === 'bad' ? 'warn' : ''}" style="margin-bottom:10px;${g.isCurrent ? 'border:2px solid var(--gold);' : ''}">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <p><strong>${g.name}</strong> <span style="color:var(--gray);font-size:0.85rem;">${g.alias}</span></p>
                    ${g.isCurrent ? '<span style="background:var(--gold);color:#000;padding:2px 8px;border-radius:10px;font-size:0.7rem;">Current</span>' : ''}
                </div>
                <p style="margin-top:8px;font-size:0.85rem;">
                    ğŸ“… <strong>${g.ageRange}</strong> Â· 
                    ${g.pillar ? `${g.pillar.s.c}${g.pillar.b.c}` : '-'} Â· 
                    ${g.god ? g.god.k : 'Day Master'} Â· 
                    ${g.state ? g.state.k : '-'}
                </p>
                <p style="margin-top:5px;font-size:0.85rem;color:var(--gray);">
                    ğŸ‘¤ ${GENDER === 'm' ? g.relationM : g.relationF} Â· ğŸ¦´ ${g.bodyPart}
                </p>
                <p style="margin-top:8px;line-height:1.6;">${g.analysis}</p>
            </div>
        `).join('')}
    `;
    
    // ========== 12ìš´ì„± ì™„ì „ ë¶„ì„ (NEW) ==========
    const ts = analyzeTwelveStates(SAJU);
    document.getElementById('twelve-states-full').innerHTML = `
        <div class="info-box ${ts.dominant === 'strong' ? 'good' : ts.dominant === 'weak' ? 'warn' : ''}">
            <p><strong>ğŸ“Š Base Energy Status</strong></p>
            <p style="margin-top:8px;">${ts.summary}</p>
        </div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:15px 0;">
            ${ts.pillars.map(p => `
                <div style="text-align:center;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;
                    border-bottom:3px solid ${p.energy >= 9 ? 'var(--wood)' : p.energy >= 6 ? 'var(--gold)' : p.energy >= 3 ? 'var(--earth)' : 'var(--fire)'};">
                    <div style="font-size:0.8rem;color:var(--gray);">${p.name}</div>
                    <div style="font-size:1.3rem;margin:8px 0;">${p.state.k}</div>
                    <div style="font-size:0.9rem;">âš¡ ${p.energy}/12</div>
                </div>
            `).join('')}
        </div>
        <div class="info-box">
            <p><strong>ğŸ”„ Life Energy Flow</strong></p>
            <div style="margin-top:10px;">
                ${ts.lifeFlow.map(lf => `
                    <div style="display:flex;align-items:center;padding:8px;margin:5px 0;background:rgba(255,255,255,0.03);border-radius:6px;">
                        <div style="width:80px;font-size:0.8rem;color:var(--gray);">${lf.period}</div>
                        <div style="width:60px;font-weight:bold;">${lf.state}</div>
                        <div style="flex:1;font-size:0.85rem;">${lf.advice}</div>
                        <div>${'â­'.repeat(Math.ceil(lf.energy/3))}${'â˜†'.repeat(4-Math.ceil(lf.energy/3))}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    // Life Cycles(Life Cycle) - v4.15.1 ì •ë°€ ê³„ì‚° ë²„ì „
    const luck = calcLuck(SAJU, BIRTH_YEAR, GENDER, GODS, BIRTH_MONTH, BIRTH_DAY, BIRTH_HOUR);
    
    // v4.15.1: ëŒ€ìš´ ë©”íƒ€ ì •ë³´ í‘œì‹œ
    let luckMetaHtml = '';
    if (luck.meta) {
        const meta = luck.meta;
        luckMetaHtml = `
            <div class="info-box" style="margin-bottom:15px;background:rgba(212,175,55,0.1);border:1px solid rgba(212,175,55,0.3);">
                <p style="font-size:0.9rem;"><strong>ğŸ“Š å¤§é‹ Calculation Info</strong></p>
                <div style="margin-top:8px;font-size:0.85rem;display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
                    <div>ğŸ”„ Direction: <strong>${meta.directionK}</strong> (${meta.direction === 'forward' ? 'é †è¡Œ' : 'é€†è¡Œ'})</div>
                    <div>ğŸ“… First Age: <strong>${meta.firstAgeExact}ì„¸</strong> (${meta.daysToTerm}ì¼Ã·3)</div>
                    ${meta.targetTerm ? `<div>ğŸ—“ï¸ Target Term: <strong>${meta.targetTerm.k}</strong> (${meta.targetTerm.e})</div>` : ''}
                    <div>âš™ï¸ Method: <strong>${meta.calculationMethod === 'precise' ? 'Precision' : 'Default'}</strong></div>
                </div>
            </div>
        `;
    }
    
    document.getElementById('luck-timeline').innerHTML = luckMetaHtml + luck.map((l, idx) => `
        <div class="luck-item ${l.isCur ? 'current' : ''} ${l.rating}" title="${l.startYear}-${l.endYear}ë…„">
            <div class="luck-age">Ages ${l.startAge}-${l.endAge}</div>
            <div style="font-size:0.65rem;color:var(--gray);">${l.startYear}-${l.endYear}</div>
            <div class="luck-pillar el-${l.s.e}">${l.s.c}${l.b.c}</div>
            <div class="luck-rating">${l.rating === 'good' ? 'ğŸ˜Š' : l.rating === 'bad' ? 'ğŸ˜°' : 'ğŸ˜'}</div>
            ${l.climateClash ? '<div style="font-size:0.6rem;color:#ff6b6b;">ğŸŒ¡ï¸ì—­ìš´</div>' : ''}
        </div>
    `).join('');
    
    const curLuck = luck.find(l => l.isCur);
    if (curLuck) {
        const curYear = new Date().getFullYear();
        const yearsInCycle = curYear - curLuck.startYear;
        const yearsRemaining = curLuck.endYear - curYear;
        
        document.getElementById('luck-detail').innerHTML = `
            <div class="info-box ${curLuck.rating === 'good' ? 'good' : curLuck.rating === 'bad' ? 'warn' : ''}">
                <p><strong>Current Life Cycle (Ages ${curLuck.startAge}-${curLuck.endAge}): ${curLuck.s.c}${curLuck.b.c}</strong></p>
                <p style="margin-top:8px;font-size:0.9rem;">
                    ğŸ“… Period: ${curLuck.startYear} ~ ${curLuck.endYear}ë…„<br>
                    â³ Progress: ${yearsInCycle + 1}ë…„ì°¨ (${yearsRemaining}ë…„ ë‚¨ìŒ)
                </p>
                <p style="margin-top:8px;">
                    ${curLuck.rating === 'good' ? 'ğŸŒŸ Great fortune period! Take bold action.' : 
                      curLuck.rating === 'bad' ? 'âš ï¸ Caution period. Avoid overexertion.' : 
                      'ğŸ˜Œ Stable period. Stay consistent.'}
                </p>
                ${curLuck.climateClash ? '<p style="margin-top:8px;color:#ff6b6b;font-size:0.85rem;">ğŸŒ¡ï¸ Climate clash detected - balance seasonal energy.</p>' : ''}
            </div>
        `;
    }
    
    // ========== Life Cycle Transition Analysis (NEW) ==========
    const gyoungi = analyzeGyoungi(luck, BIRTH_YEAR, new Date().getFullYear());
    document.getElementById('gyoungi-analysis').innerHTML = gyoungi.length ? `
        <div class="info-box" style="margin-bottom:10px;">
            <p style="font-size:0.85rem;color:var(--gray);">Knowing when your Life Cycle changes helps you prepare for life transitions.</p>
        </div>
        ${gyoungi.map(g => `
            <div class="info-box ${g.intensity === 'strong' ? 'warn' : ''} ${g.isCurrent ? 'gold' : ''}" style="margin-bottom:10px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <p><strong>ğŸ”„ Age ${g.transitionAge} Transition</strong> (${g.transitionYear})</p>
                    ${g.isCurrent ? '<span style="background:var(--gold);color:#000;padding:2px 8px;border-radius:10px;font-size:0.7rem;">Current Transition!</span>' : ''}
                </div>
                <p style="margin-top:10px;font-size:1.1rem;text-align:center;">
                    <span style="color:var(--gray);">${g.from}</span>
                    <span style="margin:0 10px;">â†’</span>
                    <span style="color:var(--gold);">${g.to}</span>
                </p>
                <p style="margin-top:10px;line-height:1.6;">${g.warning}</p>
                <p style="margin-top:8px;font-size:0.9rem;color:var(--gray);">ğŸ’¡ ${g.advice}</p>
            </div>
        `).join('')}
    ` : `<div class="info-box"><p style="color:var(--gray);">No major transition period near current age.</p></div>`;
    
    // ========== 10Year Fortune ë¯¸ë¦¬ë³´ê¸° (NEW) ==========
    const next10 = getNext10Years(SAJU, BIRTH_YEAR, GENDER, GODS, BIRTH_MONTH, BIRTH_DAY, BIRTH_HOUR);
    const ratingEmoji = {excellent:'ğŸŒŸ',good:'ğŸ˜Š',neutral:'ğŸ˜',caution:'âš ï¸',difficult:'ğŸ˜°'};
    const ratingClass = {excellent:'good',good:'good',neutral:'',caution:'warn',difficult:'warn'};
    document.getElementById('ten-years-luck').innerHTML = `
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px;">
            ${next10.years.map(y => `
                <div style="flex:1;min-width:60px;padding:8px;text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;
                    border:1px solid ${y.rating === 'excellent' || y.rating === 'good' ? 'var(--wood)' : y.rating === 'difficult' || y.rating === 'caution' ? 'var(--fire)' : 'transparent'};">
                    <div style="font-size:0.75rem;color:var(--gray);">${y.year}</div>
                    <div style="font-size:1.1rem;">${ratingEmoji[y.rating]}</div>
                    <div style="font-size:0.7rem;color:var(--gray);">Age ${y.age}</div>
                </div>
            `).join('')}
        </div>
        <div class="info-box good">
            <p>ğŸŒŸ <strong>Best year: ${next10.bestYear.year}</strong> (Age ${next10.bestYear.age})<br>
            ${next10.bestYear.saeun.pillar.s.c}${next10.bestYear.saeun.pillar.b.c}, ${next10.bestYear.saeun.god.k} energy</p>
        </div>
        <div class="info-box warn" style="margin-top:10px;">
            <p>âš ï¸ <strong>Caution year: ${next10.worstYear.year}</strong> (Age ${next10.worstYear.age})<br>
            ${next10.worstYear.saeun.pillar.s.c}${next10.worstYear.saeun.pillar.b.c} - Take care of health!</p>
        </div>
    `;
    
    // ========== This Year Monthly Fortune (NEW) ==========
    const curYear = new Date().getFullYear();
    const monthlyLuck = getYearlyMonthLuck(curYear, SAJU, GODS);
    document.getElementById('monthly-luck').innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:15px;">
            ${monthlyLuck.months.map(m => `
                <div style="padding:10px;text-align:center;background:rgba(255,255,255,0.05);border-radius:8px;
                    border:1px solid ${m.rating === 'good' ? 'var(--wood)' : m.rating === 'bad' ? 'var(--fire)' : 'transparent'};">
                    <div style="font-weight:bold;">${MONTH_ABBR[m.month - 1]}</div>
                    <div style="font-size:1.2rem;margin:5px 0;">${m.rating === 'good' ? 'ğŸ˜Š' : m.rating === 'bad' ? 'ğŸ˜°' : 'ğŸ˜'}</div>
                    <div style="font-size:0.7rem;color:var(--gray);">${m.pillar.s.c}${m.pillar.b.c}</div>
                    <div style="font-size:0.7rem;color:var(--gray);">${m.god.e || m.god.k}</div>
                </div>
            `).join('')}
        </div>
        <div class="info-box good">
            <p>ğŸŒŸ <strong>Best: ${MONTH_ABBR[monthlyLuck.best.month - 1]}</strong><br>${monthlyLuck.best.god.e || monthlyLuck.best.god.k} energy brings good fortune!</p>
        </div>
        <div class="info-box warn" style="margin-top:10px;">
            <p>âš ï¸ <strong>Caution: ${MONTH_ABBR[monthlyLuck.worst.month - 1]}</strong><br>${monthlyLuck.worst.god.e || monthlyLuck.worst.god.k} energy - take it easy.</p>
        </div>
    `;
    
    // Interactions
    const ints = calcInteractions(SAJU);
    document.getElementById('interactions').innerHTML = ints.length ? ints.map(i => `<div class="int-item"><div class="int-type">${i.t}</div><div><div class="int-chars">${i.c}</div><div class="int-meaning">${i.m} - ${i.d}</div></div></div>`).join('') : '<p style="color:var(--gray);">No special harmony or clash in chart.</p>';
    
    // ========== æ–¹åˆ(Directional Harmony)/æš—åˆ(Hidden Harmony) ë¶„ì„ (NEW) ==========
    const banghap = analyzeBanghap(SAJU);
    const amhap = analyzeAmhap(SAJU);
    document.getElementById('banghap-amhap').innerHTML = `
        <div class="info-box" style="margin-bottom:10px;">
            <p><strong>ğŸŒ€ Directional Harmony (æ–¹åˆ)</strong> - Same direction branches form powerful element</p>
            ${banghap.length ? banghap.map(b => `
                <div style="margin-top:10px;padding:12px;background:rgba(${b.type === 'complete' ? '76,175,80' : '255,152,0'},0.1);border-radius:8px;border-left:3px solid ${b.type === 'complete' ? 'var(--wood)' : 'var(--earth)'};">
                    <p style="font-weight:bold;color:${b.type === 'complete' ? 'var(--wood)' : 'var(--earth)'};">${b.name} (${b.branches})</p>
                    <p style="margin-top:5px;font-size:0.9rem;">${b.dir}</p>
                    <p style="margin-top:5px;font-size:0.85rem;">${b.desc}</p>
                    ${b.type === 'partial' ? `<p style="margin-top:5px;font-size:0.8rem;color:var(--gray);">ğŸ’¡ When ${b.missing} arrives, Complete!</p>` : ''}
                </div>
            `).join('') : '<p style="margin-top:10px;color:var(--gray);font-size:0.9rem;">No Directional Harmony found.</p>'}
        </div>
        
        <div class="info-box">
            <p><strong>ğŸ¤« Hidden Harmony (æš—åˆ)</strong> - Hidden harmony between branch stems</p>
            ${amhap.length ? amhap.map(a => `
                <div style="margin-top:10px;padding:12px;background:rgba(156,39,176,0.1);border-radius:8px;border-left:3px solid #9C27B0;">
                    <p style="font-weight:bold;color:#9C27B0;">${a.name}</p>
                    <p style="margin-top:5px;font-size:0.9rem;">${a.positions}</p>
                    <p style="margin-top:5px;font-size:0.85rem;">${a.desc}</p>
                    <p style="margin-top:5px;font-size:0.8rem;color:var(--gray);">ğŸ’« ${a.meaning}</p>
                </div>
            `).join('') : '<p style="margin-top:10px;color:var(--gray);font-size:0.9rem;">No hidden harmony.</p>'}
        </div>
    `;
    
    // ========== Advanced Harmony/Clash Analysis ==========
    const advInt = analyzeAdvancedInteractions(SAJU);
    document.getElementById('advanced-interactions').innerHTML = `
        ${advInt.hapHwa.length ? `
            <div class="info-box" style="margin-bottom:10px;">
                <p><strong>ğŸ”® Stem Transformation Analysis</strong></p>
                ${advInt.hapHwa.map(h => `
                    <div style="margin-top:10px;padding:10px;background:rgba(255,255,255,0.05);border-radius:6px;border-left:3px solid ${h.isHwa ? 'var(--gold)' : 'var(--gray)'};">
                        <p><strong>${h.name}</strong> (${h.stems})</p>
                        <p style="font-size:0.85rem;color:${h.isHwa ? 'var(--gold)' : 'var(--gray)'};margin-top:5px;">
                            ${h.isHwa ? `âœ¨ ${h.result} transformation complete! ${h.reason}` : `âšª ${h.reason}`}
                        </p>
                    </div>
                `).join('')}
            </div>
        ` : ''}
        ${advInt.samhapGuk.length ? `
            <div class="info-box" style="margin-bottom:10px;">
                <p><strong>ğŸŒ€ Trinity (ä¸‰åˆ) Analysis</strong></p>
                ${advInt.samhapGuk.map(s => `
                    <div style="margin-top:10px;padding:10px;background:rgba(255,255,255,0.05);border-radius:6px;border-left:3px solid ${s.complete ? 'var(--wood)' : 'var(--earth)'};">
                        <p><strong>${s.name}</strong> â†’ ${s.result} energy</p>
                        <p style="font-size:0.85rem;margin-top:5px;">${s.desc}</p>
                    </div>
                `).join('')}
            </div>
        ` : ''}
        ${advInt.chungHaeso.length ? `
            <div class="info-box ${advInt.chungHaeso.some(c => !c.isResolved) ? 'warn' : ''}" style="margin-bottom:10px;">
                <p><strong>âš¡ Clash Resolution Analysis</strong></p>
                ${advInt.chungHaeso.map(c => `
                    <div style="margin-top:10px;padding:10px;background:rgba(255,255,255,0.05);border-radius:6px;border-left:3px solid ${c.isResolved ? 'var(--wood)' : 'var(--fire)'};">
                        <p><strong>${c.clash}</strong></p>
                        <p style="font-size:0.85rem;color:${c.isResolved ? 'var(--wood)' : 'var(--fire)'};margin-top:5px;">${c.reason}</p>
                    </div>
                `).join('')}
            </div>
        ` : ''}
        ${advInt.warnings.length ? `
            <div class="info-box warn">
                <p><strong>âš ï¸ Special Warnings</strong></p>
                ${advInt.warnings.map(w => `
                    <div style="margin-top:10px;">
                        <p><strong>${w.type}</strong></p>
                        <p style="font-size:0.85rem;margin-top:5px;">${w.desc}</p>
                    </div>
                `).join('')}
            </div>
        ` : ''}
        ${!advInt.hapHwa.length && !advInt.samhapGuk.length && !advInt.chungHaeso.length && !advInt.warnings.length ?
            '<p style="color:var(--gray);">No special transformations or clashes. A peaceful chart!</p>' : ''}
    `;
    
    // Emptiness
    const gm = calcGongmang(SAJU);
    document.getElementById('gongmang').innerHTML = `<div class="info-box"><p><strong>ê³µë§:</strong> ${gm.names.join(', ')}<br>${gm.affected.length ? `âš ï¸ ${gm.affected.join(', ')} has Empty Void (ç©ºäº¡). This area energy is weak.` : 'No Empty Void (ç©ºäº¡) in chart!'}</p></div>`;
    
    // ========== ê³µë§ í•´ì†Œ ë¶„ì„ (NEW) ==========
    const gmHaeso = analyzeGongmangHaeso(SAJU, gm);
    document.getElementById('gongmang-haeso').innerHTML = gmHaeso.hasGongmang ? `
        ${gmHaeso.results.map(r => `
            <div class="info-box ${r.resolved ? 'good' : 'warn'}" style="margin-bottom:10px;">
                <p><strong>${r.position} ê³µë§ (${r.branch})</strong></p>
                <p style="margin-top:8px;font-size:0.9rem;">
                    ${r.resolved ? 
                        `âœ… í•´ì†Œë¨: ${r.method}` : 
                        `âŒ í•´ì†Œë˜ì§€ ì•ŠìŒ`}
                </p>
                <p style="margin-top:5px;font-size:0.85rem;color:var(--gray);">${r.effect}</p>
            </div>
        `).join('')}
        <div class="info-box" style="margin-top:10px;">
            <p><strong>ğŸ’¡ Empty Void (ç©ºäº¡) Resolution Conditions</strong></p>
            <p style="margin-top:8px;font-size:0.85rem;line-height:1.6;">
                1. Clash resolution: Opposite branch present<br>
                2. Trinity resolution: Other two trinity branches present<br>
                3. Luck cycle resolution: Temporary when conditions met in luck cycles
            </p>
        </div>
    ` : '<div class="info-box"><p style="color:var(--gray);">No void in chart - resolution analysis not needed. ğŸ‘</p></div>';
    
    // Spirit Indicators
    const sinsal = calcSinsal(SAJU);
    document.getElementById('sinsal').innerHTML = sinsal.length ? sinsal.map(s => `<div class="sinsal ${s.t}"><div class="sinsal-icon">${s.i}</div><div><div class="sinsal-name">${s.n}</div><div class="sinsal-desc">${s.d}</div></div></div>`).join('') : '<p style="color:var(--gray);">No special divine stars.</p>';
    
    // ========== ì‹ ì‚´ ìœ„ì¹˜ë³„ ë¶„ì„ (NEW) ==========
    const sinsalPos = analyzeSinsalPosition(SAJU);
    document.getElementById('sinsal-position').innerHTML = sinsalPos.length ? `
        <div class="info-box" style="margin-bottom:10px;">
            <p style="font-size:0.85rem;color:var(--gray);">The same Divine Star has different meanings depending on its position.</p>
        </div>
        ${sinsalPos.map(sp => `
            <div class="info-box" style="margin-bottom:10px;border-left:3px solid ${sp.sinsal.includes('Peach Blossom') ? '#e91e63' : sp.sinsal.includes('Traveling Horse') ? '#ff9800' : '#9c27b0'};">
                <p><strong>${sp.sinsal}</strong> - ${sp.position}</p>
                <p style="margin-top:8px;font-size:0.9rem;">${sp.interpretation}</p>
                <p style="margin-top:5px;font-size:0.85rem;color:var(--gold);">ğŸ’¡ ${sp.advice}</p>
            </div>
        `).join('')}
    ` : '<div class="info-box"><p style="color:var(--gray);">No major divine stars to analyze by position.</p></div>';
    
    // AI Comprehensive Interpretation
    document.getElementById('ai-interpretation').innerHTML = generateAIInterpretation(SAJU, GODS, BIRTH_YEAR, GENDER, BIRTH_MONTH, BIRTH_DAY, BIRTH_HOUR);
    
    // Summary Analysis
    const summaryEl = document.getElementById('summary-analysis');
    if (summaryEl) {
        const dm = SAJU.day.s;
        const str = calcStrength(SAJU);
        const format = calcFormat(SAJU);
        const curYear = new Date().getFullYear();
        const luck = calcLuck(SAJU, BIRTH_YEAR, GENDER, GODS, BIRTH_MONTH, BIRTH_DAY, BIRTH_HOUR);
        const curLuck = luck.find(l => l.isCur);
        
        summaryEl.innerHTML = `
            <div class="info-box gold" style="margin-bottom:15px;">
                <p style="font-size:1.1rem;font-weight:bold;margin-bottom:10px;">ğŸ“‹ Your Four Pillars at a Glance</p>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div class="info-box" style="margin:0;">
                    <p style="font-size:0.8rem;color:var(--gray);">Day Master</p>
                    <p style="font-size:1.2rem;font-weight:bold;color:var(--gold);">${dm.c} ${ELEMENT[dm.e].k}</p>
                    <p style="font-size:0.85rem;margin-top:5px;">${str.pct}% ${str.type === 'strong' ? 'ğŸ’ª Strong' : str.type === 'weak' ? 'ğŸŒŠ Gentle' : 'âš–ï¸ Balanced'}</p>
                </div>
                <div class="info-box" style="margin:0;">
                    <p style="font-size:0.8rem;color:var(--gray);">Structure (æ ¼å±€)</p>
                    <p style="font-size:1rem;font-weight:bold;">${format.k || format.name}</p>
                </div>
                <div class="info-box" style="margin:0;">
                    <p style="font-size:0.8rem;color:var(--gray);">Beneficial Element</p>
                    <p style="font-size:1.2rem;font-weight:bold;color:${ELEMENT[GODS.yong].color};">${ELEMENT[GODS.yong].icon} ${ELEMENT[GODS.yong].k}</p>
                </div>
                <div class="info-box" style="margin:0;">
                    <p style="font-size:0.8rem;color:var(--gray);">Current Life Cycle</p>
                    <p style="font-size:1rem;font-weight:bold;">${curLuck ? curLuck.s.c + curLuck.b.c : '-'}</p>
                    <p style="font-size:0.8rem;color:var(--gray);">${curLuck ? 'Ages ' + curLuck.startAge + '-' + curLuck.endAge : ''}</p>
                </div>
            </div>
            <div class="info-box" style="margin-top:10px;text-align:center;">
                <p style="font-size:0.9rem;"><strong>${curYear} Outlook:</strong> ${str.type === 'balanced' ? 'ğŸŒŸ Excellent adaptability!' : str.type === 'strong' ? 'ğŸ’ª Lead with confidence!' : 'ğŸ¤ Collaborate for success!'}</p>
            </div>
        `;
    }
    
    // Today's Fortune direct display
    const todayEl = document.getElementById('today-fortune');
    if (todayEl) {
        todayEl.innerHTML = getTodayFortune();
    }
    
    // Init fortune reading (fortune-contentê°€ ìˆìœ¼ë©´)
    renderFortune('total');
    } catch (error) {
        console.error('ì‚¬ì£¼ ë Œë”ë§ ì˜¤ë¥˜:', error);
        toast('Error displaying results.');
    }
}

function renderFortune(type) {
    const el = document.getElementById('fortune-content');
    if (!el) return; // Skip if element missing
    if (!SAJU) { el.innerHTML = '<p>Please analyze your Four Pillars first.</p>'; return; }
    
    const str = calcStrength(SAJU);
    
    // Use new detailed reading function
    if (type === 'today') {
        el.innerHTML = genTodayFortune(SAJU, GODS);
        return;
    }
    if (type === 'year') {
        const cy = new Date().getFullYear();
        el.innerHTML = genYearFortune(SAJU, GODS, cy);
        return;
    }
    if (type === 'career') {
        el.innerHTML = genCareerFortune(SAJU, str, GODS);
        return;
    }
    if (type === 'love') {
        el.innerHTML = genLoveFortune(SAJU, str, GODS);
        return;
    }
    if (type === 'wealth') {
        el.innerHTML = genWealthFortune(SAJU, str, GODS);
        return;
    }
    if (type === 'health') {
        el.innerHTML = genHealthFortune(SAJU, str, GODS);
        return;
    }
    
    // total (ê¸°ë³¸ê°’)
    const dm = SAJU.day.s;
    const yongEl = ELEMENT[GODS.yong];
    const colorAdvice = {
        wood: { color: 'ì´ˆë¡ìƒ‰, ì²­ë¡ìƒ‰', dir: 'ë™ìª½', num: '3, 8', item: 'Wood ì†Œí’ˆ, ì‹Water, ì±…' },
        fire: { color: 'ë¹¨ê°„ìƒ‰, ë³´ë¼ìƒ‰', dir: 'ë‚¨ìª½', num: '2, 7', item: 'ì¡°ëª…, ìº”ë“¤, ì „ìê¸°ê¸°' },
        earth: { color: 'ë…¸ë€ìƒ‰, ê°ˆìƒ‰', dir: 'ì¤‘ì•™', num: '5, 10', item: 'ë„ìenergy, í¬ë¦¬ìŠ¤íƒˆ, ë¶€ë™ì‚°' },
        metal: { color: 'í°ìƒ‰, Metalìƒ‰, ì€ìƒ‰', dir: 'ì„œìª½', num: '4, 9', item: 'ê¸ˆì† ì•¡ì„¸ì„œë¦¬, ì‹œê³„, ìë™ì°¨' },
        water: { color: 'ê²€ì€ìƒ‰, íŒŒë€ìƒ‰', dir: 'ë¶ìª½', num: '1, 6', item: 'Waterì¡±ê´€, ë¶„Water, ê·¸ë¦¼' }
    };
    const yongAdvice = colorAdvice[GODS.yong];
    
    const typeDesc = {
        strong: `<strong>ğŸ”¥ Strong Chart!</strong><br><br>You have a strong will and don't get swayed by others.<br><br><strong>Strengths:</strong> Leadership, Quick decisions, Independence, Drive<br><strong>Watch out:</strong> Too strong can seem stubborn. Listen to others sometimes!`,
        weak: `<strong>ğŸ’§ Gentle Chart!</strong><br><br>You cooperate well and live harmoniously with others.<br><br><strong>Strengths:</strong> Perceptive, Adaptable, Considerate, Noble helpers<br><strong>Watch out:</strong> Don't be too cautious. Be confident!`,
        balanced: `<strong>âš–ï¸ Balanced Chart!</strong><br><br>Strong when needed, gentle when appropriate â€” the versatile type! This is the best state in Saju!<br><br><strong>Strengths:</strong> Quick situational judgment, Best adaptability, Thrives anywhere`
    };
    
    el.innerHTML = `
        <div class="info-box gold">
            <p><strong>ğŸ“Š Overall Fortune Analysis</strong></p>
        </div>
        <div class="info-box" style="margin-top:12px;">
            <p style="line-height:1.8;">${typeDesc[GODS.type]}</p>
        </div>
        ${str.extreme ? `<div class="info-box warn" style="margin-top:12px;"><p><strong>âš¡ ${str.extreme} Chart!</strong><br>${str.extreme === 'Extreme Strong' ? 'Extremely strong energy â€” possibly a Special Structure (å¾æ ¼). Living by your own will leads to success!' : 'Extremely weak energy â€” possibly a Special Structure (å¾æ ¼). Following others and collaborating leads to success!'}</p></div>` : ''}
        <div class="info-box good" style="margin-top:15px;">
            <p><strong>ğŸ¯ Beneficial Element Guide</strong></p>
            <p style="margin-top:8px;">Your Beneficial Element is <strong>${yongEl.n}(${yongEl.k})</strong> â€” keep this energy close!</p>
            <ul style="margin-top:10px;margin-left:15px;line-height:1.8;">
                <li>ğŸ¨ Lucky Color: ${yongAdvice.color}</li>
                <li>ğŸ§­ Lucky Direction: ${yongAdvice.dir}</li>
                <li>ğŸ”¢ Lucky Number: ${yongAdvice.num}</li>
                <li>âœ¨ Lucky Item: ${yongAdvice.item}</li>
            </ul>
        </div>`;
}

function getTodayFortune() {
    const today = new Date();
    const dp = calcDayPillar(today.getFullYear(), today.getMonth() + 1, today.getDate());
    const god = getTenGod(dp.s, SAJU.day.s);
    
    const isYong = [dp.s.e, dp.b.e].includes(GODS.yong);
    const isHee = [dp.s.e, dp.b.e].includes(GODS.hee);
    const isGi = [dp.s.e, dp.b.e].includes(GODS.gi);
    
    let rating, advice;
    if (isYong) {
        rating = 'âœ¨ Great Fortune';
        advice = 'Today your Beneficial Element energy is strong! Push forward with important matters. Active movement brings good results.';
    } else if (isHee) {
        rating = 'ğŸ˜Š Good';
        advice = 'Supporting Element helps today. Plans proceed smoothly. New attempts bring fortune.';
    } else if (isGi) {
        rating = 'âš ï¸ Caution';
        advice = 'Challenging Element energy is strong today. Avoid overexertion, postpone major decisions, and focus on existing tasks.';
    } else {
        rating = 'ğŸ˜ Neutral';
        advice = 'An ordinary day. Maintain your routine and find small joys.';
    }
    
    return `<div class="info-box">
        <p><strong>ğŸ“… Today's Fortune</strong> <span style="color:var(--gold);">(${dp.s.c}${dp.b.c} Day)</span></p>
        <div style="margin-top:12px;text-align:center;font-size:18px;">${rating}</div>
        <p style="margin-top:12px;line-height:1.8;">
            Today's day energy: <strong>${dp.s.c}${dp.b.c}</strong> (${ELEMENT[dp.s.e].k}${ELEMENT[dp.b.e].k})<br>
            Today's Influence: <strong>${god.k}</strong> - ${god.d}
        </p>
        <div style="margin-top:15px;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;">
            <p><strong>ğŸ’¡ Today's Advice</strong></p>
            <p style="margin-top:8px;line-height:1.6;">${advice}</p>
        </div>
    </div>`;
}

function getYearFortune() {
    const cy = new Date().getFullYear();
    const yp = calcYearPillar(cy, 6, 1);
    const god = getTenGod(yp.s, SAJU.day.s);
    
    const isYong = [yp.s.e, yp.b.e].includes(GODS.yong);
    const isHee = [yp.s.e, yp.b.e].includes(GODS.hee);
    const isGi = [yp.s.e, yp.b.e].includes(GODS.gi);
    
    let rating, advice;
    if (isYong) {
        rating = 'ğŸŒŸ Excellent Year';
        advice = 'This is your Beneficial Element year! A once-in-10-years opportunity. Actively challenge yourself and expand. Big decisions like career change, starting business, or marriage bring fortune.';
    } else if (isHee) {
        rating = 'ğŸ˜Š Good Year';
        advice = 'Supporting Element helps this year. Work goes smoothly and help comes easily. Expand connections and invest in learning.';
    } else if (isGi) {
        rating = 'âš ï¸ Caution Year';
        advice = 'Challenging Element year. Avoid overexpansion or risky investments. Focus on health and maintain stability while building inner strength.';
    } else {
        rating = 'ğŸ˜ Neutral Year';
        advice = 'A stable year without major changes. Stay focused on your work and prepare for next opportunities.';
    }
    
    return `<div class="info-box">
        <p><strong>ğŸ“† ${cy} Year Fortune</strong> <span style="color:var(--gold);">(${yp.s.c}${yp.b.c})</span></p>
        <div style="margin-top:12px;text-align:center;font-size:18px;">${rating}</div>
        <p style="margin-top:12px;line-height:1.8;">
            Annual Fortune: <strong>${yp.s.c}${yp.b.c}</strong> (${ELEMENT[yp.s.e].k} ${ELEMENT[yp.b.e].k})<br>
            This Year's God: <strong>${god.k}</strong> - ${god.d}
        </p>
        <div style="margin-top:15px;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;">
            <p><strong>ğŸ’¡ Advice for This Year</strong></p>
            <p style="margin-top:8px;line-height:1.6;">${advice}</p>
        </div>
        <div style="margin-top:12px;padding:12px;background:rgba(253,216,53,0.1);border-radius:8px;">
            <p><strong>ğŸ“… Favorable Months</strong></p>
            <p style="margin-top:8px;">${ELEMENT[GODS.yong].k} energy peaks in: ${getGoodMonths()}</p>
        </div>
    </div>`;
}

function getGoodMonths() {
    const monthElements = ['water','water','wood','wood','earth','fire','fire','earth','metal','metal','earth','water'];
    const goodMonths = [];
    monthElements.forEach((el, i) => {
        if (el === GODS.yong || el === GODS.hee) goodMonths.push(MONTH_ABBR[i]);
    });
    return goodMonths.length ? goodMonths.join(', ') : 'Second half of year brings more fortune';
}

/* ========================================
   AI ì¢…í•© í•´ì„ ì—”ì§„
   ======================================== */
function generateAIInterpretation(saju, gods, birthYear, gender, birthMonth, birthDay, birthHour) {
    const dm = saju.day.s;
    const str = calcStrength(saju);
    const currentYear = new Date().getFullYear();
    const age = currentYear - birthYear + 1;
    
    // Gather analysis results
    const interactions = calcInteractions(saju);
    const format = calcFormat(saju);
    const sinsal = calcSinsal(saju);
    const gongmang = calcGongmang(saju);
    const luck = calcLuck(saju, birthYear, gender, gods, birthMonth, birthDay, birthHour);
    const curLuck = luck.find(l => l.isCur);
    
    // äº”è¡Œ(Five Elements) distribution
    const elCount = {wood:0, fire:0, earth:0, metal:0, water:0};
    [saju.year, saju.month, saju.day, saju.hour].forEach(p => {
        if(p && p.s) elCount[p.s.e]++;
        if(p && p.b) elCount[p.b.e]++;
    });
    
    // Strongest/Weakest elements
    const maxEl = Object.entries(elCount).reduce((a,b) => b[1] > a[1] ? b : a);
    const minEl = Object.entries(elCount).filter(e => e[1] === 0);
    
    // Harmony/Clash analysis
    const hasGoodHap = interactions.some(i => i.t.includes('åˆ'));
    const hasBadChung = interactions.some(i => i.t.includes('æ²–'));
    
    // Good/Bad stars
    const goodSinsal = sinsal.filter(s => s.t === 'good');
    const badSinsal = sinsal.filter(s => s.t === 'bad');
    
    // ========== Core Message ==========
    let coreMessage = '';
    let priority = [];
    
    const dmName = `${dm.c} ${ELEMENT[dm.e].k}`;
    const dmHanja = `${dm.c}${ELEMENT[dm.e].c}`;
    
    if (str.type === 'strong') {
        coreMessage = `<strong>${dmName} (${dmHanja})</strong> Day Master is ${str.pct}% <span style="color:var(--fire);">Strong</span>. You have a powerful will and lead your own path in life.`;
        priority.push('Forge your own path - independence suits you best');
    } else if (str.type === 'weak') {
        coreMessage = `<strong>${dmName} (${dmHanja})</strong> Day Master is ${str.pct}% <span style="color:var(--water);">Weak</span>. You shine brightest through cooperation and harmony with others.`;
        priority.push('Partner with the right people - collaboration is your key');
    } else {
        coreMessage = `<strong>${dmName} (${dmHanja})</strong> Day Master is ${str.pct}% <span style="color:var(--gold);">Balanced</span>. You can adapt flexibly to any situation.`;
        priority.push('Adaptability is your superpower');
    }
    
    // Conflict analysis
    let conflictAnalysis = [];
    
    if (hasBadChung && hasGoodHap) {
        conflictAnalysis.push({
            type: 'resolved',
            msg: 'Your chart has both Clash and Harmony - conflicts tend to resolve themselves. You experience growth through challenges.'
        });
    } else if (hasBadChung) {
        conflictAnalysis.push({
            type: 'caution',
            msg: 'Your chart contains Clash energy - expect changes and some conflicts. However, these can become opportunities for growth.'
        });
    }
    
    if (minEl.length >= 2) {
        conflictAnalysis.push({
            type: 'missing',
            msg: `Missing ${minEl.map(e => ELEMENT[e[0]].display).join(', ')} elements. Your Beneficial Element (${ELEMENT[gods.yong].n}) naturally compensates for this.`
        });
    }
    
    if (str.extreme) {
        conflictAnalysis.push({
            type: 'extreme',
            msg: `This is an ${str.extreme === 'Extreme Strong' ? 'Extremely Strong' : 'Extremely Weak'} chart. ${str.extreme === 'Extreme Strong' ? 'Following your own will leads to success.' : 'Delegating and collaborating is your key to success.'}`
        });
    }
    
    // Timing guide
    let timingGuide = '';
    const yearPillar = calcYearPillar(currentYear, 6, 1);
    const isYongYear = [yearPillar.s.e, yearPillar.b.e].includes(gods.yong);
    const isGiYear = [yearPillar.s.e, yearPillar.b.e].includes(gods.gi);
    
    if (curLuck) {
        const isGoodLuck = curLuck.rating === 'good';
        const luckEl = ELEMENT[curLuck.s.e].n;
        
        if (isGoodLuck && isYongYear) {
            timingGuide = `ğŸŒŸ <strong>Golden Opportunity!</strong><br>Both your å¤§é‹(Life Cycle) and this year are favorable. Ages ${curLuck.startAge}-${curLuck.endAge} (${curLuck.s.c}${curLuck.b.c}) with ${luckEl} energy supporting you, plus ${currentYear} is your Beneficial Year. <span style="color:var(--gold);">Take bold action now!</span>`;
        } else if (isGoodLuck && isGiYear) {
            timingGuide = `âš–ï¸ <strong>Mixed Energies</strong><br>Your å¤§é‹(Life Cycle) brings fortune but this year has challenging energy. Stay the course - short-term difficulties won't derail your upward trajectory. <span style="color:var(--earth);">Build foundations for next year.</span>`;
        } else if (!isGoodLuck && isYongYear) {
            timingGuide = `ğŸ’« <strong>Year of Reversal!</strong><br>Though your current å¤§é‹(Life Cycle) is weak, this year brings Beneficial energy. Don't miss this window! <span style="color:var(--gold);">Act now for good results.</span>`;
        } else if (!isGoodLuck && isGiYear) {
            timingGuide = `ğŸ›¡ï¸ <strong>Time for Patience</strong><br>Both å¤§é‹(Life Cycle) and yearly energy require caution. Focus on <span style="color:var(--water);">health and inner strength</span> rather than expansion. Better times are coming.`;
        } else {
            timingGuide = `ğŸ˜Š <strong>Steady Flow</strong><br>Ages ${curLuck.startAge}-${curLuck.endAge} å¤§é‹(Life Cycle) (${curLuck.s.c}${curLuck.b.c}). Consistency is your best strategy.`;
        }
    }
    
    // Personal advice
    let personalAdvice = [];
    
    if (age < 30) {
        personalAdvice.push({icon:'ğŸ“š', title:'Advice for 20s', msg:`Study or gain experience in ${ELEMENT[gods.yong].n}-related fields. This becomes a lifelong asset.`});
    } else if (age < 40) {
        personalAdvice.push({icon:'ğŸš€', title:'Advice for 30s', msg:`What you build now bears fruit in your 40s. Develop expertise in ${format.b.split(',')[0]} areas.`});
    } else if (age < 50) {
        personalAdvice.push({icon:'ğŸ¯', title:'Advice for 40s', msg:'Time to leverage your experience and lead. Mentoring others also benefits you.'});
    } else {
        personalAdvice.push({icon:'ğŸŒ³', title:'Life Wisdom', msg:'Share your wisdom and prioritize health. Spiritual richness is true happiness.'});
    }
    
    const yongAdvice = {
        wood: {actions:['East direction', 'Morning exercise', 'Green colors', 'Reading/Learning', 'New beginnings'], avoid:'Excessive competition, metal decor'},
        fire: {actions:['South direction', 'Social gatherings', 'Red accents', 'Social media', 'Public speaking'], avoid:'Dark environments, isolation'},
        earth: {actions:['Center positions', 'Real estate', 'Yellow/Brown colors', 'Building trust', 'Stable investments'], avoid:'Frequent moves, sudden changes'},
        metal: {actions:['West direction', 'Finance/Investment', 'White/Silver colors', 'Setting principles', 'Organization'], avoid:'Indecisiveness, chaotic environments'},
        water: {actions:['North direction', 'Flexible thinking', 'Black/Blue colors', 'Networking', 'Travel'], avoid:'Stubbornness, staying in one place'}
    };
    
    const yongAction = yongAdvice[gods.yong];
    personalAdvice.push({
        icon:'âœ¨',
        title:`Using ${ELEMENT[gods.yong].n} (Beneficial Element)`,
        msg:`Recommended: ${yongAction.actions.slice(0,3).join(', ')}<br>Avoid: ${yongAction.avoid}`
    });
    
    personalAdvice.push({
        icon:'ğŸ’¼',
        title:'Career Aptitude',
        msg:`Based on your ${format.n}: ${format.b}`
    });
    
    if (goodSinsal.length > 0) {
        personalAdvice.push({
            icon:'ğŸŒŸ',
            title:'Lucky Stars',
            msg:`You have ${goodSinsal.map(s => s.n).join(', ')}. Trust this energy and take bold action!`
        });
    }
    
    // ========== Generate HTML ==========
    let html = `
        <div style="padding:15px;background:linear-gradient(135deg,rgba(156,39,176,0.1),rgba(103,58,183,0.05));border-radius:12px;margin-bottom:15px;">
            <p style="font-size:0.85rem;color:var(--gray);margin-bottom:10px;">ğŸ§  AI Comprehensive Analysis of Your Four Pillars</p>
            <p style="line-height:1.8;font-size:1rem;">${coreMessage}</p>
        </div>
    `;
    
    if (conflictAnalysis.length > 0) {
        html += `
            <div class="info-box ${conflictAnalysis.some(c => c.type === 'caution' || c.type === 'extreme') ? 'warn' : ''}" style="margin-bottom:15px;">
                <p style="margin-bottom:10px;"><strong>âš–ï¸ Energy Conflict Analysis</strong></p>
                ${conflictAnalysis.map(c => `
                    <div style="padding:10px;margin:8px 0;background:rgba(255,255,255,0.05);border-radius:8px;border-left:3px solid ${c.type === 'caution' ? 'var(--fire)' : c.type === 'resolved' ? 'var(--wood)' : 'var(--gold)'};">
                        <p style="font-size:0.9rem;line-height:1.6;">${c.msg}</p>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    html += `
        <div class="info-box gold" style="margin-bottom:15px;">
            <p style="margin-bottom:10px;"><strong>ğŸ“… Current Period Guide (${currentYear}, Age ${age})</strong></p>
            <p style="line-height:1.8;font-size:0.95rem;">${timingGuide}</p>
        </div>
    `;
    
    html += `
        <div class="info-box" style="margin-bottom:15px;">
            <p style="margin-bottom:12px;"><strong>ğŸ’¡ Personalized Advice</strong></p>
            ${personalAdvice.map(a => `
                <div style="padding:12px;margin:8px 0;background:rgba(255,255,255,0.05);border-radius:8px;">
                    <p style="font-weight:bold;margin-bottom:5px;">${a.icon} ${a.title}</p>
                    <p style="font-size:0.9rem;line-height:1.6;color:var(--gray);">${a.msg}</p>
                </div>
            `).join('')}
        </div>
    `;
    
    if (priority.length > 0) {
        html += `
            <div style="padding:15px;background:linear-gradient(135deg,var(--gold),var(--gold-dark));border-radius:12px;color:var(--red-dark);text-align:center;">
                <p style="font-weight:bold;font-size:1.1rem;">ğŸ¯ Key Message</p>
                <p style="margin-top:8px;font-size:0.95rem;">"${priority[0]}"</p>
            </div>
        `;
    }
    
    return html;
}

function showTodayFortune() {
    const el = document.getElementById('today-fortune');
    if (!el) return;
    const content = document.getElementById('today-fortune-content');
    if (content) {
        content.innerHTML = getTodayFortune();
    }
}

/* ========================================
   AI Interpretation Copy Function
   ======================================== */
function copySajuForAI() {
    if (!SAJU) { toast('Please analyze your Four Pillars first'); return; }
    
    // Premium check
    if (!requirePremium('AI Interpretation Copy')) {
        return;
    }
    
    try {
        const str = calcStrength(SAJU);
        const dm = SAJU.day.s;
        const dmName = `${dm.c} ${ELEMENT[dm.e].k}`;
        const gods = GODS;
        const format = calcFormat(SAJU);
        const interactions = calcInteractions(SAJU) || [];
        const sinsal = calcSinsal(SAJU) || [];
        const gongmang = calcGongmang(SAJU);
        const luck = calcLuck(SAJU, BIRTH_YEAR, GENDER, GODS, BIRTH_MONTH, BIRTH_DAY, BIRTH_HOUR) || [];
        const curLuck = luck.find(l => l.isCur);
        const currentYear = new Date().getFullYear();
        const age = currentYear - BIRTH_YEAR + 1;
        const ilju = getIljuDesc(SAJU.day.s, SAJU.day.b);
        
        // Five Elements calculation
        const elCount = {wood:0, fire:0, earth:0, metal:0, water:0};
        [SAJU.year, SAJU.month, SAJU.day, SAJU.hour].forEach(p => {
            if(p && p.s) elCount[p.s.e]++;
            if(p && p.b) elCount[p.b.e]++;
        });
        
        // ====== ì§€ì¥ê°„(Hidden Stems) í¬í•¨ ì˜¤í–‰ ì²´í¬ (v4.8 fix) ======
        const hiddenElCount = {wood:0, fire:0, earth:0, metal:0, water:0};
        const JIJANGGAN_MAP = {
            0: [9],           // å­: ç™¸
            1: [5,7,9],       // ä¸‘: å·±,è¾›,ç™¸
            2: [0,2,4],       // å¯…: ç”²,ä¸™,æˆŠ
            3: [1],           // å¯: ä¹™
            4: [4,9,1],       // è¾°: æˆŠ,ç™¸,ä¹™
            5: [2,4,6],       // å·³: ä¸™,æˆŠ,åºš
            6: [3,5],         // åˆ: ä¸,å·±
            7: [5,3,1],       // æœª: å·±,ä¸,ä¹™
            8: [6,8,4],       // ç”³: åºš,å£¬,æˆŠ
            9: [7],           // é…‰: è¾›
            10:[4,7,3],       // æˆŒ: æˆŠ,è¾›,ä¸
            11:[8,0]          // äº¥: å£¬,ç”²
        };
        [SAJU.year.b, SAJU.month.b, SAJU.day.b, SAJU.hour?.b].filter(b => b).forEach(b => {
            const bi = BRANCH.findIndex(br => br.c === b.c);
            const hidden = JIJANGGAN_MAP[bi] || [];
            hidden.forEach(hi => { hiddenElCount[STEM[hi].e]++; });
        });
        
        // Ten Gods calculation
        const yearGod = getTenGod(SAJU.year.s, dm);
        const monthGod = getTenGod(SAJU.month.s, dm);
        const hourGod = SAJU.hour ? getTenGod(SAJU.hour.s, dm) : null;
        
        // ì‹­ì‹  ì¤‘ë³µ ì²´í¬ - ê°™ì€ ì‹­ì‹ ì´ë©´ ê°„ëµí™”
        const monthGodDesc = (monthGod.k === yearGod.k) 
            ? `Same as Year Stem (${yearGod.k}), amplifying its influence`
            : `${monthGod.k} - ${monthGod.d}`;
        const hourGodDesc = hourGod 
            ? (hourGod.k === yearGod.k || hourGod.k === monthGod.k)
                ? `Same as above (${hourGod.k})`
                : `${hourGod.k} - ${hourGod.d}`
            : null;
        
        // Twelve States ê³„ì‚°
        const yearState = getTwelveState(dm, SAJU.year.b);
        const monthState = getTwelveState(dm, SAJU.month.b);
        const dayState = getTwelveState(dm, SAJU.day.b);
        const hourState = SAJU.hour ? getTwelveState(dm, SAJU.hour.b) : null;
        
        // Hidden Stems Analysis (safe)
        let jjText = '';
        try {
            const jjAnalysis = analyzeJijanggan(SAJU);
            if (jjAnalysis && jjAnalysis.pillars) {
                jjText = `â€¢ Year Branch ${SAJU.year.b.c}: ${jjAnalysis.pillars[0]?.hidden?.map(h => h.stem.c + '(' + h.stem.k + ',' + h.type + ',' + h.god.k + ')').join(', ') || '-'}
â€¢ Month Branch ${SAJU.month.b.c}: ${jjAnalysis.pillars[1]?.hidden?.map(h => h.stem.c + '(' + h.stem.k + ',' + h.type + ',' + h.god.k + ')').join(', ') || '-'}
â€¢ Day Branch ${SAJU.day.b.c}: ${jjAnalysis.pillars[2]?.hidden?.map(h => h.stem.c + '(' + h.stem.k + ',' + h.type + ',' + h.god.k + ')').join(', ') || '-'}`;
                if (SAJU.hour && jjAnalysis.pillars[3]) {
                    jjText += `\nâ€¢ Hour Branch ${SAJU.hour.b.c}: ${jjAnalysis.pillars[3]?.hidden?.map(h => h.stem.c + '(' + h.stem.k + ',' + h.type + ',' + h.god.k + ')').join(', ') || '-'}`;
                }
            }
        } catch(e) { jjText = 'â€¢ Hidden Stems analysis unavailable'; }
        
        // Root/Stem Analysis (safe)
        let ttText = '';
        try {
            const ttAnalysis = analyzeTonggeunTougan(SAJU);
            const tgText = ttAnalysis?.tonggeun?.length ? 
                ttAnalysis.tonggeun.map(t => t.stem + ' roots in ' + (t.roots?.map(r => r.pillar + r.branch).join(',') || '')).join('; ') : 'No roots';
            const tuText = ttAnalysis?.tougan?.length ? 
                ttAnalysis.tougan.map(t => t.stem + '(' + t.god + ')').join(', ') : 'No stems revealed';
            ttText = `â€¢ Roots (é€šæ ¹): ${tgText}\nâ€¢ Stems Revealed (é€å¹²): ${tuText}`;
        } catch(e) { ttText = 'â€¢ Root/Stem analysis unavailable'; }
        
        // Six Relations (å…­è¦ª) Analysis (safe)
        let ycText = '';
        try {
            const yukcheon = analyzeYukcheon(SAJU, GENDER);
            if (yukcheon) {
                // ë°°ìš°ìì„± ìƒíƒœ íŒë³„
                let spouseStatus = '';
                if (yukcheon.spouse?.count > 0) {
                    spouseStatus = yukcheon.spouse.count + ' visible';
                } else if (yukcheon.spouse?.hiddenSpouse?.found) {
                    if (yukcheon.spouse.hiddenSpouse.damaged) {
                        spouseStatus = 'Hidden but Damaged (' + yukcheon.spouse.hiddenSpouse.position + ' branch - ' + yukcheon.spouse.hiddenSpouse.damageDesc + ')';
                    } else {
                        spouseStatus = 'Hidden in ' + yukcheon.spouse.hiddenSpouse.position + ' branch (latent)';
                    }
                } else {
                    spouseStatus = 'Hidden (latent in chart)';
                }
                
                // ğŸ”¥ ìë…€ì„± ìƒíƒœ íŒë³„ - Gemini Round 4
                let childStatus = '';
                if (yukcheon.children?.hourStemChild) {
                    const hsc = yukcheon.children.hourStemChild;
                    if (hsc.underFire) {
                        childStatus = `REVEALED on Hour Stem (${hsc.stem.c}) but under Fire - challenged`;
                    } else {
                        childStatus = `REVEALED on Hour Stem (${hsc.stem.c})`;
                    }
                } else if (yukcheon.children?.count > 0) {
                    childStatus = 'Visible';
                } else {
                    childStatus = 'Hidden (may manifest in Life Cycles)';
                }
                
                ycText = `â€¢ é…å¶æ˜Ÿ(Spouse Star) (${yukcheon.spouse?.god || '-'}): ${spouseStatus} - ${yukcheon.spouse?.analysis || 'Check Divine Stars for hidden potential'}
â€¢ å­å¥³æ˜Ÿ(Children Star) (${yukcheon.children?.gods?.join('/') || '-'}): ${childStatus} - ${yukcheon.children?.analysis || 'Check Life Cycles for timing'}
â€¢ Father (åè²¡/Indirect Wealth): ${yukcheon.parents?.father?.analysis || '-'}
â€¢ Mother (æ­£å°/Direct Seal): ${yukcheon.parents?.mother?.analysis || '-'}`;
            }
        } catch(e) { ycText = 'â€¢ Six Relations (å…­è¦ª) analysis unavailable'; }
        
        // å®®ä½(Palace Analysis) (safe)
        let gwText = '';
        try {
            const gungwi = analyzeGungwi(SAJU, BIRTH_YEAR);
            if (gungwi && Array.isArray(gungwi)) {
                gwText = gungwi.map(g => 'â€¢ ' + g.name + ' (' + g.ageRange + '): ' + (g.status || 'Neutral') + ' - ' + (g.twelveState || '') + (g.isCurrent ? ' â—€ CURRENT' : '')).join('\n');
            }
        } catch(e) { gwText = 'â€¢ Palace analysis unavailable'; }
        
        // Next 10 Years (safe)
        let next10Text = '';
        try {
            const next10 = getNext10Years(SAJU, BIRTH_YEAR, GENDER, GODS, BIRTH_MONTH, BIRTH_DAY, BIRTH_HOUR);
            if (next10) {
                next10Text = `â€¢ Best Year: ${next10.bestYear?.year || '-'} (Age ${next10.bestYear?.age || '-'})
â€¢ Caution Year: ${next10.worstYear?.year || '-'} (Age ${next10.worstYear?.age || '-'})`;
            }
        } catch(e) { next10Text = 'â€¢ 10-year forecast unavailable'; }
        
        // Monthly Fortune (safe)
        let monthText = '';
        try {
            const monthlyLuck = getYearlyMonthLuck(currentYear, SAJU, GODS);
            if (monthlyLuck) {
                // Find climate clash months
                const climateClashMonths = monthlyLuck.months.filter(m => m.climateClash).map(m => m.month);
                // Find wang clash months (ìì˜¤ì¶© ë“±)
                const wangClashMonths = monthlyLuck.wangClashMonths || [];
                monthText = `â€¢ Best Month: ${monthlyLuck.best?.month || '-'} (${monthlyLuck.best?.god?.k || '-'})
â€¢ Caution Month: ${monthlyLuck.worst?.month || '-'} (${monthlyLuck.worst?.god?.k || '-'})${climateClashMonths.length ? `
â€¢ âš ï¸ Climate Clash Months: ${climateClashMonths.join(', ')} - Extra caution for health!` : ''}${wangClashMonths.length ? `
â€¢ ğŸ”¥ Fire-Water Clash Months: ${wangClashMonths.join(', ')} - Cardiovascular shock risk! Avoid sudden temperature changes.` : ''}`;
            }
        } catch(e) { monthText = 'â€¢ Monthly forecast unavailable'; }
        
        // ç´éŸ³(Sound Element)/å‘½å®®(Life Palace)/Conception (safe)
        let napeumText = '';
        try {
            const dayNapeum = calcNapeum(SAJU.day.s, SAJU.day.b);
            const yearNapeum = calcNapeum(SAJU.year.s, SAJU.year.b);
            napeumText = `â€¢ Day Sound Element: ${SAJU.day.s.c}${SAJU.day.b.c} â†’ ${dayNapeum.name} (${dayNapeum.elementK}) - ${dayNapeum.desc}
â€¢ Year Sound Element: ${SAJU.year.s.c}${SAJU.year.b.c} â†’ ${yearNapeum.name} (${yearNapeum.elementK})`;
        } catch(e) { napeumText = 'â€¢ Sound Element unavailable'; }
        
        let myunggungText = '';
        try {
            if (SAJU.hour) {
                const myunggung = calcMyunggung(SAJU.month.b, SAJU.hour.b);
                myunggungText = `â€¢ Life Palace (å‘½å®®): ${myunggung.name}
â€¢ Tendency: ${myunggung.trait}
â€¢ Suitable Fields: ${myunggung.career}`;
            } else {
                myunggungText = 'â€¢ Life Palace: Cannot calculate without Hour';
            }
        } catch(e) { myunggungText = 'â€¢ Life Palace unavailable'; }
        
        let taewonText = '';
        try {
            const taewon = calcTaewon(SAJU.year.s, SAJU.month.s, SAJU.month.b);
            taewonText = `â€¢ Conception Origin (èƒå…ƒ): ${taewon.pillar}
â€¢ Conception Sound Element: ${taewon.napeum.name} (${taewon.napeum.elementK})`;
        } catch(e) { taewonText = 'â€¢ Conception Origin unavailable'; }
        
        // æ–¹åˆ(Directional Harmony)/æš—åˆ(Hidden Harmony) (safe)
        let banghapText = '';
        try {
            const banghap = analyzeBanghap(SAJU);
            banghapText = banghap.length ? banghap.map(b => 
                `â€¢ ${b.name} (${b.branches}): ${b.dir} ${b.type === 'complete' ? 'COMPLETE!' : 'Incomplete'}`
            ).join('\n') : 'â€¢ No Directional Harmony';
        } catch(e) { banghapText = 'â€¢ æ–¹åˆ(Directional Harmony) unavailable'; }
        
        let amhapText = '';
        try {
            const amhap = analyzeAmhap(SAJU);
            amhapText = amhap.length ? amhap.map(a => 
                `â€¢ ${a.name}: ${a.positions} - ${a.desc}`
            ).join('\n') : 'â€¢ No Hidden Harmony';
        } catch(e) { amhapText = 'â€¢ Hidden Harmony unavailable'; }
        
        // v4.14.7: í•µì‹¬ íŠ¹ì§• TOP 3 ìë™ ì¶”ì¶œ
        let criticalText = '';
        try {
            const criticalFeatures = [];
            if (dm && dm.e) {
                const wealthEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 2) % 5];
                if (GODS && GODS.climate && GODS.climate.type) {
                    if (GODS.climate.type.includes('Cold') || GODS.climate.type.includes('Extreme Cold')) {
                        criticalFeatures.push('ğŸ”¥ CLIMATE EMERGENCY: ' + GODS.climate.type + ' - Fire (ç«) is ESSENTIAL');
                    }
                    if (GODS.climate.type.includes('Hot') || GODS.climate.type.includes('Dry')) {
                        criticalFeatures.push('ğŸ’§ CLIMATE EMERGENCY: ' + GODS.climate.type + ' - Water (æ°´) is ESSENTIAL');
                    }
                }
                if (str && str.type === 'weak' && wealthEl && elCount[wealthEl] >= 3) {
                    criticalFeatures.push('âš ï¸ WEALTH OVERLOAD (è²¡å¤šèº«å¼±): ' + elCount[wealthEl] + ' Wealth vs weak (' + str.pct + '%) Day Master');
                }
                const bureaus = (interactions || []).filter(i => i.t && i.t.includes('åˆ'));
                if (bureaus.length > 0) {
                    // v4.14.7: ì˜¤í–‰ ëª…ì‹œ (Fire/Water/Metal/Wood)
                    const bureauDesc = bureaus.map(b => {
                        let el = '';
                        if (b.m && b.m.includes('Fire')) el = 'Fire';
                        else if (b.m && b.m.includes('Water')) el = 'Water';
                        else if (b.m && b.m.includes('Metal')) el = 'Metal';
                        else if (b.m && b.m.includes('Wood')) el = 'Wood';
                        return b.c + ' ' + b.t + (el ? ' (' + el + ' x10)' : '');
                    }).join(', ');
                    criticalFeatures.push('ğŸŒ² BUREAU: ' + bureauDesc);
                }
                if (GODS && GODS.yong && elCount[GODS.yong] === 0) {
                    criticalFeatures.push('ğŸ›¡ï¸ NO SHIELD: Beneficial Element (' + GODS.yong + ') MISSING from chart');
                }
            }
            const top3 = criticalFeatures.slice(0, 3);
            criticalText = top3.length > 0 ? 'ã€âš¡ CRITICAL FEATURES - AI MUST ADDRESS FIRST âš¡ã€‘\n' + top3.map((f, i) => (i+1) + '. ' + f).join('\n') + '\n\n' : '';
        } catch(e) { criticalText = ''; }
        
        // Generate text
        const locationSelect = document.getElementById('birth-location');
        const locationText = locationSelect ? locationSelect.options[locationSelect.selectedIndex]?.text || 'Unknown' : 'Unknown';
        const calendarText = CALENDAR === 'lunar' ? 'Lunar (ìŒë ¥)' : 'Solar (ì–‘ë ¥)';
        
        // ì‹œ(æ™‚) ì •ë³´ - ì§„íƒœì–‘ì‹œ ê¸°ì¤€ ì‹œê°„ëŒ€ í¬í•¨
        const HOUR_RANGES = {
            'å­': '23:30-01:29', 'ä¸‘': '01:30-03:29', 'å¯…': '03:30-05:29', 'å¯': '05:30-07:29',
            'è¾°': '07:30-09:29', 'å·³': '09:30-11:29', 'åˆ': '11:30-13:29', 'æœª': '13:30-15:29',
            'ç”³': '15:30-17:29', 'é…‰': '17:30-19:29', 'æˆŒ': '19:30-21:29', 'äº¥': '21:30-23:29'
        };
        let hourText = 'Unknown';
        if (SAJU.hour && SAJU.hour.b) {
            const hourBranch = SAJU.hour.b.c;
            const hourRange = HOUR_RANGES[hourBranch] || '';
            hourText = `${hourBranch}æ™‚ (${hourRange}) - True Solar Time`;
        }
        
        let text = `===== FOUR PILLARS OF DESTINY (SAJU) ANALYSIS =====

${criticalText}ã€BASIC INFOã€‘
â€¢ Birth Date: ${BIRTH_YEAR}-${String(BIRTH_MONTH).padStart(2,'0')}-${String(BIRTH_DAY).padStart(2,'0')}
â€¢ Birth Hour: ${hourText}
â€¢ Calendar: ${calendarText}
â€¢ Gender: ${GENDER === 'm' ? 'Male (ë‚¨)' : 'Female (ì—¬)'}
â€¢ Birth Location: ${locationText}
â€¢ Age: ${age-1} (Korean Age: ${age})
â€¢ Day Master: ${dm.c} ${ELEMENT[dm.e].n} (${dm.c}${ELEMENT[dm.e].c})

ã€FOUR PILLARS CHART (Year/Month/Day/Hour)ã€‘
â€¢ Heavenly Stems: ${SAJU.year.s.c}(${SAJU.year.s.k}) ${SAJU.month.s.c}(${SAJU.month.s.k}) ${SAJU.day.s.c}(${SAJU.day.s.k}) ${SAJU.hour ? SAJU.hour.s.c+'('+SAJU.hour.s.k+')' : 'Unknown'}
â€¢ Earthly Branches: ${SAJU.year.b.c}(${SAJU.year.b.k}) ${SAJU.month.b.c}(${SAJU.month.b.k}) ${SAJU.day.b.c}(${SAJU.day.b.k}) ${SAJU.hour ? SAJU.hour.b.c+'('+SAJU.hour.b.k+')' : 'Unknown'}

ã€TEN GODS (Based on Stems)ã€‘
â€¢ Year Stem ${SAJU.year.s.c}: ${yearGod.k} - ${yearGod.d}
â€¢ Month Stem ${SAJU.month.s.c}: ${monthGodDesc}
â€¢ Day Stem ${SAJU.day.s.c}: Self (Day Master)
${hourGod ? 'â€¢ Hour Stem ' + SAJU.hour.s.c + ': ' + hourGodDesc : 'â€¢ Hour Stem: Unknown'}

ã€TWELVE LIFE STAGES (Based on Day Master)ã€‘
â€¢ Year Branch ${SAJU.year.b.c}: ${yearState.k} (Energy ${yearState.l}/12)
â€¢ Month Branch ${SAJU.month.b.c}: ${monthState.k} (Energy ${monthState.l}/12)
â€¢ Day Branch ${SAJU.day.b.c}: ${dayState.k} (Energy ${dayState.l}/12)
${hourState ? 'â€¢ Hour Branch ' + SAJU.hour.b.c + ': ' + hourState.k + ' (Energy ' + hourState.l + '/12)' : 'â€¢ Hour Branch: Unknown'}

ã€FIVE ELEMENTS DISTRIBUTIONã€‘
â€¢ Wood (æœ¨): ${elCount.wood}
â€¢ Fire (ç«): ${elCount.fire}
â€¢ Earth (åœŸ): ${elCount.earth}
â€¢ Metal (é‡‘): ${elCount.metal}
â€¢ Water (æ°´): ${elCount.water}
â€¢ Missing Elements: ${(() => {
    const missing = Object.entries(elCount).filter(e => e[1] === 0);
    if (missing.length === 0) return 'None';
    return missing.map(([el, cnt]) => {
        if (hiddenElCount[el] > 0) {
            return ELEMENT[el].c + '(' + ELEMENT[el].k + ') - Weak (Hidden in branches)';
        }
        return ELEMENT[el].c + '(' + ELEMENT[el].k + ')';
    }).join(', ');
})()}

ã€DAY MASTER STRENGTHã€‘
â€¢ Strength: ${str.pct}% (${str.type === 'strong' ? 'STRONG Body' : str.type === 'weak' ? 'WEAK Body' : 'BALANCED'})
${str.extreme ? 'â€¢ Special Note: ' + (str.extreme === 'Extreme Strong' ? 'Extremely Strong' : 'Extremely Weak') + ' chart (Possible Special Format)' : ''}
${(() => {
    // v4.12.1: ì‹¤ì œ í†µê·¼ ì •ë³´ (ì§€ì¥ê°„ ê¸°ì¤€)
    let rootInfo = '';
    if (str.dayRoot || str.hourRoot) {
        rootInfo = 'â€¢ âš¡ REAL ROOTS (ì§€ì¥ê°„ ê¸°ì¤€): ';
        if (str.dayRoot) rootInfo += 'Day Branch has Peer/Seal in hidden stems. ';
        if (str.hourRoot) rootInfo += 'Hour Branch has Peer/Seal in hidden stems. ';
        rootInfo += 'Hidden resilience - not helpless despite low percentage.';
    } else if (str.type === 'weak') {
        rootInfo = 'â€¢ âš ï¸ NO REAL ROOTS: Day Master lacks Peer/Seal in branch hidden stems. Flexible but needs external support.';
    }
    return rootInfo;
})()}
${(() => {
    // v4.12.1: ì²œê°„í•© ë¬´ë ¥í™” ì •ë³´
    if (str.disabledSeals?.length || str.disabledPeers?.length) {
        const disabled = [];
        if (str.disabledSeals?.length) {
            str.disabledSeals.forEach(si => disabled.push(STEM[si].c + '(Seal)'));
        }
        if (str.disabledPeers?.length) {
            str.disabledPeers.forEach(si => disabled.push(STEM[si].c + '(Peer)'));
        }
        return 'â€¢ ğŸ”— STEM COMBINE NEUTRALIZATION: ' + disabled.join(', ') + ' disabled by å¤©å¹²åˆ. These helpers cannot support Day Master.';
    }
    return '';
})()}
${(() => {
    // ğŸ”¥ ì¬ë‹¤ì‹ ì•½(è²¡å¤šèº«å¼±) ì²´í¬ - Gemini Round 3
    const dm = SAJU.day.s;
    const wealthEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 2) % 5];  // ì¬ì„± ì˜¤í–‰
    const wealthCount = elCount[wealthEl] || 0;
    if (str.type === 'weak' && wealthCount >= 3) {
        return 'â€¢ ğŸ’° WEALTH OVERLOAD (è²¡å¤šèº«å¼±): ' + wealthCount + ' Wealth elements overwhelming weak Day Master! ' +
               'Metaphor: "Small boat carrying elephant." ' +
               'Strategy: Do NOT chase money directly. Lock assets in Real Estate/Documents. Let spouse manage finances. Health first, money second.';
    }
    return '';
})()}
${(() => {
    // Rooted check - ì¼ì§€/ì‹œì§€ì— ë¡ì™•ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
    const dmEl = SAJU.day.s.e;
    const dayState = getTwelveState(SAJU.day.s, SAJU.day.b);
    const hourState = SAJU.hour ? getTwelveState(SAJU.day.s, SAJU.hour.b) : null;
    const strongStates = [11, 12]; // ê±´ë¡(11), ì œì™•(12)
    const hasRoot = strongStates.includes(dayState.l) || (hourState && strongStates.includes(hourState.l));
    
    // ğŸ”¥ ë¿Œë¦¬ ê³µê²© ì²´í¬ (ì¼ì§€-ì‹œì§€ ì¶©) - Gemini Round 3
    let rootUnderAttack = false;
    let attackDesc = '';
    if (SAJU.hour) {
        const dbi = BRANCH.findIndex(br => br.c === SAJU.day.b.c);
        const hbi = BRANCH.findIndex(br => br.c === SAJU.hour.b.c);
        // ìœ¡ì¶© ì²´í¬ (6 ì°¨ì´)
        if (Math.abs(dbi - hbi) === 6) {
            rootUnderAttack = true;
            attackDesc = `Day-Hour Clash (${SAJU.day.b.c}â†”${SAJU.hour.b.c})! Root is under attack from spouse palace.`;
        }
    }
    
    if (str.type === 'weak' && hasRoot) {
        if (rootUnderAttack) {
            return 'â€¢ âš ï¸ ROOT UNDER ATTACK: Day Master has root in ' + 
                   (hourState && strongStates.includes(hourState.l) ? 'Hour Branch (' + hourState.k + ')' : 'Day Branch') +
                   ' BUT ' + attackDesc + 
                   ' Late-life instability. Spouse conflicts may drain vitality. Guard cardiovascular health especially in later years.';
        } else {
            return 'â€¢ âš¡ ROOT ANALYSIS: Despite low percentage, Day Master has STRONG ROOTS in ' + 
                   (strongStates.includes(dayState.l) ? 'Day Branch (' + dayState.k + ')' : '') +
                   (strongStates.includes(dayState.l) && hourState && strongStates.includes(hourState.l) ? ' and ' : '') +
                   (hourState && strongStates.includes(hourState.l) ? 'Hour Branch (' + hourState.k + ')' : '') +
                   '. Hidden resilience and late-blooming potential. Not helpless - just selective about when to fight.';
        }
    }
    return '';
})()}
${(() => {
    // ğŸ”¥ ë¬´Expression(ç„¡é£Ÿå‚·) í†µê´€ ë¶€ì¬ ì²´í¬ - Gemini Round 5
    // ìˆ˜í™”ìƒì „(æ°´ç«ç›¸æˆ°)ì¸ë° ëª©(æœ¨)ì´ ì—†ëŠ” ê²½ìš°
    const dm = SAJU.day.s;
    const outputEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 1) % 5];  // Expression ì˜¤í–‰
    const wealthEl = EL_ORDER[(EL_ORDER.indexOf(dm.e) + 2) % 5];  // ì¬ì„± ì˜¤í–‰
    
    // ì¼ê°„ì´ æ°´ì´ê³  ì¬ì„±(ç«)ì´ ê°•í•œë° æœ¨(í†µê´€)ì´ ì—†ëŠ” ê²½ìš°
    if (dm.e === 'water' && elCount['wood'] === 0 && elCount['fire'] >= 2) {
        return 'â€¢ âš ï¸ NO BRIDGE (ç„¡é€šé—œ): Water (self) vs Fire (wealth) war with NO Wood mediator! ' +
               'Danger: Chasing money directly leads to health collapse. ' +
               'Solution: BUILD WOOD activities - learning, hobbies, plants, yoga, charity. This creates the bridge between effort and reward.';
    }
    // ì¼ê°„ì´ ç«ì´ê³  ì¬ì„±(é‡‘)ì´ ê°•í•œë° åœŸ(í†µê´€)ì´ ì—†ëŠ” ê²½ìš°
    if (dm.e === 'fire' && elCount['earth'] === 0 && elCount['metal'] >= 2) {
        return 'â€¢ âš ï¸ NO BRIDGE (ç„¡é€šé—œ): Fire (self) vs Metal (wealth) war with NO Earth mediator! ' +
               'Danger: Wealth goals burn you out. ' +
               'Solution: BUILD EARTH activities - stability, real estate, documentation, grounding practices.';
    }
    return '';
})()}
${(() => {
    // ğŸ”¥ ì—¬ëª… ë¹„ê² ê³¼ë‹¤ ì²´í¬ - Gemini Round 5
    if (GENDER !== 'f') return '';  // ë‚¨ëª…ì€ í•´ë‹¹ ì—†ìŒ
    
    const dm = SAJU.day.s;
    // ë¹„ê²¬/ê²ì¬ ì¹´ìš´íŠ¸ (ê°™ì€ ì˜¤í–‰)
    let peerCount = 0;
    const stems = [SAJU.year.s, SAJU.month.s, SAJU.day.s];
    if (SAJU.hour) stems.push(SAJU.hour.s);
    stems.forEach(s => {
        if (s.e === dm.e) peerCount++;
    });
    
    // ì¼ì§€ê°€ ì¶©ì„ ë°›ëŠ”ì§€ ì²´í¬
    const dayBranchIdx = BRANCH.findIndex(br => br.c === SAJU.day.b.c);
    let dayClashed = false;
    const branches = [SAJU.year.b, SAJU.month.b];
    if (SAJU.hour) branches.push(SAJU.hour.b);
    branches.forEach(b => {
        if (Math.abs(BRANCH.findIndex(br => br.c === b.c) - dayBranchIdx) === 6) dayClashed = true;
    });
    
    if (peerCount >= 3 && dayClashed) {
        return 'â€¢ âš ï¸ FEMALE PEER OVERLOAD (å¥³å‘½æ¯”åŠ«å¤š+æ—¥æ”¯æ²–): ' + peerCount + ' same-element stems AND spouse palace clashed! ' +
               'Meaning: Competition in romantic sphere. Husband may face pressure. ' +
               'Advice: Maintain independence but avoid power struggles. "Weekend marriage" or separate hobbies preserve harmony.';
    } else if (peerCount >= 3) {
        return 'â€¢ âš ï¸ FEMALE PEER OVERLOAD (å¥³å‘½æ¯”åŠ«å¤š): ' + peerCount + ' same-element stems. Strong independence but romantic competition possible. ' +
               'Advice: Choose partner who respects your autonomy. Avoid competing with spouse.';
    }
    return '';
})()}

ã€BENEFICIAL ELEMENTS (ç”¨ç¥ System)ã€‘
â€¢ Beneficial God (ç”¨ç¥): ${ELEMENT[GODS.yong].n} (${ELEMENT[GODS.yong].c}) - Most needed element
â€¢ Favorable God (å–œç¥): ${ELEMENT[GODS.hee].n} (${ELEMENT[GODS.hee].c}) - Supports beneficial element
â€¢ Unfavorable God (å¿Œç¥): ${ELEMENT[GODS.gi].n} (${ELEMENT[GODS.gi].c}) - Element to avoid
${GODS.isFollower ? 'â€¢ ğŸŒ€ FOLLOWER CHART (' + GODS.followerType + '): Extremely weak Day Master follows the dominant element. DO NOT fight the trend - ride it. Years bringing ' + ELEMENT[GODS.yong].n + ' are FAVORABLE, not threatening.' : ''}
${GODS.sealExcess ? 'â€¢ âš ï¸ SEAL EXCESS (åå°å¤ªæ—º): 3+ Seal elements suffocating Day Master. Output (Expression) needed to drain the overflow.' : ''}
${GODS.johu ? 'â€¢ Seasonal Adjustment: ' + (GODS.johuDesc || '') : ''}
${GODS.climate ? 'â€¢ Climate Balance: ' + GODS.climate.type + ' - ' + GODS.climate.desc : ''}

ã€PERSONALITY STRUCTURE (æ ¼å±€)ã€‘
â€¢ ${format.n}
â€¢ Characteristics: ${format.d}
${str.pct < 20 && format.n.includes('Wealth') ? 'â€¢ âš ï¸ WEAK CHART WARNING: With low strength (' + str.pct.toFixed(1) + '%), this becomes "Anxious Chaser" rather than "Steady Builder". Wealth overwhelms instead of supports. Health-first strategy required.' : ''}
${format.fakeFollower ? 'â€¢ âš ï¸ FAKE FOLLOWER ALERT: This may be a "Following Wealth/Officer" structure. If true, years that strengthen the dominant element (Fire/Earth) become FAVORABLE, not dangerous. Extreme volatility interpretation required.' : ''}
â€¢ Suitable Fields: ${format.b}

ã€60 PILLARS DAY MASTER THEORY - ${SAJU.day.s.c}${SAJU.day.b.c} Dayã€‘
â€¢ ${ilju.title}
â€¢ Personality: ${ilju.desc?.substring(0, 100) || ''}...
â€¢ Spouse Fortune: ${ilju.spouse?.substring(0, 80) || ''}...

ã€HIDDEN STEMS (æ”¯è—å¹²)ã€‘
${jjText}

ã€SOUND ELEMENT (ç´éŸ³)ã€‘
${napeumText}

ã€LIFE PALACE (å‘½å®®)ã€‘
${myunggungText}

ã€CONCEPTION ORIGIN (èƒå…ƒ)ã€‘
${taewonText}

ã€ROOT & STEM ANALYSIS (é€šæ ¹é€å¹²)ã€‘
${ttText}

ã€SIX RELATIONS (å…­è¦ª)ã€‘
${ycText}

ã€PALACE ANALYSIS (å®®ä½) - Life Periodsã€‘
${gwText}

ã€HARMONY & CLASH (åˆæ²–åˆ‘ç ´å®³)ã€‘
${interactions.length ? interactions.map(i => 'â€¢ ' + i.t + ': ' + i.c + ' - ' + i.m).join('\n') : 'â€¢ No significant interactions'}

ã€DIRECTIONAL HARMONY (æ–¹åˆ)ã€‘
${banghapText}

ã€HIDDEN HARMONY (æš—åˆ)ã€‘
${amhapText}

ã€EMPTY VOID (ç©ºäº¡)ã€‘
â€¢ Void Branches: ${gongmang?.names?.join(', ') || 'None'}
${gongmang?.affected?.length ? 'â€¢ Affected Positions: ' + gongmang.affected.join(', ') : 'â€¢ No void in Four Pillars'}

ã€DIVINE STARS (ç¥æ®º)ã€‘
${sinsal.length ? sinsal.map(s => 'â€¢ ' + s.n + ' (' + (s.t === 'good' ? 'Auspicious' : s.t === 'bad' ? 'Inauspicious' : 'Neutral') + '): ' + s.d).join('\n') : 'â€¢ No significant divine stars'}

ã€LIFE CYCLES (å¤§é‹) - 10-Year Periodsã€‘
${luck.slice(0,8).map(l => 'â€¢ Ages ' + l.startAge + '-' + l.endAge + ': ' + l.s.c + l.b.c + ' (' + ELEMENT[l.s.e].n + '/' + ELEMENT[l.b.e].n + ')' + (l.isCur ? ' â—€ CURRENT' : '')).join('\n')}

ã€CURRENT FORTUNEã€‘
â€¢ Current å¤§é‹(Life Cycle): ${curLuck ? curLuck.s.c + curLuck.b.c + ' (Ages ' + curLuck.startAge + '-' + curLuck.endAge + ')' : 'Calculating...'}
â€¢ Cycle Rating: ${curLuck ? (curLuck.rating === 'good' ? 'FAVORABLE' : curLuck.rating === 'bad' ? 'CHALLENGING' : 'NEUTRAL') : '-'}${curLuck && curLuck.climateClash ? ' âš ï¸ Climate Clash!' : ''}
â€¢ ${currentYear} æ­²é‹(Annual Fortune): ${(() => { const yp = calcYearPillar(currentYear, 6, 1); return yp.s.c + yp.b.c + ' (' + ELEMENT[yp.s.e].n + '/' + ELEMENT[yp.b.e].n + ')'; })()}
${(() => {
    const yearLuck = calcYearLuck(currentYear, SAJU, GODS);
    const ratingText = yearLuck.rating === 'breakthrough' ? 'ğŸš€ BREAKTHROUGH - Grand Opportunity Year!' :
                       yearLuck.rating === 'yong_attacked' ? 'ğŸš¨ DANGER - Beneficial Element Under Attack! Preserve assets!' :
                       yearLuck.rating === 'rob_wealth' ? 'âš”ï¸ DANGER - Wealth Robbery Year (ç¾¤åŠ«çˆ­è²¡)! Avoid partnerships!' :
                       yearLuck.rating === 'surgery_risk' ? 'âš”ï¸ HIGH RISK HIGH RETURN - Wealth OR Surgery Year (æ²–ç¾Šåˆƒ)' :
                       yearLuck.rating === 'volatile_wealth' ? 'ğŸ’°âš ï¸ VOLATILE WEALTH - Big money but health/spouse risk' :
                       yearLuck.rating === 'wang_shin_chung_bal' ? 'ğŸš¨ ì™•ì‹ ì¶©ë°œ(æ—ºç¥æ²–ç™¼) - ëŒ€ê²©ë³€/ì‚¬ê³ /íŒŒì¬ ê·¹ë„ ì£¼ì˜!' :
                       yearLuck.rating === 'yong_overwhelmed' ? 'âš ï¸ ì‡ ì‹ ì¶©ì™•(è¡°ç¥æ²–æ—º) - ìš©ì‹ ì´ ì™€ë„ ê¸°ì‹ ì— ì••ë„ë¨!' :
                       yearLuck.rating === 'pyunin_doshik' ? 'âš ï¸ í¸ì¸ë„ì‹(åå°å€’é£Ÿ) - ë°¥ê·¸ë¦‡ ê¹¨ì§ ì£¼ì˜!' :
                       yearLuck.rating === 'great' ? 'EXCELLENT' : 
                       yearLuck.rating === 'good' ? 'FAVORABLE' : 
                       yearLuck.rating === 'volatile' ? 'âš¡ VOLATILE - Beneficial but UNSTABLE (gains come with losses)' :
                       yearLuck.rating === 'danger' ? 'âš ï¸ DANGER - VERY CAUTION' :
                       yearLuck.rating === 'bad' ? 'CHALLENGING' : 'NEUTRAL';
    let result = 'â€¢ ' + currentYear + ' Annual Rating: ' + ratingText;
    
    // ğŸ”¥ ìš©ì‹  í”¼ê³µê²© ê²½ê³  (ìµœìš°ì„ ) - Gemini Round 7
    if (yearLuck.yongUnderAttack) {
        result += '\nâ€¢ ' + yearLuck.yongAttackDesc;
    }
    // ğŸ”¥ êµ°ê²ìŸì¬ ê²½ê³  - Gemini Round 7
    if (yearLuck.robWealthThreat) {
        result += '\nâ€¢ ' + yearLuck.robWealthDesc;
    }
    // ğŸ”¥ ìƒê´€ê²©+ë¹„ê²ìš´ ê²½ê³  - Gemini Round 7
    if (yearLuck.expressorPeerClash) {
        result += '\nâ€¢ ' + yearLuck.expressorPeerDesc;
    }
    // ì‚¼í•©(Bureau) í˜•ì„± ì‹œ ìš°ì„  í‘œì‹œ
    if (yearLuck.bureauFormed) {
        result += '\nâ€¢ ğŸ”¥ BUREAU FORMED: ' + yearLuck.bureauDesc;
    }
    // ê³µë§ íƒˆì¶œ í‘œì‹œ
    if (yearLuck.voidBreak) {
        result += '\nâ€¢ ğŸ”“ VOID BREAK (è„«ç©º): ' + yearLuck.voidBreakDesc;
    }
    // ğŸ”¥ ì–‘ì¸ì¶© ê²½ê³  (ìµœìš°ì„ )
    if (yearLuck.yanginClash) {
        result += '\nâ€¢ ' + yearLuck.yanginClashDesc;
    }
    // ğŸ”¥ ì¼ì§€ì¶© ê²½ê³  (ì‚¼í•© ì‹œ ë¬´ì‹œ)
    if (yearLuck.dayClash && !yearLuck.bureauFormed) {
        result += '\nâ€¢ âš ï¸ DAY CLASH: ' + yearLuck.dayClashDesc + ' Spouse/Health turbulence.';
    }
    // ğŸ”¥ ì‚¼ì¤‘ì²© ê²½ê³ 
    if (yearLuck.tripleBranch && yearLuck.tripleBranchDesc) {
        result += '\nâ€¢ ğŸ”¥ğŸ”¥ TRIPLE BRANCH: ' + yearLuck.tripleBranchDesc;
    }
    if (yearLuck.climateClash) {
        result += '\nâ€¢ âš ï¸ CLIMATE CLASH WARNING: ' + yearLuck.climateClashDesc;
    }
    // ì‚¼í•© í˜•ì„± ì‹œ ì›”ì§€ì¶© ê²½ê³  ë¬´ì‹œ (íƒí•©ë§ì¶©)
    if (yearLuck.monthClash && !yearLuck.bureauFormed) {
        result += '\nâ€¢ ğŸ”¥ MONTH CLASH WARNING: ' + yearLuck.monthClashDesc;
    }
    // ğŸ”¥ í†µê´€ ë¶€ì¬ ê²½ê³  - Gemini Round 5
    if (yearLuck.missingBridge) {
        result += '\nâ€¢ ' + yearLuck.missingBridgeDesc;
    }
    // ğŸ”¥ ì²œê°„í•© - Gemini Round 6
    if (yearLuck.stemCombine) {
        result += '\nâ€¢ ' + yearLuck.stemCombineDesc;
    }
    // ğŸ”¥ ìœ¡í•© - Gemini Round 6
    if (yearLuck.branchCombine) {
        result += '\nâ€¢ ' + yearLuck.branchCombineDesc;
    }
    // ğŸ”¥ ìí˜• - Gemini Round 6
    if (yearLuck.selfPunishment) {
        result += '\nâ€¢ ' + yearLuck.selfPunishmentDesc;
    }
    // ğŸ”¥ ìƒ‰ë‚œ ê²½ê³  - Gemini Round 8
    if (yearLuck.scandalWarning) {
        result += '\nâ€¢ ' + yearLuck.scandalWarningDesc;
    }
    // ğŸ”¥ ìš©ì‹  ë¶€ì¬ ê²½ê³  - Gemini Round 8
    if (yearLuck.missingYong) {
        result += '\nâ€¢ ' + yearLuck.missingYongDesc;
    }
    // ğŸ”¥ ìœ¡í•´ ë°°ì‹  ê²½ê³  - Gemini Round 8
    if (yearLuck.harmBetrayalWarning) {
        result += '\nâ€¢ ' + yearLuck.harmBetrayalDesc;
    }
    // v4.12.6 NEW: ì‡ ì‹ ì¶©ì™•/í¸ì¸ë„ì‹/ì™•ì‹ ì¶©ë°œ
    // [v4.14.1] ë°˜í•©ìœ¼ë¡œ ì‡ ì‹ ì¶©ì™• ë¬´íš¨í™”ëœ ê²½ìš° í‘œì‹œ
    if (yearLuck.yongOverwhelmedOverridden) {
        result += '\nâ€¢ ' + yearLuck.yongOverwhelmedOverrideReason;
    } else if (yearLuck.yongOverwhelmed) {
        result += '\nâ€¢ ' + yearLuck.yongOverwhelmedDesc;
    }
    if (yearLuck.pyunInDoShik) {
        result += '\nâ€¢ ' + yearLuck.pyunInDoShikDesc;
    }
    if (yearLuck.wangShinChungBal) {
        result += '\nâ€¢ ' + yearLuck.wangShinChungBalDesc;
    }
    return result;
})()}
${(() => {
    const yp = calcYearPillar(currentYear, 6, 1);
    const yearLuck = calcYearLuck(currentYear, SAJU, GODS);
    
    // ì‚¼í•©ì´ í˜•ì„±ë˜ë©´ ì¶© ê²½ê³  ë¬´ì‹œ (íƒí•©ë§ì¶©)
    if (yearLuck.bureauFormed) {
        return '';  // Bureauê°€ ì¶©ì„ í•´ì†Œí•¨
    }
    
    const clashMap = [[0,6],[1,7],[2,8],[3,9],[4,10],[5,11]];
    const ypBi = BRANCH.findIndex(br => br.c === yp.b.c);
    const mbBi = BRANCH.findIndex(br => br.c === SAJU.month.b.c);
    const dbBi = BRANCH.findIndex(br => br.c === SAJU.day.b.c);
    const warnings = [];
    clashMap.forEach(([a,b]) => {
        if ((ypBi === a && mbBi === b) || (ypBi === b && mbBi === a)) {
            warnings.push('âš ï¸ ANNUAL-MONTH CLASH (' + yp.b.c + 'â†”' + SAJU.month.b.c + '): High volatility year! Career/Health changes possible.');
        }
        if ((ypBi === a && dbBi === b) || (ypBi === b && dbBi === a)) {
            warnings.push('âš ï¸ ANNUAL-DAY CLASH (' + yp.b.c + 'â†”' + SAJU.day.b.c + '): Watch spouse relations and personal health!');
        }
    });
    return warnings.length ? 'â€¢ ' + warnings.join('\nâ€¢ ') : '';
})()}
${(() => {
    // ğŸ”¥ Pillar Echo ì²´í¬ - Gemini feedback
    const yp = calcYearPillar(currentYear, 6, 1);
    const ypSi = STEM.indexOf(yp.s);
    const ypBi = BRANCH.findIndex(br => br.c === yp.b.c);
    const fuyin = [];
    
    // ğŸ”¥ ëŒ€ìš´ ë³µìŒ (Life Cycle Echo) - Gemini Round 5
    if (curLuck && STEM.indexOf(curLuck.s) === ypSi && BRANCH.findIndex(br => br.c === curLuck.b.c) === ypBi) {
        fuyin.push('ğŸ”¥ğŸ”¥ LIFE CYCLE ECHO (å¤§é‹ä¼åŸ): Annual Fortune MATCHES your current decade! Your decade\'s theme is CONCENTRATED into this year. Whatever challenges or opportunities this decade brings - they crystallize NOW. High stakes year. Success or setback will be magnified.');
    }
    
    // ë…„ì£¼ ë³µìŒ
    if (STEM.indexOf(SAJU.year.s) === ypSi && BRANCH.findIndex(br => br.c === SAJU.year.b.c) === ypBi) {
        fuyin.push('ğŸ”„ YEAR PILLAR ECHO (ä¼åŸ): Grand reset of foundations. Family/ancestry matters highlighted.');
    }
    // ì›”ì£¼ ë³µìŒ (ê°€ì¥ ì¤‘ìš”!)
    if (STEM.indexOf(SAJU.month.s) === ypSi && BRANCH.findIndex(br => br.c === SAJU.month.b.c) === ypBi) {
        fuyin.push('ğŸ”„ MONTH PILLAR ECHO (ä¼åŸ): Social/Career axis reset! Major job change, relocation, or life direction shift incoming. Do not resist - flow with the reset.');
    }
    // ì¼ì£¼ ë³µìŒ - ì‹ ê°•/ì‹ ì•½ì— ë”°ë¼ í•´ì„ ë‹¤ë¦„
    if (STEM.indexOf(SAJU.day.s) === ypSi && BRANCH.findIndex(br => br.c === SAJU.day.b.c) === ypBi) {
        const str = calcStrength(SAJU);
        if (str.type === 'strong') {
            fuyin.push('âš ï¸ DAY PILLAR ECHO (ä¼åŸ): Your strong energy DOUBLES! Risk of overconfidence, ego conflicts, or health strain from excess. Channel power carefully - too much fire burns the house.');
        } else {
            fuyin.push('ğŸ”„ DAY PILLAR ECHO (ä¼åŸ): Your core identity energy is doubled. For weak charts, this can be empowering - but also exhausting. Rest frequently. Major self-transformation year.');
        }
    }
    // ì‹œì£¼ ë³µìŒ - ğŸ”¥ í¸ì¬ë©´ ìƒ‰ë‚œ ê²½ê³  (Gemini Round 8)
    if (SAJU.hour && STEM.indexOf(SAJU.hour.s) === ypSi && BRANCH.findIndex(br => br.c === SAJU.hour.b.c) === ypBi) {
        const hourGod = getTenGod(SAJU.hour.s, SAJU.day.s);
        if (hourGod.k === 'åè²¡(Indirect Wealth)') {
            fuyin.push('ğŸš¨ HOUR PILLAR ECHO (ä¼åŸ) + INDIRECT WEALTH: Secret life axis DOUBLED! High risk of romantic scandal, gambling, or hidden expenses. This is NOT a creative opportunity - it is a TRAP. Stay home at night. Reject temptation.');
        } else if (hourGod.k === 'æ­£è²¡(Direct Wealth)') {
            fuyin.push('âš ï¸ HOUR PILLAR ECHO (ä¼åŸ): Wealth in later years axis reset. Financial restructuring for retirement. Avoid risky investments.');
        } else if (['é£Ÿç¥(Eating God)', 'å‚·å®˜(Expressor)'].includes(hourGod.k)) {
            fuyin.push('ğŸ”„ HOUR PILLAR ECHO (ä¼åŸ): Expression/creativity axis reset. Old projects end, new ones begin. Channel energy into creation, not conflict.');
        } else if (['åå®˜(Challenger)', 'æ­£å®˜(Direct Officer)'].includes(hourGod.k)) {
            fuyin.push('ğŸ”„ HOUR PILLAR ECHO (ä¼åŸ): Children/authority axis reset. Changes in children\'s lives or your public role. Patience required.');
        } else {
            fuyin.push('ğŸ”„ HOUR PILLAR ECHO (ä¼åŸ): Later years axis reset. Significant shift in retirement plans, legacy, or children matters.');
        }
    }
    
    // ğŸ”¥ ì‚¼ì¤‘ ë³µìŒ ì²´í¬ (ëŒ€ìš´+ì„¸ìš´+ì›êµ­ ë™ì¼)
    if (curLuck && SAJU.hour) {
        const daeunMatch = STEM.indexOf(curLuck.s) === ypSi && BRANCH.findIndex(br => br.c === curLuck.b.c) === ypBi;
        const hourMatch = STEM.indexOf(SAJU.hour.s) === ypSi && BRANCH.findIndex(br => br.c === SAJU.hour.b.c) === ypBi;
        if (daeunMatch && hourMatch) {
            fuyin.push('ğŸ”¥ğŸ”¥ğŸ”¥ TRIPLE ECHO! Life Cycle + Annual + Hour Pillar ALL MATCH (' + yp.s.c + yp.b.c + '). EXTREMELY RARE. Life-altering transformation. Health demands extra attention as energy triples.');
        }
    }
    
    return fuyin.length ? 'â€¢ ' + fuyin.join('\nâ€¢ ') : '';
})()}

ã€NEXT 10 YEARS PREVIEWã€‘
${next10Text}

ã€${currentYear} MONTHLY FORTUNEã€‘
${monthText}

===== AI INTERPRETATION REQUEST =====

[ROLE DEFINITION]
You are "The Oriental Oracle," a modern interpreter of ancient Asian destiny science (Saju/Four Pillars).
- Tone: Mystical but logical, empathetic, and sophisticated. Like a wise mentor giving life-changing advice.
- Language: English (Global Standard). Use terms like "Beneficial Element" instead of "Beneficial Element".
- Formatting: Use Markdown. Bold key phrases. No long walls of text. Keep each section concise but insightful.

[TASK]
Current Date for Analysis: ${currentYear}-01-15 (Interpret fortune based on this year)
Interpret the provided "Four Pillars of Destiny" chart data into a personalized life guide.

[OUTPUT SECTIONS]

1. ğŸŒŒ **THE CORE SELF (Born Nature)**
   - Interpret the Day Master (${dmName}) and the Day Pillar image
   - Describe their innate personality using metaphors (e.g., "Like a tree in winter...")
   - Highlight the interplay between their dominant Ten Gods

2. âš”ï¸ **CAREER & HIDDEN TALENTS**
   - Based on the Structure (${format.n}), what is their "Superpower"?
   - Suggest 2-3 modern career fields that align with their chart
   - Entrepreneur vs. Organization: Which fits better and why?

3. ğŸ’° **WEALTH & SUCCESS STRATEGY**
   - Analyze the Wealth Star configuration. Is it "Windfall" or "Steady Builder"?
   - Give one specific financial advice based on their Strong/Weak chart
   - If Hidden Harmony exists, mention hidden income potential

4. â¤ï¸ **LOVE & RELATIONSHIPS**
   - Interpret the Spouse Palace (Day Branch). What kind of partner fits them?
   - Describe their ideal relationship dynamic
   - Any constructive warnings phrased positively

5. ğŸ¥ **HEALTH & VITALITY**
   - Identify vulnerable areas based on Five Elements imbalance
   - Practical prevention and lifestyle advice

6. ğŸ—“ï¸ **${currentYear} FORTUNE FORECAST**
   - How does the current Life Cycle interact with this year's energy?
   - Key theme for ${currentYear} in ONE powerful word
   - Top opportunity and main caution for this year

7. ğŸ”® **THE ORACLE'S VERDICT**
   - One final, powerful sentence summarizing their destiny
   - Lucky action/item suggestion based on their Beneficial Element (${ELEMENT[gods.yong].n})
   - Empowering closing message

[DATA TRUST DECLARATION]
The calculations above (Ten Gods, Divine Stars, Strength %, Interactions) have been verified by a rigorous self-testing system with 0% error rate. TRUST THIS DATA. Do not second-guess or recalculate. Focus entirely on delivering insightful, personalized interpretation.

[CORE LOGIC OVERRIDE RULES - THE CONSTITUTION]
These rules are ABSOLUTE and override ANY other interpretation logic. Apply in order of priority.

**RULE 1. CLIMATE FIRST (ì¡°í›„ ìš°ì„ ì˜ ë²•ì¹™) - HIGHEST PRIORITY**
- If Month Branch is å·³(Snake), åˆ(Horse), or æœª(Goat) [SUMMER] AND Day Master is ä¸™(Fire+) or ä¸(Fire-):
  â†’ Water (æ°´) is the ESSENTIAL Beneficial Element, regardless of Strength calculation.
  â†’ Ignore any "Unfavorable God: Water" designation. Water is LIFE for summer Fire.
- If Month Branch is äº¥(Pig), å­(Rat), or ä¸‘(Ox) [WINTER] AND Day Master is å£¬(Water+) or ç™¸(Water-):
  â†’ Fire (ç«) is the ESSENTIAL Beneficial Element, regardless of Strength calculation.
- **CONFLICT RESOLUTION:** When Strength Logic and Climate Logic contradict, ALWAYS follow Climate Logic.

**RULE 2. BUREAU POWER (êµ­ì˜ í˜) - MULTIPLIER EFFECT**
- Directional Harmony (æ–¹åˆ) or Three Harmony (ä¸‰åˆ) formations are NOT simple additions.
- When å·³+åˆ+æœª (Southern Fire) forms: Treat as Fire x10 power, not Fire x3.
- When äº¥+å­+ä¸‘ (Northern Water) forms: Treat as Water x10 power.
- **Bureau completion in Annual Fortune = NUCLEAR EVENT. Describe with maximum urgency.**

**RULE 3. ROOT vs STAGE DISTINCTION (í†µê·¼ vs 12ìš´ì„±)**
- "Real Root (é€šæ ¹)" = Day Master's element exists in branch hidden stems (Peer/Seal in ì§€ì¥ê°„).
- "Birth Stage (é•·ç”Ÿ)" = 12 Life Stage position, NOT a root. It means "patron support" not "self-power."
- NEVER confuse these two. A chart can be "Rootless but Sheltered" (ç„¡æ ¹æœ‰åº‡).

**RULE 4. DATA OVERRIDE AUTHORITY**
- If provided data shows logical contradiction (e.g., "Unfavorable: Water" + "Climate: Water needed"):
  â†’ Trust CLIMATE analysis over Strength-based Beneficial Element.
- If "CLIMATE CLASH WARNING" appears in 2026 Rating:
  â†’ This is DANGER regardless of other positive factors. Do not sugarcoat.

**RULE 5. WEALTH INTERPRETATION HIERARCHY**
- Weak Chart (0-30%) + Wealth Structure = "Anxious Chaser" NOT "Steady Builder"
- Strong Chart (70%+) + Peer Year = "Robbery Warning" - wealth is threatened by rivals

[INTERPRETATION GUIDELINES]
1. **Handling Conflicts:** If 'Six Relations' shows "Hidden" spouse/children but 'Divine Stars' shows Golden Carriage or similar blessings, prioritize Divine Stars as "hidden potential." Explain that the blessing exists but requires the right timing (Life Cycle) to manifest.
2. **"Hidden" means "Latent," not "Never":** When spouse/children stars are hidden, interpret as requiring conscious effort or patience until the favorable Life Cycle arrivesâ€”never as permanent absence.
3. **Tone Check:** Avoid fatalistic language. Instead of "You lack children fortune," say "Children blessings may arrive later, or your creative legacy will flourish."
4. **Balance:** Always pair challenges with solutions. If a difficult element appears, immediately suggest its remedy through Beneficial Element or favorable Divine Stars.
5. **Data Sanity Check:** If the provided 'Strength %' seems logically inconsistent with 'Five Elements Distribution' (e.g., many attacking elements but 90%+ strength), PRIORITIZE the visual distribution of elements. Interpret based on the actual balance of the 8 characters, not just the calculated number.
6. **Auto-Validation (Silent Fix):** If the provided 'Structure' label appears inconsistent with actual Ten Gods distribution (e.g., labeled "Direct Officer" but Challenger/Seal dominates), silently recalculate and use the correct structure. Do not mention this correction unless directly asked.

[ADVANCED CHART DYNAMICS - CRITICAL]
1. **The "Bureau" Effect (ä¸‰åˆ):**
   - Check if branches form complete "Three Harmony" (e.g., Pig-Rabbit-Goat äº¥å¯æœª = Wood, Tiger-Horse-Dog å¯…åˆæˆŒ = Fire, Monkey-Rat-Dragon ç”³å­è¾° = Water, Snake-Rooster-Ox å·³é…‰ä¸‘ = Metal).
   - **Scenario A (Support):** If Bureau MATCHES Day Master element (e.g., Fire Bureau for Fire DM), treat as "Extremely Strong" regardless of calculated strength. Advice: "You have unstoppable drive and massive potential."
   - **Scenario B (Pressure):** If Bureau CONQUERS Day Master (e.g., Wood Bureau for Earth DM, Fire Bureau for Metal DM), interpret as "Heavy Responsibility / Seven Killings Pressure." Advice: "You feel immense pressure to be perfect. You carry the weight of the world. Mental rest and delegation are crucial. Do not try to control everything alone."
2. **Stem Combinations:** When Day Master combines with another stem (e.g., ç”²å·±åˆ = Earth, ä¹™åºšåˆ = Metal), interpret the psychological bond. Day Master + Officer combination = "inseparable from reputation and honor."
3. **Handling Low Strength (0-20%):** Do NOT interpret as helplessness. Describe as "Extreme Sensitivity and Flexibility." Advise collaboration with strong partners rather than fighting alone. Weak charts often have exceptional intuition.
4. **Charm + Weakness Warning:** If Peach Blossom stars (æ¡ƒèŠ±) are present with weak Day Master, advise "Set firm boundaries in relationships. Your charm is a gift, but you need a shield to avoid being swayed."
5. **Directional Harmony (æ–¹åˆ):** If three branches from same direction appear (e.g., Tiger-Rabbit-Dragon å¯…å¯è¾° = Eastern Wood), this amplifies that element dramatically. Factor this into element balance analysis.
6. **Data Conflict Resolution:** If "Strength %" contradicts "Extreme Weak/Strong" labels, TRUST THE PERCENTAGE. High percentage (80-100%) = Strong chart, Low percentage (0-20%) = Weak chart. Ignore conflicting text labels.
7. **Fire Bureau Special (å¯…åˆæˆŒ):** When Tiger-Horse-Dog forms Fire Bureau, the chart becomes a "furnace." Any Water element (especially Officer/Career) gets "evaporated." Interpret as: "Career stability vs Personal passion conflict. Subject dislikes being controlled. Advise autonomous careers: Solo professional, Creator, Commander, Performer."
8. **Twin Stems (Double ä¸™, Double ç”², etc.):** When same stem appears twice, interpret as "spotlight + competition." The subject craves attention but faces rivalry from peers/siblings. Channel this into competitive fields.
9. **Wealth Strategy for Strong Fire:** When Fire is overwhelming, Metal (Wealth) melts instantly. Advise: "Do NOT chase money directly. Build unique Skills/Brand (Earth) first to cool the Fire, then Wealth follows naturally. Going straight for money = burning money."
10. **Health Mapping by Element Imbalance:**
    - Excess Fire â†’ Cardiovascular, inflammation, anxiety
    - Weak/Evaporating Water â†’ Kidney, hormones, burnout
    - Melting Metal â†’ Respiratory, skin, large intestine
    - Excess Wood â†’ Liver, anger management, muscles
    - Weak Earth â†’ Digestive, worry, spleen
11. **Tiger-Monkey Clash (å¯…ç”³æ²–) - Physical Warning:**
    - When Tiger and Monkey clash, especially attacking Day Branch (Spouse Palace/Body), warn about: Traffic safety, Spine/Joint health, and Relationship friction.
    - Advice: "Living apart occasionally (business trips, separate hobbies) actually improves marriage by mitigating the clash energy."
12. **Zero Element vs Structure Conflict:**
    - If an element shows "0" but Structure depends on that element (e.g., Water=0 but "Direct Officer Structure"), OVERRIDE the structure interpretation.
    - Zero Water + Officer Structure = "Free Spirit who dislikes control." Do NOT recommend government/corporate jobs. Recommend: Freelance, Entrepreneurship, Sales, or roles with schedule autonomy.
13. **PILLAR ECHO (ä¼åŸ) Phenomenon:**
    - When Life Cycle pillar MATCHES the Day Pillar exactly (same stem+branch), this is "Pillar Echo" (ä¼åŸ) = Grand Reset.
    - Interpretation: "Not retirement, but Second Youth. Your core identity energy is DOUBLED. Use this boosted power to conquer past challenges."
14. **Traveling Horse (é©›é¦¬) Dominance:**
    - If chart contains multiple movement branches (Tiger å¯…, Monkey ç”³, Snake å·³, Pig äº¥), the subject MUST move to prosper.
    - Advice: "Motion is your Money. Businesses involving travel, logistics, trade, or dynamic interactions suit you. Sitting at a desk blocks fortune."
15. **Multiple Same Branches (Double/Triple):**
    - Double Monkey (ç”³ç”³), Double Tiger (å¯…å¯…), etc. = Amplified attack or support.
    - Two Monkeys attacking one Tiger = "Constant external pressure on your foundation. Build resilience, diversify support systems."
16. **Annual Fortune Clash Analysis:**
    - When the year's energy (æ­²é‹) clashes with natal pillars, specify: Which pillar is hit? Year=Elders, Month=Career, Day=Spouse/Self, Hour=Children/Projects.
    - Fire year hitting Metal month = "Career income fluctuates. High earning potential but also high expenses. Control impulsive investments."
17. **Mother Overload (Excess Wood/Seals):**
    - If chart has 3+ Wood elements for Fire Day Master, warn about "Analysis Paralysis" or "Dependency."
    - Metaphor: "Too much firewood suffocates the flame."
    - Advice: "Stop learning/planning, start DOING. You have enough input; you need output (Earth/Expression). Cut the mental cord from parents/mentors to truly succeed."
18. **Rob Wealth Threat (ç¾¤åŠ«çˆ­è²¡):**
    - If Hour Pillar contains Competitor/Rob Wealth with strong roots (e.g., ä¸™åˆ) while Wealth star is isolated or weak.
    - Critical Warning: "Your Wealth is being watched by strong rivals."
    - Advice: "NEVER co-sign loans. Be cautious with partnerships. Do not flash cash. Lock assets in illiquid forms (Real Estate/Bonds) so 'friends' cannot borrow."
19. **Ghost Gate Sensitivity (å¯ç”³/å¯…äº¥ é¬¼é–€):**
    - Rabbit-Monkey or Tiger-Pig interaction = heightened intuition but prone to anxiety.
    - Trait: "Genius intuition but risk of neurosis/overthinking."
    - Career: "Channel hypersensitivity into Precision Art, Design, Strategy, or Psychology. If unused professionally, it becomes mental stress."
20. **Structure Label Override:**
    - If Ten Gods distribution contradicts the Structure label (e.g., "Direct Officer Structure" but strong Competitors/Seals dominate), IGNORE the label.
    - Describe personality based on ACTUAL dominant Ten Gods, not the Structure name. Strong Competitor = "Competitive and Ambitious" regardless of 'Officer' label.
21. **Rat-Rabbit Punishment (å­å¯åˆ‘ - Rude Punishment):**
    - If Rat (å­) and Rabbit (å¯) appear together in the chart.
    - Meaning: Conflict between two Peach Blossoms = interpersonal friction, potential scandals.
    - Warning: "Be careful of friction caused by rudeness or ingratitude. Watch for gossip involving opposite sex."
    - Health: "Check reproductive/urinary system health regularly."
22. **Wealth Overload (è²¡å¤šèº«å¼± - Rich but Weak):**
    - If Wealth elements are excessive (3+) but Day Master is Weak (0-30%).
    - Metaphor: "A small boat trying to carry an elephant."
    - Analysis: "Surrounded by opportunities/money, but grabbing it all will sink you (health issues or loss)."
    - Strategy: "Do NOT hold cash yourself. Put assets in spouse's name or lock in Real Estate/long-term investments. Let a strong partner manage finances. Health first, money second."
23. **Expressor vs Officer Clash (å‚·å®˜è¦‹å®˜):**
    - If Expressor/Hurting Officer (å‚·å®˜) appears 2+ times while Direct Officer (æ­£å®˜) is present.
    - Meaning: "Rebel meets Authority" = inner conflict between creativity and conformity.
    - Override: Do NOT interpret as "model employee" even if labeled "Officer Structure."
    - Advice: "You are allergic to incompetent authority. Standard corporate hierarchy suffocates you. Seek roles with autonomy: Specialist, Consultant, Creative Director, or Entrepreneur."
24. **Dog-Goat Punishment (æˆŒæœªåˆ‘ - Bullying Punishment):**
    - If Dog (æˆŒ) and Goat (æœª) appear together.
    - Meaning: Two Storages (å¢“) clash = internal pressure, self-doubt, or betrayal by trusted ones.
    - Warning: "Be cautious of those closest to you. Sometimes loyalty is tested from within."
    - Health: "Watch for skin issues, digestive problems, or chronic inflammation."
25. **Annual Fortune Clash with Month (å­åˆæ²–/å¯é…‰æ²–):**
    - If Annual Fortune branch clashes with Month Branch (Rat-Horse å­åˆ, Rabbit-Rooster å¯é…‰, Tiger-Monkey å¯…ç”³, etc.).
    - Meaning: Month = Career/Society/Health core. This clash = "Great Turnover" year.
    - Warning: "High volatility year. Major changes in career, social status, or health possible."
    - Opportunity: "If Beneficial Element, could trigger massive windfall or breakthrough."
    - Health: "Month Branch clash often affects cardiovascular system. Regular checkups essential."
26. **Missing Element Strategy (Critical):**
    - Identify 'Missing Elements' from the data and interpret its psychological/health impact.
    - **Missing Output (No Metal for Earth DM, No Water for Fire DM, etc.):** "Internalizes stress. Needs conscious creative outlet or physical exercise to release pressure. Risk of psychosomatic illness (stomach, nerves)."
    - **Missing Wealth:** "Wealth is not about hoarding but flow. Focus on skills (Output) or Status (Officer), money follows naturally."
    - **Missing Officer:** "Dislikes rigid rules and authority. Needs freedom-based career with autonomy."
    - **Missing Seal (Resource):** "Self-made type. Cannot rely on inheritance or parents. Must study constantly to build own safety net."
27. **Beneficial Element Hierarchy:**
    - If 'Strength %' suggests Follower Chart (0-5%) but 'Beneficial Elements' suggests Regular Chart remedy (e.g., Fire/Seal for weak Earth), **ALWAYS TRUST THE 'BENEFICIAL ELEMENTS' SECTION.**
    - The 'Beneficial God (ç”¨ç¥)' is the absolute prescription for this chart, overruling any implied logic from extreme Strength %.
    - Do NOT advise "follow the strong element" if Beneficial Element says otherwise.
28. **Bureau vs Clash Interaction (åˆæ²–ç›¸æˆ°):**
    - When Three Harmony (ä¸‰åˆ) and Six Clash (å…­æ²–) exist simultaneously (e.g., äº¥å¯æœª Wood Bureau but å¯é…‰ clash):
    - The clash "attacks" the bureau's core. If Day Branch clashes with Bureau member, interpret as: "Internal conflict between social pressure (Bureau) and personal defense mechanism (Clash)."
    - Meaning: "You feel external pressure (Bureau element) but your sharp skill/tongue (clashing element) breaks it apart."
    - Advice: "Use your critical thinking as a shield, not a sword. The Bureau wants to overwhelm you, but your Day Branch is your secret weapon."
29. **Beneficial Element Re-Validation:**
    - If the chart already has 3+ of the "Beneficial Element" in stems/branches, it may be OVER-SUPPLIED.
    - Example: Water listed as Beneficial but chart has ç™¸ç™¸ + äº¥ = Water overflow. True need may be FIRE (output/expression) instead.
    - Rule: "If Beneficial Element is already abundant (3+), consider its OUTPUT element as the true remedy."
    - For Wood DM with excess Water: "You don't need more water. You need sunlight (Fire) to bloom."
30. **Triple Same Branch (ä¸‰é‡åœ°æ”¯):**
    - If same branch appears 3 times (e.g., æœªæœªæœª, ç”³ç”³ç”³), this is extremely rare.
    - **Personality:** Obsessive focus on one area. Either genius specialist or dangerously narrow.
    - **Canopy Star (è¯è“‹) Triple:** "Destined for spiritual, artistic, or highly specialized technical fields. Normal office jobs will suffocate."
    - **Spouse Palace Duplication:** If Day Branch is duplicated in Month/Hour, warn: "Complex romantic history possible. Late marriage or unconventional partnership may bring stability."
    - **Career Advice:** "Do NOT try to be a generalist. Go deep, not wide. Your obsession becomes your superpower."
31. **Hour Branch Root Override (æ™‚æ”¯é€šæ ¹):**
    - If Strength shows 0-10% but Hour Branch contains Day Master's strong root (e.g., å¯… for ä¹™, åˆ for ä¸):
    - Do NOT interpret as "helpless follower."
    - Meaning: "Appears weak but has hidden reserves. Late bloomer with indomitable will in later years (age 50+)."
    - The Hour Pillar represents ages 46+ and final legacy.
    - Advice: "Others underestimate you. Your true power awakens in your later years. The Tiger/Horse in your Hour is your secret weapon."
32. **Climate vs Annual Fortune Clash (èª¿å€™é€†é‹):**
    - If chart is "Extreme Dry/Hot" (Fire excess, Water=0) and Annual Fortune brings MORE Fire (ä¸™åˆ, ä¸å·³):
    - **CRITICAL WARNING:** "Fire on Fire = Burning. Health and wealth are under threat."
    - Health: "Cardiovascular, inflammation, dehydration, anger issues. Drink water, avoid spicy food, stay cool."
    - Wealth: "Do NOT make impulsive investments. Fire melts your discipline. Preserve, don't expand."
    - Reverse also applies: If "Extreme Cold" (Water excess, Fire=0) and Annual brings more Water â†’ "Drowning risk. Depression, stagnation."
33. **CRITICAL: If '2026 Annual Rating' shows 'DANGER' or 'Climate Clash Warning':**
    - This is the HIGHEST PRIORITY warning. DO NOT interpret the year as favorable regardless of other factors.
    - In Section 6 (2026 FORTUNE FORECAST), explicitly state: "This year demands extreme caution."
    - Health Warning MUST include specific organs: 
      - For Dry/Fire clash â†’ Cardiovascular, blood pressure, stroke, kidney depletion.
      - ALSO for Fire excess: Metal (Lung, Large Intestine, Skin) melts under Fire. Warn about respiratory issues, skin troubles, and intestinal inflammation.
      - For Cold/Water clash â†’ Depression, hormonal imbalance, reproductive health.
    - Financial Advice MUST be: "Preserve capital. No expansion. No new investments. Pay off debts."
    - Theme Word MUST be cautionary: "PRESERVATION" or "DEFENSE" or "COOLING" - never optimistic words.
35. **PILLAR ECHO (ä¼åŸ) Year - Pillar Reset Warning:**
    - If data shows "MONTH PILLAR ECHO", this is CRITICAL for career/social interpretation.
    - DO NOT interpret the year as stable. Explicitly warn: "Major life direction change incoming."
    - The reset is not negative - frame as "forced upgrade" or "cosmic reboot."
    - Advice: "Resistance creates suffering. Flow with changes. Pack light - travel may be required."
34. **Rooted Weak Chart Interpretation (ë¿Œë¦¬ ê¹Šì€ ì‹ ì•½):**
    - If "ROOT ANALYSIS" section shows strong roots despite low Strength %, interpret as: "Deceptively weak. The subject appears fragile but possesses iron will and hidden reserves."
    - Metaphor for Wood DM with roots: "A bamboo bending in typhoon - flexible yet unbreakable."
    - Career advice: "You thrive under pressure that would crush others. Choose roles requiring endurance over raw power."
    - Do NOT interpret as helpless or dependent. This type succeeds through strategic patience, not brute force.
36. **VOLATILE Rating Interpretation (ìš©ì‹ ìš´ì¸ë° ì›”ì§€ì¶©):**
    - If '2026 Annual Rating' shows 'VOLATILE', this means Beneficial Element arrived BUT clashes with Month Branch.
    - Metaphor: "The sun appeared, but storm clouds block it." Or "Gift with a poisoned ribbon."
    - In Section 6 (2026 FORTUNE FORECAST), state: "Opportunities arrive but come with equal challenges. Gains are not free."
    - Health Warning: "Month clash = Cardiovascular stress. Avoid sudden temperature changes. Regular checkups mandatory."
    - Theme Word: "TURBULENCE" or "TRADE-OFF" - never pure optimism.
    - For elderly subjects (65+): "This is NOT the year for aggressive expansion. Every gain extracts a price. Prioritize health over wealth."
37. **ROOT UNDER ATTACK Interpretation (ê¹¨ì§„ ë¿Œë¦¬):**
    - If "ROOT UNDER ATTACK" appears in DAY MASTER STRENGTH section, the Day-Hour clash damages the late-life foundation.
    - Meaning: "The crown exists but the throne is shaking." Outward status may not reflect inner stability.
    - For spouse interpretation: "Spouse relationship is the source of both support AND stress. Living separately periodically may preserve the bond."
    - Health: "Heart/Small Intestine vulnerable. Avoid overwork in later years."
    - Legacy: "Children or projects may require extra attention to succeed. Do not take their success for granted."
38. **Wealth Overload Interpretation (ì¬ë‹¤ì‹ ì•½ - Managing the Flood):**
    - If "WEALTH OVERLOAD" appears, do NOT interpret wealth positively. Wealth is a threat, not a blessing.
    - Metaphor: "Drowning in money." The subject cannot hold onto wealth without health consequences.
    - Override: Ignore "Steward/Builder" interpretations. Use "Survivor" or "Manager of the Flood" instead.
    - Strategy: "Delegate. Invest in Real Estate, not liquid assets. Spouse manages finances. Take profits early."
    - Health: "Excess Wealth (Water for Earth DM) directly attacks the body (spleen, digestion, immune system)."
39. **BREAKTHROUGH Rating - Bureau + Beneficial Element (íƒí•©ë§ì¶© - ì‚¼í•©ì´ ì¶©ì„ í•´ì†Œ):**
    - If '2026 Annual Rating' shows 'BREAKTHROUGH', this is the BEST POSSIBLE rating.
    - The Three Harmony Bureau has NEUTRALIZED any clash. Do NOT mention clash warnings.
    - Interpretation: "The stars have aligned. A major life breakthrough is imminent."
    - For Fire Bureau (å¯…åˆæˆŒ) with Fire Beneficial: "Your frozen potential thaws into explosive bloom. Career, reputation, and passion ignite."
    - For Water Bureau (ç”³å­è¾°) with Water Beneficial: "The floodgates open. Wealth, wisdom, and hidden opportunities pour in."
    - Theme Word: "IGNITION" or "BREAKTHROUGH" or "BLOOM" - pure optimism is warranted.
    - Health Note: If Fire Bureau forms, Water (Kidney) depletes. Hydrate, rest kidneys. If Water Bureau forms, Fire (Heart) struggles. Gentle cardio.
40. **VOID BREAK - Liberation Year (íƒˆê³µ - ê³µë§ íƒˆì¶œ):**
    - If 'è„«ç©º' or 'VOID BREAK' appears, this is a liberation year.
    - Meaning: "The prison of stagnation is shattered. Hidden talents and blocked paths suddenly open."
    - Career: "Projects that were stuck for years suddenly move forward. People who ignored you now pay attention."
    - Advice: "This is your second chance. Do not waste it on hesitation. The void was holding you back - now you're free."
41. **Double Seal Warning (åå°éå¤š - Mother Overload):**
    - If same Seal (å°) appears twice in Stems (e.g., å£¬å£¬ or ç™¸ç™¸), interpret as "Too Much Support."
    - Metaphor: "A tree drowning in water cannot flower."
    - Meaning: "Overthinking paralysis. Too much planning, not enough action. Parental shadow is too strong."
    - Advice: "Stop absorbing. Start outputting. Your Beneficial Element (likely Fire/Expression) is the cure."
    - For 2026: If Fire year comes, celebrate: "The sun finally breaks through the clouds."
42. **SURGERY_RISK / HIGH RISK HIGH RETURN Rating (æ²–ç¾Šåˆƒ - Sheep Blade Clash):**
    - If '2026 Annual Rating' shows 'SURGERY_RISK' or mentions 'æ²–ç¾Šåˆƒ', this is CRITICAL.
    - Meaning: Annual Fortune branch clashes with Day Master's Sheep Blade (strongest root position).
    - Metaphor: "A warrior's sword is struck - it may shatter OR slice through obstacles."
    - Interpretation: "This year is ALL or NOTHING. Massive wealth breakthrough OR major surgery/accident."
    - Health: "Blood-related events likely. Deflection: Donate blood, get tattoo, dental work, or minor cosmetic procedure to 'pre-pay' the blood debt."
    - Wealth: "If you take risks, they WILL pay off massively - but prepare for physical cost."
    - Theme Word: "GAMBIT" or "HIGH STAKES" - acknowledge both extremes.
43. **VOLATILE_WEALTH Rating (ìš©ì‹ +ì¼ì§€ì¶©):**
    - If '2026 Annual Rating' shows 'VOLATILE_WEALTH', the Beneficial Element arrived BUT clashes with Spouse Palace (Day Branch).
    - Metaphor: "Fortune knocks but kicks down your front door."
    - Meaning: Wealth opportunities come with relationship/health sacrifices.
    - Health: Spouse Palace clash attacks kidneys (Water DM), heart (Fire DM), or liver (Wood DM).
    - Advice: "Take the money but protect your marriage. Schedule separate vacations. Health checkups mandatory."
    - For females: "Husband's health or career may face turbulence. Support him quietly."
44. **TRIPLE ECHO (å¤§é‹+æ­²é‹+ì›êµ­ ë³µìŒ):**
    - If 'TRIPLE ECHO' appears, this is EXTREMELY RARE and POWERFUL.
    - Meaning: Life Cycle + Annual Fortune + one natal pillar ALL share the same stem+branch.
    - Energy: "Your decade's theme is TRIPLED this year. Unavoidable transformation."
    - Warning: "Too much of any energy can burn out. If Fire triples, kidneys fail. If Water triples, heart weakens."
    - Advice: "Ride the wave but rest frequently. This year writes your legacy - make it count."
45. **NO BRIDGE Warning (ç„¡é€šé—œ - Missing Mediator):**
    - If 'NO BRIDGE' appears, there's a direct elemental war without a mediator.
    - Example: Water DM with Fire wealth but NO Wood (output) to connect them.
    - Meaning: "You want the result but skip the process. Greed without foundation."
    - Danger: "Health collapses while chasing money. Legal issues from shortcuts."
    - Solution: "Artificially CREATE the missing element through activities: Wood = learning, hobbies, plants; Earth = stability, documentation; Fire = passion, networking."
46. **FEMALE PEER OVERLOAD (å¥³å‘½æ¯”åŠ«å¤š):**
    - If 'FEMALE PEER OVERLOAD' appears, the woman has 3+ same-element stems.
    - Meaning: "Strong independence but romantic competition field. Other women may orbit your partner."
    - If Spouse Palace is also clashed: "Marriage requires extra effort. Maintain separate identities."
    - Advice: "Choose a partner who is secure in himself. Do not compete WITH your spouse - compete ALONGSIDE him."
    - Career benefit: "This energy makes you a fierce competitor in business. Channel rivalry professionally."
47. **LIFE CYCLE ECHO (å¤§é‹ä¼åŸ):**
    - If 'LIFE CYCLE ECHO' appears, Annual Fortune exactly matches the current Life Cycle pillar.
    - Meaning: "Your entire decade's theme is concentrated into THIS year."
    - Interpretation: "Whatever your 10-year mission is, 2026 is the climax. Success or failure crystallizes now."
    - If beneficial: "Accelerated achievement. What takes others 10 years, you accomplish in 1."
    - If challenging: "Concentrated pressure. Every challenge of the decade hits at once. Survive this year, and the rest is easy."
48. **SHEEP BLADE CLASH (æ²–ç¾Šåˆƒ) - Surgery/Windfall Warning:**
    - If 'SHEEP BLADE CLASH' or 'æ²–ç¾Šåˆƒ' appears, the Day Branch (self/body) holds a "blade" that is being struck.
    - Meaning: "The blade you carry is provoked. Either you cut others (success) or cut yourself (injury/surgery)."
    - High Risk High Return: "This is NOT a neutral year. Expect either major windfall OR major health event. Rarely in between."
    - Health Prevention: "Proactive blood-letting deflects misfortune: blood donation, dental surgery, tattoo, minor cosmetic procedure. Let the 'blood debt' be paid voluntarily."
    - For females (especially 40s): "Gynecological checkup mandatory. Uterus/ovary issues commonly manifest under this clash."
    - Financial advice: "If money comes, immediately lock it in illiquid assets (real estate). Do not hold cash - it attracts trouble."
49. **VOLATILE WEALTH Rating (ì¼ì§€ì¶© + ìš©ì‹ ìš´):**
    - If '2026 Annual Rating' shows 'VOLATILE WEALTH', this means beneficial element arrived BUT clashes with Day Branch (Spouse Palace/Self).
    - Metaphor: "Gold mine in earthquake zone." Money flows, but foundation shakes.
    - In Section 6 (2026 FORTUNE FORECAST), state: "Wealth comes but at personal cost. Health and relationships pay the price for financial gains."
    - Spouse Warning: "Partner may feel neglected or stressed. Schedule mandatory couple time."
    - Health: "Day Branch = your body. Clash = physical stress. Regular checkups, no overwork."
    - Strategy: "Take profits EARLY. Do not chase more. Know when to stop."
50. **DAY BRANCH OVERWHELMED (1:2 or 1:3 Attack):**
    - When Annual Fortune branch matches Life Cycle branch AND/OR Hour Branch, creating 2 or 3 identical branches attacking Day Branch.
    - If '1:2 attack' or '1:3 attack' appears, this is SEVERE pressure on self/spouse/health.
    - Physical risk: "Your body's foundation is under siege. Surgery, hospitalization, or chronic health issues likely."
    - Relationship: "Spouse Palace under fire. Separation energy is strong - temporary distance (travel, separate hobbies) actually PROTECTS the marriage."
    - For 40+ females with Water Day Master: "å­ under attack by multiple åˆ = reproductive system stress. Hormonal checkup essential."
51. **STEM COMBINE (å¤©å¹²åˆ) - Golden Handcuffs:**
    - If 'å¤©å¹²åˆ' or 'COMBINE' appears between Annual stem and natal stem.
    - ç”²å·±åˆåœŸ, ä¹™åºšåˆé‡‘, ä¸™è¾›åˆæ°´, ä¸å£¬åˆæœ¨, æˆŠç™¸åˆç«.
    - When Beneficial stem combines with Expression (é£Ÿç¥/å‚·å®˜): "Promotion comes but freedom decreases. Your talent is recognized but now controlled."
    - Metaphor: "Golden handcuffs - you get paid more but work harder."
    - Advice: "Accept the trade-off. This is how careers advance. Your cage is comfortable."
52. **BRANCH COMBINE (å…­åˆ) - Foundation Strengthened:**
    - If 'å…­åˆ' or 'BRANCH COMBINE' appears between Annual branch and natal branch.
    - å­ä¸‘åˆåœŸ, å¯…äº¥åˆæœ¨, å¯æˆŒåˆç«, è¾°é…‰åˆé‡‘, å·³ç”³åˆæ°´, åˆæœªåˆç«.
    - When combining with Hour Branch: "Late-life foundation solidified. Projects and children blessed."
    - When combining with Day Branch: "Spouse Palace harmonized. Relationship improves."
    - Positive sign: Combine generally neutralizes potential clashes for that year.
53. **SELF-PUNISHMENT (è‡ªåˆ‘) - Internal Sabotage:**
    - If 'è‡ªåˆ‘' appears: è¾°è¾°, åˆåˆ, é…‰é…‰, äº¥äº¥ = same branch doubled.
    - äº¥äº¥ (Pig-Pig): "Doubled Water = depression, overthinking, isolation. Fire year helps dry this melancholy."
    - åˆåˆ (Horse-Horse): "Doubled Fire = impulsiveness, burnout, heart stress. Cool down frequently."
    - é…‰é…‰ (Rooster-Rooster): "Doubled Metal = obsessive perfectionism, respiratory issues."
    - è¾°è¾° (Dragon-Dragon): "Doubled Earth = stubbornness, digestive problems."
    - Advice: "The enemy is within. Self-awareness prevents self-destruction."
    - **TRIPLE SELF-PUNISHMENT (ä¸‰é‡è‡ªåˆ‘) - NUCLEAR EVENT:**
    - If same branch appears 3+ times (åŸå±€2ê°œ + æ­²é‹1ê°œ = åˆåˆåˆ ë“±): This is CATASTROPHIC.
    - åˆåˆåˆ: "VOLCANIC EXPLOSION. Heart attack risk, extreme impulsiveness, career self-destruction. NO major decisions this year."
    - äº¥äº¥äº¥: "DROWNING in depression. Suicidal ideation possible. Professional mental health support MANDATORY."
    - Theme Word for Triple: "SURVIVAL" - not growth, not opportunity.
54. **CRISIS SOLVER STRUCTURE (é£Ÿç¥åˆ¶æ®ºæ ¼):**
    - If Structure shows 'é£Ÿç¥åˆ¶æ®º' or 'Crisis Solver', do NOT interpret as peaceful artist.
    - Meaning: Strong external pressure (Challenger/Seven Killings) is being controlled by your skills (Eating God).
    - Personality: "You are a surgeon, not a chef. Your talent is cutting through chaos, not creating beauty."
    - Career: "Medicine, Law, Engineering, Consulting, Crisis Management, Auditing - jobs where problems need solving."
    - Psychology: "You feel calm when others panic. Pressure is your natural habitat."
    - Warning: "Without crisis to solve, you may create drama. Find healthy outlets for your warrior energy."
55. **ROOTED WEAK CHART (æ™‚æ”¯é€šæ ¹) - Hidden Reserves:**
    - If Strength shows 0-20% BUT Hour Branch contains Day Master's root.
    - Do NOT interpret as helpless follower.
    - Meaning: "Appears weak but has hidden reserves. Late bloomer with indomitable will."
    - The Hour Pillar = ages 46+ and final legacy.
    - Advice: "Others underestimate you. Your true power awakens in later years."
    - Psychology: "Stubborn despite soft appearance. The bamboo bends but never breaks."
56. **BENEFICIAL ELEMENT UNDER ATTACK (ìš©ì‹ í”¼ê³µê²© - Friend vs Foe):**
    - CRITICAL: If Annual element CONQUERS Beneficial Element (e.g., Fire year + Metal Beneficial = Fire melts Metal).
    - Five Elements conquest: æœ¨å…‹åœŸ, åœŸå…‹æ°´, æ°´å…‹ç«, ç«å…‹é‡‘, é‡‘å…‹æœ¨
    - Rating: DANGER - regardless of other positive factors.
    - Metaphor: "Your best ally is being assassinated by this year's energy."
    - Advice: "Do NOT expand. Do NOT invest. Do NOT trust new partnerships. This year is for PRESERVATION only."
    - Financial: "Assets you chase will evaporate. Lock wealth in real estate. Avoid liquid investments."
57. **WEALTH ROBBERY YEAR (ç¾¤åŠ«çˆ­è²¡ - Strong Chart + Peer Year):**
    - If chart is STRONG (80%+) AND Annual Fortune is Peer (æ¯”è‚©) or Competitor (åŠ«è²¡).
    - Meaning: "Bandits are circling your treasury. Your own friends/siblings become rivals."
    - Warning: "Never co-sign loans. Never start partnerships. Keep wealth hidden."
    - Business: "Employees may betray. Partners may steal. Solo operation is safest."
    - Health: "Stress from competition leads to cardiovascular strain."
58. **EXPRESSOR STRUCTURE + PEER YEAR (ìƒê´€ê²© + ë¹„ê²ìš´):**
    - If Structure is Expressor/Hurting Officer AND Annual is Peer/Competitor.
    - Meaning: "A rebel (Expressor) gains bad-influence friends (Peers). Together they attack authority."
    - Warning: "HIGH RISK of lawsuit, public conflict with superiors, or career self-destruction."
    - Psychology: "Your talent makes you arrogant. Your friends encourage recklessness."
    - Advice: "Channel ALL energy into CREATION (art, writing, building). Zero energy for POLITICS (office drama, arguments)."
59. **SCANDAL ALERT - Male + Hour Indirect Wealth Echo (ë‚¨ëª… ì‹œì£¼ í¸ì¬ ë³µìŒ):**
    - If Male chart has Hour Pillar = Indirect Wealth AND Annual Fortune matches Hour Pillar.
    - Meaning: "The door to secret life opens. New women/entertainment temptations arrive."
    - CRITICAL WARNING: "This is NOT romance, it's a TRAP. Scandal destroys family and career."
    - If Self-Punishment (åˆåˆ) added: "DOUBLE DANGER. Gambling addiction or affair leads to ruin."
    - Advice: "Stay home at night. Reject temptation. Every 'opportunity' is poisoned bait."
60. **NO SHIELD - Missing Beneficial Element (ìš©ì‹  ë¶€ì¬):**
    - If Beneficial Element is completely ABSENT from natal chart (zero in all 8 characters).
    - Meaning: "No natural defense when crisis hits. Like a soldier without armor."
    - Psychology: "Cannot self-regulate desires. Excess becomes addiction."
    - If yong_attacked: "DOUBLE DANGER - attacked element doesn't even exist to defend."
    - Remedy: "Artificially CREATE beneficial element through: Metal = discipline, weights, strict schedule; Water = meditation, swimming; Fire = passion projects, socializing; Wood = learning, plants, nature; Earth = stability, documentation, grounding."
61. **HARM BETRAYAL (å…­å®³ - ë°°ì‹  ê²½ê³ ):**
    - Six Harm pairs: å­æœª, ä¸‘åˆ, å¯…å·³, å¯è¾°, ç”³äº¥, é…‰æˆŒ.
    - If Month Branch and Day Branch form Harm: "Closest people damage your foundation."
    - å¯è¾°å®³ Special: "Your WORDS (Rabbit/Expressor) destroy your FOUNDATION (Dragon/Storage). Verbal mistakes or a colleague's betrayal."
    - Advice: "Never co-sign loans. No joint investments. Trust actions, not words."
    - Health: For å¯è¾°å®³: "Liver (Wood) attacks Spleen (Earth). Digestive issues from stress."
62. **WATER EVAPORATION - Fire Year on Weak Water DM (ìˆ˜ì¦ë°œ ê²½ê³ ):**
    - If Day Master is Water (å£¬/ç™¸) with low strength (0-30%) AND Annual Fortune is pure Fire (ä¸™åˆ, ä¸å·³).
    - Metaphor: "Last drop of water boiling away in a furnace."
    - Health WARNING: "Kidney depletion, bladder inflammation, hormonal collapse, panic attacks."
    - Psychology: "Mental hysteria. Cannot cope with pressure."
    - Advice: "Drink water constantly. Avoid saunas, hot places, spicy food. Mental health support essential."
63. **BRANCH COMBINE TO UNFAVORABLE ELEMENT (ìœ¡í•©ì´ ê¸°ì‹ ìœ¼ë¡œ ë³€í™”):**
    - If Annual Branch combines with natal branch AND result element is Unfavorable God (å¿Œç¥).
    - Example: åˆ+æœªâ†’Fire for Weak Water DM. Fire is enemy, not friend.
    - Interpretation: "The alliance strengthens your enemy. What looks like harmony is actually betrayal."
    - For Hour Branch combine: "Late-life/children axis transforms into pressure zone. Reproductive/kidney health warning."
    - DO NOT interpret positively just because "combine" occurred.
64. **WEAK CHART + WEALTH STRUCTURE = ANXIOUS CHASER:**
    - If Strength < 20% AND Structure is Wealth-based (Direct/Indirect Wealth).
    - Override: Do NOT use terms like "Steady Builder" or "Patient Accumulator."
    - Reality: "Wealth overwhelms the weak Day Master. Subject chases money to exhaustion."
    - Health: "Stress-induced illness. Digestive problems. Anxiety disorders."
    - Strategy: "Let spouse or partner manage finances. Focus on health FIRST, money SECOND."
65. **FAKE FOLLOWER CHART (ê°€ì¢…ê²© ê²½ê³ ):**
    - If Strength = 0-5% AND no root in any branch AND dominant element has 4+ appearances.
    - Possibility: This may be a "Follower Chart" (ì¢…ê²©) where subject should FOLLOW the dominant element.
    - Paradox: If true Follower, then Fire year (2026) is GOOD because it strengthens the King.
    - If fake Follower: Fire year is DEADLY because weak Water evaporates.
    - Advice: "Extreme volatility. If you fully surrender to the trend, you win. If you resist, you break."
    - Safe interpretation: "Do NOT make major decisions this year. Observe which way the wind truly blows."
66. **LIFE CYCLE DIRECTION VERIFICATION (ëŒ€ìš´ ìˆœì—­ í™•ì¸):**
    - Life Cycle direction rule: Yang Year Male = Forward, Yang Year Female = Reverse, Yin Year Male = Reverse, Yin Year Female = Forward.
    - Yang Year = Year Stem is ç”²ä¸™æˆŠåºšå£¬ (Yang stems).
    - If data shows Life Cycle that doesn't match this rule, flag as potential calculation error.
    - CRITICAL: Wrong Life Cycle direction = Wrong decade = Wrong life advice. Verify before interpreting.
67. **DAY PILLAR WHITE TIGER (ì¼ì£¼ ë°±í˜¸ëŒ€ì‚´):**
    - Day Pillars: ç”²è¾°, ä¹™å·³, ä¸™æˆŒ, ä¸ä¸‘, æˆŠè¾°, å·±æœª, åºšæˆŒ, è¾›ä¸‘, å£¬è¾°, ç™¸ä¸‘.
    - If 'Day Pillar White Tiger' appears in Divine Stars, this is SIGNIFICANT.
    - Personality: "Gentle and calm normally, but explosive when angered. Like a sleeping tiger."
    - Warning: "Blood-related events possible for self, spouse, or children (surgery, accident, difficult childbirth)."
    - Remedy: "Working in medical, religious, military, or healing professions TRANSFORMS this energy into blessing."
    - For women: "Childbirth may be difficult. Caesarean section possible. Monitor pregnancy closely."
68. **STEM COMBINE BETRAYAL (ì²œê°„í•© ë°°ì‹  - Helper turns Foe):**
    - If Annual Stem combines with Monthly Stem to create an UNFAVORABLE element.
    - Example: ä¸™(Fire helper for weak Fire DM) + è¾›(Wealth) â†’ æ°´(Water/Pressure). Helper becomes attacker.
    - Metaphor: "A friend enters your house, falls in love with your money, and becomes your creditor."
    - Warning: "Do NOT trust friends' investment advice. Business partners may betray. The helper is not what they seem."
    - Advice: "Rely on branch roots (åœ°æ”¯), not stem alliances (å¤©å¹²). Act alone."
69. **GRAVE DAY PILLAR (ì…ë¬˜ì¼ì£¼ - Self-Grave):**
    - When Day Branch = Storage/Grave (å¢“) stage for Day Master.
    - Example: ä¸™æˆŒ (Fire DM in Fire's Grave), å£¬è¾° (Water DM in Water's Grave).
    - Personality: "NOT active starter. Instead: philosophical, introspective, hoarding tendency."
    - Override: Do NOT interpret as "energetic" or "new beginnings" even if other factors seem positive.
    - Wealth: "Collects but rarely spends. May appear stingy. Assets hidden or locked away."
    - Spouse: "Day Branch = Spouse Palace. Grave energy means 'controlled spouse' or 'late marriage'."
    - Psychology: "Outwardly bright (especially ä¸™æˆŒ Sun), but inner melancholy exists. Religious/spiritual inclination."
70. **TWELVE STAGES OVERRIDE (12ìš´ì„± ì¬ê²€ì¦):**
    - If Day Branch shows "Birth(é•·ç”Ÿ)" but Day Master actually sits in Grave position, data is WRONG.
    - Quick check for Fire DM: å¯…=Birth, åˆ=Peak, æˆŒ=Grave. If æˆŒ shows "Birth", calculation error.
    - Quick check for Water DM: ç”³=Birth, å­=Peak, è¾°=Grave. If è¾° shows "Birth", calculation error.
    - ALWAYS verify 12 Stages against classical tables before interpreting.
`;

        navigator.clipboard.writeText(text).then(() => {
            toast('ğŸ“‹ Copied! Paste into Gemini or ChatGPT');
        }).catch(() => {
            // Fallback: textarea
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            toast('ğŸ“‹ Copied to clipboard!');
        });
    } catch(err) {
        console.error('Copy error:', err);
        toast('Error copying to clipboard');
    }
}

/* ========================================
   POWERBALL & MEGA MILLIONS
   ======================================== */
let pbHistory = [];
let megaHistory = [];

// Five Elementsë³„ ëŸ­í‚¤ ë„˜ë²„ (ëìë¦¬ ê¸°ì¤€)
const ELEMENT_LUCKY_ENDINGS = {
    water: [1, 6],  // æ°´
    fire: [2, 7],   // ç«
    wood: [3, 8],   // æœ¨
    metal: [4, 9],  // é‡‘
    earth: [5, 0]   // åœŸ
};

// Generate numbers for specific element (1~max ë²”ìœ„)
function getElementNumbers(element, max) {
    const endings = ELEMENT_LUCKY_ENDINGS[element] || [1, 6];
    const nums = [];
    for(let i = 1; i <= max; i++) {
        const lastDigit = i % 10;
        if(endings.includes(lastDigit)) {
            nums.push(i);
        }
    }
    return nums;
}

// Extract Yongsin element from Saju
function getYongsinElement(saju) {
    const dmi = STEM.indexOf(saju.day.s);  // Day Master index
    const mbi = BRANCH.findIndex(br => br.c === saju.month.b.c);  // Month branch index
    
    // JOHU_TABLEì—ì„œ ìš©ì‹  ì°¾ê¸°
    if(JOHU_TABLE[dmi] && JOHU_TABLE[dmi][mbi]) {
        return JOHU_TABLE[dmi][mbi].yong;
    }
    
    // Default: Day Master generating element
    const dayElement = saju.day.s.e;
    const supportMap = {water:'wood', wood:'fire', fire:'earth', earth:'metal', metal:'water'};
    return supportMap[dayElement] || 'fire';
}

function generatePowerball(type) {
    // Premium check for destiny-based numbers
    if (type === 'destiny' && !isPremium) {
        toast('ğŸ‘‘ Destiny Numbers require Premium. Please offer ç¦å‚µ.');
        openPremiumCheckout();
        return;
    }
    
    const y = +document.getElementById('pb-year').value;
    const m = +document.getElementById('pb-month').value;
    const d = +document.getElementById('pb-day').value;
    
    let numbers = [];
    let powerball;
    
    if(type === 'destiny' && y && m && d) {
        // v4.14.7: ì‚¬ì£¼ íƒ­ì—ì„œ ì´ë¯¸ ë¶„ì„ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ í™œìš©
        let saju, yongsin;
        if (SAJU && GODS && BIRTH_YEAR === y) {
            saju = SAJU;
            yongsin = GODS.yong;
        } else {
            // ì‚¬ì£¼ ë¶„ì„ì´ ì•ˆ ëìœ¼ë©´ ì§ì ‘ ê³„ì‚°
            saju = {
                year: calcYearPillar(y, m, d),
                month: calcMonthPillar(y, m, d),
                day: calcDayPillar(y, m, d)
            };
            yongsin = getYongsinElement(saju);
        }
        
        const luckyNums = getElementNumbers(yongsin, 69);
        
        // Generate hash seed (including Saju info)
        const dayElement = saju.day.s.e;
        const seed = `${y}-${m}-${d}-${dayElement}-${yongsin}-PB-${Date.now()}`;
        let hash = 0;
        for(let i = 0; i < seed.length; i++) {
            hash = ((hash << 5) - hash) + seed.charCodeAt(i);
            hash = hash & hash;
        }
        
        const used = new Set();
        
        // 1) Include 2 Yongsin element numbers
        for(let i = 0; i < 2 && luckyNums.length > 0; i++) {
            hash = Math.abs((hash * 1103515245 + 12345) & 0x7fffffff);
            const idx = hash % luckyNums.length;
            const n = luckyNums[idx];
            if(!used.has(n)) {
                used.add(n);
                numbers.push(n);
            }
        }
        
        // 2) Remaining numbers hash-based
        while(numbers.length < 5) {
            hash = Math.abs((hash * 1103515245 + 12345) & 0x7fffffff);
            const n = (hash % 69) + 1;
            if(!used.has(n)) {
                used.add(n);
                numbers.push(n);
            }
        }
        numbers.sort((a,b) => a-b);
        
        // Powerball (1-26) - ìš©ì‹  ì˜¤í–‰ ë°˜ì˜
        const luckyPB = getElementNumbers(yongsin, 26);
        hash = Math.abs((hash * 1103515245 + 12345) & 0x7fffffff);
        if(luckyPB.length > 0 && hash % 3 !== 0) {  // 66% chance for Yongsin number
            powerball = luckyPB[hash % luckyPB.length];
        } else {
            powerball = (hash % 26) + 1;
        }
        
        toast(`ğŸ”® Destiny numbers generated! (${yongsin.toUpperCase()} energy)`);
    } else {
        // Quick Pick
        const used = new Set();
        while(numbers.length < 5) {
            const n = Math.floor(Math.random() * 69) + 1;
            if(!used.has(n)) {
                used.add(n);
                numbers.push(n);
            }
        }
        numbers.sort((a,b) => a-b);
        powerball = Math.floor(Math.random() * 26) + 1;
        
        toast('ğŸ² Quick Pick generated!');
    }
    
    // Display
    const container = document.getElementById('pb-balls');
    container.innerHTML = '';
    
    numbers.forEach((n, i) => {
        setTimeout(() => {
            const ball = document.createElement('div');
            ball.className = 'ball';
            ball.textContent = n;
            ball.style.animationDelay = `${i * 0.1}s`;
            container.appendChild(ball);
        }, i * 200);
    });
    
    setTimeout(() => {
        const pb = document.createElement('div');
        pb.className = 'ball powerball';
        pb.textContent = powerball;
        container.appendChild(pb);
    }, 1200);
    
    document.getElementById('pb-result').style.display = 'block';
    
    // Save to history
    pbHistory.unshift({ type: type === 'destiny' ? 'DESTINY' : 'QUICK', numbers, powerball });
    if(pbHistory.length > 5) pbHistory.pop();
    renderPbHistory();
}

function renderPbHistory() {
    if(pbHistory.length === 0) return;
    document.getElementById('pb-history').style.display = 'block';
    document.getElementById('pb-history-list').innerHTML = pbHistory.map(h => `
        <div class="history-item">
            <span class="history-type">${h.type}</span>
            <div class="history-balls">
                ${h.numbers.map(n => `<div class="ball" style="animation:none;opacity:1;">${n}</div>`).join('')}
                <div class="ball powerball" style="animation:none;opacity:1;">${h.powerball}</div>
            </div>
        </div>
    `).join('');
}

function generateMega(type) {
    // Premium check for destiny-based numbers
    if (type === 'destiny' && !isPremium) {
        toast('ğŸ‘‘ Destiny Numbers require Premium. Please offer ç¦å‚µ.');
        openPremiumCheckout();
        return;
    }
    
    const y = +document.getElementById('mega-year').value;
    const m = +document.getElementById('mega-month').value;
    const d = +document.getElementById('mega-day').value;
    
    let numbers = [];
    let megaball;
    
    if(type === 'destiny' && y && m && d) {
        // v4.14.7: ì‚¬ì£¼ íƒ­ì—ì„œ ì´ë¯¸ ë¶„ì„ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ í™œìš©
        let saju, yongsin;
        if (SAJU && GODS && BIRTH_YEAR === y) {
            saju = SAJU;
            yongsin = GODS.yong;
        } else {
            // ì‚¬ì£¼ ë¶„ì„ì´ ì•ˆ ëìœ¼ë©´ ì§ì ‘ ê³„ì‚°
            saju = {
                year: calcYearPillar(y, m, d),
                month: calcMonthPillar(y, m, d),
                day: calcDayPillar(y, m, d)
            };
            yongsin = getYongsinElement(saju);
        }
        
        const luckyNums = getElementNumbers(yongsin, 70);
        
        // Generate hash seed (including Saju info)
        const dayElement = saju.day.s.e;
        const seed = `${y}-${m}-${d}-${dayElement}-${yongsin}-MEGA-${Date.now()}`;
        let hash = 0;
        for(let i = 0; i < seed.length; i++) {
            hash = ((hash << 5) - hash) + seed.charCodeAt(i);
            hash = hash & hash;
        }
        
        const used = new Set();
        
        // 1) Include 2 Yongsin element numbers
        for(let i = 0; i < 2 && luckyNums.length > 0; i++) {
            hash = Math.abs((hash * 1103515245 + 12345) & 0x7fffffff);
            const idx = hash % luckyNums.length;
            const n = luckyNums[idx];
            if(!used.has(n)) {
                used.add(n);
                numbers.push(n);
            }
        }
        
        // 2) Remaining numbers hash-based
        while(numbers.length < 5) {
            hash = Math.abs((hash * 1103515245 + 12345) & 0x7fffffff);
            const n = (hash % 70) + 1;
            if(!used.has(n)) {
                used.add(n);
                numbers.push(n);
            }
        }
        numbers.sort((a,b) => a-b);
        
        // Megaball (1-25) - ìš©ì‹  ì˜¤í–‰ ë°˜ì˜
        const luckyMB = getElementNumbers(yongsin, 25);
        hash = Math.abs((hash * 1103515245 + 12345) & 0x7fffffff);
        if(luckyMB.length > 0 && hash % 3 !== 0) {  // 66% chance for Yongsin number
            megaball = luckyMB[hash % luckyMB.length];
        } else {
            megaball = (hash % 25) + 1;
        }
        
        toast(`ğŸ”® Destiny numbers generated! (${yongsin.toUpperCase()} energy)`);
    } else {
        const used = new Set();
        while(numbers.length < 5) {
            const n = Math.floor(Math.random() * 70) + 1;
            if(!used.has(n)) {
                used.add(n);
                numbers.push(n);
            }
        }
        numbers.sort((a,b) => a-b);
        megaball = Math.floor(Math.random() * 25) + 1;
        
        toast('ğŸ² Quick Pick generated!');
    }
    
    const container = document.getElementById('mega-balls');
    container.innerHTML = '';
    
    numbers.forEach((n, i) => {
        setTimeout(() => {
            const ball = document.createElement('div');
            ball.className = 'ball mega';
            ball.textContent = n;
            ball.style.animationDelay = `${i * 0.1}s`;
            container.appendChild(ball);
        }, i * 200);
    });
    
    setTimeout(() => {
        const mb = document.createElement('div');
        mb.className = 'ball megaball';
        mb.textContent = megaball;
        container.appendChild(mb);
    }, 1200);
    
    document.getElementById('mega-result').style.display = 'block';
    
    megaHistory.unshift({ type: type === 'destiny' ? 'DESTINY' : 'QUICK', numbers, megaball });
    if(megaHistory.length > 5) megaHistory.pop();
    renderMegaHistory();
}

function renderMegaHistory() {
    if(megaHistory.length === 0) return;
    document.getElementById('mega-history').style.display = 'block';
    document.getElementById('mega-history-list').innerHTML = megaHistory.map(h => `
        <div class="history-item">
            <span class="history-type">${h.type}</span>
            <div class="history-balls">
                ${h.numbers.map(n => `<div class="ball mega" style="animation:none;opacity:1;">${n}</div>`).join('')}
                <div class="ball megaball" style="animation:none;opacity:1;">${h.megaball}</div>
            </div>
        </div>
    `).join('');
}

/* ========================================
   TAB SWITCHING
   ======================================== */
function switchGame(game) {
    // Deactivate all tabs
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.game-btn').forEach(b => b.classList.remove('active'));
    
    // Activate selected tab
    document.getElementById(`tab-${game}`).classList.add('active');
    event.target.closest('.game-btn').classList.add('active');
    
    // Change theme
    document.body.className = game + '-mode';
}

/* ========================================
   INITIALIZATION
   ======================================== */
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Saju selects
    const sajuYear = document.getElementById('saju-year');
    const sajuMonth = document.getElementById('saju-month');
    const sajuDay = document.getElementById('saju-day');
    const sajuHour = document.getElementById('saju-hour');
    
    for(let y = 2026; y >= 1940; y--) {
        const opt = document.createElement('option');
        opt.value = y; opt.textContent = y;
        if(y === 1990) opt.selected = true;
        sajuYear.appendChild(opt);
    }
    for(let m = 1; m <= 12; m++) {
        const opt = document.createElement('option');
        opt.value = m; opt.textContent = MONTH_ABBR[m - 1];
        sajuMonth.appendChild(opt);
    }
    for(let d = 1; d <= 31; d++) {
        const opt = document.createElement('option');
        opt.value = d; opt.textContent = d;
        sajuDay.appendChild(opt);
    }
    
    const hourOpts = ['Unknown','å­(23:30-01:29)','ä¸‘(01:30-03:29)','å¯…(03:30-05:29)','å¯(05:30-07:29)','è¾°(07:30-09:29)','å·³(09:30-11:29)','åˆ(11:30-13:29)','æœª(13:30-15:29)','ç”³(15:30-17:29)','é…‰(17:30-19:29)','æˆŒ(19:30-21:29)','äº¥(21:30-23:29)'];
    hourOpts.forEach((h,i) => {
        const opt = document.createElement('option');
        opt.value = i === 0 ? '' : (i-1);
        opt.textContent = h;
        sajuHour.appendChild(opt);
    });
    
    // Powerball ì…€ë ‰íŠ¸ ì´ˆê¸°í™”
    ['pb', 'mega'].forEach(prefix => {
        const yearSel = document.getElementById(`${prefix}-year`);
        const monthSel = document.getElementById(`${prefix}-month`);
        const daySel = document.getElementById(`${prefix}-day`);
        
        for(let y = 2026; y >= 1940; y--) {
            const opt = document.createElement('option');
            opt.value = y; opt.textContent = y;
            if(y === 1990) opt.selected = true;
            yearSel.appendChild(opt);
        }
        for(let m = 1; m <= 12; m++) {
            const opt = document.createElement('option');
            opt.value = m; opt.textContent = MONTH_ABBR[m - 1];
            monthSel.appendChild(opt);
        }
        for(let d = 1; d <= 31; d++) {
            const opt = document.createElement('option');
            opt.value = d; opt.textContent = d;
            daySel.appendChild(opt);
        }
    });
});

/* ========================================
   LEGAL PAGE NAVIGATION
   ======================================== */
function showLegalPage(page) {
    document.querySelectorAll('.legal-page').forEach(p => p.style.display = 'none');
    document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
    document.getElementById('legal-' + page).style.display = 'block';
    window.scrollTo(0, 0);
    // Update URL hash without triggering reload
    history.pushState(null, null, '#' + page);
}

function closeLegalPage() {
    document.querySelectorAll('.legal-page').forEach(p => p.style.display = 'none');
    document.querySelector('.tab-content.active').style.display = 'block';
    // Clear hash
    history.pushState(null, null, window.location.pathname);
}

// Handle URL hash on page load and hash change (for Paddle verification)
function handleUrlHash() {
    const hash = window.location.hash.replace('#', '');
    if (hash === 'terms' || hash === 'privacy' || hash === 'refund') {
        showLegalPage(hash);
    }
}

// Check hash on page load
window.addEventListener('load', handleUrlHash);
// Check hash on hash change
window.addEventListener('hashchange', handleUrlHash);

</script>

<!-- ========================================
     LEGAL PAGES
     ======================================== -->

<!-- TERMS OF SERVICE -->
<div id="legal-terms" class="legal-page" style="display:none;">
    <div class="legal-container">
        <button class="legal-close" onclick="closeLegalPage()">âœ• Close</button>
        <h1>ğŸ“œ Terms of Service</h1>
        <p class="legal-updated">Last Updated: January 2025</p>
        
        <h2>1. ACCEPTANCE OF TERMS</h2>
        <p>By accessing K-MUDANG ("Service"), you agree to these Terms of Service.</p>
        
        <h2>2. SERVICE DESCRIPTION</h2>
        <p>K-MUDANG provides:</p>
        <ul>
            <li>Four Pillars of Destiny (Saju) analysis</li>
            <li>AI-powered fortune interpretation</li>
            <li>Lottery number generation based on metaphysical algorithms</li>
        </ul>
        
        <h2>3. ENTERTAINMENT PURPOSE</h2>
        <p>This Service is for <strong>ENTERTAINMENT PURPOSES ONLY</strong>.</p>
        <ul>
            <li>We do NOT guarantee lottery winnings</li>
            <li>We do NOT predict actual future events</li>
            <li>Saju analysis is based on traditional Korean metaphysics, not science</li>
        </ul>
        
        <h2>4. PAYMENT & REFUNDS</h2>
        <ul>
            <li>Premium access is granted for 24 hours after payment</li>
            <li>All sales are final. No refunds (see Refund Policy for exceptions)</li>
            <li>Payment processed securely via Paddle</li>
        </ul>
        
        <h2>5. USER RESPONSIBILITIES</h2>
        <ul>
            <li>You must be 18+ to use this Service</li>
            <li>You are responsible for your gambling decisions</li>
            <li>Do not spend more than you can afford to lose</li>
        </ul>
        
        <h2>6. INTELLECTUAL PROPERTY</h2>
        <ul>
            <li>All content, algorithms, and AI prompts are owned by K-MUDANG</li>
            <li>Unauthorized copying or redistribution is prohibited</li>
        </ul>
        
        <h2>7. LIMITATION OF LIABILITY</h2>
        <p>K-MUDANG is not liable for:</p>
        <ul>
            <li>Financial losses from lottery play</li>
            <li>Decisions made based on Saju readings</li>
            <li>Any damages arising from use of this Service</li>
        </ul>
        
        <h2>8. GOVERNING LAW</h2>
        <p>These Terms are governed by the laws of the Republic of Korea.</p>
        
        <h2>9. CONTACT</h2>
        <p>For questions: <a href="https://mail.google.com/mail/?view=cm&to=kmudang.official@gmail.com" target="_blank"><span class="__cf_email__" data-cfemail="22494f5746434c450c4d44444b414b434e62454f434b4e0c414d4f">[email&#160;protected]</span></a></p>
    </div>
</div>

<!-- PRIVACY POLICY -->
<div id="legal-privacy" class="legal-page" style="display:none;">
    <div class="legal-container">
        <button class="legal-close" onclick="closeLegalPage()">âœ• Close</button>
        <h1>ğŸ”’ Privacy Policy</h1>
        <p class="legal-updated">Last Updated: January 2025</p>
        
        <h2>1. INFORMATION WE COLLECT</h2>
        
        <h3>a) Account Information:</h3>
        <ul>
            <li>Email address (via Google Sign-In)</li>
            <li>Name (from Google profile)</li>
        </ul>
        
        <h3>b) Birth Information (User Provided):</h3>
        <ul>
            <li>Birth date, time, and gender</li>
            <li>Used solely for Saju calculation</li>
        </ul>
        
        <h3>c) Payment Information:</h3>
        <ul>
            <li>Processed by Paddle</li>
            <li>We do NOT store credit card numbers</li>
        </ul>
        
        <h2>2. HOW WE USE YOUR INFORMATION</h2>
        <ul>
            <li>To provide Saju analysis</li>
            <li>To process payments</li>
            <li>To improve our Service</li>
            <li>To send service-related notifications</li>
        </ul>
        
        <h2>3. DATA STORAGE</h2>
        <ul>
            <li>Stored securely in Google Firebase (Seoul, Korea)</li>
            <li>Birth data is encrypted</li>
            <li>Retained until account deletion</li>
        </ul>
        
        <h2>4. DATA SHARING</h2>
        <p>We do NOT sell your data. We share data only with:</p>
        <ul>
            <li>Google (Authentication)</li>
            <li>Paddle (Payment processing)</li>
            <li>Analytics providers</li>
        </ul>
        
        <h2>5. YOUR RIGHTS</h2>
        <p>You may:</p>
        <ul>
            <li>Access your data</li>
            <li>Delete your account</li>
            <li>Request data export</li>
        </ul>
        
        <h2>6. COOKIES</h2>
        <p>We use essential cookies for:</p>
        <ul>
            <li>Authentication</li>
            <li>Session management</li>
        </ul>
        
        <h2>7. CHILDREN'S PRIVACY</h2>
        <p>This Service is not for users under 18.</p>
        
        <h2>8. CHANGES TO POLICY</h2>
        <p>We may update this Policy. Continued use means acceptance.</p>
        
        <h2>9. CONTACT</h2>
        <p>Privacy questions: <a href="https://mail.google.com/mail/?view=cm&to=kmudang.official@gmail.com" target="_blank"><span class="__cf_email__" data-cfemail="d3b8bea6b7b2bdb4fdbcb5b5bab0bab2bf93b4beb2babffdb0bcbe">[email&#160;protected]</span></a></p>
    </div>
</div>

<!-- REFUND POLICY -->
<div id="legal-refund" class="legal-page" style="display:none;">
    <div class="legal-container">
        <button class="legal-close" onclick="closeLegalPage()">âœ• Close</button>
        <h1>ğŸ’° Refund Policy</h1>
        <p class="legal-updated">Last Updated: January 2025</p>
        
        <h2>1. DIGITAL PRODUCTS - NO REFUNDS</h2>
        <p>K-MUDANG provides digital fortune-telling services and AI-generated content.</p>
        <p>Due to the nature of digital products, <strong>ALL SALES ARE FINAL</strong>.</p>
        <p>Once you receive your Saju analysis or lottery numbers, the service has been fully delivered and cannot be "returned."</p>
        
        <h2>2. EXCEPTIONS</h2>
        <p>We may offer refunds ONLY in these cases:</p>
        <ul>
            <li>Technical error prevented access to paid content</li>
            <li>Duplicate charge (charged twice for same purchase)</li>
            <li>Service was completely unavailable for 24+ hours</li>
        </ul>
        
        <h2>3. HOW TO REQUEST</h2>
        <p>If you believe you qualify for an exception:</p>
        <ul>
            <li>Email: <a href="https://mail.google.com/mail/?view=cm&to=kmudang.official@gmail.com" target="_blank"><span class="__cf_email__" data-cfemail="91fafce4f5f0fff6bffef7f7f8f2f8f0fdd1f6fcf0f8fdbff2fefc">[email&#160;protected]</span></a></li>
            <li>Include: Your email, purchase date, reason</li>
            <li>Response time: Within 48 hours</li>
        </ul>
        
        <h2>4. PROCESSING</h2>
        <p>Approved refunds will be processed within 5-7 business days to the original payment method.</p>
        
        <h2>5. CONTACT</h2>
        <p>Questions about refunds: <a href="https://mail.google.com/mail/?view=cm&to=kmudang.official@gmail.com" target="_blank"><span class="__cf_email__" data-cfemail="9bf0f6eefffaf5fcb5f4fdfdf2f8f2faf7dbfcf6faf2f7b5f8f4f6">[email&#160;protected]</span></a></p>
    </div>
</div>

<!-- ========================================
     FOOTER
     ======================================== -->
<footer class="legal-footer">
    <div class="disclaimer">
        <strong>âš ï¸ Disclaimer:</strong> K-MUDANG is an entertainment service based on traditional Korean Saju (Four Pillars of Destiny) logic and AI interpretation. 
        This service does not guarantee lottery winnings or predict future events. 
        Lottery numbers are generated using metaphysical algorithms for entertainment purposes only. 
        Please gamble responsibly.
    </div>
    
    <div class="copyright">
        Â© 2025 K-MUDANG. All Rights Reserved.<br>
        <span class="ip-notice">The AI-Saju Integration Protocol is a proprietary methodology of K-MUDANG.</span><br>
        <span style="color:#666;font-size:0.75rem;">Business License: 487-20-02668</span>
    </div>
    
    <div class="legal-links">
        <a href="#terms" onclick="showLegalPage('terms'); return false;">Terms of Service</a> | 
        <a href="#privacy" onclick="showLegalPage('privacy'); return false;">Privacy Policy</a> | 
        <a href="#refund" onclick="showLegalPage('refund'); return false;">Refund Policy</a> | 
        <a href="https://mail.google.com/mail/?view=cm&to=kmudang.official@gmail.com" target="_blank">Contact</a>
    </div>
</footer>

<style>
/* Legal Pages CSS */
.legal-page {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--navy);
    z-index: 9999;
    overflow-y: auto;
    padding: 20px;
}

.legal-container {
    max-width: 800px;
    margin: 0 auto;
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(212, 175, 55, 0.3);
    border-radius: 15px;
    padding: 40px;
}

.legal-close {
    float: right;
    background: rgba(212, 175, 55, 0.2);
    border: 1px solid var(--gold);
    color: var(--gold);
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
}

.legal-close:hover {
    background: var(--gold);
    color: var(--navy);
}

.legal-page h1 {
    color: var(--gold);
    font-family: 'Cinzel Decorative', serif;
    margin-bottom: 10px;
}

.legal-updated {
    color: #888;
    font-style: italic;
    margin-bottom: 30px;
}

.legal-page h2 {
    color: #F4D58D;
    margin-top: 30px;
    margin-bottom: 15px;
    border-bottom: 1px solid rgba(212, 175, 55, 0.2);
    padding-bottom: 10px;
}

.legal-page h3 {
    color: #ccc;
    margin-top: 20px;
    margin-bottom: 10px;
}

.legal-page p {
    color: #bbb;
    line-height: 1.8;
    margin-bottom: 15px;
}

.legal-page ul {
    color: #bbb;
    margin-left: 20px;
    margin-bottom: 15px;
}

.legal-page li {
    margin-bottom: 8px;
    line-height: 1.6;
}

.legal-page a {
    color: var(--gold);
}

.legal-page strong {
    color: #fff;
}

/* Footer CSS */
.legal-footer {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-top: 1px solid rgba(212, 175, 55, 0.3);
    padding: 30px 20px;
    margin-top: 50px;
    text-align: center;
    font-size: 0.85rem;
    color: #9CA3AF;
}

.legal-footer .disclaimer {
    max-width: 800px;
    margin: 0 auto 20px;
    padding: 15px;
    background: rgba(0,0,0,0.2);
    border-radius: 8px;
    line-height: 1.6;
}

.legal-footer .copyright {
    margin-bottom: 15px;
}

.legal-footer .ip-notice {
    font-size: 0.75rem;
    opacity: 0.7
}
</style>
</body>
</html>
